{"remainingRequest":"D:\\Практика\\Vue practice\\vue-pannellum-interface\\node_modules\\babel-loader\\lib\\index.js!D:\\Практика\\Vue practice\\vue-pannellum-interface\\node_modules\\eslint-loader\\index.js??ref--13-0!D:\\Практика\\Vue practice\\vue-pannellum-interface\\src\\pannellum-2.5.6\\src\\js\\pannellum.js","dependencies":[{"path":"D:\\Практика\\Vue practice\\vue-pannellum-interface\\src\\pannellum-2.5.6\\src\\js\\pannellum.js","mtime":1607675807638},{"path":"D:\\Практика\\Vue practice\\vue-pannellum-interface\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Практика\\Vue practice\\vue-pannellum-interface\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000},{"path":"D:\\Практика\\Vue practice\\vue-pannellum-interface\\node_modules\\eslint-loader\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:cmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmZvci1lYWNoIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuaW5kZXgtb2YiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5qb2luIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc2xpY2UiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5zcGxpY2UiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5udW1iZXIuY29uc3RydWN0b3IiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5udW1iZXIudG8tZml4ZWQiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QudG8tc3RyaW5nIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMucmVnZXhwLmNvbnN0cnVjdG9yIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMucmVnZXhwLmV4ZWMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5yZWdleHAudG8tc3RyaW5nIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLml0ZXJhdG9yIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLm1hdGNoIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnJlcGxhY2UiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuc3BsaXQiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy93ZWIuZG9tLWNvbGxlY3Rpb25zLmZvci1lYWNoIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvd2ViLmRvbS1jb2xsZWN0aW9ucy5pdGVyYXRvciIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL3dlYi51cmwiKTsKCi8qDQogKiBQYW5uZWxsdW0gLSBBbiBIVE1MNSBiYXNlZCBQYW5vcmFtYSBWaWV3ZXINCiAqIENvcHlyaWdodCAoYykgMjAxMS0yMDE5IE1hdHRoZXcgUGV0cm9mZg0KICogDQogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5DQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbA0KICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cw0KICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbA0KICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzDQogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOg0KICogDQogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbg0KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuDQogKiANCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SDQogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwNCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQ0KICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUg0KICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwNCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4NCiAqIFRIRSBTT0ZUV0FSRS4NCiAqLwp3aW5kb3cucGFubmVsbHVtID0gZnVuY3Rpb24gKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCkgewogICd1c2Ugc3RyaWN0JzsKICAvKioNCiAgICogQ3JlYXRlcyBhIG5ldyBwYW5vcmFtYSB2aWV3ZXIuDQogICAqIEBjb25zdHJ1Y3Rvcg0KICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fHN0cmluZ30gY29udGFpbmVyIC0gVGhlIGNvbnRhaW5lciAoZGl2KSBlbGVtZW50IGZvciB0aGUNCiAgICogICAgICB2aWV3ZXIsIG9yIGl0cyBJRC4NCiAgICogQHBhcmFtIHtPYmplY3R9IGluaXRpYWxDb25maWcgLSBJbml0YWwgY29uZmlndXJhdGlvbiBmb3Igdmlld2VyLg0KICAgKi8KCiAgZnVuY3Rpb24gVmlld2VyKGNvbnRhaW5lciwgaW5pdGlhbENvbmZpZykgewogICAgdmFyIF90aGlzID0gdGhpczsgLy8gRGVjbGFyZSB2YXJpYWJsZXMKCgogICAgdmFyIGNvbmZpZywKICAgICAgICByZW5kZXJlciwKICAgICAgICBwcmV2aWV3LAogICAgICAgIGlzVXNlckludGVyYWN0aW5nID0gZmFsc2UsCiAgICAgICAgbGF0ZXN0SW50ZXJhY3Rpb24gPSBEYXRlLm5vdygpLAogICAgICAgIG9uUG9pbnRlckRvd25Qb2ludGVyWCA9IDAsCiAgICAgICAgb25Qb2ludGVyRG93blBvaW50ZXJZID0gMCwKICAgICAgICBvblBvaW50ZXJEb3duUG9pbnRlckRpc3QgPSAtMSwKICAgICAgICBvblBvaW50ZXJEb3duWWF3ID0gMCwKICAgICAgICBvblBvaW50ZXJEb3duUGl0Y2ggPSAwLAogICAgICAgIGtleXNEb3duID0gbmV3IEFycmF5KDEwKSwKICAgICAgICBmdWxsc2NyZWVuQWN0aXZlID0gZmFsc2UsCiAgICAgICAgbG9hZGVkLAogICAgICAgIGVycm9yID0gZmFsc2UsCiAgICAgICAgaXNUaW1lZE91dCA9IGZhbHNlLAogICAgICAgIGxpc3RlbmVyc0FkZGVkID0gZmFsc2UsCiAgICAgICAgcGFub0ltYWdlLAogICAgICAgIHByZXZUaW1lLAogICAgICAgIHNwZWVkID0gewogICAgICAneWF3JzogMCwKICAgICAgJ3BpdGNoJzogMCwKICAgICAgJ2hmb3YnOiAwCiAgICB9LAogICAgICAgIGFuaW1hdGluZyA9IGZhbHNlLAogICAgICAgIG9yaWVudGF0aW9uID0gZmFsc2UsCiAgICAgICAgb3JpZW50YXRpb25ZYXdPZmZzZXQgPSAwLAogICAgICAgIGF1dG9Sb3RhdGVTdGFydCwKICAgICAgICBhdXRvUm90YXRlU3BlZWQgPSAwLAogICAgICAgIG9yaWdIZm92LAogICAgICAgIG9yaWdQaXRjaCwKICAgICAgICBhbmltYXRlZE1vdmUgPSB7fSwKICAgICAgICBleHRlcm5hbEV2ZW50TGlzdGVuZXJzID0ge30sCiAgICAgICAgc3BlY2lmaWVkUGhvdG9TcGhlcmVFeGNsdWRlcyA9IFtdLAogICAgICAgIHVwZGF0ZSA9IGZhbHNlLAogICAgICAgIC8vIFNob3VsZCB3ZSB1cGRhdGUgd2hlbiBzdGlsbCB0byByZW5kZXIgZHluYW1pYyBjb250ZW50CiAgICBlcHMgPSAxZS02LAogICAgICAgIGhvdHNwb3RzQ3JlYXRlZCA9IGZhbHNlLAogICAgICAgIGRlc3Ryb3llZCA9IGZhbHNlOwogICAgdmFyIGRlZmF1bHRDb25maWcgPSB7CiAgICAgIGhmb3Y6IDEwMCwKICAgICAgbWluSGZvdjogNTAsCiAgICAgIG11bHRpUmVzTWluSGZvdjogZmFsc2UsCiAgICAgIG1heEhmb3Y6IDEyMCwKICAgICAgcGl0Y2g6IDAsCiAgICAgIG1pblBpdGNoOiB1bmRlZmluZWQsCiAgICAgIG1heFBpdGNoOiB1bmRlZmluZWQsCiAgICAgIHlhdzogMCwKICAgICAgbWluWWF3OiAtMTgwLAogICAgICBtYXhZYXc6IDE4MCwKICAgICAgcm9sbDogMCwKICAgICAgaGFvdjogMzYwLAogICAgICB2YW92OiAxODAsCiAgICAgIHZPZmZzZXQ6IDAsCiAgICAgIGF1dG9Sb3RhdGU6IGZhbHNlLAogICAgICBhdXRvUm90YXRlSW5hY3Rpdml0eURlbGF5OiAtMSwKICAgICAgYXV0b1JvdGF0ZVN0b3BEZWxheTogdW5kZWZpbmVkLAogICAgICB0eXBlOiAnZXF1aXJlY3Rhbmd1bGFyJywKICAgICAgbm9ydGhPZmZzZXQ6IDAsCiAgICAgIHNob3dGdWxsc2NyZWVuQ3RybDogdHJ1ZSwKICAgICAgZHluYW1pYzogZmFsc2UsCiAgICAgIGR5bmFtaWNVcGRhdGU6IGZhbHNlLAogICAgICBkb3VibGVDbGlja1pvb206IHRydWUsCiAgICAgIGtleWJvYXJkWm9vbTogdHJ1ZSwKICAgICAgbW91c2Vab29tOiB0cnVlLAogICAgICBzaG93Wm9vbUN0cmw6IHRydWUsCiAgICAgIGF1dG9Mb2FkOiBmYWxzZSwKICAgICAgc2hvd0NvbnRyb2xzOiB0cnVlLAogICAgICBvcmllbnRhdGlvbk9uQnlEZWZhdWx0OiBmYWxzZSwKICAgICAgaG90U3BvdERlYnVnOiBmYWxzZSwKICAgICAgYmFja2dyb3VuZENvbG9yOiBbMCwgMCwgMF0sCiAgICAgIGF2b2lkU2hvd2luZ0JhY2tncm91bmQ6IGZhbHNlLAogICAgICBhbmltYXRpb25UaW1pbmdGdW5jdGlvbjogdGltaW5nRnVuY3Rpb24sCiAgICAgIGRyYWdnYWJsZTogdHJ1ZSwKICAgICAgZGlzYWJsZUtleWJvYXJkQ3RybDogZmFsc2UsCiAgICAgIGNyb3NzT3JpZ2luOiAnYW5vbnltb3VzJywKICAgICAgdG91Y2hQYW5TcGVlZENvZWZmRmFjdG9yOiAxLAogICAgICBjYXB0dXJlZEtleU51bWJlcnM6IFsxNiwgMTcsIDI3LCAzNywgMzgsIDM5LCA0MCwgNjEsIDY1LCA2OCwgODMsIDg3LCAxMDcsIDEwOSwgMTczLCAxODcsIDE4OV0sCiAgICAgIGZyaWN0aW9uOiAwLjE1CiAgICB9OyAvLyBUcmFuc2xhdGFibGUgLyBjb25maWd1cmFibGUgc3RyaW5ncwogICAgLy8gU29tZSBzdHJpbmdzIGNvbnRhaW4gJyVzJywgd2hpY2ggaXMgYSBwbGFjZWhvbGRlciBmb3IgaW5zZXJ0ZWQgdmFsdWVzCiAgICAvLyBXaGVuIHNldHRpbmcgc3RyaW5ncyBpbiBleHRlcm5hbCBjb25maWd1cmF0aW9uLCBgXG5gIHNob3VsZCBiZSB1c2VkIGluc3RlYWQgb2YgYDxicj5gIHRvIGluc2VydCBsaW5lIGJyZWFrcwoKICAgIGRlZmF1bHRDb25maWcuc3RyaW5ncyA9IHsKICAgICAgLy8gTGFiZWxzCiAgICAgIGxvYWRCdXR0b25MYWJlbDogJ0NsaWNrIHRvPGJyPkxvYWQ8YnI+UGFub3JhbWEnLAogICAgICBsb2FkaW5nTGFiZWw6ICdMb2FkaW5nLi4uJywKICAgICAgYnlsaW5lTGFiZWw6ICdieSAlcycsCiAgICAgIC8vIE9uZSBzdWJzdGl0dXRpb246IGF1dGhvcgogICAgICAvLyBFcnJvcnMKICAgICAgbm9QYW5vcmFtYUVycm9yOiAnTm8gcGFub3JhbWEgaW1hZ2Ugd2FzIHNwZWNpZmllZC4nLAogICAgICBmaWxlQWNjZXNzRXJyb3I6ICdUaGUgZmlsZSAlcyBjb3VsZCBub3QgYmUgYWNjZXNzZWQuJywKICAgICAgLy8gT25lIHN1YnN0aXR1dGlvbjogZmlsZSBVUkwKICAgICAgbWFsZm9ybWVkVVJMRXJyb3I6ICdUaGVyZSBpcyBzb21ldGhpbmcgd3Jvbmcgd2l0aCB0aGUgcGFub3JhbWEgVVJMLicsCiAgICAgIGlPUzhXZWJHTEVycm9yOiAiRHVlIHRvIGlPUyA4J3MgYnJva2VuIFdlYkdMIGltcGxlbWVudGF0aW9uLCBvbmx5ICIgKyAicHJvZ3Jlc3NpdmUgZW5jb2RlZCBKUEVHcyB3b3JrIGZvciB5b3VyIGRldmljZSAodGhpcyAiICsgInBhbm9yYW1hIHVzZXMgc3RhbmRhcmQgZW5jb2RpbmcpLiIsCiAgICAgIGdlbmVyaWNXZWJHTEVycm9yOiAnWW91ciBicm93c2VyIGRvZXMgbm90IGhhdmUgdGhlIG5lY2Vzc2FyeSBXZWJHTCBzdXBwb3J0IHRvIGRpc3BsYXkgdGhpcyBwYW5vcmFtYS4nLAogICAgICB0ZXh0dXJlU2l6ZUVycm9yOiAnVGhpcyBwYW5vcmFtYSBpcyB0b28gYmlnIGZvciB5b3VyIGRldmljZSEgSXRcJ3MgJyArICclc3B4IHdpZGUsIGJ1dCB5b3VyIGRldmljZSBvbmx5IHN1cHBvcnRzIGltYWdlcyB1cCB0byAnICsgJyVzcHggd2lkZS4gVHJ5IGFub3RoZXIgZGV2aWNlLicgKyAnIChJZiB5b3VcJ3JlIHRoZSBhdXRob3IsIHRyeSBzY2FsaW5nIGRvd24gdGhlIGltYWdlLiknLAogICAgICAvLyBUd28gc3Vic3RpdHV0aW9uczogaW1hZ2Ugd2lkdGgsIG1heCBpbWFnZSB3aWR0aAogICAgICB1bmtub3duRXJyb3I6ICdVbmtub3duIGVycm9yLiBDaGVjayBkZXZlbG9wZXIgY29uc29sZS4nCiAgICB9OyAvLyBJbml0aWFsaXplIGNvbnRhaW5lcgoKICAgIGNvbnRhaW5lciA9IHR5cGVvZiBjb250YWluZXIgPT09ICdzdHJpbmcnID8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY29udGFpbmVyKSA6IGNvbnRhaW5lcjsKICAgIGNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdwbmxtLWNvbnRhaW5lcicpOwogICAgY29udGFpbmVyLnRhYkluZGV4ID0gMDsgLy8gQ3JlYXRlIGNvbnRhaW5lciBmb3IgdWkKCiAgICB2YXIgdWlDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIHVpQ29udGFpbmVyLmNsYXNzTmFtZSA9ICdwbmxtLXVpJzsKICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZCh1aUNvbnRhaW5lcik7IC8vIENyZWF0ZSBjb250YWluZXIgZm9yIHJlbmRlcmVyCgogICAgdmFyIHJlbmRlckNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgcmVuZGVyQ29udGFpbmVyLmNsYXNzTmFtZSA9ICdwbmxtLXJlbmRlci1jb250YWluZXInOwogICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHJlbmRlckNvbnRhaW5lcik7CiAgICB2YXIgZHJhZ0ZpeCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgZHJhZ0ZpeC5jbGFzc05hbWUgPSAncG5sbS1kcmFnZml4JzsKICAgIHVpQ29udGFpbmVyLmFwcGVuZENoaWxkKGRyYWdGaXgpOyAvLyBEaXNwbGF5IGFib3V0IGluZm9ybWF0aW9uIG9uIHJpZ2h0IGNsaWNrCgogICAgdmFyIGFib3V0TXNnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOwogICAgYWJvdXRNc2cuY2xhc3NOYW1lID0gJ3BubG0tYWJvdXQtbXNnJzsKICAgIGFib3V0TXNnLmlubmVySFRNTCA9ICc8YSBocmVmPSJodHRwczovL3Bhbm5lbGx1bS5vcmcvIiB0YXJnZXQ9Il9ibGFuayI+UGFubmVsbHVtPC9hPic7CiAgICB1aUNvbnRhaW5lci5hcHBlbmRDaGlsZChhYm91dE1zZyk7CiAgICBkcmFnRml4LmFkZEV2ZW50TGlzdGVuZXIoJ2NvbnRleHRtZW51JywgYWJvdXRNZXNzYWdlKTsgLy8gQ3JlYXRlIGluZm8gZGlzcGxheQoKICAgIHZhciBpbmZvRGlzcGxheSA9IHt9OyAvLyBIb3Qgc3BvdCBkZWJ1ZyBpbmRpY2F0b3IKCiAgICB2YXIgaG90U3BvdERlYnVnSW5kaWNhdG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBob3RTcG90RGVidWdJbmRpY2F0b3IuY2xhc3NOYW1lID0gJ3BubG0tc3ByaXRlIHBubG0taG90LXNwb3QtZGVidWctaW5kaWNhdG9yJzsKICAgIHVpQ29udGFpbmVyLmFwcGVuZENoaWxkKGhvdFNwb3REZWJ1Z0luZGljYXRvcik7IC8vIFBhbm9yYW1hIGluZm8KCiAgICBpbmZvRGlzcGxheS5jb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGluZm9EaXNwbGF5LmNvbnRhaW5lci5jbGFzc05hbWUgPSAncG5sbS1wYW5vcmFtYS1pbmZvJzsKICAgIGluZm9EaXNwbGF5LnRpdGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBpbmZvRGlzcGxheS50aXRsZS5jbGFzc05hbWUgPSAncG5sbS10aXRsZS1ib3gnOwogICAgaW5mb0Rpc3BsYXkuY29udGFpbmVyLmFwcGVuZENoaWxkKGluZm9EaXNwbGF5LnRpdGxlKTsKICAgIGluZm9EaXNwbGF5LmF1dGhvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgaW5mb0Rpc3BsYXkuYXV0aG9yLmNsYXNzTmFtZSA9ICdwbmxtLWF1dGhvci1ib3gnOwogICAgaW5mb0Rpc3BsYXkuY29udGFpbmVyLmFwcGVuZENoaWxkKGluZm9EaXNwbGF5LmF1dGhvcik7CiAgICB1aUNvbnRhaW5lci5hcHBlbmRDaGlsZChpbmZvRGlzcGxheS5jb250YWluZXIpOyAvLyBMb2FkIGJveAoKICAgIGluZm9EaXNwbGF5LmxvYWQgPSB7fTsKICAgIGluZm9EaXNwbGF5LmxvYWQuYm94ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBpbmZvRGlzcGxheS5sb2FkLmJveC5jbGFzc05hbWUgPSAncG5sbS1sb2FkLWJveCc7CiAgICBpbmZvRGlzcGxheS5sb2FkLmJveHAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7CiAgICBpbmZvRGlzcGxheS5sb2FkLmJveC5hcHBlbmRDaGlsZChpbmZvRGlzcGxheS5sb2FkLmJveHApOwogICAgaW5mb0Rpc3BsYXkubG9hZC5sYm94ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBpbmZvRGlzcGxheS5sb2FkLmxib3guY2xhc3NOYW1lID0gJ3BubG0tbGJveCc7CiAgICBpbmZvRGlzcGxheS5sb2FkLmxib3guaW5uZXJIVE1MID0gJzxkaXYgY2xhc3M9InBubG0tbG9hZGluZyI+PC9kaXY+JzsKICAgIGluZm9EaXNwbGF5LmxvYWQuYm94LmFwcGVuZENoaWxkKGluZm9EaXNwbGF5LmxvYWQubGJveCk7CiAgICBpbmZvRGlzcGxheS5sb2FkLmxiYXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGluZm9EaXNwbGF5LmxvYWQubGJhci5jbGFzc05hbWUgPSAncG5sbS1sYmFyJzsKICAgIGluZm9EaXNwbGF5LmxvYWQubGJhckZpbGwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGluZm9EaXNwbGF5LmxvYWQubGJhckZpbGwuY2xhc3NOYW1lID0gJ3BubG0tbGJhci1maWxsJzsKICAgIGluZm9EaXNwbGF5LmxvYWQubGJhci5hcHBlbmRDaGlsZChpbmZvRGlzcGxheS5sb2FkLmxiYXJGaWxsKTsKICAgIGluZm9EaXNwbGF5LmxvYWQuYm94LmFwcGVuZENoaWxkKGluZm9EaXNwbGF5LmxvYWQubGJhcik7CiAgICBpbmZvRGlzcGxheS5sb2FkLm1zZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTsKICAgIGluZm9EaXNwbGF5LmxvYWQubXNnLmNsYXNzTmFtZSA9ICdwbmxtLWxtc2cnOwogICAgaW5mb0Rpc3BsYXkubG9hZC5ib3guYXBwZW5kQ2hpbGQoaW5mb0Rpc3BsYXkubG9hZC5tc2cpOwogICAgdWlDb250YWluZXIuYXBwZW5kQ2hpbGQoaW5mb0Rpc3BsYXkubG9hZC5ib3gpOyAvLyBFcnJvciBtZXNzYWdlCgogICAgaW5mb0Rpc3BsYXkuZXJyb3JNc2cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGluZm9EaXNwbGF5LmVycm9yTXNnLmNsYXNzTmFtZSA9ICdwbmxtLWVycm9yLW1zZyBwbmxtLWluZm8tYm94JzsKICAgIHVpQ29udGFpbmVyLmFwcGVuZENoaWxkKGluZm9EaXNwbGF5LmVycm9yTXNnKTsgLy8gQ3JlYXRlIGNvbnRyb2xzCgogICAgdmFyIGNvbnRyb2xzID0ge307CiAgICBjb250cm9scy5jb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGNvbnRyb2xzLmNvbnRhaW5lci5jbGFzc05hbWUgPSAncG5sbS1jb250cm9scy1jb250YWluZXInOwogICAgdWlDb250YWluZXIuYXBwZW5kQ2hpbGQoY29udHJvbHMuY29udGFpbmVyKTsgLy8gTG9hZCBidXR0b24KCiAgICBjb250cm9scy5sb2FkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBjb250cm9scy5sb2FkLmNsYXNzTmFtZSA9ICdwbmxtLWxvYWQtYnV0dG9uJzsKICAgIGNvbnRyb2xzLmxvYWQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgIHByb2Nlc3NPcHRpb25zKCk7CiAgICAgIGxvYWQoKTsKICAgIH0pOwogICAgdWlDb250YWluZXIuYXBwZW5kQ2hpbGQoY29udHJvbHMubG9hZCk7IC8vIFpvb20gY29udHJvbHMKCiAgICBjb250cm9scy56b29tID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBjb250cm9scy56b29tLmNsYXNzTmFtZSA9ICdwbmxtLXpvb20tY29udHJvbHMgcG5sbS1jb250cm9scyc7CiAgICBjb250cm9scy56b29tSW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGNvbnRyb2xzLnpvb21Jbi5jbGFzc05hbWUgPSAncG5sbS16b29tLWluIHBubG0tc3ByaXRlIHBubG0tY29udHJvbCc7CiAgICBjb250cm9scy56b29tSW4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB6b29tSW4pOwogICAgY29udHJvbHMuem9vbS5hcHBlbmRDaGlsZChjb250cm9scy56b29tSW4pOwogICAgY29udHJvbHMuem9vbU91dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgY29udHJvbHMuem9vbU91dC5jbGFzc05hbWUgPSAncG5sbS16b29tLW91dCBwbmxtLXNwcml0ZSBwbmxtLWNvbnRyb2wnOwogICAgY29udHJvbHMuem9vbU91dC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHpvb21PdXQpOwogICAgY29udHJvbHMuem9vbS5hcHBlbmRDaGlsZChjb250cm9scy56b29tT3V0KTsKICAgIGNvbnRyb2xzLmNvbnRhaW5lci5hcHBlbmRDaGlsZChjb250cm9scy56b29tKTsgLy8gRnVsbHNjcmVlbiB0b2dnbGUKCiAgICBjb250cm9scy5mdWxsc2NyZWVuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBjb250cm9scy5mdWxsc2NyZWVuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdG9nZ2xlRnVsbHNjcmVlbik7CiAgICBjb250cm9scy5mdWxsc2NyZWVuLmNsYXNzTmFtZSA9ICdwbmxtLWZ1bGxzY3JlZW4tdG9nZ2xlLWJ1dHRvbiBwbmxtLXNwcml0ZSBwbmxtLWZ1bGxzY3JlZW4tdG9nZ2xlLWJ1dHRvbi1pbmFjdGl2ZSBwbmxtLWNvbnRyb2xzIHBubG0tY29udHJvbCc7CiAgICBpZiAoZG9jdW1lbnQuZnVsbHNjcmVlbkVuYWJsZWQgfHwgZG9jdW1lbnQubW96RnVsbFNjcmVlbkVuYWJsZWQgfHwgZG9jdW1lbnQud2Via2l0RnVsbHNjcmVlbkVuYWJsZWQgfHwgZG9jdW1lbnQubXNGdWxsc2NyZWVuRW5hYmxlZCkgY29udHJvbHMuY29udGFpbmVyLmFwcGVuZENoaWxkKGNvbnRyb2xzLmZ1bGxzY3JlZW4pOyAvLyBEZXZpY2Ugb3JpZW50YXRpb24gdG9nZ2xlCgogICAgY29udHJvbHMub3JpZW50YXRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGNvbnRyb2xzLm9yaWVudGF0aW9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKGUpIHsKICAgICAgaWYgKG9yaWVudGF0aW9uKSBzdG9wT3JpZW50YXRpb24oKTtlbHNlIHN0YXJ0T3JpZW50YXRpb24oKTsKICAgIH0pOwogICAgY29udHJvbHMub3JpZW50YXRpb24uYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgZnVuY3Rpb24gKGUpIHsKICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH0pOwogICAgY29udHJvbHMub3JpZW50YXRpb24uYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGZ1bmN0aW9uIChlKSB7CiAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICB9KTsKICAgIGNvbnRyb2xzLm9yaWVudGF0aW9uLmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgZnVuY3Rpb24gKGUpIHsKICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH0pOwogICAgY29udHJvbHMub3JpZW50YXRpb24uY2xhc3NOYW1lID0gJ3BubG0tb3JpZW50YXRpb24tYnV0dG9uIHBubG0tb3JpZW50YXRpb24tYnV0dG9uLWluYWN0aXZlIHBubG0tc3ByaXRlIHBubG0tY29udHJvbHMgcG5sbS1jb250cm9sJzsKICAgIHZhciBvcmllbnRhdGlvblN1cHBvcnQgPSBmYWxzZTsKCiAgICBpZiAod2luZG93LkRldmljZU9yaWVudGF0aW9uRXZlbnQgJiYgbG9jYXRpb24ucHJvdG9jb2wgPT0gJ2h0dHBzOicgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJ21vYmknKSA+PSAwKSB7CiAgICAgIC8vIFRoaXMgdXNlciBhZ2VudCBjaGVjayBpcyBoZXJlIGJlY2F1c2UgdGhlcmUncyBubyB3YXkgdG8gY2hlY2sgaWYgYQogICAgICAvLyBkZXZpY2UgaGFzIGFuIGluZXJ0aWEgbWVhc3VyZW1lbnQgdW5pdC4gV2UgdXNlZCB0byBiZSBhYmxlIHRvIGNoZWNrIGlmIGEKICAgICAgLy8gRGV2aWNlT3JpZW50YXRpb25FdmVudCBoYWQgbm9uLW51bGwgdmFsdWVzLCBidXQgd2l0aCBpT1MgMTMgcmVxdWlyaW5nIGEKICAgICAgLy8gcGVybWlzc2lvbiBwcm9tcHQgdG8gYWNjZXNzIHN1Y2ggZXZlbnRzLCB0aGlzIGlzIG5vIGxvbmdlciBwb3NzaWJsZS4KICAgICAgY29udHJvbHMuY29udGFpbmVyLmFwcGVuZENoaWxkKGNvbnRyb2xzLm9yaWVudGF0aW9uKTsKICAgICAgb3JpZW50YXRpb25TdXBwb3J0ID0gdHJ1ZTsKICAgIH0gLy8gQ29tcGFzcwoKCiAgICB2YXIgY29tcGFzcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgY29tcGFzcy5jbGFzc05hbWUgPSAncG5sbS1jb21wYXNzIHBubG0tY29udHJvbHMgcG5sbS1jb250cm9sJzsKICAgIHVpQ29udGFpbmVyLmFwcGVuZENoaWxkKGNvbXBhc3MpOyAvLyBMb2FkIGFuZCBwcm9jZXNzIGNvbmZpZ3VyYXRpb24KCiAgICBpZiAoaW5pdGlhbENvbmZpZy5maXJzdFNjZW5lKSB7CiAgICAgIC8vIEFjdGl2YXRlIGZpcnN0IHNjZW5lIGlmIHNwZWNpZmllZCBpbiBVUkwKICAgICAgbWVyZ2VDb25maWcoaW5pdGlhbENvbmZpZy5maXJzdFNjZW5lKTsKICAgIH0gZWxzZSBpZiAoaW5pdGlhbENvbmZpZy5kZWZhdWx0ICYmIGluaXRpYWxDb25maWcuZGVmYXVsdC5maXJzdFNjZW5lKSB7CiAgICAgIC8vIEFjdGl2YXRlIGZpcnN0IHNjZW5lIGlmIHNwZWNpZmllZCBpbiBmaWxlCiAgICAgIG1lcmdlQ29uZmlnKGluaXRpYWxDb25maWcuZGVmYXVsdC5maXJzdFNjZW5lKTsKICAgIH0gZWxzZSB7CiAgICAgIG1lcmdlQ29uZmlnKG51bGwpOwogICAgfQoKICAgIHByb2Nlc3NPcHRpb25zKHRydWUpOwogICAgLyoqDQogICAgICogSW5pdGlhbGl6ZXMgdmlld2VyLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCgogICAgZnVuY3Rpb24gaW5pdCgpIHsKICAgICAgLy8gRGlzcGxheSBhbiBlcnJvciBmb3IgSUUgOSBhcyBpdCBkb2Vzbid0IHdvcmsgYnV0IGFsc28gZG9lc24ndCBvdGhlcndpc2UKICAgICAgLy8gc2hvdyBhbiBlcnJvciAob2xkZXIgdmVyc2lvbnMgZG9uJ3Qgd29yayBhdCBhbGwpCiAgICAgIC8vIEJhc2VkIG9uOiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8xMDk2NTIwMwogICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGRpdi5pbm5lckhUTUwgPSAiPCEtLVtpZiBsdGUgSUUgOV0+PGk+PC9pPjwhW2VuZGlmXS0tPiI7CgogICAgICBpZiAoZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJpIikubGVuZ3RoID09IDEpIHsKICAgICAgICBhbkVycm9yKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBvcmlnSGZvdiA9IGNvbmZpZy5oZm92OwogICAgICBvcmlnUGl0Y2ggPSBjb25maWcucGl0Y2g7CiAgICAgIHZhciBpLCBwOwoKICAgICAgaWYgKGNvbmZpZy50eXBlID09ICdjdWJlbWFwJykgewogICAgICAgIHBhbm9JbWFnZSA9IFtdOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgNjsgaSsrKSB7CiAgICAgICAgICBwYW5vSW1hZ2UucHVzaChuZXcgSW1hZ2UoKSk7CiAgICAgICAgICBwYW5vSW1hZ2VbaV0uY3Jvc3NPcmlnaW4gPSBjb25maWcuY3Jvc3NPcmlnaW47CiAgICAgICAgfQoKICAgICAgICBpbmZvRGlzcGxheS5sb2FkLmxib3guc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgaW5mb0Rpc3BsYXkubG9hZC5sYmFyLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgIH0gZWxzZSBpZiAoY29uZmlnLnR5cGUgPT0gJ211bHRpcmVzJykgewogICAgICAgIHZhciBjID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShjb25maWcubXVsdGlSZXMpKTsgLy8gRGVlcCBjb3B5CiAgICAgICAgLy8gQXZvaWQgInVuZGVmaW5lZCIgaW4gcGF0aCwgY2hlY2sgKG9wdGlvbmFsKSBtdWx0aVJlcy5iYXNlUGF0aCwgdG9vCiAgICAgICAgLy8gVXNlIG9ubHkgbXVsdGlSZXMuYmFzZVBhdGggaWYgaXQncyBhbiBhYnNvbHV0ZSBVUkwKCiAgICAgICAgaWYgKGNvbmZpZy5iYXNlUGF0aCAmJiBjb25maWcubXVsdGlSZXMuYmFzZVBhdGggJiYgIS9eKD86W2Etel0rOik/XC9cLy9pLnRlc3QoY29uZmlnLm11bHRpUmVzLmJhc2VQYXRoKSkgewogICAgICAgICAgYy5iYXNlUGF0aCA9IGNvbmZpZy5iYXNlUGF0aCArIGNvbmZpZy5tdWx0aVJlcy5iYXNlUGF0aDsKICAgICAgICB9IGVsc2UgaWYgKGNvbmZpZy5tdWx0aVJlcy5iYXNlUGF0aCkgewogICAgICAgICAgYy5iYXNlUGF0aCA9IGNvbmZpZy5tdWx0aVJlcy5iYXNlUGF0aDsKICAgICAgICB9IGVsc2UgaWYgKGNvbmZpZy5iYXNlUGF0aCkgewogICAgICAgICAgYy5iYXNlUGF0aCA9IGNvbmZpZy5iYXNlUGF0aDsKICAgICAgICB9CgogICAgICAgIHBhbm9JbWFnZSA9IGM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGNvbmZpZy5keW5hbWljID09PSB0cnVlKSB7CiAgICAgICAgICBwYW5vSW1hZ2UgPSBjb25maWcucGFub3JhbWE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChjb25maWcucGFub3JhbWEgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBhbkVycm9yKGNvbmZpZy5zdHJpbmdzLm5vUGFub3JhbWFFcnJvcik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBwYW5vSW1hZ2UgPSBuZXcgSW1hZ2UoKTsKICAgICAgICB9CiAgICAgIH0gLy8gQ29uZmlndXJlIGltYWdlIGxvYWRpbmcKCgogICAgICBpZiAoY29uZmlnLnR5cGUgPT0gJ2N1YmVtYXAnKSB7CiAgICAgICAgLy8gUXVpY2sgbG9hZGluZyBjb3VudGVyIGZvciBzeW5jaHJvbm91cyBsb2FkaW5nCiAgICAgICAgdmFyIGl0ZW1zVG9Mb2FkID0gNjsKCiAgICAgICAgdmFyIG9uTG9hZCA9IGZ1bmN0aW9uIG9uTG9hZCgpIHsKICAgICAgICAgIGl0ZW1zVG9Mb2FkLS07CgogICAgICAgICAgaWYgKGl0ZW1zVG9Mb2FkID09PSAwKSB7CiAgICAgICAgICAgIG9uSW1hZ2VMb2FkKCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdmFyIG9uRXJyb3IgPSBmdW5jdGlvbiBvbkVycm9yKGUpIHsKICAgICAgICAgIHZhciBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgYS5ocmVmID0gZS50YXJnZXQuc3JjOwogICAgICAgICAgYS50ZXh0Q29udGVudCA9IGEuaHJlZjsKICAgICAgICAgIGFuRXJyb3IoY29uZmlnLnN0cmluZ3MuZmlsZUFjY2Vzc0Vycm9yLnJlcGxhY2UoJyVzJywgYS5vdXRlckhUTUwpKTsKICAgICAgICB9OwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcGFub0ltYWdlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBwID0gY29uZmlnLmN1YmVNYXBbaV07CgogICAgICAgICAgaWYgKHAgPT0gIm51bGwiKSB7CiAgICAgICAgICAgIC8vIHN1cHBvcnQgcGFydGlhbCBjdWJlbWFwIGltYWdlIHdpdGggZXhwbGljaXRseSBlbXB0eSBmYWNlcwogICAgICAgICAgICBjb25zb2xlLmxvZygnV2lsbCB1c2UgYmFja2dyb3VuZCBpbnN0ZWFkIG9mIG1pc3NpbmcgY3ViZW1hcCBmYWNlICcgKyBpKTsKICAgICAgICAgICAgb25Mb2FkKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoY29uZmlnLmJhc2VQYXRoICYmICFhYnNvbHV0ZVVSTChwKSkgewogICAgICAgICAgICAgIHAgPSBjb25maWcuYmFzZVBhdGggKyBwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBwYW5vSW1hZ2VbaV0ub25sb2FkID0gb25Mb2FkOwogICAgICAgICAgICBwYW5vSW1hZ2VbaV0ub25lcnJvciA9IG9uRXJyb3I7CiAgICAgICAgICAgIHBhbm9JbWFnZVtpXS5zcmMgPSBzYW5pdGl6ZVVSTChwKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoY29uZmlnLnR5cGUgPT0gJ211bHRpcmVzJykgewogICAgICAgIG9uSW1hZ2VMb2FkKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcCA9ICcnOwoKICAgICAgICBpZiAoY29uZmlnLmJhc2VQYXRoKSB7CiAgICAgICAgICBwID0gY29uZmlnLmJhc2VQYXRoOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZy5keW5hbWljICE9PSB0cnVlKSB7CiAgICAgICAgICAvLyBTdGlsbCBpbWFnZQogICAgICAgICAgcCA9IGFic29sdXRlVVJMKGNvbmZpZy5wYW5vcmFtYSkgPyBjb25maWcucGFub3JhbWEgOiBwICsgY29uZmlnLnBhbm9yYW1hOwoKICAgICAgICAgIHBhbm9JbWFnZS5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHdpbmRvdy5VUkwucmV2b2tlT2JqZWN0VVJMKHRoaXMuc3JjKTsgLy8gQ2xlYW4gdXAKCiAgICAgICAgICAgIG9uSW1hZ2VMb2FkKCk7CiAgICAgICAgICB9OwoKICAgICAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCiAgICAgICAgICB4aHIub25sb2FkZW5kID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoeGhyLnN0YXR1cyAhPSAyMDApIHsKICAgICAgICAgICAgICAvLyBEaXNwbGF5IGVycm9yIGlmIGltYWdlIGNhbid0IGJlIGxvYWRlZAogICAgICAgICAgICAgIHZhciBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICAgIGEuaHJlZiA9IHA7CiAgICAgICAgICAgICAgYS50ZXh0Q29udGVudCA9IGEuaHJlZjsKICAgICAgICAgICAgICBhbkVycm9yKGNvbmZpZy5zdHJpbmdzLmZpbGVBY2Nlc3NFcnJvci5yZXBsYWNlKCclcycsIGEub3V0ZXJIVE1MKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBpbWcgPSB0aGlzLnJlc3BvbnNlOwogICAgICAgICAgICBwYXJzZUdQYW5vWE1QKGltZyk7CiAgICAgICAgICAgIGluZm9EaXNwbGF5LmxvYWQubXNnLmlubmVySFRNTCA9ICcnOwogICAgICAgICAgfTsKCiAgICAgICAgICB4aHIub25wcm9ncmVzcyA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIGlmIChlLmxlbmd0aENvbXB1dGFibGUpIHsKICAgICAgICAgICAgICAvLyBEaXNwbGF5IHByb2dyZXNzCiAgICAgICAgICAgICAgdmFyIHBlcmNlbnQgPSBlLmxvYWRlZCAvIGUudG90YWwgKiAxMDA7CiAgICAgICAgICAgICAgaW5mb0Rpc3BsYXkubG9hZC5sYmFyRmlsbC5zdHlsZS53aWR0aCA9IHBlcmNlbnQgKyAnJSc7CiAgICAgICAgICAgICAgdmFyIHVuaXQsIG51bWVyYXRvciwgZGVub21pbmF0b3I7CgogICAgICAgICAgICAgIGlmIChlLnRvdGFsID4gMWU2KSB7CiAgICAgICAgICAgICAgICB1bml0ID0gJ01CJzsKICAgICAgICAgICAgICAgIG51bWVyYXRvciA9IChlLmxvYWRlZCAvIDFlNikudG9GaXhlZCgyKTsKICAgICAgICAgICAgICAgIGRlbm9taW5hdG9yID0gKGUudG90YWwgLyAxZTYpLnRvRml4ZWQoMik7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChlLnRvdGFsID4gMWUzKSB7CiAgICAgICAgICAgICAgICB1bml0ID0gJ2tCJzsKICAgICAgICAgICAgICAgIG51bWVyYXRvciA9IChlLmxvYWRlZCAvIDFlMykudG9GaXhlZCgxKTsKICAgICAgICAgICAgICAgIGRlbm9taW5hdG9yID0gKGUudG90YWwgLyAxZTMpLnRvRml4ZWQoMSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVuaXQgPSAnQic7CiAgICAgICAgICAgICAgICBudW1lcmF0b3IgPSBlLmxvYWRlZDsKICAgICAgICAgICAgICAgIGRlbm9taW5hdG9yID0gZS50b3RhbDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGluZm9EaXNwbGF5LmxvYWQubXNnLmlubmVySFRNTCA9IG51bWVyYXRvciArICcgLyAnICsgZGVub21pbmF0b3IgKyAnICcgKyB1bml0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIERpc3BsYXkgbG9hZGluZyBzcGlubmVyCiAgICAgICAgICAgICAgaW5mb0Rpc3BsYXkubG9hZC5sYm94LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgIGluZm9EaXNwbGF5LmxvYWQubGJhci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHhoci5vcGVuKCdHRVQnLCBwLCB0cnVlKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgLy8gTWFsZm9ybWVkIFVSTAogICAgICAgICAgICBhbkVycm9yKGNvbmZpZy5zdHJpbmdzLm1hbGZvcm1lZFVSTEVycm9yKTsKICAgICAgICAgIH0KCiAgICAgICAgICB4aHIucmVzcG9uc2VUeXBlID0gJ2Jsb2InOwogICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0FjY2VwdCcsICdpbWFnZS8qLCovKjtxPTAuOScpOwogICAgICAgICAgeGhyLndpdGhDcmVkZW50aWFscyA9IGNvbmZpZy5jcm9zc09yaWdpbiA9PT0gJ3VzZS1jcmVkZW50aWFscyc7CiAgICAgICAgICB4aHIuc2VuZCgpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGNvbmZpZy5kcmFnZ2FibGUpIHVpQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoJ3BubG0tZ3JhYicpOwogICAgICB1aUNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdwbmxtLWdyYWJiaW5nJyk7IC8vIFByb3Blcmx5IGhhbmRsZSBzd2l0Y2hpbmcgdG8gZHluYW1pYyBzY2VuZXMKCiAgICAgIHVwZGF0ZSA9IGNvbmZpZy5keW5hbWljVXBkYXRlID09PSB0cnVlOwoKICAgICAgaWYgKGNvbmZpZy5keW5hbWljICYmIHVwZGF0ZSkgewogICAgICAgIHBhbm9JbWFnZSA9IGNvbmZpZy5wYW5vcmFtYTsKICAgICAgICBvbkltYWdlTG9hZCgpOwogICAgICB9CiAgICB9CiAgICAvKioNCiAgICAgKiBUZXN0IGlmIFVSTCBpcyBhYnNvbHV0ZSBvciByZWxhdGl2ZS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgdG8gdGVzdA0KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGFic29sdXRlLCBlbHNlIGZhbHNlDQogICAgICovCgoKICAgIGZ1bmN0aW9uIGFic29sdXRlVVJMKHVybCkgewogICAgICAvLyBGcm9tIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzE5NzA5ODQ2CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeKD86W2Etel0rOik/Ly8nLCAnaScpLnRlc3QodXJsKSB8fCB1cmxbMF0gPT0gJy8nIHx8IHVybC5zbGljZSgwLCA1KSA9PSAnYmxvYjonOwogICAgfQogICAgLyoqDQogICAgICogQ3JlYXRlIHJlbmRlcmVyIGFuZCBpbml0aWFsaXplIGV2ZW50IGxpc3RlbmVycyBvbmNlIGltYWdlIGlzIGxvYWRlZC4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBvbkltYWdlTG9hZCgpIHsKICAgICAgaWYgKCFyZW5kZXJlcikgcmVuZGVyZXIgPSBuZXcgbGlicGFubmVsbHVtLnJlbmRlcmVyKHJlbmRlckNvbnRhaW5lcik7IC8vIE9ubHkgYWRkIGV2ZW50IGxpc3RlbmVycyBvbmNlCgogICAgICBpZiAoIWxpc3RlbmVyc0FkZGVkKSB7CiAgICAgICAgbGlzdGVuZXJzQWRkZWQgPSB0cnVlOwogICAgICAgIGRyYWdGaXguYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgb25Eb2N1bWVudE1vdXNlRG93biwgZmFsc2UpOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIG9uRG9jdW1lbnRNb3VzZU1vdmUsIGZhbHNlKTsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgb25Eb2N1bWVudE1vdXNlVXAsIGZhbHNlKTsKCiAgICAgICAgaWYgKGNvbmZpZy5tb3VzZVpvb20pIHsKICAgICAgICAgIHVpQ29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNld2hlZWwnLCBvbkRvY3VtZW50TW91c2VXaGVlbCwgZmFsc2UpOwogICAgICAgICAgdWlDb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignRE9NTW91c2VTY3JvbGwnLCBvbkRvY3VtZW50TW91c2VXaGVlbCwgZmFsc2UpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZy5kb3VibGVDbGlja1pvb20pIHsKICAgICAgICAgIGRyYWdGaXguYWRkRXZlbnRMaXN0ZW5lcignZGJsY2xpY2snLCBvbkRvY3VtZW50RG91YmxlQ2xpY2ssIGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdtb3pmdWxsc2NyZWVuY2hhbmdlJywgb25GdWxsU2NyZWVuQ2hhbmdlLCBmYWxzZSk7CiAgICAgICAgY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmtpdGZ1bGxzY3JlZW5jaGFuZ2UnLCBvbkZ1bGxTY3JlZW5DaGFuZ2UsIGZhbHNlKTsKICAgICAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignbXNmdWxsc2NyZWVuY2hhbmdlJywgb25GdWxsU2NyZWVuQ2hhbmdlLCBmYWxzZSk7CiAgICAgICAgY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoJ2Z1bGxzY3JlZW5jaGFuZ2UnLCBvbkZ1bGxTY3JlZW5DaGFuZ2UsIGZhbHNlKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgb25Eb2N1bWVudFJlc2l6ZSwgZmFsc2UpOwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvcmllbnRhdGlvbmNoYW5nZScsIG9uRG9jdW1lbnRSZXNpemUsIGZhbHNlKTsKCiAgICAgICAgaWYgKCFjb25maWcuZGlzYWJsZUtleWJvYXJkQ3RybCkgewogICAgICAgICAgY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBvbkRvY3VtZW50S2V5UHJlc3MsIGZhbHNlKTsKICAgICAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIG9uRG9jdW1lbnRLZXlVcCwgZmFsc2UpOwogICAgICAgICAgY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoJ2JsdXInLCBjbGVhcktleXMsIGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBvbkRvY3VtZW50TW91c2VVcCwgZmFsc2UpOwoKICAgICAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlLnBvaW50ZXJBY3Rpb24gPT09ICcnICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS50b3VjaEFjdGlvbiA9PT0gJycpIHsKICAgICAgICAgIGRyYWdGaXguYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcmRvd24nLCBvbkRvY3VtZW50UG9pbnRlckRvd24sIGZhbHNlKTsKICAgICAgICAgIGRyYWdGaXguYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcm1vdmUnLCBvbkRvY3VtZW50UG9pbnRlck1vdmUsIGZhbHNlKTsKICAgICAgICAgIGRyYWdGaXguYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcnVwJywgb25Eb2N1bWVudFBvaW50ZXJVcCwgZmFsc2UpOwogICAgICAgICAgZHJhZ0ZpeC5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVybGVhdmUnLCBvbkRvY3VtZW50UG9pbnRlclVwLCBmYWxzZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRyYWdGaXguYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIG9uRG9jdW1lbnRUb3VjaFN0YXJ0LCBmYWxzZSk7CiAgICAgICAgICBkcmFnRml4LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIG9uRG9jdW1lbnRUb3VjaE1vdmUsIGZhbHNlKTsKICAgICAgICAgIGRyYWdGaXguYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBvbkRvY3VtZW50VG91Y2hFbmQsIGZhbHNlKTsKICAgICAgICB9IC8vIERlYWwgd2l0aCBNUyBwb2ludGVyIGV2ZW50cwoKCiAgICAgICAgaWYgKHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQpIGNvbnRhaW5lci5zdHlsZS50b3VjaEFjdGlvbiA9ICdub25lJzsKICAgICAgfQoKICAgICAgcmVuZGVySW5pdCgpOwogICAgICBzZXRIZm92KGNvbmZpZy5oZm92KTsgLy8gcG9zc2libHkgYWRhcHQgaGZvdiBhZnRlciBjb25maWd1cmF0aW9uIGFuZCBjYW52YXMgaXMgY29tcGxldGU7IHByZXZlbnRzIGVtcHR5IHNwYWNlIG9uIHRvcCBvciBib3R0b20gYnkgem9tbWluZyBvdXQgdG9vIG11Y2gKCiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIGlzVGltZWRPdXQgPSB0cnVlOwogICAgICB9LCA1MDApOwogICAgfQogICAgLyoqDQogICAgICogUGFyc2VzIEdvb2dsZSBQaG90byBTcGhlcmUgWE1QIE1ldGFkYXRhLg0KICAgICAqIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL3Bob3RvLXNwaGVyZS9tZXRhZGF0YS8NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7SW1hZ2V9IGltYWdlIC0gSW1hZ2UgdG8gcmVhZCBYTVAgbWV0YWRhdGEgZnJvbS4NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gcGFyc2VHUGFub1hNUChpbWFnZSkgewogICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgICAgcmVhZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWRlbmQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGltZyA9IHJlYWRlci5yZXN1bHQ7IC8vIFRoaXMgYXdmdWwgYnJvd3NlciBzcGVjaWZpYyB0ZXN0IGV4aXN0cyBiZWNhdXNlIGlPUyA4IGRvZXMgbm90IHdvcmsKICAgICAgICAvLyB3aXRoIG5vbi1wcm9ncmVzc2l2ZSBlbmNvZGVkIEpQRUdzLgoKICAgICAgICBpZiAobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLm1hdGNoKC8oaXBob25lfGlwb2R8aXBhZCkuKiBvcyA4Xy8pKSB7CiAgICAgICAgICB2YXIgZmxhZ0luZGV4ID0gaW1nLmluZGV4T2YoJ1x4ZmZceGMyJyk7CiAgICAgICAgICBpZiAoZmxhZ0luZGV4IDwgMCB8fCBmbGFnSW5kZXggPiA2NTUzNikgYW5FcnJvcihjb25maWcuc3RyaW5ncy5pT1M4V2ViR0xFcnJvcik7CiAgICAgICAgfQoKICAgICAgICB2YXIgc3RhcnQgPSBpbWcuaW5kZXhPZignPHg6eG1wbWV0YScpOwoKICAgICAgICBpZiAoc3RhcnQgPiAtMSAmJiBjb25maWcuaWdub3JlR1Bhbm9YTVAgIT09IHRydWUpIHsKICAgICAgICAgIHZhciB4bXBEYXRhID0gaW1nLnN1YnN0cmluZyhzdGFydCwgaW1nLmluZGV4T2YoJzwveDp4bXBtZXRhPicpICsgMTIpOyAvLyBFeHRyYWN0IHRoZSByZXF1ZXN0ZWQgdGFnIGZyb20gdGhlIFhNUCBkYXRhCgogICAgICAgICAgdmFyIGdldFRhZyA9IGZ1bmN0aW9uIGdldFRhZyh0YWcpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdDsKCiAgICAgICAgICAgIGlmICh4bXBEYXRhLmluZGV4T2YodGFnICsgJz0iJykgPj0gMCkgewogICAgICAgICAgICAgIHJlc3VsdCA9IHhtcERhdGEuc3Vic3RyaW5nKHhtcERhdGEuaW5kZXhPZih0YWcgKyAnPSInKSArIHRhZy5sZW5ndGggKyAyKTsKICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuc3Vic3RyaW5nKDAsIHJlc3VsdC5pbmRleE9mKCciJykpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHhtcERhdGEuaW5kZXhPZih0YWcgKyAnPicpID49IDApIHsKICAgICAgICAgICAgICByZXN1bHQgPSB4bXBEYXRhLnN1YnN0cmluZyh4bXBEYXRhLmluZGV4T2YodGFnICsgJz4nKSArIHRhZy5sZW5ndGggKyAxKTsKICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuc3Vic3RyaW5nKDAsIHJlc3VsdC5pbmRleE9mKCc8JykpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gTnVtYmVyKHJlc3VsdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfTsgLy8gUmVsZXZhbnQgWE1QIGRhdGEKCgogICAgICAgICAgdmFyIHhtcCA9IHsKICAgICAgICAgICAgZnVsbFdpZHRoOiBnZXRUYWcoJ0dQYW5vOkZ1bGxQYW5vV2lkdGhQaXhlbHMnKSwKICAgICAgICAgICAgY3JvcHBlZFdpZHRoOiBnZXRUYWcoJ0dQYW5vOkNyb3BwZWRBcmVhSW1hZ2VXaWR0aFBpeGVscycpLAogICAgICAgICAgICBmdWxsSGVpZ2h0OiBnZXRUYWcoJ0dQYW5vOkZ1bGxQYW5vSGVpZ2h0UGl4ZWxzJyksCiAgICAgICAgICAgIGNyb3BwZWRIZWlnaHQ6IGdldFRhZygnR1Bhbm86Q3JvcHBlZEFyZWFJbWFnZUhlaWdodFBpeGVscycpLAogICAgICAgICAgICB0b3BQaXhlbHM6IGdldFRhZygnR1Bhbm86Q3JvcHBlZEFyZWFUb3BQaXhlbHMnKSwKICAgICAgICAgICAgaGVhZGluZzogZ2V0VGFnKCdHUGFubzpQb3NlSGVhZGluZ0RlZ3JlZXMnKSwKICAgICAgICAgICAgaG9yaXpvblBpdGNoOiBnZXRUYWcoJ0dQYW5vOlBvc2VQaXRjaERlZ3JlZXMnKSwKICAgICAgICAgICAgaG9yaXpvblJvbGw6IGdldFRhZygnR1Bhbm86UG9zZVJvbGxEZWdyZWVzJykKICAgICAgICAgIH07CgogICAgICAgICAgaWYgKHhtcC5mdWxsV2lkdGggIT09IG51bGwgJiYgeG1wLmNyb3BwZWRXaWR0aCAhPT0gbnVsbCAmJiB4bXAuZnVsbEhlaWdodCAhPT0gbnVsbCAmJiB4bXAuY3JvcHBlZEhlaWdodCAhPT0gbnVsbCAmJiB4bXAudG9wUGl4ZWxzICE9PSBudWxsKSB7CiAgICAgICAgICAgIC8vIFNldCB1cCB2aWV3ZXIgdXNpbmcgR1Bhbm8gWE1QIGRhdGEKICAgICAgICAgICAgaWYgKHNwZWNpZmllZFBob3RvU3BoZXJlRXhjbHVkZXMuaW5kZXhPZignaGFvdicpIDwgMCkgY29uZmlnLmhhb3YgPSB4bXAuY3JvcHBlZFdpZHRoIC8geG1wLmZ1bGxXaWR0aCAqIDM2MDsKICAgICAgICAgICAgaWYgKHNwZWNpZmllZFBob3RvU3BoZXJlRXhjbHVkZXMuaW5kZXhPZigndmFvdicpIDwgMCkgY29uZmlnLnZhb3YgPSB4bXAuY3JvcHBlZEhlaWdodCAvIHhtcC5mdWxsSGVpZ2h0ICogMTgwOwogICAgICAgICAgICBpZiAoc3BlY2lmaWVkUGhvdG9TcGhlcmVFeGNsdWRlcy5pbmRleE9mKCd2T2Zmc2V0JykgPCAwKSBjb25maWcudk9mZnNldCA9ICgoeG1wLnRvcFBpeGVscyArIHhtcC5jcm9wcGVkSGVpZ2h0IC8gMikgLyB4bXAuZnVsbEhlaWdodCAtIDAuNSkgKiAtMTgwOwoKICAgICAgICAgICAgaWYgKHhtcC5oZWFkaW5nICE9PSBudWxsICYmIHNwZWNpZmllZFBob3RvU3BoZXJlRXhjbHVkZXMuaW5kZXhPZignbm9ydGhPZmZzZXQnKSA8IDApIHsKICAgICAgICAgICAgICAvLyBUT0RPOiBtYWtlIHN1cmUgdGhpcyB3b3JrcyBjb3JyZWN0bHkgZm9yIHBhcnRpYWwgcGFub3JhbWFzCiAgICAgICAgICAgICAgY29uZmlnLm5vcnRoT2Zmc2V0ID0geG1wLmhlYWRpbmc7CgogICAgICAgICAgICAgIGlmIChjb25maWcuY29tcGFzcyAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5jb21wYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh4bXAuaG9yaXpvblBpdGNoICE9PSBudWxsICYmIHhtcC5ob3Jpem9uUm9sbCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChzcGVjaWZpZWRQaG90b1NwaGVyZUV4Y2x1ZGVzLmluZGV4T2YoJ2hvcml6b25QaXRjaCcpIDwgMCkgY29uZmlnLmhvcml6b25QaXRjaCA9IHhtcC5ob3Jpem9uUGl0Y2g7CiAgICAgICAgICAgICAgaWYgKHNwZWNpZmllZFBob3RvU3BoZXJlRXhjbHVkZXMuaW5kZXhPZignaG9yaXpvblJvbGwnKSA8IDApIGNvbmZpZy5ob3Jpem9uUm9sbCA9IHhtcC5ob3Jpem9uUm9sbDsKICAgICAgICAgICAgfSAvLyBUT0RPOiBhZGQgc3VwcG9ydCBmb3IgaW5pdGlhbCB2aWV3IHNldHRpbmdzCgogICAgICAgICAgfQogICAgICAgIH0gLy8gTG9hZCBwYW5vcmFtYQoKCiAgICAgICAgcGFub0ltYWdlLnNyYyA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGltYWdlKTsKICAgICAgfSk7CiAgICAgIGlmIChyZWFkZXIucmVhZEFzQmluYXJ5U3RyaW5nICE9PSB1bmRlZmluZWQpIHJlYWRlci5yZWFkQXNCaW5hcnlTdHJpbmcoaW1hZ2UpO2Vsc2UgcmVhZGVyLnJlYWRBc1RleHQoaW1hZ2UpOwogICAgfQogICAgLyoqDQogICAgICogRGlzcGxheXMgYW4gZXJyb3IgbWVzc2FnZS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBlcnJvck1zZyAtIEVycm9yIG1lc3NhZ2UgdG8gZGlzcGxheS4gSWYgbm90IHNwZWNpZmllZCwgYQ0KICAgICAqICAgICAgZ2VuZXJpYyBXZWJHTCBlcnJvciBpcyBkaXNwbGF5ZWQuDQogICAgICovCgoKICAgIGZ1bmN0aW9uIGFuRXJyb3IoZXJyb3JNc2cpIHsKICAgICAgaWYgKGVycm9yTXNnID09PSB1bmRlZmluZWQpIGVycm9yTXNnID0gY29uZmlnLnN0cmluZ3MuZ2VuZXJpY1dlYkdMRXJyb3I7CiAgICAgIGluZm9EaXNwbGF5LmVycm9yTXNnLmlubmVySFRNTCA9ICc8cD4nICsgZXJyb3JNc2cgKyAnPC9wPic7CiAgICAgIGNvbnRyb2xzLmxvYWQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgaW5mb0Rpc3BsYXkubG9hZC5ib3guc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgaW5mb0Rpc3BsYXkuZXJyb3JNc2cuc3R5bGUuZGlzcGxheSA9ICd0YWJsZSc7CiAgICAgIGVycm9yID0gdHJ1ZTsKICAgICAgbG9hZGVkID0gdW5kZWZpbmVkOwogICAgICByZW5kZXJDb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgZmlyZUV2ZW50KCdlcnJvcicsIGVycm9yTXNnKTsKICAgIH0KICAgIC8qKg0KICAgICAqIEhpZGVzIGVycm9yIG1lc3NhZ2UgZGlzcGxheS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBjbGVhckVycm9yKCkgewogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICBpbmZvRGlzcGxheS5sb2FkLmJveC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIGluZm9EaXNwbGF5LmVycm9yTXNnLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgZXJyb3IgPSBmYWxzZTsKICAgICAgICByZW5kZXJDb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgZmlyZUV2ZW50KCdlcnJvcmNsZWFyZWQnKTsKICAgICAgfQogICAgfQogICAgLyoqDQogICAgICogRGlzcGxheXMgYWJvdXQgbWVzc2FnZS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7TW91c2VFdmVudH0gZXZlbnQgLSBSaWdodCBjbGljayBsb2NhdGlvbg0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBhYm91dE1lc3NhZ2UoZXZlbnQpIHsKICAgICAgdmFyIHBvcyA9IG1vdXNlUG9zaXRpb24oZXZlbnQpOwogICAgICBhYm91dE1zZy5zdHlsZS5sZWZ0ID0gcG9zLnggKyAncHgnOwogICAgICBhYm91dE1zZy5zdHlsZS50b3AgPSBwb3MueSArICdweCc7CiAgICAgIGNsZWFyVGltZW91dChhYm91dE1lc3NhZ2UudDEpOwogICAgICBjbGVhclRpbWVvdXQoYWJvdXRNZXNzYWdlLnQyKTsKICAgICAgYWJvdXRNc2cuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgIGFib3V0TXNnLnN0eWxlLm9wYWNpdHkgPSAxOwogICAgICBhYm91dE1lc3NhZ2UudDEgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICBhYm91dE1zZy5zdHlsZS5vcGFjaXR5ID0gMDsKICAgICAgfSwgMjAwMCk7CiAgICAgIGFib3V0TWVzc2FnZS50MiA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgIGFib3V0TXNnLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgIH0sIDI1MDApOwogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgfQogICAgLyoqDQogICAgICogQ2FsY3VsYXRlIG1vdXNlIHBvc2l0aW9uIHJlbGF0aXZlIHRvIHRvcCBsZWZ0IG9mIHZpZXdlciBjb250YWluZXIuDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge01vdXNlRXZlbnR9IGV2ZW50IC0gTW91c2UgZXZlbnQgdG8gdXNlIGluIGNhbGN1bGF0aW9uDQogICAgICogQHJldHVybnMge09iamVjdH0gQ2FsY3VsYXRlZCBYIGFuZCBZIGNvb3JkaW5hdGVzDQogICAgICovCgoKICAgIGZ1bmN0aW9uIG1vdXNlUG9zaXRpb24oZXZlbnQpIHsKICAgICAgdmFyIGJvdW5kcyA9IGNvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgdmFyIHBvcyA9IHt9OyAvLyBwYWdlWCAvIHBhZ2VZIG5lZWRlZCBmb3IgaU9TCgogICAgICBwb3MueCA9IChldmVudC5jbGllbnRYIHx8IGV2ZW50LnBhZ2VYKSAtIGJvdW5kcy5sZWZ0OwogICAgICBwb3MueSA9IChldmVudC5jbGllbnRZIHx8IGV2ZW50LnBhZ2VZKSAtIGJvdW5kcy50b3A7CiAgICAgIHJldHVybiBwb3M7CiAgICB9CiAgICAvKioNCiAgICAgKiBFdmVudCBoYW5kbGVyIGZvciBtb3VzZSBjbGlja3MuIEluaXRpYWxpemVzIHBhbm5pbmcuIFByaW50cyBjZW50ZXIgYW5kIGNsaWNrDQogICAgICogbG9jYXRpb24gY29vcmRpbmF0ZXMgd2hlbiBob3Qgc3BvdCBkZWJ1Z2dpbmcgaXMgZW5hYmxlZC4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7TW91c2VFdmVudH0gZXZlbnQgLSBEb2N1bWVudCBtb3VzZSBkb3duIGV2ZW50Lg0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBvbkRvY3VtZW50TW91c2VEb3duKGV2ZW50KSB7CiAgICAgIC8vIE92ZXJyaWRlIGRlZmF1bHQgYWN0aW9uCiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7IC8vIEJ1dCBub3QgYWxsIG9mIGl0CgogICAgICBjb250YWluZXIuZm9jdXMoKTsgLy8gT25seSBkbyBzb21ldGhpbmcgaWYgdGhlIHBhbm9yYW1hIGlzIGxvYWRlZAoKICAgICAgaWYgKCFsb2FkZWQgfHwgIWNvbmZpZy5kcmFnZ2FibGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gQ2FsY3VsYXRlIG1vdXNlIHBvc2l0aW9uIHJlbGF0aXZlIHRvIHRvcCBsZWZ0IG9mIHZpZXdlciBjb250YWluZXIKCgogICAgICB2YXIgcG9zID0gbW91c2VQb3NpdGlvbihldmVudCk7IC8vIExvZyBwaXRjaCAvIHlhdyBvZiBtb3VzZSBjbGljayB3aGVuIGRlYnVnZ2luZyAvIHBsYWNpbmcgaG90IHNwb3RzCgogICAgICBpZiAoY29uZmlnLmhvdFNwb3REZWJ1ZykgewogICAgICAgIHZhciBjb29yZHMgPSBtb3VzZUV2ZW50VG9Db29yZHMoZXZlbnQpOwogICAgICAgIGNvbnNvbGUubG9nKCdQaXRjaDogJyArIGNvb3Jkc1swXSArICcsIFlhdzogJyArIGNvb3Jkc1sxXSArICcsIENlbnRlciBQaXRjaDogJyArIGNvbmZpZy5waXRjaCArICcsIENlbnRlciBZYXc6ICcgKyBjb25maWcueWF3ICsgJywgSEZPVjogJyArIGNvbmZpZy5oZm92KTsKICAgICAgfSAvLyBUdXJuIG9mZiBhdXRvLXJvdGF0aW9uIGlmIGVuYWJsZWQKCgogICAgICBzdG9wQW5pbWF0aW9uKCk7CiAgICAgIHN0b3BPcmllbnRhdGlvbigpOwogICAgICBjb25maWcucm9sbCA9IDA7CiAgICAgIHNwZWVkLmhmb3YgPSAwOwogICAgICBpc1VzZXJJbnRlcmFjdGluZyA9IHRydWU7CiAgICAgIGxhdGVzdEludGVyYWN0aW9uID0gRGF0ZS5ub3coKTsKICAgICAgb25Qb2ludGVyRG93blBvaW50ZXJYID0gcG9zLng7CiAgICAgIG9uUG9pbnRlckRvd25Qb2ludGVyWSA9IHBvcy55OwogICAgICBvblBvaW50ZXJEb3duWWF3ID0gY29uZmlnLnlhdzsKICAgICAgb25Qb2ludGVyRG93blBpdGNoID0gY29uZmlnLnBpdGNoOwogICAgICB1aUNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdwbmxtLWdyYWJiaW5nJyk7CiAgICAgIHVpQ29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoJ3BubG0tZ3JhYicpOwogICAgICBmaXJlRXZlbnQoJ21vdXNlZG93bicsIGV2ZW50KTsKICAgICAgYW5pbWF0ZUluaXQoKTsKICAgIH0KICAgIC8qKg0KICAgICAqIEV2ZW50IGhhbmRsZXIgZm9yIGRvdWJsZSBjbGlja3MuIFpvb21zIGluIGF0IGNsaWNrZWQgbG9jYXRpb24NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7TW91c2VFdmVudH0gZXZlbnQgLSBEb2N1bWVudCBtb3VzZSBkb3duIGV2ZW50Lg0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBvbkRvY3VtZW50RG91YmxlQ2xpY2soZXZlbnQpIHsKICAgICAgaWYgKGNvbmZpZy5taW5IZm92ID09PSBjb25maWcuaGZvdikgewogICAgICAgIF90aGlzLnNldEhmb3Yob3JpZ0hmb3YsIDEwMDApOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBjb29yZHMgPSBtb3VzZUV2ZW50VG9Db29yZHMoZXZlbnQpOwoKICAgICAgICBfdGhpcy5sb29rQXQoY29vcmRzWzBdLCBjb29yZHNbMV0sIGNvbmZpZy5taW5IZm92LCAxMDAwKTsKICAgICAgfQogICAgfQogICAgLyoqDQogICAgICogQ2FsY3VsYXRlIHBhbm9yYW1hIHBpdGNoIGFuZCB5YXcgZnJvbSBsb2NhdGlvbiBvZiBtb3VzZSBldmVudC4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7TW91c2VFdmVudH0gZXZlbnQgLSBEb2N1bWVudCBtb3VzZSBkb3duIGV2ZW50Lg0KICAgICAqIEByZXR1cm5zIHtudW1iZXJbXX0gW3BpdGNoLCB5YXddDQogICAgICovCgoKICAgIGZ1bmN0aW9uIG1vdXNlRXZlbnRUb0Nvb3JkcyhldmVudCkgewogICAgICB2YXIgcG9zID0gbW91c2VQb3NpdGlvbihldmVudCk7CiAgICAgIHZhciBjYW52YXMgPSByZW5kZXJlci5nZXRDYW52YXMoKTsKICAgICAgdmFyIGNhbnZhc1dpZHRoID0gY2FudmFzLmNsaWVudFdpZHRoLAogICAgICAgICAgY2FudmFzSGVpZ2h0ID0gY2FudmFzLmNsaWVudEhlaWdodDsKICAgICAgdmFyIHggPSBwb3MueCAvIGNhbnZhc1dpZHRoICogMiAtIDE7CiAgICAgIHZhciB5ID0gKDEgLSBwb3MueSAvIGNhbnZhc0hlaWdodCAqIDIpICogY2FudmFzSGVpZ2h0IC8gY2FudmFzV2lkdGg7CiAgICAgIHZhciBmb2NhbCA9IDEgLyBNYXRoLnRhbihjb25maWcuaGZvdiAqIE1hdGguUEkgLyAzNjApOwogICAgICB2YXIgcyA9IE1hdGguc2luKGNvbmZpZy5waXRjaCAqIE1hdGguUEkgLyAxODApOwogICAgICB2YXIgYyA9IE1hdGguY29zKGNvbmZpZy5waXRjaCAqIE1hdGguUEkgLyAxODApOwogICAgICB2YXIgYSA9IGZvY2FsICogYyAtIHkgKiBzOwogICAgICB2YXIgcm9vdCA9IE1hdGguc3FydCh4ICogeCArIGEgKiBhKTsKICAgICAgdmFyIHBpdGNoID0gTWF0aC5hdGFuKCh5ICogYyArIGZvY2FsICogcykgLyByb290KSAqIDE4MCAvIE1hdGguUEk7CiAgICAgIHZhciB5YXcgPSBNYXRoLmF0YW4yKHggLyByb290LCBhIC8gcm9vdCkgKiAxODAgLyBNYXRoLlBJICsgY29uZmlnLnlhdzsKICAgICAgaWYgKHlhdyA8IC0xODApIHlhdyArPSAzNjA7CiAgICAgIGlmICh5YXcgPiAxODApIHlhdyAtPSAzNjA7CiAgICAgIHJldHVybiBbcGl0Y2gsIHlhd107CiAgICB9CiAgICAvKioNCiAgICAgKiBFdmVudCBoYW5kbGVyIGZvciBtb3VzZSBtb3Zlcy4gUGFucyBjZW50ZXIgb2Ygdmlldy4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7TW91c2VFdmVudH0gZXZlbnQgLSBEb2N1bWVudCBtb3VzZSBtb3ZlIGV2ZW50Lg0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBvbkRvY3VtZW50TW91c2VNb3ZlKGV2ZW50KSB7CiAgICAgIGlmIChpc1VzZXJJbnRlcmFjdGluZyAmJiBsb2FkZWQpIHsKICAgICAgICBsYXRlc3RJbnRlcmFjdGlvbiA9IERhdGUubm93KCk7CiAgICAgICAgdmFyIGNhbnZhcyA9IHJlbmRlcmVyLmdldENhbnZhcygpOwogICAgICAgIHZhciBjYW52YXNXaWR0aCA9IGNhbnZhcy5jbGllbnRXaWR0aCwKICAgICAgICAgICAgY2FudmFzSGVpZ2h0ID0gY2FudmFzLmNsaWVudEhlaWdodDsKICAgICAgICB2YXIgcG9zID0gbW91c2VQb3NpdGlvbihldmVudCk7IC8vVE9ETzogVGhpcyBzdGlsbCBpc24ndCBxdWl0ZSByaWdodAoKICAgICAgICB2YXIgeWF3ID0gKE1hdGguYXRhbihvblBvaW50ZXJEb3duUG9pbnRlclggLyBjYW52YXNXaWR0aCAqIDIgLSAxKSAtIE1hdGguYXRhbihwb3MueCAvIGNhbnZhc1dpZHRoICogMiAtIDEpKSAqIDE4MCAvIE1hdGguUEkgKiBjb25maWcuaGZvdiAvIDkwICsgb25Qb2ludGVyRG93bllhdzsKICAgICAgICBzcGVlZC55YXcgPSAoeWF3IC0gY29uZmlnLnlhdykgJSAzNjAgKiAwLjI7CiAgICAgICAgY29uZmlnLnlhdyA9IHlhdzsKICAgICAgICB2YXIgdmZvdiA9IDIgKiBNYXRoLmF0YW4oTWF0aC50YW4oY29uZmlnLmhmb3YgLyAzNjAgKiBNYXRoLlBJKSAqIGNhbnZhc0hlaWdodCAvIGNhbnZhc1dpZHRoKSAqIDE4MCAvIE1hdGguUEk7CiAgICAgICAgdmFyIHBpdGNoID0gKE1hdGguYXRhbihwb3MueSAvIGNhbnZhc0hlaWdodCAqIDIgLSAxKSAtIE1hdGguYXRhbihvblBvaW50ZXJEb3duUG9pbnRlclkgLyBjYW52YXNIZWlnaHQgKiAyIC0gMSkpICogMTgwIC8gTWF0aC5QSSAqIHZmb3YgLyA5MCArIG9uUG9pbnRlckRvd25QaXRjaDsKICAgICAgICBzcGVlZC5waXRjaCA9IChwaXRjaCAtIGNvbmZpZy5waXRjaCkgKiAwLjI7CiAgICAgICAgY29uZmlnLnBpdGNoID0gcGl0Y2g7CiAgICAgIH0KICAgIH0KICAgIC8qKg0KICAgICAqIEV2ZW50IGhhbmRsZXIgZm9yIG1vdXNlIHVwIGV2ZW50cy4gU3RvcHMgcGFubmluZy4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBvbkRvY3VtZW50TW91c2VVcChldmVudCkgewogICAgICBpZiAoIWlzVXNlckludGVyYWN0aW5nKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpc1VzZXJJbnRlcmFjdGluZyA9IGZhbHNlOwoKICAgICAgaWYgKERhdGUubm93KCkgLSBsYXRlc3RJbnRlcmFjdGlvbiA+IDE1KSB7CiAgICAgICAgLy8gUHJldmVudHMganVtcCB3aGVuIHVzZXIgcmFwaWRseSBtb3ZlcyBtb3VzZSwgc3RvcHMsIGFuZCB0aGVuCiAgICAgICAgLy8gcmVsZWFzZXMgdGhlIG1vdXNlIGJ1dHRvbgogICAgICAgIHNwZWVkLnBpdGNoID0gc3BlZWQueWF3ID0gMDsKICAgICAgfQoKICAgICAgdWlDb250YWluZXIuY2xhc3NMaXN0LmFkZCgncG5sbS1ncmFiJyk7CiAgICAgIHVpQ29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoJ3BubG0tZ3JhYmJpbmcnKTsKICAgICAgbGF0ZXN0SW50ZXJhY3Rpb24gPSBEYXRlLm5vdygpOwogICAgICBmaXJlRXZlbnQoJ21vdXNldXAnLCBldmVudCk7CiAgICB9CiAgICAvKioNCiAgICAgKiBFdmVudCBoYW5kbGVyIGZvciB0b3VjaGVzLiBJbml0aWFsaXplcyBwYW5uaW5nIGlmIG9uZSB0b3VjaCBvciB6b29taW5nIGlmDQogICAgICogdHdvIHRvdWNoZXMuDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge1RvdWNoRXZlbnR9IGV2ZW50IC0gRG9jdW1lbnQgdG91Y2ggc3RhcnQgZXZlbnQuDQogICAgICovCgoKICAgIGZ1bmN0aW9uIG9uRG9jdW1lbnRUb3VjaFN0YXJ0KGV2ZW50KSB7CiAgICAgIC8vIE9ubHkgZG8gc29tZXRoaW5nIGlmIHRoZSBwYW5vcmFtYSBpcyBsb2FkZWQKICAgICAgaWYgKCFsb2FkZWQgfHwgIWNvbmZpZy5kcmFnZ2FibGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gVHVybiBvZmYgYXV0by1yb3RhdGlvbiBpZiBlbmFibGVkCgoKICAgICAgc3RvcEFuaW1hdGlvbigpOwogICAgICBzdG9wT3JpZW50YXRpb24oKTsKICAgICAgY29uZmlnLnJvbGwgPSAwOwogICAgICBzcGVlZC5oZm92ID0gMDsgLy8gQ2FsY3VsYXRlIHRvdWNoIHBvc2l0aW9uIHJlbGF0aXZlIHRvIHRvcCBsZWZ0IG9mIHZpZXdlciBjb250YWluZXIKCiAgICAgIHZhciBwb3MwID0gbW91c2VQb3NpdGlvbihldmVudC50YXJnZXRUb3VjaGVzWzBdKTsKICAgICAgb25Qb2ludGVyRG93blBvaW50ZXJYID0gcG9zMC54OwogICAgICBvblBvaW50ZXJEb3duUG9pbnRlclkgPSBwb3MwLnk7CgogICAgICBpZiAoZXZlbnQudGFyZ2V0VG91Y2hlcy5sZW5ndGggPT0gMikgewogICAgICAgIC8vIERvd24gcG9pbnRlciBpcyB0aGUgY2VudGVyIG9mIHRoZSB0d28gZmluZ2VycwogICAgICAgIHZhciBwb3MxID0gbW91c2VQb3NpdGlvbihldmVudC50YXJnZXRUb3VjaGVzWzFdKTsKICAgICAgICBvblBvaW50ZXJEb3duUG9pbnRlclggKz0gKHBvczEueCAtIHBvczAueCkgKiAwLjU7CiAgICAgICAgb25Qb2ludGVyRG93blBvaW50ZXJZICs9IChwb3MxLnkgLSBwb3MwLnkpICogMC41OwogICAgICAgIG9uUG9pbnRlckRvd25Qb2ludGVyRGlzdCA9IE1hdGguc3FydCgocG9zMC54IC0gcG9zMS54KSAqIChwb3MwLnggLSBwb3MxLngpICsgKHBvczAueSAtIHBvczEueSkgKiAocG9zMC55IC0gcG9zMS55KSk7CiAgICAgIH0KCiAgICAgIGlzVXNlckludGVyYWN0aW5nID0gdHJ1ZTsKICAgICAgbGF0ZXN0SW50ZXJhY3Rpb24gPSBEYXRlLm5vdygpOwogICAgICBvblBvaW50ZXJEb3duWWF3ID0gY29uZmlnLnlhdzsKICAgICAgb25Qb2ludGVyRG93blBpdGNoID0gY29uZmlnLnBpdGNoOwogICAgICBmaXJlRXZlbnQoJ3RvdWNoc3RhcnQnLCBldmVudCk7CiAgICAgIGFuaW1hdGVJbml0KCk7CiAgICB9CiAgICAvKioNCiAgICAgKiBFdmVudCBoYW5kbGVyIGZvciB0b3VjaCBtb3ZlbWVudHMuIFBhbnMgY2VudGVyIG9mIHZpZXcgaWYgb25lIHRvdWNoIG9yDQogICAgICogYWRqdXN0cyB6b29tIGlmIHR3byB0b3VjaGVzLg0KICAgICAqIEBwcml2YXRlDQogICAgICogQHBhcmFtIHtUb3VjaEV2ZW50fSBldmVudCAtIERvY3VtZW50IHRvdWNoIG1vdmUgZXZlbnQuDQogICAgICovCgoKICAgIGZ1bmN0aW9uIG9uRG9jdW1lbnRUb3VjaE1vdmUoZXZlbnQpIHsKICAgICAgaWYgKCFjb25maWcuZHJhZ2dhYmxlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIE92ZXJyaWRlIGRlZmF1bHQgYWN0aW9uCgoKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICAgIGlmIChsb2FkZWQpIHsKICAgICAgICBsYXRlc3RJbnRlcmFjdGlvbiA9IERhdGUubm93KCk7CiAgICAgIH0KCiAgICAgIGlmIChpc1VzZXJJbnRlcmFjdGluZyAmJiBsb2FkZWQpIHsKICAgICAgICB2YXIgcG9zMCA9IG1vdXNlUG9zaXRpb24oZXZlbnQudGFyZ2V0VG91Y2hlc1swXSk7CiAgICAgICAgdmFyIGNsaWVudFggPSBwb3MwLng7CiAgICAgICAgdmFyIGNsaWVudFkgPSBwb3MwLnk7CgogICAgICAgIGlmIChldmVudC50YXJnZXRUb3VjaGVzLmxlbmd0aCA9PSAyICYmIG9uUG9pbnRlckRvd25Qb2ludGVyRGlzdCAhPSAtMSkgewogICAgICAgICAgdmFyIHBvczEgPSBtb3VzZVBvc2l0aW9uKGV2ZW50LnRhcmdldFRvdWNoZXNbMV0pOwogICAgICAgICAgY2xpZW50WCArPSAocG9zMS54IC0gcG9zMC54KSAqIDAuNTsKICAgICAgICAgIGNsaWVudFkgKz0gKHBvczEueSAtIHBvczAueSkgKiAwLjU7CiAgICAgICAgICB2YXIgY2xpZW50RGlzdCA9IE1hdGguc3FydCgocG9zMC54IC0gcG9zMS54KSAqIChwb3MwLnggLSBwb3MxLngpICsgKHBvczAueSAtIHBvczEueSkgKiAocG9zMC55IC0gcG9zMS55KSk7CiAgICAgICAgICBzZXRIZm92KGNvbmZpZy5oZm92ICsgKG9uUG9pbnRlckRvd25Qb2ludGVyRGlzdCAtIGNsaWVudERpc3QpICogMC4xKTsKICAgICAgICAgIG9uUG9pbnRlckRvd25Qb2ludGVyRGlzdCA9IGNsaWVudERpc3Q7CiAgICAgICAgfSAvLyBUaGUgc21hbGxlciB0aGUgY29uZmlnLmhmb3YgdmFsdWUgKHRoZSBtb3JlIHpvb21lZC1pbiB0aGUgdXNlciBpcyksIHRoZSBmYXN0ZXIKICAgICAgICAvLyB5YXcvcGl0Y2ggYXJlIHBlcmNlaXZlZCB0byBjaGFuZ2Ugb24gb25lLWZpbmdlciB0b3VjaG1vdmUgKHBhbm5pbmcpIGV2ZW50cyBhbmQgdmljZSB2ZXJzYS4KICAgICAgICAvLyBUbyBpbXByb3ZlIHVzYWJpbGl0eSBhdCBib3RoIHNtYWxsIGFuZCBsYXJnZSB6b29tIGxldmVscyAoY29uZmlnLmhmb3YgdmFsdWVzKQogICAgICAgIC8vIHdlIGludHJvZHVjZSBhIGR5bmFtaWMgcGFuIHNwZWVkIGNvZWZmaWNpZW50LgogICAgICAgIC8vCiAgICAgICAgLy8gQ3VycmVudGx5IHRoaXMgc2VlbXMgdG8gKnJvdWdobHkqIGtlZXAgaW5pdGlhbCBkcmFnL3BhbiBzdGFydCBwb3NpdGlvbiBjbG9zZSB0bwogICAgICAgIC8vIHRoZSB1c2VyJ3MgZmluZ2VyIHdoaWxlIHBhbm5pbmcgcmVnYXJkbGVzcyBvZiB6b29tIGxldmVsIC8gY29uZmlnLmhmb3YgdmFsdWUuCgoKICAgICAgICB2YXIgdG91Y2htb3ZlUGFuU3BlZWRDb2VmZiA9IGNvbmZpZy5oZm92IC8gMzYwICogY29uZmlnLnRvdWNoUGFuU3BlZWRDb2VmZkZhY3RvcjsKICAgICAgICB2YXIgeWF3ID0gKG9uUG9pbnRlckRvd25Qb2ludGVyWCAtIGNsaWVudFgpICogdG91Y2htb3ZlUGFuU3BlZWRDb2VmZiArIG9uUG9pbnRlckRvd25ZYXc7CiAgICAgICAgc3BlZWQueWF3ID0gKHlhdyAtIGNvbmZpZy55YXcpICUgMzYwICogMC4yOwogICAgICAgIGNvbmZpZy55YXcgPSB5YXc7CiAgICAgICAgdmFyIHBpdGNoID0gKGNsaWVudFkgLSBvblBvaW50ZXJEb3duUG9pbnRlclkpICogdG91Y2htb3ZlUGFuU3BlZWRDb2VmZiArIG9uUG9pbnRlckRvd25QaXRjaDsKICAgICAgICBzcGVlZC5waXRjaCA9IChwaXRjaCAtIGNvbmZpZy5waXRjaCkgKiAwLjI7CiAgICAgICAgY29uZmlnLnBpdGNoID0gcGl0Y2g7CiAgICAgIH0KICAgIH0KICAgIC8qKg0KICAgICAqIEV2ZW50IGhhbmRsZXIgZm9yIGVuZCBvZiB0b3VjaGVzLiBTdG9wcyBwYW5uaW5nIGFuZC9vciB6b29taW5nLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCgoKICAgIGZ1bmN0aW9uIG9uRG9jdW1lbnRUb3VjaEVuZCgpIHsKICAgICAgaXNVc2VySW50ZXJhY3RpbmcgPSBmYWxzZTsKCiAgICAgIGlmIChEYXRlLm5vdygpIC0gbGF0ZXN0SW50ZXJhY3Rpb24gPiAxNTApIHsKICAgICAgICBzcGVlZC5waXRjaCA9IHNwZWVkLnlhdyA9IDA7CiAgICAgIH0KCiAgICAgIG9uUG9pbnRlckRvd25Qb2ludGVyRGlzdCA9IC0xOwogICAgICBsYXRlc3RJbnRlcmFjdGlvbiA9IERhdGUubm93KCk7CiAgICAgIGZpcmVFdmVudCgndG91Y2hlbmQnLCBldmVudCk7CiAgICB9CgogICAgdmFyIHBvaW50ZXJJRHMgPSBbXSwKICAgICAgICBwb2ludGVyQ29vcmRpbmF0ZXMgPSBbXTsKICAgIC8qKg0KICAgICAqIEV2ZW50IGhhbmRsZXIgZm9yIHRvdWNoIHN0YXJ0cyBpbiBJRSAvIEVkZ2UuDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge1BvaW50ZXJFdmVudH0gZXZlbnQgLSBEb2N1bWVudCBwb2ludGVyIGRvd24gZXZlbnQuDQogICAgICovCgogICAgZnVuY3Rpb24gb25Eb2N1bWVudFBvaW50ZXJEb3duKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5wb2ludGVyVHlwZSA9PSAndG91Y2gnKSB7CiAgICAgICAgLy8gT25seSBkbyBzb21ldGhpbmcgaWYgdGhlIHBhbm9yYW1hIGlzIGxvYWRlZAogICAgICAgIGlmICghbG9hZGVkIHx8ICFjb25maWcuZHJhZ2dhYmxlKSByZXR1cm47CiAgICAgICAgcG9pbnRlcklEcy5wdXNoKGV2ZW50LnBvaW50ZXJJZCk7CiAgICAgICAgcG9pbnRlckNvb3JkaW5hdGVzLnB1c2goewogICAgICAgICAgY2xpZW50WDogZXZlbnQuY2xpZW50WCwKICAgICAgICAgIGNsaWVudFk6IGV2ZW50LmNsaWVudFkKICAgICAgICB9KTsKICAgICAgICBldmVudC50YXJnZXRUb3VjaGVzID0gcG9pbnRlckNvb3JkaW5hdGVzOwogICAgICAgIG9uRG9jdW1lbnRUb3VjaFN0YXJ0KGV2ZW50KTsKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICB9CiAgICAvKioNCiAgICAgKiBFdmVudCBoYW5kbGVyIGZvciB0b3VjaCBtb3ZlcyBpbiBJRSAvIEVkZ2UuDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge1BvaW50ZXJFdmVudH0gZXZlbnQgLSBEb2N1bWVudCBwb2ludGVyIG1vdmUgZXZlbnQuDQogICAgICovCgoKICAgIGZ1bmN0aW9uIG9uRG9jdW1lbnRQb2ludGVyTW92ZShldmVudCkgewogICAgICBpZiAoZXZlbnQucG9pbnRlclR5cGUgPT0gJ3RvdWNoJykgewogICAgICAgIGlmICghY29uZmlnLmRyYWdnYWJsZSkgcmV0dXJuOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBvaW50ZXJJRHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChldmVudC5wb2ludGVySWQgPT0gcG9pbnRlcklEc1tpXSkgewogICAgICAgICAgICBwb2ludGVyQ29vcmRpbmF0ZXNbaV0uY2xpZW50WCA9IGV2ZW50LmNsaWVudFg7CiAgICAgICAgICAgIHBvaW50ZXJDb29yZGluYXRlc1tpXS5jbGllbnRZID0gZXZlbnQuY2xpZW50WTsKICAgICAgICAgICAgZXZlbnQudGFyZ2V0VG91Y2hlcyA9IHBvaW50ZXJDb29yZGluYXRlczsKICAgICAgICAgICAgb25Eb2N1bWVudFRvdWNoTW92ZShldmVudCk7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKg0KICAgICAqIEV2ZW50IGhhbmRsZXIgZm9yIHRvdWNoIGVuZHMgaW4gSUUgLyBFZGdlLg0KICAgICAqIEBwcml2YXRlDQogICAgICogQHBhcmFtIHtQb2ludGVyRXZlbnR9IGV2ZW50IC0gRG9jdW1lbnQgcG9pbnRlciB1cCBldmVudC4NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gb25Eb2N1bWVudFBvaW50ZXJVcChldmVudCkgewogICAgICBpZiAoZXZlbnQucG9pbnRlclR5cGUgPT0gJ3RvdWNoJykgewogICAgICAgIHZhciBkZWZpbmVkID0gZmFsc2U7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcG9pbnRlcklEcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGV2ZW50LnBvaW50ZXJJZCA9PSBwb2ludGVySURzW2ldKSBwb2ludGVySURzW2ldID0gdW5kZWZpbmVkOwogICAgICAgICAgaWYgKHBvaW50ZXJJRHNbaV0pIGRlZmluZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFkZWZpbmVkKSB7CiAgICAgICAgICBwb2ludGVySURzID0gW107CiAgICAgICAgICBwb2ludGVyQ29vcmRpbmF0ZXMgPSBbXTsKICAgICAgICAgIG9uRG9jdW1lbnRUb3VjaEVuZCgpOwogICAgICAgIH0KCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgfQogICAgfQogICAgLyoqDQogICAgICogRXZlbnQgaGFuZGxlciBmb3IgbW91c2Ugd2hlZWwuIENoYW5nZXMgem9vbS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7V2hlZWxFdmVudH0gZXZlbnQgLSBEb2N1bWVudCBtb3VzZSB3aGVlbCBldmVudC4NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gb25Eb2N1bWVudE1vdXNlV2hlZWwoZXZlbnQpIHsKICAgICAgLy8gT25seSBkbyBzb21ldGhpbmcgaWYgdGhlIHBhbm9yYW1hIGlzIGxvYWRlZCBhbmQgbW91c2Ugd2hlZWwgem9vbSBpcyBlbmFibGVkCiAgICAgIGlmICghbG9hZGVkIHx8IGNvbmZpZy5tb3VzZVpvb20gPT0gJ2Z1bGxzY3JlZW5vbmx5JyAmJiAhZnVsbHNjcmVlbkFjdGl2ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsgLy8gVHVybiBvZmYgYXV0by1yb3RhdGlvbiBpZiBlbmFibGVkCgogICAgICBzdG9wQW5pbWF0aW9uKCk7CiAgICAgIGxhdGVzdEludGVyYWN0aW9uID0gRGF0ZS5ub3coKTsKCiAgICAgIGlmIChldmVudC53aGVlbERlbHRhWSkgewogICAgICAgIC8vIFdlYktpdAogICAgICAgIHNldEhmb3YoY29uZmlnLmhmb3YgLSBldmVudC53aGVlbERlbHRhWSAqIDAuMDUpOwogICAgICAgIHNwZWVkLmhmb3YgPSBldmVudC53aGVlbERlbHRhIDwgMCA/IDEgOiAtMTsKICAgICAgfSBlbHNlIGlmIChldmVudC53aGVlbERlbHRhKSB7CiAgICAgICAgLy8gT3BlcmEgLyBFeHBsb3JlciA5CiAgICAgICAgc2V0SGZvdihjb25maWcuaGZvdiAtIGV2ZW50LndoZWVsRGVsdGEgKiAwLjA1KTsKICAgICAgICBzcGVlZC5oZm92ID0gZXZlbnQud2hlZWxEZWx0YSA8IDAgPyAxIDogLTE7CiAgICAgIH0gZWxzZSBpZiAoZXZlbnQuZGV0YWlsKSB7CiAgICAgICAgLy8gRmlyZWZveAogICAgICAgIHNldEhmb3YoY29uZmlnLmhmb3YgKyBldmVudC5kZXRhaWwgKiAxLjUpOwogICAgICAgIHNwZWVkLmhmb3YgPSBldmVudC5kZXRhaWwgPiAwID8gMSA6IC0xOwogICAgICB9CgogICAgICBhbmltYXRlSW5pdCgpOwogICAgfQogICAgLyoqDQogICAgICogRXZlbnQgaGFuZGxlciBmb3Iga2V5IHByZXNzZXMuIFVwZGF0ZXMgbGlzdCBvZiBjdXJyZW50bHkgcHJlc3NlZCBrZXlzLg0KICAgICAqIEBwcml2YXRlDQogICAgICogQHBhcmFtIHtLZXlib2FyZEV2ZW50fSBldmVudCAtIERvY3VtZW50IGtleSBwcmVzcyBldmVudC4NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gb25Eb2N1bWVudEtleVByZXNzKGV2ZW50KSB7CiAgICAgIC8vIFR1cm4gb2ZmIGF1dG8tcm90YXRpb24gaWYgZW5hYmxlZAogICAgICBzdG9wQW5pbWF0aW9uKCk7CiAgICAgIGxhdGVzdEludGVyYWN0aW9uID0gRGF0ZS5ub3coKTsKICAgICAgc3RvcE9yaWVudGF0aW9uKCk7CiAgICAgIGNvbmZpZy5yb2xsID0gMDsgLy8gUmVjb3JkIGtleSBwcmVzc2VkCgogICAgICB2YXIga2V5bnVtYmVyID0gZXZlbnQud2hpY2ggfHwgZXZlbnQua2V5Y29kZTsgLy8gT3ZlcnJpZGUgZGVmYXVsdCBhY3Rpb24gZm9yIGtleXMgdGhhdCBhcmUgdXNlZAoKICAgICAgaWYgKGNvbmZpZy5jYXB0dXJlZEtleU51bWJlcnMuaW5kZXhPZihrZXludW1iZXIpIDwgMCkgcmV0dXJuOwogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOyAvLyBJZiBlc2NhcGUga2V5IGlzIHByZXNzZWQKCiAgICAgIGlmIChrZXludW1iZXIgPT0gMjcpIHsKICAgICAgICAvLyBJZiBpbiBmdWxsc2NyZWVuIG1vZGUKICAgICAgICBpZiAoZnVsbHNjcmVlbkFjdGl2ZSkgewogICAgICAgICAgdG9nZ2xlRnVsbHNjcmVlbigpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBDaGFuZ2Uga2V5CiAgICAgICAgY2hhbmdlS2V5KGtleW51bWJlciwgdHJ1ZSk7CiAgICAgIH0KICAgIH0KICAgIC8qKg0KICAgICAqIENsZWFycyBsaXN0IG9mIGN1cnJlbnRseSBwcmVzc2VkIGtleXMuDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KCgogICAgZnVuY3Rpb24gY2xlYXJLZXlzKCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDEwOyBpKyspIHsKICAgICAgICBrZXlzRG93bltpXSA9IGZhbHNlOwogICAgICB9CiAgICB9CiAgICAvKioNCiAgICAgKiBFdmVudCBoYW5kbGVyIGZvciBrZXkgcmVsZWFzZXMuIFVwZGF0ZXMgbGlzdCBvZiBjdXJyZW50bHkgcHJlc3NlZCBrZXlzLg0KICAgICAqIEBwcml2YXRlDQogICAgICogQHBhcmFtIHtLZXlib2FyZEV2ZW50fSBldmVudCAtIERvY3VtZW50IGtleSB1cCBldmVudC4NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gb25Eb2N1bWVudEtleVVwKGV2ZW50KSB7CiAgICAgIC8vIFJlY29yZCBrZXkgcHJlc3NlZAogICAgICB2YXIga2V5bnVtYmVyID0gZXZlbnQud2hpY2ggfHwgZXZlbnQua2V5Y29kZTsgLy8gT3ZlcnJpZGUgZGVmYXVsdCBhY3Rpb24gZm9yIGtleXMgdGhhdCBhcmUgdXNlZAoKICAgICAgaWYgKGNvbmZpZy5jYXB0dXJlZEtleU51bWJlcnMuaW5kZXhPZihrZXludW1iZXIpIDwgMCkgcmV0dXJuOwogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOyAvLyBDaGFuZ2Uga2V5CgogICAgICBjaGFuZ2VLZXkoa2V5bnVtYmVyLCBmYWxzZSk7CiAgICB9CiAgICAvKioNCiAgICAgKiBVcGRhdGVzIGxpc3Qgb2YgY3VycmVudGx5IHByZXNzZWQga2V5cy4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBrZXludW1iZXIgLSBLZXkgbnVtYmVyLg0KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gdmFsdWUgLSBXaGV0aGVyIG9yIG5vdCBrZXkgaXMgcHJlc3NlZC4NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gY2hhbmdlS2V5KGtleW51bWJlciwgdmFsdWUpIHsKICAgICAgdmFyIGtleUNoYW5nZWQgPSBmYWxzZTsKCiAgICAgIHN3aXRjaCAoa2V5bnVtYmVyKSB7CiAgICAgICAgLy8gSWYgbWludXMga2V5IGlzIHJlbGVhc2VkCiAgICAgICAgY2FzZSAxMDk6CiAgICAgICAgY2FzZSAxODk6CiAgICAgICAgY2FzZSAxNzoKICAgICAgICBjYXNlIDE3MzoKICAgICAgICAgIGlmIChrZXlzRG93blswXSAhPSB2YWx1ZSkgewogICAgICAgICAgICBrZXlDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBrZXlzRG93blswXSA9IHZhbHVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gSWYgcGx1cyBrZXkgaXMgcmVsZWFzZWQKCiAgICAgICAgY2FzZSAxMDc6CiAgICAgICAgY2FzZSAxODc6CiAgICAgICAgY2FzZSAxNjoKICAgICAgICBjYXNlIDYxOgogICAgICAgICAgaWYgKGtleXNEb3duWzFdICE9IHZhbHVlKSB7CiAgICAgICAgICAgIGtleUNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGtleXNEb3duWzFdID0gdmFsdWU7CiAgICAgICAgICBicmVhazsKICAgICAgICAvLyBJZiB1cCBhcnJvdyBpcyByZWxlYXNlZAoKICAgICAgICBjYXNlIDM4OgogICAgICAgICAgaWYgKGtleXNEb3duWzJdICE9IHZhbHVlKSB7CiAgICAgICAgICAgIGtleUNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGtleXNEb3duWzJdID0gdmFsdWU7CiAgICAgICAgICBicmVhazsKICAgICAgICAvLyBJZiAidyIgaXMgcmVsZWFzZWQKCiAgICAgICAgY2FzZSA4NzoKICAgICAgICAgIGlmIChrZXlzRG93bls2XSAhPSB2YWx1ZSkgewogICAgICAgICAgICBrZXlDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBrZXlzRG93bls2XSA9IHZhbHVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gSWYgZG93biBhcnJvdyBpcyByZWxlYXNlZAoKICAgICAgICBjYXNlIDQwOgogICAgICAgICAgaWYgKGtleXNEb3duWzNdICE9IHZhbHVlKSB7CiAgICAgICAgICAgIGtleUNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGtleXNEb3duWzNdID0gdmFsdWU7CiAgICAgICAgICBicmVhazsKICAgICAgICAvLyBJZiAicyIgaXMgcmVsZWFzZWQKCiAgICAgICAgY2FzZSA4MzoKICAgICAgICAgIGlmIChrZXlzRG93bls3XSAhPSB2YWx1ZSkgewogICAgICAgICAgICBrZXlDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBrZXlzRG93bls3XSA9IHZhbHVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gSWYgbGVmdCBhcnJvdyBpcyByZWxlYXNlZAoKICAgICAgICBjYXNlIDM3OgogICAgICAgICAgaWYgKGtleXNEb3duWzRdICE9IHZhbHVlKSB7CiAgICAgICAgICAgIGtleUNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGtleXNEb3duWzRdID0gdmFsdWU7CiAgICAgICAgICBicmVhazsKICAgICAgICAvLyBJZiAiYSIgaXMgcmVsZWFzZWQKCiAgICAgICAgY2FzZSA2NToKICAgICAgICAgIGlmIChrZXlzRG93bls4XSAhPSB2YWx1ZSkgewogICAgICAgICAgICBrZXlDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBrZXlzRG93bls4XSA9IHZhbHVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gSWYgcmlnaHQgYXJyb3cgaXMgcmVsZWFzZWQKCiAgICAgICAgY2FzZSAzOToKICAgICAgICAgIGlmIChrZXlzRG93bls1XSAhPSB2YWx1ZSkgewogICAgICAgICAgICBrZXlDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBrZXlzRG93bls1XSA9IHZhbHVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgLy8gSWYgImQiIGlzIHJlbGVhc2VkCgogICAgICAgIGNhc2UgNjg6CiAgICAgICAgICBpZiAoa2V5c0Rvd25bOV0gIT0gdmFsdWUpIHsKICAgICAgICAgICAga2V5Q2hhbmdlZCA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAga2V5c0Rvd25bOV0gPSB2YWx1ZTsKICAgICAgfQoKICAgICAgaWYgKGtleUNoYW5nZWQgJiYgdmFsdWUpIHsKICAgICAgICBpZiAodHlwZW9mIHBlcmZvcm1hbmNlICE9PSAndW5kZWZpbmVkJyAmJiBwZXJmb3JtYW5jZS5ub3coKSkgewogICAgICAgICAgcHJldlRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcHJldlRpbWUgPSBEYXRlLm5vdygpOwogICAgICAgIH0KCiAgICAgICAgYW5pbWF0ZUluaXQoKTsKICAgICAgfQogICAgfQogICAgLyoqDQogICAgICogUGFucyBhbmQvb3Igem9vbXMgcGFub3JhbWEgYmFzZWQgb24gY3VycmVudGx5IHByZXNzZWQga2V5cy4gQWxzbyBoYW5kbGVzDQogICAgICogcGFub3JhbWEgImluZXJ0aWEiIGFuZCBhdXRvIHJvdGF0aW9uLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCgoKICAgIGZ1bmN0aW9uIGtleVJlcGVhdCgpIHsKICAgICAgLy8gT25seSBkbyBzb21ldGhpbmcgaWYgdGhlIHBhbm9yYW1hIGlzIGxvYWRlZAogICAgICBpZiAoIWxvYWRlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGlzS2V5RG93biA9IGZhbHNlOwogICAgICB2YXIgcHJldlBpdGNoID0gY29uZmlnLnBpdGNoOwogICAgICB2YXIgcHJldllhdyA9IGNvbmZpZy55YXc7CiAgICAgIHZhciBwcmV2Wm9vbSA9IGNvbmZpZy5oZm92OwogICAgICB2YXIgbmV3VGltZTsKCiAgICAgIGlmICh0eXBlb2YgcGVyZm9ybWFuY2UgIT09ICd1bmRlZmluZWQnICYmIHBlcmZvcm1hbmNlLm5vdygpKSB7CiAgICAgICAgbmV3VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICB9IGVsc2UgewogICAgICAgIG5ld1RpbWUgPSBEYXRlLm5vdygpOwogICAgICB9CgogICAgICBpZiAocHJldlRpbWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHByZXZUaW1lID0gbmV3VGltZTsKICAgICAgfQoKICAgICAgdmFyIGRpZmYgPSAobmV3VGltZSAtIHByZXZUaW1lKSAqIGNvbmZpZy5oZm92IC8gMTcwMDsKICAgICAgZGlmZiA9IE1hdGgubWluKGRpZmYsIDEuMCk7IC8vIElmIG1pbnVzIGtleSBpcyBkb3duCgogICAgICBpZiAoa2V5c0Rvd25bMF0gJiYgY29uZmlnLmtleWJvYXJkWm9vbSA9PT0gdHJ1ZSkgewogICAgICAgIHNldEhmb3YoY29uZmlnLmhmb3YgKyAoc3BlZWQuaGZvdiAqIDAuOCArIDAuNSkgKiBkaWZmKTsKICAgICAgICBpc0tleURvd24gPSB0cnVlOwogICAgICB9IC8vIElmIHBsdXMga2V5IGlzIGRvd24KCgogICAgICBpZiAoa2V5c0Rvd25bMV0gJiYgY29uZmlnLmtleWJvYXJkWm9vbSA9PT0gdHJ1ZSkgewogICAgICAgIHNldEhmb3YoY29uZmlnLmhmb3YgKyAoc3BlZWQuaGZvdiAqIDAuOCAtIDAuMikgKiBkaWZmKTsKICAgICAgICBpc0tleURvd24gPSB0cnVlOwogICAgICB9IC8vIElmIHVwIGFycm93IG9yICJ3IiBpcyBkb3duCgoKICAgICAgaWYgKGtleXNEb3duWzJdIHx8IGtleXNEb3duWzZdKSB7CiAgICAgICAgLy8gUGFuIHVwCiAgICAgICAgY29uZmlnLnBpdGNoICs9IChzcGVlZC5waXRjaCAqIDAuOCArIDAuMikgKiBkaWZmOwogICAgICAgIGlzS2V5RG93biA9IHRydWU7CiAgICAgIH0gLy8gSWYgZG93biBhcnJvdyBvciAicyIgaXMgZG93bgoKCiAgICAgIGlmIChrZXlzRG93blszXSB8fCBrZXlzRG93bls3XSkgewogICAgICAgIC8vIFBhbiBkb3duCiAgICAgICAgY29uZmlnLnBpdGNoICs9IChzcGVlZC5waXRjaCAqIDAuOCAtIDAuMikgKiBkaWZmOwogICAgICAgIGlzS2V5RG93biA9IHRydWU7CiAgICAgIH0gLy8gSWYgbGVmdCBhcnJvdyBvciAiYSIgaXMgZG93bgoKCiAgICAgIGlmIChrZXlzRG93bls0XSB8fCBrZXlzRG93bls4XSkgewogICAgICAgIC8vIFBhbiBsZWZ0CiAgICAgICAgY29uZmlnLnlhdyArPSAoc3BlZWQueWF3ICogMC44IC0gMC4yKSAqIGRpZmY7CiAgICAgICAgaXNLZXlEb3duID0gdHJ1ZTsKICAgICAgfSAvLyBJZiByaWdodCBhcnJvdyBvciAiZCIgaXMgZG93bgoKCiAgICAgIGlmIChrZXlzRG93bls1XSB8fCBrZXlzRG93bls5XSkgewogICAgICAgIC8vIFBhbiByaWdodAogICAgICAgIGNvbmZpZy55YXcgKz0gKHNwZWVkLnlhdyAqIDAuOCArIDAuMikgKiBkaWZmOwogICAgICAgIGlzS2V5RG93biA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmIChpc0tleURvd24pIGxhdGVzdEludGVyYWN0aW9uID0gRGF0ZS5ub3coKTsgLy8gSWYgYXV0by1yb3RhdGUKCiAgICAgIGlmIChjb25maWcuYXV0b1JvdGF0ZSkgewogICAgICAgIC8vIFBhbgogICAgICAgIGlmIChuZXdUaW1lIC0gcHJldlRpbWUgPiAwLjAwMSkgewogICAgICAgICAgdmFyIHRpbWVEaWZmID0gKG5ld1RpbWUgLSBwcmV2VGltZSkgLyAxMDAwOwogICAgICAgICAgdmFyIHlhd0RpZmYgPSAoc3BlZWQueWF3IC8gdGltZURpZmYgKiBkaWZmIC0gY29uZmlnLmF1dG9Sb3RhdGUgKiAwLjIpICogdGltZURpZmY7CiAgICAgICAgICB5YXdEaWZmID0gKC1jb25maWcuYXV0b1JvdGF0ZSA+IDAgPyAxIDogLTEpICogTWF0aC5taW4oTWF0aC5hYnMoY29uZmlnLmF1dG9Sb3RhdGUgKiB0aW1lRGlmZiksIE1hdGguYWJzKHlhd0RpZmYpKTsKICAgICAgICAgIGNvbmZpZy55YXcgKz0geWF3RGlmZjsKICAgICAgICB9IC8vIERlYWwgd2l0aCBzdG9wcGluZyBhdXRvIHJvdGF0aW9uIGFmdGVyIGEgc2V0IGRlbGF5CgoKICAgICAgICBpZiAoY29uZmlnLmF1dG9Sb3RhdGVTdG9wRGVsYXkpIHsKICAgICAgICAgIGNvbmZpZy5hdXRvUm90YXRlU3RvcERlbGF5IC09IG5ld1RpbWUgLSBwcmV2VGltZTsKCiAgICAgICAgICBpZiAoY29uZmlnLmF1dG9Sb3RhdGVTdG9wRGVsYXkgPD0gMCkgewogICAgICAgICAgICBjb25maWcuYXV0b1JvdGF0ZVN0b3BEZWxheSA9IGZhbHNlOwogICAgICAgICAgICBhdXRvUm90YXRlU3BlZWQgPSBjb25maWcuYXV0b1JvdGF0ZTsKICAgICAgICAgICAgY29uZmlnLmF1dG9Sb3RhdGUgPSAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAvLyBBbmltYXRlZCBtb3ZlcwoKCiAgICAgIGlmIChhbmltYXRlZE1vdmUucGl0Y2gpIHsKICAgICAgICBhbmltYXRlTW92ZSgncGl0Y2gnKTsKICAgICAgICBwcmV2UGl0Y2ggPSBjb25maWcucGl0Y2g7CiAgICAgIH0KCiAgICAgIGlmIChhbmltYXRlZE1vdmUueWF3KSB7CiAgICAgICAgYW5pbWF0ZU1vdmUoJ3lhdycpOwogICAgICAgIHByZXZZYXcgPSBjb25maWcueWF3OwogICAgICB9CgogICAgICBpZiAoYW5pbWF0ZWRNb3ZlLmhmb3YpIHsKICAgICAgICBhbmltYXRlTW92ZSgnaGZvdicpOwogICAgICAgIHByZXZab29tID0gY29uZmlnLmhmb3Y7CiAgICAgIH0gLy8gIkluZXJ0aWEiCgoKICAgICAgaWYgKGRpZmYgPiAwICYmICFjb25maWcuYXV0b1JvdGF0ZSkgewogICAgICAgIC8vICJGcmljdGlvbiIKICAgICAgICB2YXIgc2xvd0Rvd25GYWN0b3IgPSAxIC0gY29uZmlnLmZyaWN0aW9uOyAvLyBZYXcKCiAgICAgICAgaWYgKCFrZXlzRG93bls0XSAmJiAha2V5c0Rvd25bNV0gJiYgIWtleXNEb3duWzhdICYmICFrZXlzRG93bls5XSAmJiAhYW5pbWF0ZWRNb3ZlLnlhdykgewogICAgICAgICAgY29uZmlnLnlhdyArPSBzcGVlZC55YXcgKiBkaWZmICogc2xvd0Rvd25GYWN0b3I7CiAgICAgICAgfSAvLyBQaXRjaAoKCiAgICAgICAgaWYgKCFrZXlzRG93blsyXSAmJiAha2V5c0Rvd25bM10gJiYgIWtleXNEb3duWzZdICYmICFrZXlzRG93bls3XSAmJiAhYW5pbWF0ZWRNb3ZlLnBpdGNoKSB7CiAgICAgICAgICBjb25maWcucGl0Y2ggKz0gc3BlZWQucGl0Y2ggKiBkaWZmICogc2xvd0Rvd25GYWN0b3I7CiAgICAgICAgfSAvLyBab29tCgoKICAgICAgICBpZiAoIWtleXNEb3duWzBdICYmICFrZXlzRG93blsxXSAmJiAhYW5pbWF0ZWRNb3ZlLmhmb3YpIHsKICAgICAgICAgIHNldEhmb3YoY29uZmlnLmhmb3YgKyBzcGVlZC5oZm92ICogZGlmZiAqIHNsb3dEb3duRmFjdG9yKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHByZXZUaW1lID0gbmV3VGltZTsKCiAgICAgIGlmIChkaWZmID4gMCkgewogICAgICAgIHNwZWVkLnlhdyA9IHNwZWVkLnlhdyAqIDAuOCArIChjb25maWcueWF3IC0gcHJldllhdykgLyBkaWZmICogMC4yOwogICAgICAgIHNwZWVkLnBpdGNoID0gc3BlZWQucGl0Y2ggKiAwLjggKyAoY29uZmlnLnBpdGNoIC0gcHJldlBpdGNoKSAvIGRpZmYgKiAwLjI7CiAgICAgICAgc3BlZWQuaGZvdiA9IHNwZWVkLmhmb3YgKiAwLjggKyAoY29uZmlnLmhmb3YgLSBwcmV2Wm9vbSkgLyBkaWZmICogMC4yOyAvLyBMaW1pdCBzcGVlZAoKICAgICAgICB2YXIgbWF4U3BlZWQgPSBjb25maWcuYXV0b1JvdGF0ZSA/IE1hdGguYWJzKGNvbmZpZy5hdXRvUm90YXRlKSA6IDU7CiAgICAgICAgc3BlZWQueWF3ID0gTWF0aC5taW4obWF4U3BlZWQsIE1hdGgubWF4KHNwZWVkLnlhdywgLW1heFNwZWVkKSk7CiAgICAgICAgc3BlZWQucGl0Y2ggPSBNYXRoLm1pbihtYXhTcGVlZCwgTWF0aC5tYXgoc3BlZWQucGl0Y2gsIC1tYXhTcGVlZCkpOwogICAgICAgIHNwZWVkLmhmb3YgPSBNYXRoLm1pbihtYXhTcGVlZCwgTWF0aC5tYXgoc3BlZWQuaGZvdiwgLW1heFNwZWVkKSk7CiAgICAgIH0gLy8gU3RvcCBtb3ZlbWVudCBpZiBvcHBvc2l0ZSBjb250cm9scyBhcmUgcHJlc3NlZAoKCiAgICAgIGlmIChrZXlzRG93blswXSAmJiBrZXlzRG93blsxXSkgewogICAgICAgIHNwZWVkLmhmb3YgPSAwOwogICAgICB9CgogICAgICBpZiAoKGtleXNEb3duWzJdIHx8IGtleXNEb3duWzZdKSAmJiAoa2V5c0Rvd25bM10gfHwga2V5c0Rvd25bN10pKSB7CiAgICAgICAgc3BlZWQucGl0Y2ggPSAwOwogICAgICB9CgogICAgICBpZiAoKGtleXNEb3duWzRdIHx8IGtleXNEb3duWzhdKSAmJiAoa2V5c0Rvd25bNV0gfHwga2V5c0Rvd25bOV0pKSB7CiAgICAgICAgc3BlZWQueWF3ID0gMDsKICAgICAgfQogICAgfQogICAgLyoqDQogICAgICogQW5pbWF0ZXMgbW92ZXMuDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGF4aXMgLSBBeGlzIHRvIGFuaW1hdGUNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBhbmltYXRlTW92ZShheGlzKSB7CiAgICAgIHZhciB0ID0gYW5pbWF0ZWRNb3ZlW2F4aXNdOwogICAgICB2YXIgbm9ybVRpbWUgPSBNYXRoLm1pbigxLCBNYXRoLm1heCgoRGF0ZS5ub3coKSAtIHQuc3RhcnRUaW1lKSAvIDEwMDAgLyAodC5kdXJhdGlvbiAvIDEwMDApLCAwKSk7CiAgICAgIHZhciByZXN1bHQgPSB0LnN0YXJ0UG9zaXRpb24gKyBjb25maWcuYW5pbWF0aW9uVGltaW5nRnVuY3Rpb24obm9ybVRpbWUpICogKHQuZW5kUG9zaXRpb24gLSB0LnN0YXJ0UG9zaXRpb24pOwoKICAgICAgaWYgKHQuZW5kUG9zaXRpb24gPiB0LnN0YXJ0UG9zaXRpb24gJiYgcmVzdWx0ID49IHQuZW5kUG9zaXRpb24gfHwgdC5lbmRQb3NpdGlvbiA8IHQuc3RhcnRQb3NpdGlvbiAmJiByZXN1bHQgPD0gdC5lbmRQb3NpdGlvbiB8fCB0LmVuZFBvc2l0aW9uID09PSB0LnN0YXJ0UG9zaXRpb24pIHsKICAgICAgICByZXN1bHQgPSB0LmVuZFBvc2l0aW9uOwogICAgICAgIHNwZWVkW2F4aXNdID0gMDsKICAgICAgICBkZWxldGUgYW5pbWF0ZWRNb3ZlW2F4aXNdOwogICAgICB9CgogICAgICBjb25maWdbYXhpc10gPSByZXN1bHQ7CiAgICB9CiAgICAvKioNCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdCAtIE5vcm1hbGl6ZWQgdGltZSBpbiBhbmltYXRpb24NCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ9IFBvc2l0aW9uIGluIGFuaW1hdGlvbg0KICAgICAqIEBwcml2YXRlDQogICAgICovCgoKICAgIGZ1bmN0aW9uIHRpbWluZ0Z1bmN0aW9uKHQpIHsKICAgICAgLy8gZWFzZUluT3V0UXVhZCBmcm9tIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL2dyZS8xNjUwMjk0CiAgICAgIHJldHVybiB0IDwgMC41ID8gMiAqIHQgKiB0IDogLTEgKyAoNCAtIDIgKiB0KSAqIHQ7CiAgICB9CiAgICAvKioNCiAgICAgKiBFdmVudCBoYW5kbGVyIGZvciBkb2N1bWVudCByZXNpemVzLiBVcGRhdGVzIHZpZXdlciBzaXplIGFuZCByZXJlbmRlcnMgdmlldy4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBvbkRvY3VtZW50UmVzaXplKCkgewogICAgICAvLyBSZXNpemUgcGFub3JhbWEgcmVuZGVyZXIgKG1vdmVkIHRvIG9uRnVsbFNjcmVlbkNoYW5nZSkKICAgICAgLy9yZW5kZXJlci5yZXNpemUoKTsKICAgICAgLy9hbmltYXRlSW5pdCgpOwogICAgICAvLyBLbHVkZ2UgdG8gZGVhbCB3aXRoIFdlYktpdCByZWdyZXNzaW9uOiBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9OTM1MjUKICAgICAgb25GdWxsU2NyZWVuQ2hhbmdlKCdyZXNpemUnKTsKICAgIH0KICAgIC8qKg0KICAgICAqIEluaXRpYWxpemVzIGFuaW1hdGlvbi4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBhbmltYXRlSW5pdCgpIHsKICAgICAgaWYgKGFuaW1hdGluZykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgYW5pbWF0aW5nID0gdHJ1ZTsKICAgICAgYW5pbWF0ZSgpOwogICAgfQogICAgLyoqDQogICAgICogQW5pbWF0ZXMgdmlldywgdXNpbmcgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIHRvIHRyaWdnZXIgcmVuZGVyaW5nLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCgoKICAgIGZ1bmN0aW9uIGFuaW1hdGUoKSB7CiAgICAgIGlmIChkZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHJlbmRlcigpOwogICAgICBpZiAoYXV0b1JvdGF0ZVN0YXJ0KSBjbGVhclRpbWVvdXQoYXV0b1JvdGF0ZVN0YXJ0KTsKCiAgICAgIGlmIChpc1VzZXJJbnRlcmFjdGluZyB8fCBvcmllbnRhdGlvbiA9PT0gdHJ1ZSkgewogICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTsKICAgICAgfSBlbHNlIGlmIChrZXlzRG93blswXSB8fCBrZXlzRG93blsxXSB8fCBrZXlzRG93blsyXSB8fCBrZXlzRG93blszXSB8fCBrZXlzRG93bls0XSB8fCBrZXlzRG93bls1XSB8fCBrZXlzRG93bls2XSB8fCBrZXlzRG93bls3XSB8fCBrZXlzRG93bls4XSB8fCBrZXlzRG93bls5XSB8fCBjb25maWcuYXV0b1JvdGF0ZSB8fCBhbmltYXRlZE1vdmUucGl0Y2ggfHwgYW5pbWF0ZWRNb3ZlLnlhdyB8fCBhbmltYXRlZE1vdmUuaGZvdiB8fCBNYXRoLmFicyhzcGVlZC55YXcpID4gMC4wMSB8fCBNYXRoLmFicyhzcGVlZC5waXRjaCkgPiAwLjAxIHx8IE1hdGguYWJzKHNwZWVkLmhmb3YpID4gMC4wMSkgewogICAgICAgIGtleVJlcGVhdCgpOwoKICAgICAgICBpZiAoY29uZmlnLmF1dG9Sb3RhdGVJbmFjdGl2aXR5RGVsYXkgPj0gMCAmJiBhdXRvUm90YXRlU3BlZWQgJiYgRGF0ZS5ub3coKSAtIGxhdGVzdEludGVyYWN0aW9uID4gY29uZmlnLmF1dG9Sb3RhdGVJbmFjdGl2aXR5RGVsYXkgJiYgIWNvbmZpZy5hdXRvUm90YXRlKSB7CiAgICAgICAgICBjb25maWcuYXV0b1JvdGF0ZSA9IGF1dG9Sb3RhdGVTcGVlZDsKCiAgICAgICAgICBfdGhpcy5sb29rQXQob3JpZ1BpdGNoLCB1bmRlZmluZWQsIG9yaWdIZm92LCAzMDAwKTsKICAgICAgICB9CgogICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTsKICAgICAgfSBlbHNlIGlmIChyZW5kZXJlciAmJiAocmVuZGVyZXIuaXNMb2FkaW5nKCkgfHwgY29uZmlnLmR5bmFtaWMgPT09IHRydWUgJiYgdXBkYXRlKSkgewogICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmaXJlRXZlbnQoJ2FuaW1hdGVmaW5pc2hlZCcsIHsKICAgICAgICAgIHBpdGNoOiBfdGhpcy5nZXRQaXRjaCgpLAogICAgICAgICAgeWF3OiBfdGhpcy5nZXRZYXcoKSwKICAgICAgICAgIGhmb3Y6IF90aGlzLmdldEhmb3YoKQogICAgICAgIH0pOwogICAgICAgIGFuaW1hdGluZyA9IGZhbHNlOwogICAgICAgIHByZXZUaW1lID0gdW5kZWZpbmVkOwogICAgICAgIHZhciBhdXRvUm90YXRlU3RhcnRUaW1lID0gY29uZmlnLmF1dG9Sb3RhdGVJbmFjdGl2aXR5RGVsYXkgLSAoRGF0ZS5ub3coKSAtIGxhdGVzdEludGVyYWN0aW9uKTsKCiAgICAgICAgaWYgKGF1dG9Sb3RhdGVTdGFydFRpbWUgPiAwKSB7CiAgICAgICAgICBhdXRvUm90YXRlU3RhcnQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgY29uZmlnLmF1dG9Sb3RhdGUgPSBhdXRvUm90YXRlU3BlZWQ7CgogICAgICAgICAgICBfdGhpcy5sb29rQXQob3JpZ1BpdGNoLCB1bmRlZmluZWQsIG9yaWdIZm92LCAzMDAwKTsKCiAgICAgICAgICAgIGFuaW1hdGVJbml0KCk7CiAgICAgICAgICB9LCBhdXRvUm90YXRlU3RhcnRUaW1lKTsKICAgICAgICB9IGVsc2UgaWYgKGNvbmZpZy5hdXRvUm90YXRlSW5hY3Rpdml0eURlbGF5ID49IDAgJiYgYXV0b1JvdGF0ZVNwZWVkKSB7CiAgICAgICAgICBjb25maWcuYXV0b1JvdGF0ZSA9IGF1dG9Sb3RhdGVTcGVlZDsKCiAgICAgICAgICBfdGhpcy5sb29rQXQob3JpZ1BpdGNoLCB1bmRlZmluZWQsIG9yaWdIZm92LCAzMDAwKTsKCiAgICAgICAgICBhbmltYXRlSW5pdCgpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqDQogICAgICogUmVuZGVycyBwYW5vcmFtYSB2aWV3Lg0KICAgICAqIEBwcml2YXRlDQogICAgICovCgoKICAgIGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgdmFyIHRtcHlhdzsKCiAgICAgIGlmIChsb2FkZWQpIHsKICAgICAgICB2YXIgY2FudmFzID0gcmVuZGVyZXIuZ2V0Q2FudmFzKCk7CgogICAgICAgIGlmIChjb25maWcuYXV0b1JvdGF0ZSAhPT0gZmFsc2UpIHsKICAgICAgICAgIC8vIFdoZW4gYXV0by1yb3RhdGluZyB0aGlzIGNoZWNrIG5lZWRzIHRvIGhhcHBlbiBmaXJzdCAoc2VlIGlzc3VlICM3NjQpCiAgICAgICAgICBpZiAoY29uZmlnLnlhdyA+IDM2MCkgewogICAgICAgICAgICBjb25maWcueWF3IC09IDM2MDsKICAgICAgICAgIH0gZWxzZSBpZiAoY29uZmlnLnlhdyA8IC0zNjApIHsKICAgICAgICAgICAgY29uZmlnLnlhdyArPSAzNjA7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBLZWVwIGEgdG1wIHZhbHVlIG9mIHlhdyBmb3IgYXV0b1JvdGF0ZSBjb21wYXJpc29uIGxhdGVyCgoKICAgICAgICB0bXB5YXcgPSBjb25maWcueWF3OyAvLyBPcHRpb25hbGx5IGF2b2lkIHNob3dpbmcgYmFja2dyb3VuZCAoZW1wdHkgc3BhY2UpIG9uIGxlZnQgb3IgcmlnaHQgYnkgYWRhcHRpbmcgbWluL21heCB5YXcKCiAgICAgICAgdmFyIGhvZmZjdXQgPSAwLAogICAgICAgICAgICB2b2ZmY3V0ID0gMDsKCiAgICAgICAgaWYgKGNvbmZpZy5hdm9pZFNob3dpbmdCYWNrZ3JvdW5kKSB7CiAgICAgICAgICB2YXIgaGZvdjIgPSBjb25maWcuaGZvdiAvIDIsCiAgICAgICAgICAgICAgdmZvdjIgPSBNYXRoLmF0YW4yKE1hdGgudGFuKGhmb3YyIC8gMTgwICogTWF0aC5QSSksIGNhbnZhcy53aWR0aCAvIGNhbnZhcy5oZWlnaHQpICogMTgwIC8gTWF0aC5QSSwKICAgICAgICAgICAgICB0cmFuc3Bvc2VkID0gY29uZmlnLnZhb3YgPiBjb25maWcuaGFvdjsKCiAgICAgICAgICBpZiAodHJhbnNwb3NlZCkgewogICAgICAgICAgICB2b2ZmY3V0ID0gdmZvdjIgKiAoMSAtIE1hdGgubWluKE1hdGguY29zKChjb25maWcucGl0Y2ggLSBoZm92MikgLyAxODAgKiBNYXRoLlBJKSwgTWF0aC5jb3MoKGNvbmZpZy5waXRjaCArIGhmb3YyKSAvIDE4MCAqIE1hdGguUEkpKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBob2ZmY3V0ID0gaGZvdjIgKiAoMSAtIE1hdGgubWluKE1hdGguY29zKChjb25maWcucGl0Y2ggLSB2Zm92MikgLyAxODAgKiBNYXRoLlBJKSwgTWF0aC5jb3MoKGNvbmZpZy5waXRjaCArIHZmb3YyKSAvIDE4MCAqIE1hdGguUEkpKSk7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBFbnN1cmUgdGhlIHlhdyBpcyB3aXRoaW4gbWluIGFuZCBtYXggYWxsb3dlZAoKCiAgICAgICAgdmFyIHlhd1JhbmdlID0gY29uZmlnLm1heFlhdyAtIGNvbmZpZy5taW5ZYXcsCiAgICAgICAgICAgIG1pbllhdyA9IC0xODAsCiAgICAgICAgICAgIG1heFlhdyA9IDE4MDsKCiAgICAgICAgaWYgKHlhd1JhbmdlIDwgMzYwKSB7CiAgICAgICAgICBtaW5ZYXcgPSBjb25maWcubWluWWF3ICsgY29uZmlnLmhmb3YgLyAyICsgaG9mZmN1dDsKICAgICAgICAgIG1heFlhdyA9IGNvbmZpZy5tYXhZYXcgLSBjb25maWcuaGZvdiAvIDIgLSBob2ZmY3V0OwoKICAgICAgICAgIGlmICh5YXdSYW5nZSA8IGNvbmZpZy5oZm92KSB7CiAgICAgICAgICAgIC8vIExvY2sgeWF3IHRvIGF2ZXJhZ2Ugb2YgbWluIGFuZCBtYXggeWF3IHdoZW4gYm90aCBjYW4gYmUgc2VlbiBhdCBvbmNlCiAgICAgICAgICAgIG1pbllhdyA9IG1heFlhdyA9IChtaW5ZYXcgKyBtYXhZYXcpIC8gMjsKICAgICAgICAgIH0KCiAgICAgICAgICBjb25maWcueWF3ID0gTWF0aC5tYXgobWluWWF3LCBNYXRoLm1pbihtYXhZYXcsIGNvbmZpZy55YXcpKTsKICAgICAgICB9CgogICAgICAgIGlmICghKGNvbmZpZy5hdXRvUm90YXRlICE9PSBmYWxzZSkpIHsKICAgICAgICAgIC8vIFdoZW4gbm90IGF1dG8tcm90YXRpbmcsIHRoaXMgY2hlY2sgbmVlZHMgdG8gaGFwcGVuIGFmdGVyIHRoZQogICAgICAgICAgLy8gcHJldmlvdXMgY2hlY2sgKHNlZSBpc3N1ZSAjNjk4KQogICAgICAgICAgaWYgKGNvbmZpZy55YXcgPiAzNjApIHsKICAgICAgICAgICAgY29uZmlnLnlhdyAtPSAzNjA7CiAgICAgICAgICB9IGVsc2UgaWYgKGNvbmZpZy55YXcgPCAtMzYwKSB7CiAgICAgICAgICAgIGNvbmZpZy55YXcgKz0gMzYwOwogICAgICAgICAgfQogICAgICAgIH0gLy8gQ2hlY2sgaWYgd2UgYXV0b1JvdGF0ZSBpbiBhIGxpbWl0ZWQgYnkgbWluIGFuZCBtYXggeWF3CiAgICAgICAgLy8gSWYgc28gcmV2ZXJzZSBkaXJlY3Rpb24KCgogICAgICAgIGlmIChjb25maWcuYXV0b1JvdGF0ZSAhPT0gZmFsc2UgJiYgdG1weWF3ICE9IGNvbmZpZy55YXcgJiYgcHJldlRpbWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgLy8gdGhpcyBjb25kaXRpb24gcHJldmVudHMgY2hhbmdpbmcgdGhlIGRpcmVjdGlvbiBpbml0aWFsbHkKICAgICAgICAgIGNvbmZpZy5hdXRvUm90YXRlICo9IC0xOwogICAgICAgIH0gLy8gRW5zdXJlIHRoZSBjYWxjdWxhdGVkIHBpdGNoIGlzIHdpdGhpbiBtaW4gYW5kIG1heCBhbGxvd2VkCgoKICAgICAgICB2YXIgdmZvdiA9IDIgKiBNYXRoLmF0YW4oTWF0aC50YW4oY29uZmlnLmhmb3YgLyAxODAgKiBNYXRoLlBJICogMC41KSAvIChjYW52YXMud2lkdGggLyBjYW52YXMuaGVpZ2h0KSkgLyBNYXRoLlBJICogMTgwOwogICAgICAgIHZhciBtaW5QaXRjaCA9IGNvbmZpZy5taW5QaXRjaCArIHZmb3YgLyAyLAogICAgICAgICAgICBtYXhQaXRjaCA9IGNvbmZpZy5tYXhQaXRjaCAtIHZmb3YgLyAyOwogICAgICAgIHZhciBwaXRjaFJhbmdlID0gY29uZmlnLm1heFBpdGNoIC0gY29uZmlnLm1pblBpdGNoOwoKICAgICAgICBpZiAocGl0Y2hSYW5nZSA8IHZmb3YpIHsKICAgICAgICAgIC8vIExvY2sgcGl0Y2ggdG8gYXZlcmFnZSBvZiBtaW4gYW5kIG1heCBwaXRjaCB3aGVuIGJvdGggY2FuIGJlIHNlZW4gYXQgb25jZQogICAgICAgICAgbWluUGl0Y2ggPSBtYXhQaXRjaCA9IChtaW5QaXRjaCArIG1heFBpdGNoKSAvIDI7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNOYU4obWluUGl0Y2gpKSBtaW5QaXRjaCA9IC05MDsKICAgICAgICBpZiAoaXNOYU4obWF4UGl0Y2gpKSBtYXhQaXRjaCA9IDkwOwogICAgICAgIGNvbmZpZy5waXRjaCA9IE1hdGgubWF4KG1pblBpdGNoLCBNYXRoLm1pbihtYXhQaXRjaCwgY29uZmlnLnBpdGNoKSk7CiAgICAgICAgcmVuZGVyZXIucmVuZGVyKGNvbmZpZy5waXRjaCAqIE1hdGguUEkgLyAxODAsIGNvbmZpZy55YXcgKiBNYXRoLlBJIC8gMTgwLCBjb25maWcuaGZvdiAqIE1hdGguUEkgLyAxODAsIHsKICAgICAgICAgIHJvbGw6IGNvbmZpZy5yb2xsICogTWF0aC5QSSAvIDE4MAogICAgICAgIH0pOwogICAgICAgIHJlbmRlckhvdFNwb3RzKCk7IC8vIFVwZGF0ZSBjb21wYXNzCgogICAgICAgIGlmIChjb25maWcuY29tcGFzcykgewogICAgICAgICAgY29tcGFzcy5zdHlsZS50cmFuc2Zvcm0gPSAncm90YXRlKCcgKyAoLWNvbmZpZy55YXcgLSBjb25maWcubm9ydGhPZmZzZXQpICsgJ2RlZyknOwogICAgICAgICAgY29tcGFzcy5zdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSAncm90YXRlKCcgKyAoLWNvbmZpZy55YXcgLSBjb25maWcubm9ydGhPZmZzZXQpICsgJ2RlZyknOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqDQogICAgICogQ3JlYXRlcyBhIG5ldyBxdWF0ZXJuaW9uLg0KICAgICAqIEBwcml2YXRlDQogICAgICogQGNvbnN0cnVjdG9yDQogICAgICogQHBhcmFtIHtOdW1iZXJ9IHcgLSBXIHZhbHVlDQogICAgICogQHBhcmFtIHtOdW1iZXJ9IHggLSBYIHZhbHVlDQogICAgICogQHBhcmFtIHtOdW1iZXJ9IHkgLSBZIHZhbHVlDQogICAgICogQHBhcmFtIHtOdW1iZXJ9IHogLSBaIHZhbHVlDQogICAgICovCgoKICAgIGZ1bmN0aW9uIFF1YXRlcm5pb24odywgeCwgeSwgeikgewogICAgICB0aGlzLncgPSB3OwogICAgICB0aGlzLnggPSB4OwogICAgICB0aGlzLnkgPSB5OwogICAgICB0aGlzLnogPSB6OwogICAgfQogICAgLyoqDQogICAgICogTXVsdGlwbGllcyBxdWF0ZXJuaW9ucy4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7UXVhdGVybmlvbn0gcSAtIFF1YXRlcm5pb24gdG8gbXVsdGlwbHkNCiAgICAgKiBAcmV0dXJucyB7UXVhdGVybmlvbn0gUmVzdWx0IG9mIG11bHRpcGxpY2F0aW9uDQogICAgICovCgoKICAgIFF1YXRlcm5pb24ucHJvdG90eXBlLm11bHRpcGx5ID0gZnVuY3Rpb24gKHEpIHsKICAgICAgcmV0dXJuIG5ldyBRdWF0ZXJuaW9uKHRoaXMudyAqIHEudyAtIHRoaXMueCAqIHEueCAtIHRoaXMueSAqIHEueSAtIHRoaXMueiAqIHEueiwgdGhpcy54ICogcS53ICsgdGhpcy53ICogcS54ICsgdGhpcy55ICogcS56IC0gdGhpcy56ICogcS55LCB0aGlzLnkgKiBxLncgKyB0aGlzLncgKiBxLnkgKyB0aGlzLnogKiBxLnggLSB0aGlzLnggKiBxLnosIHRoaXMueiAqIHEudyArIHRoaXMudyAqIHEueiArIHRoaXMueCAqIHEueSAtIHRoaXMueSAqIHEueCk7CiAgICB9OwogICAgLyoqDQogICAgICogQ29udmVydHMgcXVhdGVybmlvbiB0byBFdWxlciBhbmdsZXMuDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcmV0dXJucyB7TnVtYmVyW119IFtwaGkgYW5nbGUsIHRoZXRhIGFuZ2xlLCBwc2kgYW5nbGVdDQogICAgICovCgoKICAgIFF1YXRlcm5pb24ucHJvdG90eXBlLnRvRXVsZXJBbmdsZXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBwaGkgPSBNYXRoLmF0YW4yKDIgKiAodGhpcy53ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy56KSwgMSAtIDIgKiAodGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55KSksCiAgICAgICAgICB0aGV0YSA9IE1hdGguYXNpbigyICogKHRoaXMudyAqIHRoaXMueSAtIHRoaXMueiAqIHRoaXMueCkpLAogICAgICAgICAgcHNpID0gTWF0aC5hdGFuMigyICogKHRoaXMudyAqIHRoaXMueiArIHRoaXMueCAqIHRoaXMueSksIDEgLSAyICogKHRoaXMueSAqIHRoaXMueSArIHRoaXMueiAqIHRoaXMueikpOwogICAgICByZXR1cm4gW3BoaSwgdGhldGEsIHBzaV07CiAgICB9OwogICAgLyoqDQogICAgICogQ29udmVydHMgZGV2aWNlIG9yaWVudGF0aW9uIEFQSSBUYWl0LUJyeWFuIGFuZ2xlcyB0byBhIHF1YXRlcm5pb24uDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge051bWJlcn0gYWxwaGEgLSBBbHBoYSBhbmdsZSAoaW4gZGVncmVlcykNCiAgICAgKiBAcGFyYW0ge051bWJlcn0gYmV0YSAtIEJldGEgYW5nbGUgKGluIGRlZ3JlZXMpDQogICAgICogQHBhcmFtIHtOdW1iZXJ9IGdhbW1hIC0gR2FtbWEgYW5nbGUgKGluIGRlZ3JlZXMpDQogICAgICogQHJldHVybnMge1F1YXRlcm5pb259IE9yaWVudGF0aW9uIHF1YXRlcm5pb24NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gdGFpdEJyeWFuVG9RdWF0ZXJuaW9uKGFscGhhLCBiZXRhLCBnYW1tYSkgewogICAgICB2YXIgciA9IFtiZXRhID8gYmV0YSAqIE1hdGguUEkgLyAxODAgLyAyIDogMCwgZ2FtbWEgPyBnYW1tYSAqIE1hdGguUEkgLyAxODAgLyAyIDogMCwgYWxwaGEgPyBhbHBoYSAqIE1hdGguUEkgLyAxODAgLyAyIDogMF07CiAgICAgIHZhciBjID0gW01hdGguY29zKHJbMF0pLCBNYXRoLmNvcyhyWzFdKSwgTWF0aC5jb3MoclsyXSldLAogICAgICAgICAgcyA9IFtNYXRoLnNpbihyWzBdKSwgTWF0aC5zaW4oclsxXSksIE1hdGguc2luKHJbMl0pXTsKICAgICAgcmV0dXJuIG5ldyBRdWF0ZXJuaW9uKGNbMF0gKiBjWzFdICogY1syXSAtIHNbMF0gKiBzWzFdICogc1syXSwgc1swXSAqIGNbMV0gKiBjWzJdIC0gY1swXSAqIHNbMV0gKiBzWzJdLCBjWzBdICogc1sxXSAqIGNbMl0gKyBzWzBdICogY1sxXSAqIHNbMl0sIGNbMF0gKiBjWzFdICogc1syXSArIHNbMF0gKiBzWzFdICogY1syXSk7CiAgICB9CiAgICAvKioNCiAgICAgKiBDb21wdXRlcyBjdXJyZW50IGRldmljZSBvcmllbnRhdGlvbiBxdWF0ZXJuaW9uIGZyb20gZGV2aWNlIG9yaWVudGF0aW9uIEFQSQ0KICAgICAqIFRhaXQtQnJ5YW4gYW5nbGVzLg0KICAgICAqIEBwcml2YXRlDQogICAgICogQHBhcmFtIHtOdW1iZXJ9IGFscGhhIC0gQWxwaGEgYW5nbGUgKGluIGRlZ3JlZXMpDQogICAgICogQHBhcmFtIHtOdW1iZXJ9IGJldGEgLSBCZXRhIGFuZ2xlIChpbiBkZWdyZWVzKQ0KICAgICAqIEBwYXJhbSB7TnVtYmVyfSBnYW1tYSAtIEdhbW1hIGFuZ2xlIChpbiBkZWdyZWVzKQ0KICAgICAqIEByZXR1cm5zIHtRdWF0ZXJuaW9ufSBPcmllbnRhdGlvbiBxdWF0ZXJuaW9uDQogICAgICovCgoKICAgIGZ1bmN0aW9uIGNvbXB1dGVRdWF0ZXJuaW9uKGFscGhhLCBiZXRhLCBnYW1tYSkgewogICAgICAvLyBDb252ZXJ0IFRhaXQtQnJ5YW4gYW5nbGVzIHRvIHF1YXRlcm5pb24KICAgICAgdmFyIHF1YXRlcm5pb24gPSB0YWl0QnJ5YW5Ub1F1YXRlcm5pb24oYWxwaGEsIGJldGEsIGdhbW1hKTsgLy8gQXBwbHkgd29ybGQgdHJhbnNmb3JtCgogICAgICBxdWF0ZXJuaW9uID0gcXVhdGVybmlvbi5tdWx0aXBseShuZXcgUXVhdGVybmlvbihNYXRoLnNxcnQoMC41KSwgLU1hdGguc3FydCgwLjUpLCAwLCAwKSk7IC8vIEFwcGx5IHNjcmVlbiB0cmFuc2Zvcm0KCiAgICAgIHZhciBhbmdsZSA9IHdpbmRvdy5vcmllbnRhdGlvbiA/IC13aW5kb3cub3JpZW50YXRpb24gKiBNYXRoLlBJIC8gMTgwIC8gMiA6IDA7CiAgICAgIHJldHVybiBxdWF0ZXJuaW9uLm11bHRpcGx5KG5ldyBRdWF0ZXJuaW9uKE1hdGguY29zKGFuZ2xlKSwgMCwgLU1hdGguc2luKGFuZ2xlKSwgMCkpOwogICAgfQogICAgLyoqDQogICAgICogRXZlbnQgaGFuZGxlciBmb3IgZGV2aWNlIG9yaWVudGF0aW9uIEFQSS4gQ29udHJvbHMgcG9pbnRpbmcuDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge0RldmljZU9yaWVudGF0aW9uRXZlbnR9IGV2ZW50IC0gRGV2aWNlIG9yaWVudGF0aW9uIGV2ZW50Lg0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBvcmllbnRhdGlvbkxpc3RlbmVyKGUpIHsKICAgICAgdmFyIHEgPSBjb21wdXRlUXVhdGVybmlvbihlLmFscGhhLCBlLmJldGEsIGUuZ2FtbWEpLnRvRXVsZXJBbmdsZXMoKTsKCiAgICAgIGlmICh0eXBlb2Ygb3JpZW50YXRpb24gPT0gJ251bWJlcicgJiYgb3JpZW50YXRpb24gPCAxMCkgewogICAgICAgIC8vIFRoaXMga2x1ZGdlIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIGlPUyBzb21ldGltZXMgcHJvdmlkZXMgYSBmZXcgc3RhbGUKICAgICAgICAvLyBkZXZpY2Ugb3JpZW50YXRpb24gZXZlbnRzIHdoZW4gdGhlIGxpc3RlbmVyIGlzIHJlbW92ZWQgYW5kIHRoZW4KICAgICAgICAvLyByZWFkZGVkLiBUaHVzLCB3ZSBza2lwIHRoZSBmaXJzdCAxMCBldmVudHMgdG8gcHJldmVudCB0aGlzIGZyb20KICAgICAgICAvLyBjYXVzaW5nIHByb2JsZW1zLgogICAgICAgIG9yaWVudGF0aW9uICs9IDE7CiAgICAgIH0gZWxzZSBpZiAob3JpZW50YXRpb24gPT09IDEwKSB7CiAgICAgICAgLy8gUmVjb3JkIHN0YXJ0aW5nIHlhdyB0byBwcmV2ZW50IGp1bXBpbmcKICAgICAgICBvcmllbnRhdGlvbllhd09mZnNldCA9IHFbMl0gLyBNYXRoLlBJICogMTgwICsgY29uZmlnLnlhdzsKICAgICAgICBvcmllbnRhdGlvbiA9IHRydWU7CiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbmZpZy5waXRjaCA9IHFbMF0gLyBNYXRoLlBJICogMTgwOwogICAgICAgIGNvbmZpZy5yb2xsID0gLXFbMV0gLyBNYXRoLlBJICogMTgwOwogICAgICAgIGNvbmZpZy55YXcgPSAtcVsyXSAvIE1hdGguUEkgKiAxODAgKyBvcmllbnRhdGlvbllhd09mZnNldDsKICAgICAgfQogICAgfQogICAgLyoqDQogICAgICogSW5pdGlhbGl6ZXMgcmVuZGVyZXIuDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KCgogICAgZnVuY3Rpb24gcmVuZGVySW5pdCgpIHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgcGFyYW1zID0ge307CiAgICAgICAgaWYgKGNvbmZpZy5ob3Jpem9uUGl0Y2ggIT09IHVuZGVmaW5lZCkgcGFyYW1zLmhvcml6b25QaXRjaCA9IGNvbmZpZy5ob3Jpem9uUGl0Y2ggKiBNYXRoLlBJIC8gMTgwOwogICAgICAgIGlmIChjb25maWcuaG9yaXpvblJvbGwgIT09IHVuZGVmaW5lZCkgcGFyYW1zLmhvcml6b25Sb2xsID0gY29uZmlnLmhvcml6b25Sb2xsICogTWF0aC5QSSAvIDE4MDsKICAgICAgICBpZiAoY29uZmlnLmJhY2tncm91bmRDb2xvciAhPT0gdW5kZWZpbmVkKSBwYXJhbXMuYmFja2dyb3VuZENvbG9yID0gY29uZmlnLmJhY2tncm91bmRDb2xvcjsKICAgICAgICByZW5kZXJlci5pbml0KHBhbm9JbWFnZSwgY29uZmlnLnR5cGUsIGNvbmZpZy5keW5hbWljLCBjb25maWcuaGFvdiAqIE1hdGguUEkgLyAxODAsIGNvbmZpZy52YW92ICogTWF0aC5QSSAvIDE4MCwgY29uZmlnLnZPZmZzZXQgKiBNYXRoLlBJIC8gMTgwLCByZW5kZXJJbml0Q2FsbGJhY2ssIHBhcmFtcyk7CgogICAgICAgIGlmIChjb25maWcuZHluYW1pYyAhPT0gdHJ1ZSkgewogICAgICAgICAgLy8gQWxsb3cgaW1hZ2UgdG8gYmUgZ2FyYmFnZSBjb2xsZWN0ZWQKICAgICAgICAgIHBhbm9JbWFnZSA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGV2ZW50KSB7CiAgICAgICAgLy8gUGFub3JhbWEgbm90IGxvYWRlZAogICAgICAgIC8vIERpc3BsYXkgZXJyb3IgaWYgdGhlcmUgaXMgYSBiYWQgdGV4dHVyZQogICAgICAgIGlmIChldmVudC50eXBlID09ICd3ZWJnbCBlcnJvcicgfHwgZXZlbnQudHlwZSA9PSAnbm8gd2ViZ2wnKSB7CiAgICAgICAgICBhbkVycm9yKCk7CiAgICAgICAgfSBlbHNlIGlmIChldmVudC50eXBlID09ICd3ZWJnbCBzaXplIGVycm9yJykgewogICAgICAgICAgYW5FcnJvcihjb25maWcuc3RyaW5ncy50ZXh0dXJlU2l6ZUVycm9yLnJlcGxhY2UoJyVzJywgZXZlbnQud2lkdGgpLnJlcGxhY2UoJyVzJywgZXZlbnQubWF4V2lkdGgpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYW5FcnJvcihjb25maWcuc3RyaW5ncy51bmtub3duRXJyb3IpOwogICAgICAgICAgdGhyb3cgZXZlbnQ7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioNCiAgICAgKiBUcmlnZ2VyZWQgd2hlbiByZW5kZXIgaW5pdGlhbGl6YXRpb24gZmluaXNoZXMuIEhhbmRsZXMgZmFkaW5nIGJldHdlZW4NCiAgICAgKiBzY2VuZXMgYXMgd2VsbCBhcyBzaG93aW5nIHRoZSBjb21wYXNzIGFuZCBob3RzcG90cyBhbmQgaGlkaW5nIHRoZSBsb2FkaW5nDQogICAgICogZGlzcGxheS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiByZW5kZXJJbml0Q2FsbGJhY2soKSB7CiAgICAgIC8vIEZhZGUgaWYgc3BlY2lmaWVkCiAgICAgIGlmIChjb25maWcuc2NlbmVGYWRlRHVyYXRpb24gJiYgcmVuZGVyZXIuZmFkZUltZyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmVuZGVyZXIuZmFkZUltZy5zdHlsZS5vcGFjaXR5ID0gMDsgLy8gUmVtb3ZlIGltYWdlCgogICAgICAgIHZhciBmYWRlSW1nID0gcmVuZGVyZXIuZmFkZUltZzsKICAgICAgICBkZWxldGUgcmVuZGVyZXIuZmFkZUltZzsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJlbmRlckNvbnRhaW5lci5yZW1vdmVDaGlsZChmYWRlSW1nKTsKICAgICAgICAgIGZpcmVFdmVudCgnc2NlbmVjaGFuZ2VmYWRlZG9uZScpOwogICAgICAgIH0sIGNvbmZpZy5zY2VuZUZhZGVEdXJhdGlvbik7CiAgICAgIH0gLy8gU2hvdyBjb21wYXNzIGlmIGFwcGxpY2FibGUKCgogICAgICBpZiAoY29uZmlnLmNvbXBhc3MpIHsKICAgICAgICBjb21wYXNzLnN0eWxlLmRpc3BsYXkgPSAnaW5saW5lJzsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb21wYXNzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgIH0gLy8gU2hvdyBob3RzcG90cwoKCiAgICAgIGNyZWF0ZUhvdFNwb3RzKCk7IC8vIEhpZGUgbG9hZGluZyBkaXNwbGF5CgogICAgICBpbmZvRGlzcGxheS5sb2FkLmJveC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgICAgaWYgKHByZXZpZXcgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJlbmRlckNvbnRhaW5lci5yZW1vdmVDaGlsZChwcmV2aWV3KTsKICAgICAgICBwcmV2aWV3ID0gdW5kZWZpbmVkOwogICAgICB9CgogICAgICBsb2FkZWQgPSB0cnVlOwogICAgICBmaXJlRXZlbnQoJ2xvYWQnKTsKICAgICAgYW5pbWF0ZUluaXQoKTsKICAgIH0KICAgIC8qKg0KICAgICAqIENyZWF0ZXMgaG90IHNwb3QgZWxlbWVudCBmb3IgdGhlIGN1cnJlbnQgc2NlbmUuDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge09iamVjdH0gaHMgLSBUaGUgY29uZmlndXJhdGlvbiBmb3IgdGhlIGhvdHNwb3QNCiAgICAgKi8KCgogICAgZnVuY3Rpb24gY3JlYXRlSG90U3BvdChocykgewogICAgICAvLyBNYWtlIHN1cmUgaG90IHNwb3QgcGl0Y2ggYW5kIHlhdyBhcmUgbnVtYmVycwogICAgICBocy5waXRjaCA9IE51bWJlcihocy5waXRjaCkgfHwgMDsKICAgICAgaHMueWF3ID0gTnVtYmVyKGhzLnlhdykgfHwgMDsKICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICBkaXYuY2xhc3NOYW1lID0gJ3BubG0taG90c3BvdC1iYXNlJzsKICAgICAgaWYgKGhzLmNzc0NsYXNzKSBkaXYuY2xhc3NOYW1lICs9ICcgJyArIGhzLmNzc0NsYXNzO2Vsc2UgZGl2LmNsYXNzTmFtZSArPSAnIHBubG0taG90c3BvdCBwbmxtLXNwcml0ZSBwbmxtLScgKyBlc2NhcGVIVE1MKGhzLnR5cGUpOwogICAgICB2YXIgc3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgaWYgKGhzLnRleHQpIHNwYW4uaW5uZXJIVE1MID0gZXNjYXBlSFRNTChocy50ZXh0KTsKICAgICAgdmFyIGE7CgogICAgICBpZiAoaHMudmlkZW8pIHsKICAgICAgICB2YXIgdmlkZW8gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd2aWRlbycpLAogICAgICAgICAgICB2aWRwID0gaHMudmlkZW87CiAgICAgICAgaWYgKGNvbmZpZy5iYXNlUGF0aCAmJiAhYWJzb2x1dGVVUkwodmlkcCkpIHZpZHAgPSBjb25maWcuYmFzZVBhdGggKyB2aWRwOwogICAgICAgIHZpZGVvLnNyYyA9IHNhbml0aXplVVJMKHZpZHApOwogICAgICAgIHZpZGVvLmNvbnRyb2xzID0gdHJ1ZTsKICAgICAgICB2aWRlby5zdHlsZS53aWR0aCA9IGhzLndpZHRoICsgJ3B4JzsKICAgICAgICByZW5kZXJDb250YWluZXIuYXBwZW5kQ2hpbGQoZGl2KTsKICAgICAgICBzcGFuLmFwcGVuZENoaWxkKHZpZGVvKTsKICAgICAgfSBlbHNlIGlmIChocy5pbWFnZSkgewogICAgICAgIHZhciBpbWdwID0gaHMuaW1hZ2U7CiAgICAgICAgaWYgKGNvbmZpZy5iYXNlUGF0aCAmJiAhYWJzb2x1dGVVUkwoaW1ncCkpIGltZ3AgPSBjb25maWcuYmFzZVBhdGggKyBpbWdwOwogICAgICAgIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgYS5ocmVmID0gc2FuaXRpemVVUkwoaHMuVVJMID8gaHMuVVJMIDogaW1ncCwgdHJ1ZSk7CiAgICAgICAgYS50YXJnZXQgPSAnX2JsYW5rJzsKICAgICAgICBzcGFuLmFwcGVuZENoaWxkKGEpOwogICAgICAgIHZhciBpbWFnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpOwogICAgICAgIGltYWdlLnNyYyA9IHNhbml0aXplVVJMKGltZ3ApOwogICAgICAgIGltYWdlLnN0eWxlLndpZHRoID0gaHMud2lkdGggKyAncHgnOwogICAgICAgIGltYWdlLnN0eWxlLnBhZGRpbmdUb3AgPSAnNXB4JzsKICAgICAgICByZW5kZXJDb250YWluZXIuYXBwZW5kQ2hpbGQoZGl2KTsKICAgICAgICBhLmFwcGVuZENoaWxkKGltYWdlKTsKICAgICAgICBzcGFuLnN0eWxlLm1heFdpZHRoID0gJ2luaXRpYWwnOwogICAgICB9IGVsc2UgaWYgKGhzLlVSTCkgewogICAgICAgIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgYS5ocmVmID0gc2FuaXRpemVVUkwoaHMuVVJMLCB0cnVlKTsKCiAgICAgICAgaWYgKGhzLmF0dHJpYnV0ZXMpIHsKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBocy5hdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgIGEuc2V0QXR0cmlidXRlKGtleSwgaHMuYXR0cmlidXRlc1trZXldKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgYS50YXJnZXQgPSAnX2JsYW5rJzsKICAgICAgICB9CgogICAgICAgIHJlbmRlckNvbnRhaW5lci5hcHBlbmRDaGlsZChhKTsKICAgICAgICBkaXYuY2xhc3NOYW1lICs9ICcgcG5sbS1wb2ludGVyJzsKICAgICAgICBzcGFuLmNsYXNzTmFtZSArPSAnIHBubG0tcG9pbnRlcic7CiAgICAgICAgYS5hcHBlbmRDaGlsZChkaXYpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChocy5zY2VuZUlkKSB7CiAgICAgICAgICBkaXYub25jbGljayA9IGRpdi5vbnRvdWNoZW5kID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIWRpdi5jbGlja2VkKSB7CiAgICAgICAgICAgICAgZGl2LmNsaWNrZWQgPSB0cnVlOwogICAgICAgICAgICAgIGxvYWRTY2VuZShocy5zY2VuZUlkLCBocy50YXJnZXRQaXRjaCwgaHMudGFyZ2V0WWF3LCBocy50YXJnZXRIZm92KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfTsKCiAgICAgICAgICBkaXYuY2xhc3NOYW1lICs9ICcgcG5sbS1wb2ludGVyJzsKICAgICAgICAgIHNwYW4uY2xhc3NOYW1lICs9ICcgcG5sbS1wb2ludGVyJzsKICAgICAgICB9CgogICAgICAgIHJlbmRlckNvbnRhaW5lci5hcHBlbmRDaGlsZChkaXYpOwogICAgICB9CgogICAgICBpZiAoaHMuY3JlYXRlVG9vbHRpcEZ1bmMpIHsKICAgICAgICBocy5jcmVhdGVUb29sdGlwRnVuYyhkaXYsIGhzLmNyZWF0ZVRvb2x0aXBBcmdzKTsKICAgICAgfSBlbHNlIGlmIChocy50ZXh0IHx8IGhzLnZpZGVvIHx8IGhzLmltYWdlKSB7CiAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoJ3BubG0tdG9vbHRpcCcpOwogICAgICAgIGRpdi5hcHBlbmRDaGlsZChzcGFuKTsKICAgICAgICBzcGFuLnN0eWxlLndpZHRoID0gc3Bhbi5zY3JvbGxXaWR0aCAtIDIwICsgJ3B4JzsKICAgICAgICBzcGFuLnN0eWxlLm1hcmdpbkxlZnQgPSAtKHNwYW4uc2Nyb2xsV2lkdGggLSBkaXYub2Zmc2V0V2lkdGgpIC8gMiArICdweCc7CiAgICAgICAgc3Bhbi5zdHlsZS5tYXJnaW5Ub3AgPSAtc3Bhbi5zY3JvbGxIZWlnaHQgLSAxMiArICdweCc7CiAgICAgIH0KCiAgICAgIGlmIChocy5jbGlja0hhbmRsZXJGdW5jKSB7CiAgICAgICAgZGl2LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIGhzLmNsaWNrSGFuZGxlckZ1bmMoZSwgaHMuY2xpY2tIYW5kbGVyQXJncyk7CiAgICAgICAgfSwgJ2ZhbHNlJyk7CiAgICAgICAgZGl2LmNsYXNzTmFtZSArPSAnIHBubG0tcG9pbnRlcic7CiAgICAgICAgc3Bhbi5jbGFzc05hbWUgKz0gJyBwbmxtLXBvaW50ZXInOwogICAgICB9CgogICAgICBocy5kaXYgPSBkaXY7CiAgICB9CiAgICAvKioNCiAgICAgKiBDcmVhdGVzIGhvdCBzcG90IGVsZW1lbnRzIGZvciB0aGUgY3VycmVudCBzY2VuZS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBjcmVhdGVIb3RTcG90cygpIHsKICAgICAgaWYgKGhvdHNwb3RzQ3JlYXRlZCkgcmV0dXJuOwoKICAgICAgaWYgKCFjb25maWcuaG90U3BvdHMpIHsKICAgICAgICBjb25maWcuaG90U3BvdHMgPSBbXTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTb3J0IGJ5IHBpdGNoIHNvIHRvb2x0aXAgaXMgbmV2ZXIgb2JzY3VyZWQgYnkgYW5vdGhlciBob3Qgc3BvdAogICAgICAgIGNvbmZpZy5ob3RTcG90cyA9IGNvbmZpZy5ob3RTcG90cy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYS5waXRjaCA8IGIucGl0Y2g7CiAgICAgICAgfSk7CiAgICAgICAgY29uZmlnLmhvdFNwb3RzLmZvckVhY2goY3JlYXRlSG90U3BvdCk7CiAgICAgIH0KCiAgICAgIGhvdHNwb3RzQ3JlYXRlZCA9IHRydWU7CiAgICAgIHJlbmRlckhvdFNwb3RzKCk7CiAgICB9CiAgICAvKioNCiAgICAgKiBEZXN0cm95cyBjdXJyZW50bHkgY3JlYXRlZCBob3Qgc3BvdCBlbGVtZW50cy4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBkZXN0cm95SG90U3BvdHMoKSB7CiAgICAgIHZhciBocyA9IGNvbmZpZy5ob3RTcG90czsKICAgICAgaG90c3BvdHNDcmVhdGVkID0gZmFsc2U7CiAgICAgIGRlbGV0ZSBjb25maWcuaG90U3BvdHM7CgogICAgICBpZiAoaHMpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgY3VycmVudCA9IGhzW2ldLmRpdjsKCiAgICAgICAgICBpZiAoY3VycmVudCkgewogICAgICAgICAgICB3aGlsZSAoY3VycmVudC5wYXJlbnROb2RlICYmIGN1cnJlbnQucGFyZW50Tm9kZSAhPSByZW5kZXJDb250YWluZXIpIHsKICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC5wYXJlbnROb2RlOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZW5kZXJDb250YWluZXIucmVtb3ZlQ2hpbGQoY3VycmVudCk7CiAgICAgICAgICB9CgogICAgICAgICAgZGVsZXRlIGhzW2ldLmRpdjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKg0KICAgICAqIFJlbmRlcnMgaG90IHNwb3QsIHVwZGF0aW5nIGl0cyBwb3NpdGlvbiBhbmQgdmlzaWJpbGl0eS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiByZW5kZXJIb3RTcG90KGhzKSB7CiAgICAgIHZhciBoc1BpdGNoU2luID0gTWF0aC5zaW4oaHMucGl0Y2ggKiBNYXRoLlBJIC8gMTgwKSwKICAgICAgICAgIGhzUGl0Y2hDb3MgPSBNYXRoLmNvcyhocy5waXRjaCAqIE1hdGguUEkgLyAxODApLAogICAgICAgICAgY29uZmlnUGl0Y2hTaW4gPSBNYXRoLnNpbihjb25maWcucGl0Y2ggKiBNYXRoLlBJIC8gMTgwKSwKICAgICAgICAgIGNvbmZpZ1BpdGNoQ29zID0gTWF0aC5jb3MoY29uZmlnLnBpdGNoICogTWF0aC5QSSAvIDE4MCksCiAgICAgICAgICB5YXdDb3MgPSBNYXRoLmNvcygoLWhzLnlhdyArIGNvbmZpZy55YXcpICogTWF0aC5QSSAvIDE4MCk7CiAgICAgIHZhciB6ID0gaHNQaXRjaFNpbiAqIGNvbmZpZ1BpdGNoU2luICsgaHNQaXRjaENvcyAqIHlhd0NvcyAqIGNvbmZpZ1BpdGNoQ29zOwoKICAgICAgaWYgKGhzLnlhdyA8PSA5MCAmJiBocy55YXcgPiAtOTAgJiYgeiA8PSAwIHx8IChocy55YXcgPiA5MCB8fCBocy55YXcgPD0gLTkwKSAmJiB6IDw9IDApIHsKICAgICAgICBocy5kaXYuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciB5YXdTaW4gPSBNYXRoLnNpbigoLWhzLnlhdyArIGNvbmZpZy55YXcpICogTWF0aC5QSSAvIDE4MCksCiAgICAgICAgICAgIGhmb3ZUYW4gPSBNYXRoLnRhbihjb25maWcuaGZvdiAqIE1hdGguUEkgLyAzNjApOwogICAgICAgIGhzLmRpdi5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOyAvLyBTdWJwaXhlbCByZW5kZXJpbmcgZG9lc24ndCB3b3JrIGluIEZpcmVmb3gKICAgICAgICAvLyBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD03MzkxNzYKCiAgICAgICAgdmFyIGNhbnZhcyA9IHJlbmRlcmVyLmdldENhbnZhcygpLAogICAgICAgICAgICBjYW52YXNXaWR0aCA9IGNhbnZhcy5jbGllbnRXaWR0aCwKICAgICAgICAgICAgY2FudmFzSGVpZ2h0ID0gY2FudmFzLmNsaWVudEhlaWdodDsKICAgICAgICB2YXIgY29vcmQgPSBbLWNhbnZhc1dpZHRoIC8gaGZvdlRhbiAqIHlhd1NpbiAqIGhzUGl0Y2hDb3MgLyB6IC8gMiwgLWNhbnZhc1dpZHRoIC8gaGZvdlRhbiAqIChoc1BpdGNoU2luICogY29uZmlnUGl0Y2hDb3MgLSBoc1BpdGNoQ29zICogeWF3Q29zICogY29uZmlnUGl0Y2hTaW4pIC8geiAvIDJdOyAvLyBBcHBseSByb2xsCgogICAgICAgIHZhciByb2xsU2luID0gTWF0aC5zaW4oY29uZmlnLnJvbGwgKiBNYXRoLlBJIC8gMTgwKSwKICAgICAgICAgICAgcm9sbENvcyA9IE1hdGguY29zKGNvbmZpZy5yb2xsICogTWF0aC5QSSAvIDE4MCk7CiAgICAgICAgY29vcmQgPSBbY29vcmRbMF0gKiByb2xsQ29zIC0gY29vcmRbMV0gKiByb2xsU2luLCBjb29yZFswXSAqIHJvbGxTaW4gKyBjb29yZFsxXSAqIHJvbGxDb3NdOyAvLyBBcHBseSB0cmFuc2Zvcm0KCiAgICAgICAgY29vcmRbMF0gKz0gKGNhbnZhc1dpZHRoIC0gaHMuZGl2Lm9mZnNldFdpZHRoKSAvIDI7CiAgICAgICAgY29vcmRbMV0gKz0gKGNhbnZhc0hlaWdodCAtIGhzLmRpdi5vZmZzZXRIZWlnaHQpIC8gMjsKICAgICAgICB2YXIgdHJhbnNmb3JtID0gJ3RyYW5zbGF0ZSgnICsgY29vcmRbMF0gKyAncHgsICcgKyBjb29yZFsxXSArICdweCkgdHJhbnNsYXRlWig5OTk5cHgpIHJvdGF0ZSgnICsgY29uZmlnLnJvbGwgKyAnZGVnKSc7CgogICAgICAgIGlmIChocy5zY2FsZSkgewogICAgICAgICAgdHJhbnNmb3JtICs9ICcgc2NhbGUoJyArIG9yaWdIZm92IC8gY29uZmlnLmhmb3YgLyB6ICsgJyknOwogICAgICAgIH0KCiAgICAgICAgaHMuZGl2LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IHRyYW5zZm9ybTsKICAgICAgICBocy5kaXYuc3R5bGUuTW96VHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgICAgIGhzLmRpdi5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CiAgICAgIH0KICAgIH0KICAgIC8qKg0KICAgICAqIFJlbmRlcnMgaG90IHNwb3RzLCB1cGRhdGluZyB0aGVpciBwb3NpdGlvbnMgYW5kIHZpc2liaWxpdHkuDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KCgogICAgZnVuY3Rpb24gcmVuZGVySG90U3BvdHMoKSB7CiAgICAgIGNvbmZpZy5ob3RTcG90cy5mb3JFYWNoKHJlbmRlckhvdFNwb3QpOwogICAgfQogICAgLyoqDQogICAgICogTWVyZ2VzIGEgc2NlbmUgY29uZmlndXJhdGlvbiBpbnRvIHRoZSBjdXJyZW50IGNvbmZpZ3VyYXRpb24uDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2NlbmVJZCAtIElkZW50aWZpZXIgb2Ygc2NlbmUgY29uZmlndXJhdGlvbiB0byBtZXJnZSBpbi4NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gbWVyZ2VDb25maWcoc2NlbmVJZCkgewogICAgICBjb25maWcgPSB7fTsKICAgICAgdmFyIGssIHM7CiAgICAgIHZhciBwaG90b1NwaGVyZUV4Y2x1ZGVzID0gWydoYW92JywgJ3Zhb3YnLCAndk9mZnNldCcsICdub3J0aE9mZnNldCcsICdob3Jpem9uUGl0Y2gnLCAnaG9yaXpvblJvbGwnXTsKICAgICAgc3BlY2lmaWVkUGhvdG9TcGhlcmVFeGNsdWRlcyA9IFtdOyAvLyBNZXJnZSBkZWZhdWx0IGNvbmZpZwoKICAgICAgZm9yIChrIGluIGRlZmF1bHRDb25maWcpIHsKICAgICAgICBpZiAoZGVmYXVsdENvbmZpZy5oYXNPd25Qcm9wZXJ0eShrKSkgewogICAgICAgICAgY29uZmlnW2tdID0gZGVmYXVsdENvbmZpZ1trXTsKICAgICAgICB9CiAgICAgIH0gLy8gTWVyZ2UgZGVmYXVsdCBzY2VuZSBjb25maWcKCgogICAgICBmb3IgKGsgaW4gaW5pdGlhbENvbmZpZy5kZWZhdWx0KSB7CiAgICAgICAgaWYgKGluaXRpYWxDb25maWcuZGVmYXVsdC5oYXNPd25Qcm9wZXJ0eShrKSkgewogICAgICAgICAgaWYgKGsgPT0gJ3N0cmluZ3MnKSB7CiAgICAgICAgICAgIGZvciAocyBpbiBpbml0aWFsQ29uZmlnLmRlZmF1bHQuc3RyaW5ncykgewogICAgICAgICAgICAgIGlmIChpbml0aWFsQ29uZmlnLmRlZmF1bHQuc3RyaW5ncy5oYXNPd25Qcm9wZXJ0eShzKSkgewogICAgICAgICAgICAgICAgY29uZmlnLnN0cmluZ3Nbc10gPSBlc2NhcGVIVE1MKGluaXRpYWxDb25maWcuZGVmYXVsdC5zdHJpbmdzW3NdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ1trXSA9IGluaXRpYWxDb25maWcuZGVmYXVsdFtrXTsKCiAgICAgICAgICAgIGlmIChwaG90b1NwaGVyZUV4Y2x1ZGVzLmluZGV4T2YoaykgPj0gMCkgewogICAgICAgICAgICAgIHNwZWNpZmllZFBob3RvU3BoZXJlRXhjbHVkZXMucHVzaChrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAvLyBNZXJnZSBjdXJyZW50IHNjZW5lIGNvbmZpZwoKCiAgICAgIGlmIChzY2VuZUlkICE9PSBudWxsICYmIHNjZW5lSWQgIT09ICcnICYmIGluaXRpYWxDb25maWcuc2NlbmVzICYmIGluaXRpYWxDb25maWcuc2NlbmVzW3NjZW5lSWRdKSB7CiAgICAgICAgdmFyIHNjZW5lID0gaW5pdGlhbENvbmZpZy5zY2VuZXNbc2NlbmVJZF07CgogICAgICAgIGZvciAoayBpbiBzY2VuZSkgewogICAgICAgICAgaWYgKHNjZW5lLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICAgIGlmIChrID09ICdzdHJpbmdzJykgewogICAgICAgICAgICAgIGZvciAocyBpbiBzY2VuZS5zdHJpbmdzKSB7CiAgICAgICAgICAgICAgICBpZiAoc2NlbmUuc3RyaW5ncy5oYXNPd25Qcm9wZXJ0eShzKSkgewogICAgICAgICAgICAgICAgICBjb25maWcuc3RyaW5nc1tzXSA9IGVzY2FwZUhUTUwoc2NlbmUuc3RyaW5nc1tzXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbmZpZ1trXSA9IHNjZW5lW2tdOwoKICAgICAgICAgICAgICBpZiAocGhvdG9TcGhlcmVFeGNsdWRlcy5pbmRleE9mKGspID49IDApIHsKICAgICAgICAgICAgICAgIHNwZWNpZmllZFBob3RvU3BoZXJlRXhjbHVkZXMucHVzaChrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNvbmZpZy5zY2VuZSA9IHNjZW5lSWQ7CiAgICAgIH0gLy8gTWVyZ2UgaW5pdGlhbCBjb25maWcKCgogICAgICBmb3IgKGsgaW4gaW5pdGlhbENvbmZpZykgewogICAgICAgIGlmIChpbml0aWFsQ29uZmlnLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgICAgICBpZiAoayA9PSAnc3RyaW5ncycpIHsKICAgICAgICAgICAgZm9yIChzIGluIGluaXRpYWxDb25maWcuc3RyaW5ncykgewogICAgICAgICAgICAgIGlmIChpbml0aWFsQ29uZmlnLnN0cmluZ3MuaGFzT3duUHJvcGVydHkocykpIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5zdHJpbmdzW3NdID0gZXNjYXBlSFRNTChpbml0aWFsQ29uZmlnLnN0cmluZ3Nbc10pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlnW2tdID0gaW5pdGlhbENvbmZpZ1trXTsKCiAgICAgICAgICAgIGlmIChwaG90b1NwaGVyZUV4Y2x1ZGVzLmluZGV4T2YoaykgPj0gMCkgewogICAgICAgICAgICAgIHNwZWNpZmllZFBob3RvU3BoZXJlRXhjbHVkZXMucHVzaChrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqDQogICAgICogUHJvY2Vzc2VzIGNvbmZpZ3VyYXRpb24gb3B0aW9ucy4NCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc1ByZXZpZXddIC0gV2hldGhlciBvciBub3QgdGhlIHByZXZpZXcgaXMgYmVpbmcgZGlzcGxheWVkDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KCgogICAgZnVuY3Rpb24gcHJvY2Vzc09wdGlvbnMoaXNQcmV2aWV3KSB7CiAgICAgIGlzUHJldmlldyA9IGlzUHJldmlldyA/IGlzUHJldmlldyA6IGZhbHNlOyAvLyBQcm9jZXNzIHByZXZpZXcgZmlyc3Qgc28gaXQgYWx3YXlzIGxvYWRzIGJlZm9yZSB0aGUgYnJvd3NlciBoaXRzIGl0cwogICAgICAvLyBtYXhpbXVtIG51bWJlciBvZiBjb25uZWN0aW9ucyB0byBhIHNlcnZlciBhcyBjYW4gaGFwcGVuIHdpdGggY3ViaWMKICAgICAgLy8gcGFub3JhbWFzCgogICAgICBpZiAoaXNQcmV2aWV3ICYmICdwcmV2aWV3JyBpbiBjb25maWcpIHsKICAgICAgICB2YXIgcCA9IGNvbmZpZy5wcmV2aWV3OwogICAgICAgIGlmIChjb25maWcuYmFzZVBhdGggJiYgIWFic29sdXRlVVJMKHApKSBwID0gY29uZmlnLmJhc2VQYXRoICsgcDsKICAgICAgICBwcmV2aWV3ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgcHJldmlldy5jbGFzc05hbWUgPSAncG5sbS1wcmV2aWV3LWltZyc7CiAgICAgICAgcHJldmlldy5zdHlsZS5iYWNrZ3JvdW5kSW1hZ2UgPSAidXJsKCciICsgc2FuaXRpemVVUkxGb3JDc3MocCkgKyAiJykiOwogICAgICAgIHJlbmRlckNvbnRhaW5lci5hcHBlbmRDaGlsZChwcmV2aWV3KTsKICAgICAgfSAvLyBIYW5kbGUgZGlmZmVyZW50IHByZXZpZXcgdmFsdWVzCgoKICAgICAgdmFyIHRpdGxlID0gY29uZmlnLnRpdGxlLAogICAgICAgICAgYXV0aG9yID0gY29uZmlnLmF1dGhvcjsKCiAgICAgIGlmIChpc1ByZXZpZXcpIHsKICAgICAgICBpZiAoJ3ByZXZpZXdUaXRsZScgaW4gY29uZmlnKSBjb25maWcudGl0bGUgPSBjb25maWcucHJldmlld1RpdGxlOwogICAgICAgIGlmICgncHJldmlld0F1dGhvcicgaW4gY29uZmlnKSBjb25maWcuYXV0aG9yID0gY29uZmlnLnByZXZpZXdBdXRob3I7CiAgICAgIH0gLy8gUmVzZXQgdGl0bGUgLyBhdXRob3IgZGlzcGxheQoKCiAgICAgIGlmICghY29uZmlnLmhhc093blByb3BlcnR5KCd0aXRsZScpKSBpbmZvRGlzcGxheS50aXRsZS5pbm5lckhUTUwgPSAnJzsKICAgICAgaWYgKCFjb25maWcuaGFzT3duUHJvcGVydHkoJ2F1dGhvcicpKSBpbmZvRGlzcGxheS5hdXRob3IuaW5uZXJIVE1MID0gJyc7CiAgICAgIGlmICghY29uZmlnLmhhc093blByb3BlcnR5KCd0aXRsZScpICYmICFjb25maWcuaGFzT3duUHJvcGVydHkoJ2F1dGhvcicpKSBpbmZvRGlzcGxheS5jb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJzsgLy8gRmlsbCBpbiBsb2FkIGJ1dHRvbiBsYWJlbCBhbmQgbG9hZGluZyBib3ggdGV4dAoKICAgICAgY29udHJvbHMubG9hZC5pbm5lckhUTUwgPSAnPHA+JyArIGNvbmZpZy5zdHJpbmdzLmxvYWRCdXR0b25MYWJlbCArICc8L3A+JzsKICAgICAgaW5mb0Rpc3BsYXkubG9hZC5ib3hwLmlubmVySFRNTCA9IGNvbmZpZy5zdHJpbmdzLmxvYWRpbmdMYWJlbDsgLy8gUHJvY2VzcyBvdGhlciBvcHRpb25zCgogICAgICBmb3IgKHZhciBrZXkgaW4gY29uZmlnKSB7CiAgICAgICAgaWYgKGNvbmZpZy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICBzd2l0Y2ggKGtleSkgewogICAgICAgICAgICBjYXNlICd0aXRsZSc6CiAgICAgICAgICAgICAgaW5mb0Rpc3BsYXkudGl0bGUuaW5uZXJIVE1MID0gZXNjYXBlSFRNTChjb25maWdba2V5XSk7CiAgICAgICAgICAgICAgaW5mb0Rpc3BsYXkuY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnaW5saW5lJzsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ2F1dGhvcic6CiAgICAgICAgICAgICAgdmFyIGF1dGhvclRleHQgPSBlc2NhcGVIVE1MKGNvbmZpZ1trZXldKTsKCiAgICAgICAgICAgICAgaWYgKGNvbmZpZy5hdXRob3JVUkwpIHsKICAgICAgICAgICAgICAgIHZhciBhdXRob3JMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICAgICAgYXV0aG9yTGluay5ocmVmID0gc2FuaXRpemVVUkwoY29uZmlnWydhdXRob3JVUkwnXSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBhdXRob3JMaW5rLnRhcmdldCA9ICdfYmxhbmsnOwogICAgICAgICAgICAgICAgYXV0aG9yTGluay5pbm5lckhUTUwgPSBlc2NhcGVIVE1MKGNvbmZpZ1trZXldKTsKICAgICAgICAgICAgICAgIGF1dGhvclRleHQgPSBhdXRob3JMaW5rLm91dGVySFRNTDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGluZm9EaXNwbGF5LmF1dGhvci5pbm5lckhUTUwgPSBjb25maWcuc3RyaW5ncy5ieWxpbmVMYWJlbC5yZXBsYWNlKCclcycsIGF1dGhvclRleHQpOwogICAgICAgICAgICAgIGluZm9EaXNwbGF5LmNvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2lubGluZSc7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICdmYWxsYmFjayc6CiAgICAgICAgICAgICAgdmFyIGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgICAgbGluay5ocmVmID0gc2FuaXRpemVVUkwoY29uZmlnW2tleV0sIHRydWUpOwogICAgICAgICAgICAgIGxpbmsudGFyZ2V0ID0gJ19ibGFuayc7CiAgICAgICAgICAgICAgbGluay50ZXh0Q29udGVudCA9ICdDbGljayBoZXJlIHRvIHZpZXcgdGhpcyBwYW5vcmFtYSBpbiBhbiBhbHRlcm5hdGl2ZSB2aWV3ZXIuJzsKICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTsKICAgICAgICAgICAgICBtZXNzYWdlLnRleHRDb250ZW50ID0gJ1lvdXIgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IFdlYkdMLic7CiAgICAgICAgICAgICAgbWVzc2FnZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdicicpKTsKICAgICAgICAgICAgICBtZXNzYWdlLmFwcGVuZENoaWxkKGxpbmspOwogICAgICAgICAgICAgIGluZm9EaXNwbGF5LmVycm9yTXNnLmlubmVySFRNTCA9ICcnOyAvLyBSZW1vdmVzIGFsbCBjaGlsZHJlbiBub2RlcwoKICAgICAgICAgICAgICBpbmZvRGlzcGxheS5lcnJvck1zZy5hcHBlbmRDaGlsZChtZXNzYWdlKTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ2hmb3YnOgogICAgICAgICAgICAgIHNldEhmb3YoTnVtYmVyKGNvbmZpZ1trZXldKSk7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICdhdXRvTG9hZCc6CiAgICAgICAgICAgICAgaWYgKGNvbmZpZ1trZXldID09PSB0cnVlICYmIHJlbmRlcmVyID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIC8vIFNob3cgbG9hZGluZyBib3gKICAgICAgICAgICAgICAgIGluZm9EaXNwbGF5LmxvYWQuYm94LnN0eWxlLmRpc3BsYXkgPSAnaW5saW5lJzsgLy8gSGlkZSBsb2FkIGJ1dHRvbgoKICAgICAgICAgICAgICAgIGNvbnRyb2xzLmxvYWQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsgLy8gSW5pdGlhbGl6ZQoKICAgICAgICAgICAgICAgIGluaXQoKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnc2hvd1pvb21DdHJsJzoKICAgICAgICAgICAgICBpZiAoY29uZmlnW2tleV0gJiYgY29uZmlnLnNob3dDb250cm9scyAhPSBmYWxzZSkgewogICAgICAgICAgICAgICAgLy8gU2hvdyB6b29tIGNvbnRyb2xzCiAgICAgICAgICAgICAgICBjb250cm9scy56b29tLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBIaWRlIHpvb20gY29udHJvbHMKICAgICAgICAgICAgICAgIGNvbnRyb2xzLnpvb20uc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnc2hvd0Z1bGxzY3JlZW5DdHJsJzoKICAgICAgICAgICAgICBpZiAoY29uZmlnW2tleV0gJiYgY29uZmlnLnNob3dDb250cm9scyAhPSBmYWxzZSAmJiAoJ2Z1bGxzY3JlZW4nIGluIGRvY3VtZW50IHx8ICdtb3pGdWxsU2NyZWVuJyBpbiBkb2N1bWVudCB8fCAnd2Via2l0SXNGdWxsU2NyZWVuJyBpbiBkb2N1bWVudCB8fCAnbXNGdWxsc2NyZWVuRWxlbWVudCcgaW4gZG9jdW1lbnQpKSB7CiAgICAgICAgICAgICAgICAvLyBTaG93IGZ1bGxzY3JlZW4gY29udHJvbAogICAgICAgICAgICAgICAgY29udHJvbHMuZnVsbHNjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gSGlkZSBmdWxsc2NyZWVuIGNvbnRyb2wKICAgICAgICAgICAgICAgIGNvbnRyb2xzLmZ1bGxzY3JlZW4uc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnaG90U3BvdERlYnVnJzoKICAgICAgICAgICAgICBpZiAoY29uZmlnW2tleV0pIGhvdFNwb3REZWJ1Z0luZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztlbHNlIGhvdFNwb3REZWJ1Z0luZGljYXRvci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnc2hvd0NvbnRyb2xzJzoKICAgICAgICAgICAgICBpZiAoIWNvbmZpZ1trZXldKSB7CiAgICAgICAgICAgICAgICBjb250cm9scy5vcmllbnRhdGlvbi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgY29udHJvbHMuem9vbS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgY29udHJvbHMuZnVsbHNjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICdvcmllbnRhdGlvbk9uQnlEZWZhdWx0JzoKICAgICAgICAgICAgICBpZiAoY29uZmlnW2tleV0pIHN0YXJ0T3JpZW50YXRpb24oKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChpc1ByZXZpZXcpIHsKICAgICAgICAvLyBSZXN0b3JlIG9yaWdpbmFsIHZhbHVlcyBpZiBjaGFuZ2VkIGZvciBwcmV2aWV3CiAgICAgICAgaWYgKHRpdGxlKSBjb25maWcudGl0bGUgPSB0aXRsZTtlbHNlIGRlbGV0ZSBjb25maWcudGl0bGU7CiAgICAgICAgaWYgKGF1dGhvcikgY29uZmlnLmF1dGhvciA9IGF1dGhvcjtlbHNlIGRlbGV0ZSBjb25maWcuYXV0aG9yOwogICAgICB9CiAgICB9CiAgICAvKioNCiAgICAgKiBUb2dnbGVzIGZ1bGxzY3JlZW4gbW9kZS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiB0b2dnbGVGdWxsc2NyZWVuKCkgewogICAgICBpZiAobG9hZGVkICYmICFlcnJvcikgewogICAgICAgIGlmICghZnVsbHNjcmVlbkFjdGl2ZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5yZXF1ZXN0RnVsbHNjcmVlbikgewogICAgICAgICAgICAgIGNvbnRhaW5lci5yZXF1ZXN0RnVsbHNjcmVlbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRhaW5lci5tb3pSZXF1ZXN0RnVsbFNjcmVlbikgewogICAgICAgICAgICAgIGNvbnRhaW5lci5tb3pSZXF1ZXN0RnVsbFNjcmVlbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRhaW5lci5tc1JlcXVlc3RGdWxsc2NyZWVuKSB7CiAgICAgICAgICAgICAgY29udGFpbmVyLm1zUmVxdWVzdEZ1bGxzY3JlZW4oKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb250YWluZXIud2Via2l0UmVxdWVzdEZ1bGxTY3JlZW4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZXZlbnQpIHsvLyBGdWxsc2NyZWVuIGRvZXNuJ3Qgd29yawogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoZG9jdW1lbnQuZXhpdEZ1bGxzY3JlZW4pIHsKICAgICAgICAgICAgZG9jdW1lbnQuZXhpdEZ1bGxzY3JlZW4oKTsKICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQubW96Q2FuY2VsRnVsbFNjcmVlbikgewogICAgICAgICAgICBkb2N1bWVudC5tb3pDYW5jZWxGdWxsU2NyZWVuKCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50LndlYmtpdENhbmNlbEZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgZG9jdW1lbnQud2Via2l0Q2FuY2VsRnVsbFNjcmVlbigpOwogICAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5tc0V4aXRGdWxsc2NyZWVuKSB7CiAgICAgICAgICAgIGRvY3VtZW50Lm1zRXhpdEZ1bGxzY3JlZW4oKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKg0KICAgICAqIEV2ZW50IGhhbmRsZXIgZm9yIGZ1bGxzY3JlZW4gY2hhbmdlcy4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBvbkZ1bGxTY3JlZW5DaGFuZ2UocmVzaXplKSB7CiAgICAgIGlmIChkb2N1bWVudC5mdWxsc2NyZWVuRWxlbWVudCB8fCBkb2N1bWVudC5mdWxsc2NyZWVuIHx8IGRvY3VtZW50Lm1vekZ1bGxTY3JlZW4gfHwgZG9jdW1lbnQud2Via2l0SXNGdWxsU2NyZWVuIHx8IGRvY3VtZW50Lm1zRnVsbHNjcmVlbkVsZW1lbnQpIHsKICAgICAgICBjb250cm9scy5mdWxsc2NyZWVuLmNsYXNzTGlzdC5hZGQoJ3BubG0tZnVsbHNjcmVlbi10b2dnbGUtYnV0dG9uLWFjdGl2ZScpOwogICAgICAgIGZ1bGxzY3JlZW5BY3RpdmUgPSB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnRyb2xzLmZ1bGxzY3JlZW4uY2xhc3NMaXN0LnJlbW92ZSgncG5sbS1mdWxsc2NyZWVuLXRvZ2dsZS1idXR0b24tYWN0aXZlJyk7CiAgICAgICAgZnVsbHNjcmVlbkFjdGl2ZSA9IGZhbHNlOwogICAgICB9CgogICAgICBpZiAocmVzaXplICE9PSAncmVzaXplJykgZmlyZUV2ZW50KCdmdWxsc2NyZWVuY2hhbmdlJywgZnVsbHNjcmVlbkFjdGl2ZSk7IC8vIFJlc2l6ZSByZW5kZXJlciAoZGVhbCB3aXRoIGJyb3dzZXIgcXVpcmtzIGFuZCBmaXhlcyAjMTU1KQoKICAgICAgcmVuZGVyZXIucmVzaXplKCk7CiAgICAgIHNldEhmb3YoY29uZmlnLmhmb3YpOwogICAgICBhbmltYXRlSW5pdCgpOwogICAgfQogICAgLyoqDQogICAgICogSW5jcmVhc2VzIHBhbm9yYW1hIHpvb20uIEZvciB1c2Ugd2l0aCB6b29tIGJ1dHRvbi4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiB6b29tSW4oKSB7CiAgICAgIGlmIChsb2FkZWQpIHsKICAgICAgICBzZXRIZm92KGNvbmZpZy5oZm92IC0gNSk7CiAgICAgICAgYW5pbWF0ZUluaXQoKTsKICAgICAgfQogICAgfQogICAgLyoqDQogICAgICogRGVjcmVhc2VzIHBhbm9yYW1hIHpvb20uIEZvciB1c2Ugd2l0aCB6b29tIGJ1dHRvbi4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiB6b29tT3V0KCkgewogICAgICBpZiAobG9hZGVkKSB7CiAgICAgICAgc2V0SGZvdihjb25maWcuaGZvdiArIDUpOwogICAgICAgIGFuaW1hdGVJbml0KCk7CiAgICAgIH0KICAgIH0KICAgIC8qKg0KICAgICAqIENsYW1wcyBob3J6b250YWwgZmllbGQgb2YgdmlldyB0byB2aWV3ZXIncyBsaW1pdHMuDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge251bWJlcn0gaGZvdiAtIElucHV0IGhvcml6b250YWwgZmllbGQgb2YgdmlldyAoaW4gZGVncmVlcykNCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ9IC0gQ2xhbXBlZCBob3Jpem9udGFsIGZpZWxkIG9mIHZpZXcgKGluIGRlZ3JlZXMpDQogICAgICovCgoKICAgIGZ1bmN0aW9uIGNvbnN0cmFpbkhmb3YoaGZvdikgewogICAgICAvLyBLZWVwIGZpZWxkIG9mIHZpZXcgd2l0aGluIGJvdW5kcwogICAgICB2YXIgbWluSGZvdiA9IGNvbmZpZy5taW5IZm92OwoKICAgICAgaWYgKGNvbmZpZy50eXBlID09ICdtdWx0aXJlcycgJiYgcmVuZGVyZXIgJiYgIWNvbmZpZy5tdWx0aVJlc01pbkhmb3YpIHsKICAgICAgICBtaW5IZm92ID0gTWF0aC5taW4obWluSGZvdiwgcmVuZGVyZXIuZ2V0Q2FudmFzKCkud2lkdGggLyAoY29uZmlnLm11bHRpUmVzLmN1YmVSZXNvbHV0aW9uIC8gOTAgKiAwLjkpKTsKICAgICAgfQoKICAgICAgaWYgKG1pbkhmb3YgPiBjb25maWcubWF4SGZvdikgewogICAgICAgIC8vIERvbid0IGNoYW5nZSB2aWV3IGlmIGJvdW5kcyBkb24ndCBtYWtlIHNlbnNlCiAgICAgICAgY29uc29sZS5sb2coJ0hGT1YgYm91bmRzIGRvIG5vdCBtYWtlIHNlbnNlIChtaW5IZm92ID4gbWF4SGZvdikuJyk7CiAgICAgICAgcmV0dXJuIGNvbmZpZy5oZm92OwogICAgICB9CgogICAgICB2YXIgbmV3SGZvdiA9IGNvbmZpZy5oZm92OwoKICAgICAgaWYgKGhmb3YgPCBtaW5IZm92KSB7CiAgICAgICAgbmV3SGZvdiA9IG1pbkhmb3Y7CiAgICAgIH0gZWxzZSBpZiAoaGZvdiA+IGNvbmZpZy5tYXhIZm92KSB7CiAgICAgICAgbmV3SGZvdiA9IGNvbmZpZy5tYXhIZm92OwogICAgICB9IGVsc2UgewogICAgICAgIG5ld0hmb3YgPSBoZm92OwogICAgICB9IC8vIE9wdGlvbmFsbHkgYXZvaWQgc2hvd2luZyBiYWNrZ3JvdW5kIChlbXB0eSBzcGFjZSkgb24gdG9wIG9yIGJvdHRvbSBieSBhZGFwdGluZyBuZXdIZm92CgoKICAgICAgaWYgKGNvbmZpZy5hdm9pZFNob3dpbmdCYWNrZ3JvdW5kICYmIHJlbmRlcmVyKSB7CiAgICAgICAgdmFyIGNhbnZhcyA9IHJlbmRlcmVyLmdldENhbnZhcygpOwogICAgICAgIG5ld0hmb3YgPSBNYXRoLm1pbihuZXdIZm92LCBNYXRoLmF0YW4oTWF0aC50YW4oKGNvbmZpZy5tYXhQaXRjaCAtIGNvbmZpZy5taW5QaXRjaCkgLyAzNjAgKiBNYXRoLlBJKSAvIGNhbnZhcy5oZWlnaHQgKiBjYW52YXMud2lkdGgpICogMzYwIC8gTWF0aC5QSSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBuZXdIZm92OwogICAgfQogICAgLyoqDQogICAgICogU2V0cyB2aWV3ZXIncyBob3Jpem9udGFsIGZpZWxkIG9mIHZpZXcuDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge251bWJlcn0gaGZvdiAtIERlc2lyZWQgaG9yaXpvbnRhbCBmaWVsZCBvZiB2aWV3IGluIGRlZ3JlZXMuDQogICAgICovCgoKICAgIGZ1bmN0aW9uIHNldEhmb3YoaGZvdikgewogICAgICBjb25maWcuaGZvdiA9IGNvbnN0cmFpbkhmb3YoaGZvdik7CiAgICAgIGZpcmVFdmVudCgnem9vbWNoYW5nZScsIGNvbmZpZy5oZm92KTsKICAgIH0KICAgIC8qKg0KICAgICAqIFN0b3BzIGF1dG8gcm90YXRpb24gYW5kIGFuaW1hdGVkIG1vdmVzLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCgoKICAgIGZ1bmN0aW9uIHN0b3BBbmltYXRpb24oKSB7CiAgICAgIGFuaW1hdGVkTW92ZSA9IHt9OwogICAgICBhdXRvUm90YXRlU3BlZWQgPSBjb25maWcuYXV0b1JvdGF0ZSA/IGNvbmZpZy5hdXRvUm90YXRlIDogYXV0b1JvdGF0ZVNwZWVkOwogICAgICBjb25maWcuYXV0b1JvdGF0ZSA9IGZhbHNlOwogICAgfQogICAgLyoqDQogICAgICogTG9hZHMgcGFub3JhbWEuDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KCgogICAgZnVuY3Rpb24gbG9hZCgpIHsKICAgICAgLy8gU2luY2UgV2ViR0wgZXJyb3IgaGFuZGxpbmcgaXMgdmVyeSBnZW5lcmFsLCBmaXJzdCB3ZSBjbGVhciBhbnkgZXJyb3IgYm94CiAgICAgIC8vIHNpbmNlIGl0IGlzIGEgbmV3IHNjZW5lIGFuZCB0aGUgZXJyb3IgZnJvbSBwcmV2aW91cyBtYXliZSBiZWNhdXNlIG9mIGxhY2tpbmcKICAgICAgLy8gbWVtb3J5IGV0YyBhbmQgbm90IGJlY2F1c2Ugb2YgYSBsYWNrIG9mIFdlYkdMIHN1cHBvcnQgZXRjCiAgICAgIGNsZWFyRXJyb3IoKTsKICAgICAgbG9hZGVkID0gZmFsc2U7CiAgICAgIGNvbnRyb2xzLmxvYWQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgaW5mb0Rpc3BsYXkubG9hZC5ib3guc3R5bGUuZGlzcGxheSA9ICdpbmxpbmUnOwogICAgICBpbml0KCk7CiAgICB9CiAgICAvKioNCiAgICAgKiBMb2FkcyBzY2VuZS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzY2VuZUlkIC0gSWRlbnRpZmllciBvZiBzY2VuZSBjb25maWd1cmF0aW9uIHRvIG1lcmdlIGluLg0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB0YXJnZXRQaXRjaCAtIFBpdGNoIHZpZXdlciBzaG91bGQgYmUgY2VudGVyZWQgb24gb25jZSBzY2VuZSBsb2Fkcy4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdGFyZ2V0WWF3IC0gWWF3IHZpZXdlciBzaG91bGQgYmUgY2VudGVyZWQgb24gb25jZSBzY2VuZSBsb2Fkcy4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdGFyZ2V0SGZvdiAtIEhGT1Ygdmlld2VyIHNob3VsZCB1c2Ugb25jZSBzY2VuZSBsb2Fkcy4NCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmYWRlRG9uZV0gLSBJZiBgdHJ1ZWAsIGZhZGUgc2V0dXAgaXMgc2tpcHBlZC4NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gbG9hZFNjZW5lKHNjZW5lSWQsIHRhcmdldFBpdGNoLCB0YXJnZXRZYXcsIHRhcmdldEhmb3YsIGZhZGVEb25lKSB7CiAgICAgIGlmICghbG9hZGVkKSBmYWRlRG9uZSA9IHRydWU7IC8vIERvbid0IHRyeSB0byBmYWRlIHdoZW4gdGhlcmUgaXNuJ3QgYSBzY2VuZSBsb2FkZWQKCiAgICAgIGxvYWRlZCA9IGZhbHNlOwogICAgICBhbmltYXRlZE1vdmUgPSB7fTsgLy8gU2V0IHVwIGZhZGUgaWYgc3BlY2lmaWVkCgogICAgICB2YXIgZmFkZUltZywgd29ya2luZ1BpdGNoLCB3b3JraW5nWWF3LCB3b3JraW5nSGZvdjsKCiAgICAgIGlmIChjb25maWcuc2NlbmVGYWRlRHVyYXRpb24gJiYgIWZhZGVEb25lKSB7CiAgICAgICAgdmFyIGRhdGEgPSByZW5kZXJlci5yZW5kZXIoY29uZmlnLnBpdGNoICogTWF0aC5QSSAvIDE4MCwgY29uZmlnLnlhdyAqIE1hdGguUEkgLyAxODAsIGNvbmZpZy5oZm92ICogTWF0aC5QSSAvIDE4MCwgewogICAgICAgICAgcmV0dXJuSW1hZ2U6IHRydWUKICAgICAgICB9KTsKCiAgICAgICAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgZmFkZUltZyA9IG5ldyBJbWFnZSgpOwogICAgICAgICAgZmFkZUltZy5jbGFzc05hbWUgPSAncG5sbS1mYWRlLWltZyc7CiAgICAgICAgICBmYWRlSW1nLnN0eWxlLnRyYW5zaXRpb24gPSAnb3BhY2l0eSAnICsgY29uZmlnLnNjZW5lRmFkZUR1cmF0aW9uIC8gMTAwMCArICdzJzsKICAgICAgICAgIGZhZGVJbWcuc3R5bGUud2lkdGggPSAnMTAwJSc7CiAgICAgICAgICBmYWRlSW1nLnN0eWxlLmhlaWdodCA9ICcxMDAlJzsKCiAgICAgICAgICBmYWRlSW1nLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgbG9hZFNjZW5lKHNjZW5lSWQsIHRhcmdldFBpdGNoLCB0YXJnZXRZYXcsIHRhcmdldEhmb3YsIHRydWUpOwogICAgICAgICAgfTsKCiAgICAgICAgICBmYWRlSW1nLnNyYyA9IGRhdGE7CiAgICAgICAgICByZW5kZXJDb250YWluZXIuYXBwZW5kQ2hpbGQoZmFkZUltZyk7CiAgICAgICAgICByZW5kZXJlci5mYWRlSW1nID0gZmFkZUltZzsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0gLy8gU2V0IG5ldyBwb2ludGluZwoKCiAgICAgIGlmICh0YXJnZXRQaXRjaCA9PT0gJ3NhbWUnKSB7CiAgICAgICAgd29ya2luZ1BpdGNoID0gY29uZmlnLnBpdGNoOwogICAgICB9IGVsc2UgewogICAgICAgIHdvcmtpbmdQaXRjaCA9IHRhcmdldFBpdGNoOwogICAgICB9CgogICAgICBpZiAodGFyZ2V0WWF3ID09PSAnc2FtZScpIHsKICAgICAgICB3b3JraW5nWWF3ID0gY29uZmlnLnlhdzsKICAgICAgfSBlbHNlIGlmICh0YXJnZXRZYXcgPT09ICdzYW1lQXppbXV0aCcpIHsKICAgICAgICB3b3JraW5nWWF3ID0gY29uZmlnLnlhdyArIChjb25maWcubm9ydGhPZmZzZXQgfHwgMCkgLSAoaW5pdGlhbENvbmZpZy5zY2VuZXNbc2NlbmVJZF0ubm9ydGhPZmZzZXQgfHwgMCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd29ya2luZ1lhdyA9IHRhcmdldFlhdzsKICAgICAgfQoKICAgICAgaWYgKHRhcmdldEhmb3YgPT09ICdzYW1lJykgewogICAgICAgIHdvcmtpbmdIZm92ID0gY29uZmlnLmhmb3Y7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd29ya2luZ0hmb3YgPSB0YXJnZXRIZm92OwogICAgICB9IC8vIERlc3Ryb3kgaG90IHNwb3RzIGZyb20gcHJldmlvdXMgc2NlbmUKCgogICAgICBkZXN0cm95SG90U3BvdHMoKTsgLy8gQ3JlYXRlIHRoZSBuZXcgY29uZmlnIGZvciB0aGUgc2NlbmUKCiAgICAgIG1lcmdlQ29uZmlnKHNjZW5lSWQpOyAvLyBTdG9wIG1vdGlvbgoKICAgICAgc3BlZWQueWF3ID0gc3BlZWQucGl0Y2ggPSBzcGVlZC5oZm92ID0gMDsgLy8gUmVsb2FkIHNjZW5lCgogICAgICBwcm9jZXNzT3B0aW9ucygpOwoKICAgICAgaWYgKHdvcmtpbmdQaXRjaCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgY29uZmlnLnBpdGNoID0gd29ya2luZ1BpdGNoOwogICAgICB9CgogICAgICBpZiAod29ya2luZ1lhdyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgY29uZmlnLnlhdyA9IHdvcmtpbmdZYXc7CiAgICAgIH0KCiAgICAgIGlmICh3b3JraW5nSGZvdiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgY29uZmlnLmhmb3YgPSB3b3JraW5nSGZvdjsKICAgICAgfQoKICAgICAgZmlyZUV2ZW50KCdzY2VuZWNoYW5nZScsIHNjZW5lSWQpOwogICAgICBsb2FkKCk7CiAgICB9CiAgICAvKioNCiAgICAgKiBTdG9wIHVzaW5nIGRldmljZSBvcmllbnRhdGlvbi4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBzdG9wT3JpZW50YXRpb24oKSB7CiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdkZXZpY2VvcmllbnRhdGlvbicsIG9yaWVudGF0aW9uTGlzdGVuZXIpOwogICAgICBjb250cm9scy5vcmllbnRhdGlvbi5jbGFzc0xpc3QucmVtb3ZlKCdwbmxtLW9yaWVudGF0aW9uLWJ1dHRvbi1hY3RpdmUnKTsKICAgICAgb3JpZW50YXRpb24gPSBmYWxzZTsKICAgIH0KICAgIC8qKg0KICAgICAqIFN0YXJ0IHVzaW5nIGRldmljZSBvcmllbnRhdGlvbi4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBzdGFydE9yaWVudGF0aW9uKCkgewogICAgICBpZiAodHlwZW9mIERldmljZU1vdGlvbkV2ZW50LnJlcXVlc3RQZXJtaXNzaW9uID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgRGV2aWNlT3JpZW50YXRpb25FdmVudC5yZXF1ZXN0UGVybWlzc2lvbigpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICBpZiAocmVzcG9uc2UgPT0gJ2dyYW50ZWQnKSB7CiAgICAgICAgICAgIG9yaWVudGF0aW9uID0gMTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2RldmljZW9yaWVudGF0aW9uJywgb3JpZW50YXRpb25MaXN0ZW5lcik7CiAgICAgICAgICAgIGNvbnRyb2xzLm9yaWVudGF0aW9uLmNsYXNzTGlzdC5hZGQoJ3BubG0tb3JpZW50YXRpb24tYnV0dG9uLWFjdGl2ZScpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIG9yaWVudGF0aW9uID0gMTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZGV2aWNlb3JpZW50YXRpb24nLCBvcmllbnRhdGlvbkxpc3RlbmVyKTsKICAgICAgICBjb250cm9scy5vcmllbnRhdGlvbi5jbGFzc0xpc3QuYWRkKCdwbmxtLW9yaWVudGF0aW9uLWJ1dHRvbi1hY3RpdmUnKTsKICAgICAgfQogICAgfQogICAgLyoqDQogICAgICogRXNjYXBlcyBIVE1MIHN0cmluZyAodG8gbWl0aWdhdGUgcG9zc2libGUgRE9NIFhTUyBhdHRhY2tzKS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzIC0gU3RyaW5nIHRvIGVzY2FwZQ0KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IEVzY2FwZWQgc3RyaW5nDQogICAgICovCgoKICAgIGZ1bmN0aW9uIGVzY2FwZUhUTUwocykgewogICAgICBpZiAoIWluaXRpYWxDb25maWcuZXNjYXBlSFRNTCkgcmV0dXJuIFN0cmluZyhzKS5zcGxpdCgnXG4nKS5qb2luKCc8YnI+Jyk7CiAgICAgIHJldHVybiBTdHJpbmcocykuc3BsaXQoLyYvZykuam9pbignJmFtcDsnKS5zcGxpdCgnIicpLmpvaW4oJyZxdW90OycpLnNwbGl0KCInIikuam9pbignJiMzOTsnKS5zcGxpdCgnPCcpLmpvaW4oJyZsdDsnKS5zcGxpdCgnPicpLmpvaW4oJyZndDsnKS5zcGxpdCgnLycpLmpvaW4oJyYjeDJmOycpLnNwbGl0KCdcbicpLmpvaW4oJzxicj4nKTsgLy8gQWxsb3cgbGluZSBicmVha3MKICAgIH0KICAgIC8qKg0KICAgICAqIFJlbW92ZXMgcG9zc2liaWxpdHkgb2YgWFNTIGF0dGFja3Mgd2l0aCBVUkxzLg0KICAgICAqIFRoZSBVUkwgY2Fubm90IGJlIG9mIHByb3RvY29sICdqYXZhc2NyaXB0Jy4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgdG8gc2FuaXRpemUNCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGhyZWYgLSBUcnVlIGlmIFVSTCBpcyBmb3IgbGluayAoYmxvY2tzIGRhdGEgVVJJcykNCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBTYW5pdGl6ZWQgVVJMDQogICAgICovCgoKICAgIGZ1bmN0aW9uIHNhbml0aXplVVJMKHVybCwgaHJlZikgewogICAgICB0cnkgewogICAgICAgIHZhciBkZWNvZGVkX3VybCA9IGRlY29kZVVSSUNvbXBvbmVudCh1bmVzY2FwZSh1cmwpKS5yZXBsYWNlKC9bXlx3Ol0vZywgJycpLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4gJ2Fib3V0OmJsYW5rJzsKICAgICAgfQoKICAgICAgaWYgKGRlY29kZWRfdXJsLmluZGV4T2YoJ2phdmFzY3JpcHQ6JykgPT09IDAgfHwgZGVjb2RlZF91cmwuaW5kZXhPZigndmJzY3JpcHQ6JykgPT09IDApIHsKICAgICAgICBjb25zb2xlLmxvZygnU2NyaXB0IFVSTCByZW1vdmVkLicpOwogICAgICAgIHJldHVybiAnYWJvdXQ6YmxhbmsnOwogICAgICB9CgogICAgICBpZiAoaHJlZiAmJiBkZWNvZGVkX3VybC5pbmRleE9mKCdkYXRhOicpID09PSAwKSB7CiAgICAgICAgY29uc29sZS5sb2coJ0RhdGEgVVJJIHJlbW92ZWQgZnJvbSBsaW5rLicpOwogICAgICAgIHJldHVybiAnYWJvdXQ6YmxhbmsnOwogICAgICB9CgogICAgICByZXR1cm4gdXJsOwogICAgfQogICAgLyoqDQogICAgICogVW5lc2NhcGVzIEhUTUwgZW50aXRpZXMuDQogICAgICogQ29waWVkIGZyb20gTWFya2VkLmpzIDAuNy4wLg0KICAgICAqIEBwcml2YXRlDQogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCB0byBzYW5pdGl6ZQ0KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gaHJlZiAtIFRydWUgaWYgVVJMIGlzIGZvciBsaW5rIChibG9ja3MgZGF0YSBVUklzKQ0KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFNhbml0aXplZCBVUkwNCiAgICAgKi8KCgogICAgZnVuY3Rpb24gdW5lc2NhcGUoaHRtbCkgewogICAgICAvLyBFeHBsaWNpdGx5IG1hdGNoIGRlY2ltYWwsIGhleCwgYW5kIG5hbWVkIEhUTUwgZW50aXRpZXMKICAgICAgcmV0dXJuIGh0bWwucmVwbGFjZSgvJigjKD86XGQrKXwoPzojeFswLTlBLUZhLWZdKyl8KD86XHcrKSk7Py9pZywgZnVuY3Rpb24gKF8sIG4pIHsKICAgICAgICBuID0gbi50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmIChuID09PSAnY29sb24nKSByZXR1cm4gJzonOwoKICAgICAgICBpZiAobi5jaGFyQXQoMCkgPT09ICcjJykgewogICAgICAgICAgcmV0dXJuIG4uY2hhckF0KDEpID09PSAneCcgPyBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KG4uc3Vic3RyaW5nKDIpLCAxNikpIDogU3RyaW5nLmZyb21DaGFyQ29kZSgrbi5zdWJzdHJpbmcoMSkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICcnOwogICAgICB9KTsKICAgIH0KICAgIC8qKg0KICAgICAqIFJlbW92ZXMgcG9zc2liaWxpdHkgb2YgWFNTIGF0YWNrcyB3aXRoIFVSTHMgZm9yIENTUy4NCiAgICAgKiBUaGUgVVJMIHdpbGwgYmUgc2FuaXRpemVkIHdpdGggYHNhbml0aXplVVJMKClgIGFuZCBzaW5nbGUgcXVvdGVzDQogICAgICogYW5kIGRvdWJsZSBxdW90ZXMgZXNjYXBlZC4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgdG8gc2FuaXRpemUNCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBTYW5pdGl6ZWQgVVJMDQogICAgICovCgoKICAgIGZ1bmN0aW9uIHNhbml0aXplVVJMRm9yQ3NzKHVybCkgewogICAgICByZXR1cm4gc2FuaXRpemVVUkwodXJsKS5yZXBsYWNlKC8iL2csICclMjInKS5yZXBsYWNlKC8nL2csICclMjcnKTsKICAgIH0KICAgIC8qKg0KICAgICAqIENoZWNrcyB3aGV0aGVyIG9yIG5vdCBhIHBhbm9yYW1hIGlzIGxvYWRlZC4NCiAgICAgKiBAbWVtYmVyb2YgVmlld2VyDQogICAgICogQGluc3RhbmNlDQogICAgICogQHJldHVybnMge2Jvb2xlYW59IGB0cnVlYCBpZiBhIHBhbm9yYW1hIGlzIGxvYWRlZCwgZWxzZSBgZmFsc2VgDQogICAgICovCgoKICAgIHRoaXMuaXNMb2FkZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBCb29sZWFuKGxvYWRlZCk7CiAgICB9OwogICAgLyoqDQogICAgICogUmV0dXJucyB0aGUgcGl0Y2ggb2YgdGhlIGNlbnRlciBvZiB0aGUgdmlldy4NCiAgICAgKiBAbWVtYmVyb2YgVmlld2VyDQogICAgICogQGluc3RhbmNlDQogICAgICogQHJldHVybnMge251bWJlcn0gUGl0Y2ggaW4gZGVncmVlcw0KICAgICAqLwoKCiAgICB0aGlzLmdldFBpdGNoID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gY29uZmlnLnBpdGNoOwogICAgfTsKICAgIC8qKg0KICAgICAqIFNldHMgdGhlIHBpdGNoIG9mIHRoZSBjZW50ZXIgb2YgdGhlIHZpZXcuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBwaXRjaCAtIFBpdGNoIGluIGRlZ3JlZXMNCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW58bnVtYmVyfSBbYW5pbWF0ZWQ9MTAwMF0gLSBBbmltYXRpb24gZHVyYXRpb24gaW4gbWlsbGlzZWNvbmRzIG9yIGZhbHNlIGZvciBubyBhbmltYXRpb24NCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbY2FsbGJhY2tdIC0gRnVuY3Rpb24gdG8gY2FsbCB3aGVuIGFuaW1hdGlvbiBmaW5pc2hlcw0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbY2FsbGJhY2tBcmdzXSAtIEFyZ3VtZW50cyB0byBwYXNzIHRvIGNhbGxiYWNrIGZ1bmN0aW9uDQogICAgICogQHJldHVybnMge1ZpZXdlcn0gYHRoaXNgDQogICAgICovCgoKICAgIHRoaXMuc2V0UGl0Y2ggPSBmdW5jdGlvbiAocGl0Y2gsIGFuaW1hdGVkLCBjYWxsYmFjaywgY2FsbGJhY2tBcmdzKSB7CiAgICAgIGxhdGVzdEludGVyYWN0aW9uID0gRGF0ZS5ub3coKTsKCiAgICAgIGlmIChNYXRoLmFicyhwaXRjaCAtIGNvbmZpZy5waXRjaCkgPD0gZXBzKSB7CiAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nKSBjYWxsYmFjayhjYWxsYmFja0FyZ3MpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CgogICAgICBhbmltYXRlZCA9IGFuaW1hdGVkID09IHVuZGVmaW5lZCA/IDEwMDAgOiBOdW1iZXIoYW5pbWF0ZWQpOwoKICAgICAgaWYgKGFuaW1hdGVkKSB7CiAgICAgICAgYW5pbWF0ZWRNb3ZlLnBpdGNoID0gewogICAgICAgICAgJ3N0YXJ0VGltZSc6IERhdGUubm93KCksCiAgICAgICAgICAnc3RhcnRQb3NpdGlvbic6IGNvbmZpZy5waXRjaCwKICAgICAgICAgICdlbmRQb3NpdGlvbic6IHBpdGNoLAogICAgICAgICAgJ2R1cmF0aW9uJzogYW5pbWF0ZWQKICAgICAgICB9OwogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJykgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjYWxsYmFjayhjYWxsYmFja0FyZ3MpOwogICAgICAgIH0sIGFuaW1hdGVkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25maWcucGl0Y2ggPSBwaXRjaDsKICAgICAgfQoKICAgICAgYW5pbWF0ZUluaXQoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogICAgLyoqDQogICAgICogUmV0dXJucyB0aGUgbWluaW11bSBhbmQgbWF4aW11bSBhbGxvd2VkIHBpdGNoZXMgKGluIGRlZ3JlZXMpLg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyW119IFttaW5pbXVtIHBpdGNoLCBtYXhpbXVtIHBpdGNoXQ0KICAgICAqLwoKCiAgICB0aGlzLmdldFBpdGNoQm91bmRzID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gW2NvbmZpZy5taW5QaXRjaCwgY29uZmlnLm1heFBpdGNoXTsKICAgIH07CiAgICAvKioNCiAgICAgKiBTZXQgdGhlIG1pbmltdW0gYW5kIG1heGltdW0gYWxsb3dlZCBwaXRjaGVzIChpbiBkZWdyZWVzKS4NCiAgICAgKiBAbWVtYmVyb2YgVmlld2VyDQogICAgICogQGluc3RhbmNlDQogICAgICogQHBhcmFtIHtudW1iZXJbXX0gYm91bmRzIC0gW21pbmltdW0gcGl0Y2gsIG1heGltdW0gcGl0Y2hdDQogICAgICogQHJldHVybnMge1ZpZXdlcn0gYHRoaXNgDQogICAgICovCgoKICAgIHRoaXMuc2V0UGl0Y2hCb3VuZHMgPSBmdW5jdGlvbiAoYm91bmRzKSB7CiAgICAgIGNvbmZpZy5taW5QaXRjaCA9IE1hdGgubWF4KC05MCwgTWF0aC5taW4oYm91bmRzWzBdLCA5MCkpOwogICAgICBjb25maWcubWF4UGl0Y2ggPSBNYXRoLm1heCgtOTAsIE1hdGgubWluKGJvdW5kc1sxXSwgOTApKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogICAgLyoqDQogICAgICogUmV0dXJucyB0aGUgeWF3IG9mIHRoZSBjZW50ZXIgb2YgdGhlIHZpZXcuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFlhdyBpbiBkZWdyZWVzDQogICAgICovCgoKICAgIHRoaXMuZ2V0WWF3ID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gKGNvbmZpZy55YXcgKyA1NDApICUgMzYwIC0gMTgwOwogICAgfTsKICAgIC8qKg0KICAgICAqIFNldHMgdGhlIHlhdyBvZiB0aGUgY2VudGVyIG9mIHRoZSB2aWV3Lg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcGFyYW0ge251bWJlcn0geWF3IC0gWWF3IGluIGRlZ3JlZXMgWy0xODAsIDE4MF0NCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW58bnVtYmVyfSBbYW5pbWF0ZWQ9MTAwMF0gLSBBbmltYXRpb24gZHVyYXRpb24gaW4gbWlsbGlzZWNvbmRzIG9yIGZhbHNlIGZvciBubyBhbmltYXRpb24NCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbY2FsbGJhY2tdIC0gRnVuY3Rpb24gdG8gY2FsbCB3aGVuIGFuaW1hdGlvbiBmaW5pc2hlcw0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbY2FsbGJhY2tBcmdzXSAtIEFyZ3VtZW50cyB0byBwYXNzIHRvIGNhbGxiYWNrIGZ1bmN0aW9uDQogICAgICogQHJldHVybnMge1ZpZXdlcn0gYHRoaXNgDQogICAgICovCgoKICAgIHRoaXMuc2V0WWF3ID0gZnVuY3Rpb24gKHlhdywgYW5pbWF0ZWQsIGNhbGxiYWNrLCBjYWxsYmFja0FyZ3MpIHsKICAgICAgbGF0ZXN0SW50ZXJhY3Rpb24gPSBEYXRlLm5vdygpOwoKICAgICAgaWYgKE1hdGguYWJzKHlhdyAtIGNvbmZpZy55YXcpIDw9IGVwcykgewogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJykgY2FsbGJhY2soY2FsbGJhY2tBcmdzKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgYW5pbWF0ZWQgPSBhbmltYXRlZCA9PSB1bmRlZmluZWQgPyAxMDAwIDogTnVtYmVyKGFuaW1hdGVkKTsKICAgICAgeWF3ID0gKHlhdyArIDE4MCkgJSAzNjAgLSAxODA7IC8vIEtlZXAgaW4gYm91bmRzCgogICAgICBpZiAoYW5pbWF0ZWQpIHsKICAgICAgICAvLyBBbmltYXRlIGluIHNob3J0ZXN0IGRpcmVjdGlvbgogICAgICAgIGlmIChjb25maWcueWF3IC0geWF3ID4gMTgwKSB5YXcgKz0gMzYwO2Vsc2UgaWYgKHlhdyAtIGNvbmZpZy55YXcgPiAxODApIHlhdyAtPSAzNjA7CiAgICAgICAgYW5pbWF0ZWRNb3ZlLnlhdyA9IHsKICAgICAgICAgICdzdGFydFRpbWUnOiBEYXRlLm5vdygpLAogICAgICAgICAgJ3N0YXJ0UG9zaXRpb24nOiBjb25maWcueWF3LAogICAgICAgICAgJ2VuZFBvc2l0aW9uJzogeWF3LAogICAgICAgICAgJ2R1cmF0aW9uJzogYW5pbWF0ZWQKICAgICAgICB9OwogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJykgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjYWxsYmFjayhjYWxsYmFja0FyZ3MpOwogICAgICAgIH0sIGFuaW1hdGVkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25maWcueWF3ID0geWF3OwogICAgICB9CgogICAgICBhbmltYXRlSW5pdCgpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICAvKioNCiAgICAgKiBSZXR1cm5zIHRoZSBtaW5pbXVtIGFuZCBtYXhpbXVtIGFsbG93ZWQgcGl0Y2hlcyAoaW4gZGVncmVlcykuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEByZXR1cm5zIHtudW1iZXJbXX0gW3lhdyBwaXRjaCwgbWF4aW11bSB5YXddDQogICAgICovCgoKICAgIHRoaXMuZ2V0WWF3Qm91bmRzID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gW2NvbmZpZy5taW5ZYXcsIGNvbmZpZy5tYXhZYXddOwogICAgfTsKICAgIC8qKg0KICAgICAqIFNldCB0aGUgbWluaW11bSBhbmQgbWF4aW11bSBhbGxvd2VkIHlhd3MgKGluIGRlZ3JlZXMgWy0zNjAsIDM2MF0pLg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcGFyYW0ge251bWJlcltdfSBib3VuZHMgLSBbbWluaW11bSB5YXcsIG1heGltdW0geWF3XQ0KICAgICAqIEByZXR1cm5zIHtWaWV3ZXJ9IGB0aGlzYA0KICAgICAqLwoKCiAgICB0aGlzLnNldFlhd0JvdW5kcyA9IGZ1bmN0aW9uIChib3VuZHMpIHsKICAgICAgY29uZmlnLm1pbllhdyA9IE1hdGgubWF4KC0zNjAsIE1hdGgubWluKGJvdW5kc1swXSwgMzYwKSk7CiAgICAgIGNvbmZpZy5tYXhZYXcgPSBNYXRoLm1heCgtMzYwLCBNYXRoLm1pbihib3VuZHNbMV0sIDM2MCkpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICAvKioNCiAgICAgKiBSZXR1cm5zIHRoZSBob3Jpem9udGFsIGZpZWxkIG9mIHZpZXcuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IEhvcml6b250YWwgZmllbGQgb2YgdmlldyBpbiBkZWdyZWVzDQogICAgICovCgoKICAgIHRoaXMuZ2V0SGZvdiA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGNvbmZpZy5oZm92OwogICAgfTsKICAgIC8qKg0KICAgICAqIFNldHMgdGhlIGhvcml6b250YWwgZmllbGQgb2Ygdmlldy4NCiAgICAgKiBAbWVtYmVyb2YgVmlld2VyDQogICAgICogQGluc3RhbmNlDQogICAgICogQHBhcmFtIHtudW1iZXJ9IGhmb3YgLSBIb3Jpem9udGFsIGZpZWxkIG9mIHZpZXcgaW4gZGVncmVlcw0KICAgICAqIEBwYXJhbSB7Ym9vbGVhbnxudW1iZXJ9IFthbmltYXRlZD0xMDAwXSAtIEFuaW1hdGlvbiBkdXJhdGlvbiBpbiBtaWxsaXNlY29uZHMgb3IgZmFsc2UgZm9yIG5vIGFuaW1hdGlvbg0KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtjYWxsYmFja10gLSBGdW5jdGlvbiB0byBjYWxsIHdoZW4gYW5pbWF0aW9uIGZpbmlzaGVzDQogICAgICogQHBhcmFtIHtvYmplY3R9IFtjYWxsYmFja0FyZ3NdIC0gQXJndW1lbnRzIHRvIHBhc3MgdG8gY2FsbGJhY2sgZnVuY3Rpb24NCiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSBgdGhpc2ANCiAgICAgKi8KCgogICAgdGhpcy5zZXRIZm92ID0gZnVuY3Rpb24gKGhmb3YsIGFuaW1hdGVkLCBjYWxsYmFjaywgY2FsbGJhY2tBcmdzKSB7CiAgICAgIGxhdGVzdEludGVyYWN0aW9uID0gRGF0ZS5ub3coKTsKCiAgICAgIGlmIChNYXRoLmFicyhoZm92IC0gY29uZmlnLmhmb3YpIDw9IGVwcykgewogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJykgY2FsbGJhY2soY2FsbGJhY2tBcmdzKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgYW5pbWF0ZWQgPSBhbmltYXRlZCA9PSB1bmRlZmluZWQgPyAxMDAwIDogTnVtYmVyKGFuaW1hdGVkKTsKCiAgICAgIGlmIChhbmltYXRlZCkgewogICAgICAgIGFuaW1hdGVkTW92ZS5oZm92ID0gewogICAgICAgICAgJ3N0YXJ0VGltZSc6IERhdGUubm93KCksCiAgICAgICAgICAnc3RhcnRQb3NpdGlvbic6IGNvbmZpZy5oZm92LAogICAgICAgICAgJ2VuZFBvc2l0aW9uJzogY29uc3RyYWluSGZvdihoZm92KSwKICAgICAgICAgICdkdXJhdGlvbic6IGFuaW1hdGVkCiAgICAgICAgfTsKICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicpIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgY2FsbGJhY2soY2FsbGJhY2tBcmdzKTsKICAgICAgICB9LCBhbmltYXRlZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0SGZvdihoZm92KTsKICAgICAgfQoKICAgICAgYW5pbWF0ZUluaXQoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogICAgLyoqDQogICAgICogUmV0dXJucyB0aGUgbWluaW11bSBhbmQgbWF4aW11bSBhbGxvd2VkIGhvcml6b250YWwgZmllbGRzIG9mIHZpZXcNCiAgICAgKiAoaW4gZGVncmVlcykuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEByZXR1cm5zIHtudW1iZXJbXX0gW21pbmltdW0gaGZvdiwgbWF4aW11bSBoZm92XQ0KICAgICAqLwoKCiAgICB0aGlzLmdldEhmb3ZCb3VuZHMgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBbY29uZmlnLm1pbkhmb3YsIGNvbmZpZy5tYXhIZm92XTsKICAgIH07CiAgICAvKioNCiAgICAgKiBTZXQgdGhlIG1pbmltdW0gYW5kIG1heGltdW0gYWxsb3dlZCBob3Jpem9udGFsIGZpZWxkcyBvZiB2aWV3IChpbiBkZWdyZWVzKS4NCiAgICAgKiBAbWVtYmVyb2YgVmlld2VyDQogICAgICogQGluc3RhbmNlDQogICAgICogQHBhcmFtIHtudW1iZXJbXX0gYm91bmRzIC0gW21pbmltdW0gaGZvdiwgbWF4aW11bSBoZm92XQ0KICAgICAqIEByZXR1cm5zIHtWaWV3ZXJ9IGB0aGlzYA0KICAgICAqLwoKCiAgICB0aGlzLnNldEhmb3ZCb3VuZHMgPSBmdW5jdGlvbiAoYm91bmRzKSB7CiAgICAgIGNvbmZpZy5taW5IZm92ID0gTWF0aC5tYXgoMCwgYm91bmRzWzBdKTsKICAgICAgY29uZmlnLm1heEhmb3YgPSBNYXRoLm1heCgwLCBib3VuZHNbMV0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICAvKioNCiAgICAgKiBTZXQgYSBuZXcgdmlldy4gQW55IHBhcmFtZXRlcnMgbm90IHNwZWNpZmllZCByZW1haW4gdGhlIHNhbWUuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcGl0Y2hdIC0gVGFyZ2V0IHBpdGNoDQogICAgICogQHBhcmFtIHtudW1iZXJ9IFt5YXddIC0gVGFyZ2V0IHlhdw0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaGZvdl0gLSBUYXJnZXQgaGZvdg0KICAgICAqIEBwYXJhbSB7Ym9vbGVhbnxudW1iZXJ9IFthbmltYXRlZD0xMDAwXSAtIEFuaW1hdGlvbiBkdXJhdGlvbiBpbiBtaWxsaXNlY29uZHMgb3IgZmFsc2UgZm9yIG5vIGFuaW1hdGlvbg0KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtjYWxsYmFja10gLSBGdW5jdGlvbiB0byBjYWxsIHdoZW4gYW5pbWF0aW9uIGZpbmlzaGVzDQogICAgICogQHBhcmFtIHtvYmplY3R9IFtjYWxsYmFja0FyZ3NdIC0gQXJndW1lbnRzIHRvIHBhc3MgdG8gY2FsbGJhY2sgZnVuY3Rpb24NCiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSBgdGhpc2ANCiAgICAgKi8KCgogICAgdGhpcy5sb29rQXQgPSBmdW5jdGlvbiAocGl0Y2gsIHlhdywgaGZvdiwgYW5pbWF0ZWQsIGNhbGxiYWNrLCBjYWxsYmFja0FyZ3MpIHsKICAgICAgYW5pbWF0ZWQgPSBhbmltYXRlZCA9PSB1bmRlZmluZWQgPyAxMDAwIDogTnVtYmVyKGFuaW1hdGVkKTsKCiAgICAgIGlmIChwaXRjaCAhPT0gdW5kZWZpbmVkICYmIE1hdGguYWJzKHBpdGNoIC0gY29uZmlnLnBpdGNoKSA+IGVwcykgewogICAgICAgIHRoaXMuc2V0UGl0Y2gocGl0Y2gsIGFuaW1hdGVkLCBjYWxsYmFjaywgY2FsbGJhY2tBcmdzKTsKICAgICAgICBjYWxsYmFjayA9IHVuZGVmaW5lZDsKICAgICAgfQoKICAgICAgaWYgKHlhdyAhPT0gdW5kZWZpbmVkICYmIE1hdGguYWJzKHlhdyAtIGNvbmZpZy55YXcpID4gZXBzKSB7CiAgICAgICAgdGhpcy5zZXRZYXcoeWF3LCBhbmltYXRlZCwgY2FsbGJhY2ssIGNhbGxiYWNrQXJncyk7CiAgICAgICAgY2FsbGJhY2sgPSB1bmRlZmluZWQ7CiAgICAgIH0KCiAgICAgIGlmIChoZm92ICE9PSB1bmRlZmluZWQgJiYgTWF0aC5hYnMoaGZvdiAtIGNvbmZpZy5oZm92KSA+IGVwcykgewogICAgICAgIHRoaXMuc2V0SGZvdihoZm92LCBhbmltYXRlZCwgY2FsbGJhY2ssIGNhbGxiYWNrQXJncyk7CiAgICAgICAgY2FsbGJhY2sgPSB1bmRlZmluZWQ7CiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJykgY2FsbGJhY2soY2FsbGJhY2tBcmdzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogICAgLyoqDQogICAgICogUmV0dXJucyB0aGUgcGFub3JhbWEncyBub3J0aCBvZmZzZXQuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IE5vcnRoIG9mZnNldCBpbiBkZWdyZWVzDQogICAgICovCgoKICAgIHRoaXMuZ2V0Tm9ydGhPZmZzZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBjb25maWcubm9ydGhPZmZzZXQ7CiAgICB9OwogICAgLyoqDQogICAgICogU2V0cyB0aGUgcGFub3JhbWEncyBub3J0aCBvZmZzZXQuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWFkaW5nIC0gTm9ydGggb2Zmc2V0IGluIGRlZ3JlZXMNCiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSBgdGhpc2ANCiAgICAgKi8KCgogICAgdGhpcy5zZXROb3J0aE9mZnNldCA9IGZ1bmN0aW9uIChoZWFkaW5nKSB7CiAgICAgIGNvbmZpZy5ub3J0aE9mZnNldCA9IE1hdGgubWluKDM2MCwgTWF0aC5tYXgoMCwgaGVhZGluZykpOwogICAgICBhbmltYXRlSW5pdCgpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICAvKioNCiAgICAgKiBSZXR1cm5zIHRoZSBwYW5vcmFtYSdzIGhvcml6b24gcm9sbC4NCiAgICAgKiBAbWVtYmVyb2YgVmlld2VyDQogICAgICogQGluc3RhbmNlDQogICAgICogQHJldHVybnMge251bWJlcn0gSG9yaXpvbiByb2xsIGluIGRlZ3JlZXMNCiAgICAgKi8KCgogICAgdGhpcy5nZXRIb3Jpem9uUm9sbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGNvbmZpZy5ob3Jpem9uUm9sbDsKICAgIH07CiAgICAvKioNCiAgICAgKiBTZXRzIHRoZSBwYW5vcmFtYSdzIGhvcml6b24gcm9sbC4NCiAgICAgKiBAbWVtYmVyb2YgVmlld2VyDQogICAgICogQGluc3RhbmNlDQogICAgICogQHBhcmFtIHtudW1iZXJ9IHJvbGwgLSBIb3Jpem9uIHJvbGwgaW4gZGVncmVlcyBbLTkwLCA5MF0NCiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSBgdGhpc2ANCiAgICAgKi8KCgogICAgdGhpcy5zZXRIb3Jpem9uUm9sbCA9IGZ1bmN0aW9uIChyb2xsKSB7CiAgICAgIGNvbmZpZy5ob3Jpem9uUm9sbCA9IE1hdGgubWluKDkwLCBNYXRoLm1heCgtOTAsIHJvbGwpKTsKICAgICAgcmVuZGVyZXIuc2V0UG9zZShjb25maWcuaG9yaXpvblBpdGNoICogTWF0aC5QSSAvIDE4MCwgY29uZmlnLmhvcml6b25Sb2xsICogTWF0aC5QSSAvIDE4MCk7CiAgICAgIGFuaW1hdGVJbml0KCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICAgIC8qKg0KICAgICAqIFJldHVybnMgdGhlIHBhbm9yYW1hJ3MgaG9yaXpvbiBwaXRjaC4NCiAgICAgKiBAbWVtYmVyb2YgVmlld2VyDQogICAgICogQGluc3RhbmNlDQogICAgICogQHJldHVybnMge251bWJlcn0gSG9yaXpvbiBwaXRjaCBpbiBkZWdyZWVzDQogICAgICovCgoKICAgIHRoaXMuZ2V0SG9yaXpvblBpdGNoID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gY29uZmlnLmhvcml6b25QaXRjaDsKICAgIH07CiAgICAvKioNCiAgICAgKiBTZXRzIHRoZSBwYW5vcmFtYSdzIGhvcml6b24gcGl0Y2guDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBwaXRjaCAtIEhvcml6b24gcGl0Y2ggaW4gZGVncmVlcyBbLTkwLCA5MF0NCiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSBgdGhpc2ANCiAgICAgKi8KCgogICAgdGhpcy5zZXRIb3Jpem9uUGl0Y2ggPSBmdW5jdGlvbiAocGl0Y2gpIHsKICAgICAgY29uZmlnLmhvcml6b25QaXRjaCA9IE1hdGgubWluKDkwLCBNYXRoLm1heCgtOTAsIHBpdGNoKSk7CiAgICAgIHJlbmRlcmVyLnNldFBvc2UoY29uZmlnLmhvcml6b25QaXRjaCAqIE1hdGguUEkgLyAxODAsIGNvbmZpZy5ob3Jpem9uUm9sbCAqIE1hdGguUEkgLyAxODApOwogICAgICBhbmltYXRlSW5pdCgpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICAvKioNCiAgICAgKiBTdGFydCBhdXRvIHJvdGF0aW9uLg0KICAgICAqDQogICAgICogQmVmb3JlIHN0YXJ0aW5nIHJvdGF0aW9uLCB0aGUgdmlld2VyIGlzIHBhbm5lZCB0byBgcGl0Y2hgLg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3NwZWVkXSAtIEF1dG8gcm90YXRpb24gc3BlZWQgLyBkaXJlY3Rpb24uIElmIG5vdCBzcGVjaWZpZWQsIHByZXZpb3VzIHZhbHVlIGlzIHVzZWQuDQogICAgICogQHBhcmFtIHtudW1iZXJ9IFtwaXRjaF0gLSBUaGUgcGl0Y2ggdG8gcm90YXRlIGF0LiBJZiBub3Qgc3BlY2lmaWVkLCBpbml0YWwgcGl0Y2ggaXMgdXNlZC4NCiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSBgdGhpc2ANCiAgICAgKi8KCgogICAgdGhpcy5zdGFydEF1dG9Sb3RhdGUgPSBmdW5jdGlvbiAoc3BlZWQsIHBpdGNoKSB7CiAgICAgIHNwZWVkID0gc3BlZWQgfHwgYXV0b1JvdGF0ZVNwZWVkIHx8IDE7CiAgICAgIHBpdGNoID0gcGl0Y2ggPT09IHVuZGVmaW5lZCA/IG9yaWdQaXRjaCA6IHBpdGNoOwogICAgICBjb25maWcuYXV0b1JvdGF0ZSA9IHNwZWVkOwoKICAgICAgX3RoaXMubG9va0F0KHBpdGNoLCB1bmRlZmluZWQsIG9yaWdIZm92LCAzMDAwKTsKCiAgICAgIGFuaW1hdGVJbml0KCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICAgIC8qKg0KICAgICAqIFN0b3AgYXV0byByb3RhdGlvbi4NCiAgICAgKiBAbWVtYmVyb2YgVmlld2VyDQogICAgICogQGluc3RhbmNlDQogICAgICogQHJldHVybnMge1ZpZXdlcn0gYHRoaXNgDQogICAgICovCgoKICAgIHRoaXMuc3RvcEF1dG9Sb3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGF1dG9Sb3RhdGVTcGVlZCA9IGNvbmZpZy5hdXRvUm90YXRlID8gY29uZmlnLmF1dG9Sb3RhdGUgOiBhdXRvUm90YXRlU3BlZWQ7CiAgICAgIGNvbmZpZy5hdXRvUm90YXRlID0gZmFsc2U7CiAgICAgIGNvbmZpZy5hdXRvUm90YXRlSW5hY3Rpdml0eURlbGF5ID0gLTE7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICAgIC8qKg0KICAgICAqIFN0b3BzIGFsbCBtb3ZlbWVudC4NCiAgICAgKiBAbWVtYmVyb2YgVmlld2VyDQogICAgICogQGluc3RhbmNlDQogICAgICovCgoKICAgIHRoaXMuc3RvcE1vdmVtZW50ID0gZnVuY3Rpb24gKCkgewogICAgICBzdG9wQW5pbWF0aW9uKCk7CiAgICAgIHNwZWVkID0gewogICAgICAgICd5YXcnOiAwLAogICAgICAgICdwaXRjaCc6IDAsCiAgICAgICAgJ2hmb3YnOiAwCiAgICAgIH07CiAgICB9OwogICAgLyoqDQogICAgICogUmV0dXJucyB0aGUgcGFub3JhbWEgcmVuZGVyZXIuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEByZXR1cm5zIHtSZW5kZXJlcn0NCiAgICAgKi8KCgogICAgdGhpcy5nZXRSZW5kZXJlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHJlbmRlcmVyOwogICAgfTsKICAgIC8qKg0KICAgICAqIFNldHMgdXBkYXRlIGZsYWcgZm9yIGR5bmFtaWMgY29udGVudC4NCiAgICAgKiBAbWVtYmVyb2YgVmlld2VyDQogICAgICogQGluc3RhbmNlDQogICAgICogQHBhcmFtIHtib29sZWFufSBib29sIC0gV2hldGhlciBvciBub3Qgdmlld2VyIHNob3VsZCB1cGRhdGUgZXZlbiB3aGVuIHN0aWxsDQogICAgICogQHJldHVybnMge1ZpZXdlcn0gYHRoaXNgDQogICAgICovCgoKICAgIHRoaXMuc2V0VXBkYXRlID0gZnVuY3Rpb24gKGJvb2wpIHsKICAgICAgdXBkYXRlID0gYm9vbCA9PT0gdHJ1ZTsKICAgICAgaWYgKHJlbmRlcmVyID09PSB1bmRlZmluZWQpIG9uSW1hZ2VMb2FkKCk7ZWxzZSBhbmltYXRlSW5pdCgpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICAvKioNCiAgICAgKiBDYWxjdWxhdGUgcGFub3JhbWEgcGl0Y2ggYW5kIHlhdyBmcm9tIGxvY2F0aW9uIG9mIG1vdXNlIGV2ZW50Lg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcGFyYW0ge01vdXNlRXZlbnR9IGV2ZW50IC0gRG9jdW1lbnQgbW91c2UgZG93biBldmVudC4NCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyW119IFtwaXRjaCwgeWF3XQ0KICAgICAqLwoKCiAgICB0aGlzLm1vdXNlRXZlbnRUb0Nvb3JkcyA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICByZXR1cm4gbW91c2VFdmVudFRvQ29vcmRzKGV2ZW50KTsKICAgIH07CiAgICAvKioNCiAgICAgKiBDaGFuZ2Ugc2NlbmUgYmVpbmcgdmlld2VkLg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2NlbmVJZCAtIElkZW50aWZpZXIgb2Ygc2NlbmUgdG8gc3dpdGNoIHRvLg0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcGl0Y2hdIC0gUGl0Y2ggdG8gdXNlIHdpdGggbmV3IHNjZW5lDQogICAgICogQHBhcmFtIHtudW1iZXJ9IFt5YXddIC0gWWF3IHRvIHVzZSB3aXRoIG5ldyBzY2VuZQ0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaGZvdl0gLSBIRk9WIHRvIHVzZSB3aXRoIG5ldyBzY2VuZQ0KICAgICAqIEByZXR1cm5zIHtWaWV3ZXJ9IGB0aGlzYA0KICAgICAqLwoKCiAgICB0aGlzLmxvYWRTY2VuZSA9IGZ1bmN0aW9uIChzY2VuZUlkLCBwaXRjaCwgeWF3LCBoZm92KSB7CiAgICAgIGlmIChsb2FkZWQgIT09IGZhbHNlKSBsb2FkU2NlbmUoc2NlbmVJZCwgcGl0Y2gsIHlhdywgaGZvdik7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICAgIC8qKg0KICAgICAqIEdldCBJRCBvZiBjdXJyZW50IHNjZW5lLg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBJRCBvZiBjdXJyZW50IHNjZW5lDQogICAgICovCgoKICAgIHRoaXMuZ2V0U2NlbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBjb25maWcuc2NlbmU7CiAgICB9OwogICAgLyoqDQogICAgICogQWRkIGEgbmV3IHNjZW5lLg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2NlbmVJZCAtIFRoZSBJRCBvZiB0aGUgbmV3IHNjZW5lDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbmZpZyAtIFRoZSBjb25maWd1cmF0aW9uIG9mIHRoZSBuZXcgc2NlbmUNCiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSBgdGhpc2ANCiAgICAgKi8KCgogICAgdGhpcy5hZGRTY2VuZSA9IGZ1bmN0aW9uIChzY2VuZUlkLCBjb25maWcpIHsKICAgICAgaW5pdGlhbENvbmZpZy5zY2VuZXNbc2NlbmVJZF0gPSBjb25maWc7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICAgIC8qKg0KICAgICAqIFJlbW92ZSBhIHNjZW5lLg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2NlbmVJZCAtIFRoZSBJRCBvZiB0aGUgc2NlbmUNCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gRmFsc2UgaWYgdGhlIHNjZW5lIGlzIHRoZSBjdXJyZW50IHNjZW5lIG9yIGlmIHRoZSBzY2VuZSBkb2Vzbid0IGV4aXN0cywgZWxzZSB0cnVlDQogICAgICovCgoKICAgIHRoaXMucmVtb3ZlU2NlbmUgPSBmdW5jdGlvbiAoc2NlbmVJZCkgewogICAgICBpZiAoY29uZmlnLnNjZW5lID09PSBzY2VuZUlkIHx8ICFpbml0aWFsQ29uZmlnLnNjZW5lcy5oYXNPd25Qcm9wZXJ0eShzY2VuZUlkKSkgcmV0dXJuIGZhbHNlOwogICAgICBkZWxldGUgaW5pdGlhbENvbmZpZy5zY2VuZXNbc2NlbmVJZF07CiAgICAgIHJldHVybiB0cnVlOwogICAgfTsKICAgIC8qKg0KICAgICAqIFRvZ2dsZSBmdWxsc2NyZWVuLg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSBgdGhpc2ANCiAgICAgKi8KCgogICAgdGhpcy50b2dnbGVGdWxsc2NyZWVuID0gZnVuY3Rpb24gKCkgewogICAgICB0b2dnbGVGdWxsc2NyZWVuKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICAgIC8qKg0KICAgICAqIEdldCBjb25maWd1cmF0aW9uIG9mIGN1cnJlbnQgc2NlbmUuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IENvbmZpZ3VyYXRpb24gb2YgY3VycmVudCBzY2VuZQ0KICAgICAqLwoKCiAgICB0aGlzLmdldENvbmZpZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGNvbmZpZzsKICAgIH07CiAgICAvKioNCiAgICAgKiBHZXQgdmlld2VyJ3MgY29udGFpbmVyIGVsZW1lbnQuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEByZXR1cm5zIHtIVE1MRWxlbWVudH0gQ29udGFpbmVyIGBkaXZgIGVsZW1lbnQNCiAgICAgKi8KCgogICAgdGhpcy5nZXRDb250YWluZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBjb250YWluZXI7CiAgICB9OwogICAgLyoqDQogICAgICogQWRkIGEgbmV3IGhvdCBzcG90Lg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcGFyYW0ge09iamVjdH0gaHMgLSBUaGUgY29uZmlndXJhdGlvbiBmb3IgdGhlIGhvdCBzcG90DQogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzY2VuZUlkXSAtIEFkZHMgaG90IHNwb3QgdG8gc3BlY2lmaWVkIHNjZW5lIGlmIHByb3ZpZGVkLCBlbHNlIHRvIGN1cnJlbnQgc2NlbmUNCiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSBgdGhpc2ANCiAgICAgKiBAdGhyb3dzIFRocm93cyBhbiBlcnJvciBpZiB0aGUgc2NlbmUgSUQgaXMgcHJvdmlkZWQgYnV0IGludmFsaWQNCiAgICAgKi8KCgogICAgdGhpcy5hZGRIb3RTcG90ID0gZnVuY3Rpb24gKGhzLCBzY2VuZUlkKSB7CiAgICAgIGlmIChzY2VuZUlkID09PSB1bmRlZmluZWQgJiYgY29uZmlnLnNjZW5lID09PSB1bmRlZmluZWQpIHsKICAgICAgICAvLyBOb3QgYSB0b3VyCiAgICAgICAgY29uZmlnLmhvdFNwb3RzLnB1c2goaHMpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFRvdXIKICAgICAgICB2YXIgaWQgPSBzY2VuZUlkICE9PSB1bmRlZmluZWQgPyBzY2VuZUlkIDogY29uZmlnLnNjZW5lOwoKICAgICAgICBpZiAoaW5pdGlhbENvbmZpZy5zY2VuZXMuaGFzT3duUHJvcGVydHkoaWQpKSB7CiAgICAgICAgICBpZiAoIWluaXRpYWxDb25maWcuc2NlbmVzW2lkXS5oYXNPd25Qcm9wZXJ0eSgnaG90U3BvdHMnKSkgewogICAgICAgICAgICBpbml0aWFsQ29uZmlnLnNjZW5lc1tpZF0uaG90U3BvdHMgPSBbXTsgLy8gQ3JlYXRlIGhvdCBzcG90cyBhcnJheSBpZiBuZWVkZWQKCiAgICAgICAgICAgIGlmIChpZCA9PSBjb25maWcuc2NlbmUpIGNvbmZpZy5ob3RTcG90cyA9IGluaXRpYWxDb25maWcuc2NlbmVzW2lkXS5ob3RTcG90czsgLy8gTGluayB0byBjdXJyZW50IGNvbmZpZwogICAgICAgICAgfQoKICAgICAgICAgIGluaXRpYWxDb25maWcuc2NlbmVzW2lkXS5ob3RTcG90cy5wdXNoKGhzKTsgLy8gQWRkIGhvdCBzcG90IHRvIGNvbmZpZwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyAnSW52YWxpZCBzY2VuZSBJRCEnOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHNjZW5lSWQgPT09IHVuZGVmaW5lZCB8fCBjb25maWcuc2NlbmUgPT0gc2NlbmVJZCkgewogICAgICAgIC8vIEFkZCB0byBjdXJyZW50IHNjZW5lCiAgICAgICAgY3JlYXRlSG90U3BvdChocyk7CiAgICAgICAgaWYgKGxvYWRlZCkgcmVuZGVySG90U3BvdChocyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICAgIC8qKg0KICAgICAqIFJlbW92ZSBhIGhvdCBzcG90Lg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaG90U3BvdElkIC0gVGhlIElEIG9mIHRoZSBob3Qgc3BvdA0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbc2NlbmVJZF0gLSBSZW1vdmVzIGhvdCBzcG90IGZyb20gc3BlY2lmaWVkIHNjZW5lIGlmIHByb3ZpZGVkLCBlbHNlIGZyb20gY3VycmVudCBzY2VuZQ0KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGRlbGV0aW9uIGlzIHN1Y2Nlc3NmdWwsIGVsc2UgZmFsc2UNCiAgICAgKi8KCgogICAgdGhpcy5yZW1vdmVIb3RTcG90ID0gZnVuY3Rpb24gKGhvdFNwb3RJZCwgc2NlbmVJZCkgewogICAgICBpZiAoc2NlbmVJZCA9PT0gdW5kZWZpbmVkIHx8IGNvbmZpZy5zY2VuZSA9PSBzY2VuZUlkKSB7CiAgICAgICAgaWYgKCFjb25maWcuaG90U3BvdHMpIHJldHVybiBmYWxzZTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb25maWcuaG90U3BvdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChjb25maWcuaG90U3BvdHNbaV0uaGFzT3duUHJvcGVydHkoJ2lkJykgJiYgY29uZmlnLmhvdFNwb3RzW2ldLmlkID09PSBob3RTcG90SWQpIHsKICAgICAgICAgICAgLy8gRGVsZXRlIGhvdCBzcG90IERPTSBlbGVtZW50cwogICAgICAgICAgICB2YXIgY3VycmVudCA9IGNvbmZpZy5ob3RTcG90c1tpXS5kaXY7CgogICAgICAgICAgICB3aGlsZSAoY3VycmVudC5wYXJlbnROb2RlICE9IHJlbmRlckNvbnRhaW5lcikgewogICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlbmRlckNvbnRhaW5lci5yZW1vdmVDaGlsZChjdXJyZW50KTsKICAgICAgICAgICAgZGVsZXRlIGNvbmZpZy5ob3RTcG90c1tpXS5kaXY7IC8vIFJlbW92ZSBob3Qgc3BvdCBmcm9tIGNvbmZpZ3VyYXRpb24KCiAgICAgICAgICAgIGNvbmZpZy5ob3RTcG90cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaW5pdGlhbENvbmZpZy5zY2VuZXMuaGFzT3duUHJvcGVydHkoc2NlbmVJZCkpIHsKICAgICAgICAgIGlmICghaW5pdGlhbENvbmZpZy5zY2VuZXNbc2NlbmVJZF0uaGFzT3duUHJvcGVydHkoJ2hvdFNwb3RzJykpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGluaXRpYWxDb25maWcuc2NlbmVzW3NjZW5lSWRdLmhvdFNwb3RzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIGlmIChpbml0aWFsQ29uZmlnLnNjZW5lc1tzY2VuZUlkXS5ob3RTcG90c1tqXS5oYXNPd25Qcm9wZXJ0eSgnaWQnKSAmJiBpbml0aWFsQ29uZmlnLnNjZW5lc1tzY2VuZUlkXS5ob3RTcG90c1tqXS5pZCA9PT0gaG90U3BvdElkKSB7CiAgICAgICAgICAgICAgLy8gUmVtb3ZlIGhvdCBzcG90IGZyb20gY29uZmlndXJhdGlvbgogICAgICAgICAgICAgIGluaXRpYWxDb25maWcuc2NlbmVzW3NjZW5lSWRdLmhvdFNwb3RzLnNwbGljZShqLCAxKTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgLyoqDQogICAgICogVGhpcyBtZXRob2Qgc2hvdWxkIGJlIGNhbGxlZCBpZiB0aGUgdmlld2VyJ3MgY29udGFpbmVyIGlzIHJlc2l6ZWQuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqLwoKCiAgICB0aGlzLnJlc2l6ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHJlbmRlcmVyKSBvbkRvY3VtZW50UmVzaXplKCk7CiAgICB9OwogICAgLyoqDQogICAgICogQ2hlY2sgaWYgYSBwYW5vcmFtYSBpcyBsb2FkZWQuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGEgcGFub3JhbWEgaXMgbG9hZGVkLCBlbHNlIGZhbHNlDQogICAgICovCgoKICAgIHRoaXMuaXNMb2FkZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBsb2FkZWQ7CiAgICB9OwogICAgLyoqDQogICAgICogQ2hlY2sgaWYgZGV2aWNlIG9yaWVudGF0aW9uIGNvbnRyb2wgaXMgc3VwcG9ydGVkLg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBzdXBwb3J0ZWQsIGVsc2UgZmFsc2UNCiAgICAgKi8KCgogICAgdGhpcy5pc09yaWVudGF0aW9uU3VwcG9ydGVkID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gb3JpZW50YXRpb25TdXBwb3J0IHx8IGZhbHNlOwogICAgfTsKICAgIC8qKg0KICAgICAqIFN0b3AgdXNpbmcgZGV2aWNlIG9yaWVudGF0aW9uLg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKi8KCgogICAgdGhpcy5zdG9wT3JpZW50YXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHN0b3BPcmllbnRhdGlvbigpOwogICAgfTsKICAgIC8qKg0KICAgICAqIFN0YXJ0IHVzaW5nIGRldmljZSBvcmllbnRhdGlvbiAoZG9lcyBub3RoaW5nIGlmIG5vdCBzdXBwb3J0ZWQpLg0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKi8KCgogICAgdGhpcy5zdGFydE9yaWVudGF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgICBpZiAob3JpZW50YXRpb25TdXBwb3J0KSBzdGFydE9yaWVudGF0aW9uKCk7CiAgICB9OwogICAgLyoqDQogICAgICogQ2hlY2sgaWYgZGV2aWNlIG9yaWVudGF0aW9uIGNvbnRyb2wgaXMgY3VycmVudGx5IGFjdGl2YXRlZC4NCiAgICAgKiBAbWVtYmVyb2YgVmlld2VyDQogICAgICogQGluc3RhbmNlDQogICAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYWN0aXZlLCBlbHNlIGZhbHNlDQogICAgICovCgoKICAgIHRoaXMuaXNPcmllbnRhdGlvbkFjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIEJvb2xlYW4ob3JpZW50YXRpb24pOwogICAgfTsKICAgIC8qKg0KICAgICAqIFN1YnNjcmliZSBsaXN0ZW5lciB0byBzcGVjaWZpZWQgZXZlbnQuDQogICAgICogQG1lbWJlcm9mIFZpZXdlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIC0gVHlwZSBvZiBldmVudCB0byBzdWJzY3JpYmUgdG8uDQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gbGlzdGVuZXIgLSBMaXN0ZW5lciBmdW5jdGlvbiB0byBzdWJzY3JpYmUgdG8gZXZlbnQuDQogICAgICogQHJldHVybnMge1ZpZXdlcn0gYHRoaXNgDQogICAgICovCgoKICAgIHRoaXMub24gPSBmdW5jdGlvbiAodHlwZSwgbGlzdGVuZXIpIHsKICAgICAgZXh0ZXJuYWxFdmVudExpc3RlbmVyc1t0eXBlXSA9IGV4dGVybmFsRXZlbnRMaXN0ZW5lcnNbdHlwZV0gfHwgW107CiAgICAgIGV4dGVybmFsRXZlbnRMaXN0ZW5lcnNbdHlwZV0ucHVzaChsaXN0ZW5lcik7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICAgIC8qKg0KICAgICAqIFJlbW92ZSBhbiBldmVudCBsaXN0ZW5lciAob3IgbGlzdGVuZXJzKS4NCiAgICAgKiBAbWVtYmVyb2YgVmlld2VyDQogICAgICogQHBhcmFtIHtzdHJpbmd9IFt0eXBlXSAtIFR5cGUgb2YgZXZlbnQgdG8gcmVtb3ZlIGxpc3RlbmVycyBmcm9tLiBJZiBub3Qgc3BlY2lmaWVkLCBhbGwgbGlzdGVuZXJzIGFyZSByZW1vdmVkLg0KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtsaXN0ZW5lcl0gLSBMaXN0ZW5lciBmdW5jdGlvbiB0byByZW1vdmUuIElmIG5vdCBzcGVjaWZpZWQsIGFsbCBsaXN0ZW5lcnMgb2Ygc3BlY2lmaWVkIHR5cGUgYXJlIHJlbW92ZWQuDQogICAgICogQHJldHVybnMge1ZpZXdlcn0gYHRoaXNgDQogICAgICovCgoKICAgIHRoaXMub2ZmID0gZnVuY3Rpb24gKHR5cGUsIGxpc3RlbmVyKSB7CiAgICAgIGlmICghdHlwZSkgewogICAgICAgIC8vIFJlbW92ZSBhbGwgbGlzdGVuZXJzIGlmIHR5cGUgaXNuJ3Qgc3BlY2lmaWVkCiAgICAgICAgZXh0ZXJuYWxFdmVudExpc3RlbmVycyA9IHt9OwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CgogICAgICBpZiAobGlzdGVuZXIpIHsKICAgICAgICB2YXIgaSA9IGV4dGVybmFsRXZlbnRMaXN0ZW5lcnNbdHlwZV0uaW5kZXhPZihsaXN0ZW5lcik7CgogICAgICAgIGlmIChpID49IDApIHsKICAgICAgICAgIC8vIFJlbW92ZSBsaXN0ZW5lciBpZiBmb3VuZAogICAgICAgICAgZXh0ZXJuYWxFdmVudExpc3RlbmVyc1t0eXBlXS5zcGxpY2UoaSwgMSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoZXh0ZXJuYWxFdmVudExpc3RlbmVyc1t0eXBlXS5sZW5ndGggPT0gMCkgewogICAgICAgICAgLy8gUmVtb3ZlIGNhdGVnb3J5IGlmIGVtcHR5CiAgICAgICAgICBkZWxldGUgZXh0ZXJuYWxFdmVudExpc3RlbmVyc1t0eXBlXTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gUmVtb3ZlIGNhdGVnb3J5IG9mIGxpc3RlbmVycyBpZiBsaXN0ZW5lciBpc24ndCBzcGVjaWZpZWQKICAgICAgICBkZWxldGUgZXh0ZXJuYWxFdmVudExpc3RlbmVyc1t0eXBlXTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogICAgLyoqDQogICAgICogRmlyZSBsaXN0ZW5lcnMgYXR0YWNoZWQgdG8gc3BlY2lmaWVkIGV2ZW50Lg0KICAgICAqIEBwcml2YXRlDQogICAgICogQHBhcmFtIHtzdHJpbmd9IFt0eXBlXSAtIFR5cGUgb2YgZXZlbnQgdG8gZmlyZSBsaXN0ZW5lcnMgZm9yLg0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBmaXJlRXZlbnQodHlwZSkgewogICAgICBpZiAodHlwZSBpbiBleHRlcm5hbEV2ZW50TGlzdGVuZXJzKSB7CiAgICAgICAgLy8gUmV2ZXJzZSBpdGVyYXRpb24gaXMgdXNlZnVsLCBpZiBldmVudCBsaXN0ZW5lciBpcyByZW1vdmVkIGluc2lkZSBpdHMgZGVmaW5pdGlvbgogICAgICAgIGZvciAodmFyIGkgPSBleHRlcm5hbEV2ZW50TGlzdGVuZXJzW3R5cGVdLmxlbmd0aDsgaSA+IDA7IGktLSkgewogICAgICAgICAgZXh0ZXJuYWxFdmVudExpc3RlbmVyc1t0eXBlXVtleHRlcm5hbEV2ZW50TGlzdGVuZXJzW3R5cGVdLmxlbmd0aCAtIGldLmFwcGx5KG51bGwsIFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioNCiAgICAgKiBEZXN0cnVjdG9yLg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqIEBtZW1iZXJvZiBWaWV3ZXINCiAgICAgKi8KCgogICAgdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgICBkZXN0cm95ZWQgPSB0cnVlOwogICAgICBjbGVhclRpbWVvdXQoYXV0b1JvdGF0ZVN0YXJ0KTsKICAgICAgaWYgKHJlbmRlcmVyKSByZW5kZXJlci5kZXN0cm95KCk7CgogICAgICBpZiAobGlzdGVuZXJzQWRkZWQpIHsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBvbkRvY3VtZW50TW91c2VNb3ZlLCBmYWxzZSk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIG9uRG9jdW1lbnRNb3VzZVVwLCBmYWxzZSk7CiAgICAgICAgY29udGFpbmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vemZ1bGxzY3JlZW5jaGFuZ2UnLCBvbkZ1bGxTY3JlZW5DaGFuZ2UsIGZhbHNlKTsKICAgICAgICBjb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcignd2Via2l0ZnVsbHNjcmVlbmNoYW5nZScsIG9uRnVsbFNjcmVlbkNoYW5nZSwgZmFsc2UpOwogICAgICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCdtc2Z1bGxzY3JlZW5jaGFuZ2UnLCBvbkZ1bGxTY3JlZW5DaGFuZ2UsIGZhbHNlKTsKICAgICAgICBjb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcignZnVsbHNjcmVlbmNoYW5nZScsIG9uRnVsbFNjcmVlbkNoYW5nZSwgZmFsc2UpOwogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNpemUnLCBvbkRvY3VtZW50UmVzaXplLCBmYWxzZSk7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ29yaWVudGF0aW9uY2hhbmdlJywgb25Eb2N1bWVudFJlc2l6ZSwgZmFsc2UpOwogICAgICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywgb25Eb2N1bWVudEtleVByZXNzLCBmYWxzZSk7CiAgICAgICAgY29udGFpbmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleXVwJywgb25Eb2N1bWVudEtleVVwLCBmYWxzZSk7CiAgICAgICAgY29udGFpbmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2JsdXInLCBjbGVhcktleXMsIGZhbHNlKTsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgb25Eb2N1bWVudE1vdXNlVXAsIGZhbHNlKTsKICAgICAgfQoKICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9ICcnOwogICAgICBjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgncG5sbS1jb250YWluZXInKTsKICAgIH07CiAgfQoKICByZXR1cm4gewogICAgdmlld2VyOiBmdW5jdGlvbiB2aWV3ZXIoY29udGFpbmVyLCBjb25maWcpIHsKICAgICAgcmV0dXJuIG5ldyBWaWV3ZXIoY29udGFpbmVyLCBjb25maWcpOwogICAgfQogIH07Cn0od2luZG93LCBkb2N1bWVudCk7"},{"version":3,"sources":["D:/Практика/Vue practice/vue-pannellum-interface/src/pannellum-2.5.6/src/js/pannellum.js"],"names":["window","pannellum","document","undefined","Viewer","container","initialConfig","_this","config","renderer","preview","isUserInteracting","latestInteraction","Date","now","onPointerDownPointerX","onPointerDownPointerY","onPointerDownPointerDist","onPointerDownYaw","onPointerDownPitch","keysDown","Array","fullscreenActive","loaded","error","isTimedOut","listenersAdded","panoImage","prevTime","speed","animating","orientation","orientationYawOffset","autoRotateStart","autoRotateSpeed","origHfov","origPitch","animatedMove","externalEventListeners","specifiedPhotoSphereExcludes","update","eps","hotspotsCreated","destroyed","defaultConfig","hfov","minHfov","multiResMinHfov","maxHfov","pitch","minPitch","maxPitch","yaw","minYaw","maxYaw","roll","haov","vaov","vOffset","autoRotate","autoRotateInactivityDelay","autoRotateStopDelay","type","northOffset","showFullscreenCtrl","dynamic","dynamicUpdate","doubleClickZoom","keyboardZoom","mouseZoom","showZoomCtrl","autoLoad","showControls","orientationOnByDefault","hotSpotDebug","backgroundColor","avoidShowingBackground","animationTimingFunction","timingFunction","draggable","disableKeyboardCtrl","crossOrigin","touchPanSpeedCoeffFactor","capturedKeyNumbers","friction","strings","loadButtonLabel","loadingLabel","bylineLabel","noPanoramaError","fileAccessError","malformedURLError","iOS8WebGLError","genericWebGLError","textureSizeError","unknownError","getElementById","classList","add","tabIndex","uiContainer","createElement","className","appendChild","renderContainer","dragFix","aboutMsg","innerHTML","addEventListener","aboutMessage","infoDisplay","hotSpotDebugIndicator","title","author","load","box","boxp","lbox","lbar","lbarFill","msg","errorMsg","controls","processOptions","zoom","zoomIn","zoomOut","fullscreen","toggleFullscreen","fullscreenEnabled","mozFullScreenEnabled","webkitFullscreenEnabled","msFullscreenEnabled","e","stopOrientation","startOrientation","stopPropagation","orientationSupport","DeviceOrientationEvent","location","protocol","navigator","userAgent","toLowerCase","indexOf","compass","firstScene","mergeConfig","default","init","div","getElementsByTagName","length","anError","i","p","push","Image","style","display","c","JSON","parse","stringify","multiRes","basePath","test","panorama","itemsToLoad","onLoad","onImageLoad","onError","a","href","target","src","textContent","replace","outerHTML","cubeMap","console","log","absoluteURL","onload","onerror","sanitizeURL","URL","revokeObjectURL","xhr","XMLHttpRequest","onloadend","status","img","response","parseGPanoXMP","onprogress","lengthComputable","percent","total","width","unit","numerator","denominator","toFixed","open","responseType","setRequestHeader","withCredentials","send","remove","url","RegExp","slice","libpannellum","onDocumentMouseDown","onDocumentMouseMove","onDocumentMouseUp","onDocumentMouseWheel","onDocumentDoubleClick","onFullScreenChange","onDocumentResize","onDocumentKeyPress","onDocumentKeyUp","clearKeys","documentElement","pointerAction","touchAction","onDocumentPointerDown","onDocumentPointerMove","onDocumentPointerUp","onDocumentTouchStart","onDocumentTouchMove","onDocumentTouchEnd","pointerEnabled","renderInit","setHfov","setTimeout","image","reader","FileReader","result","match","flagIndex","start","ignoreGPanoXMP","xmpData","substring","getTag","tag","Number","xmp","fullWidth","croppedWidth","fullHeight","croppedHeight","topPixels","heading","horizonPitch","horizonRoll","createObjectURL","readAsBinaryString","readAsText","fireEvent","clearError","event","pos","mousePosition","left","x","top","y","clearTimeout","t1","t2","opacity","preventDefault","bounds","getBoundingClientRect","clientX","pageX","clientY","pageY","focus","coords","mouseEventToCoords","stopAnimation","animateInit","lookAt","canvas","getCanvas","canvasWidth","clientWidth","canvasHeight","clientHeight","focal","Math","tan","PI","s","sin","cos","root","sqrt","atan","atan2","vfov","pos0","targetTouches","pos1","clientDist","touchmovePanSpeedCoeff","pointerIDs","pointerCoordinates","pointerType","pointerId","defined","wheelDeltaY","wheelDelta","detail","keynumber","which","keycode","changeKey","value","keyChanged","performance","keyRepeat","isKeyDown","prevPitch","prevYaw","prevZoom","newTime","diff","min","timeDiff","yawDiff","abs","animateMove","slowDownFactor","maxSpeed","max","axis","t","normTime","startTime","duration","startPosition","endPosition","animate","render","requestAnimationFrame","isLoading","getPitch","getYaw","getHfov","autoRotateStartTime","tmpyaw","hoffcut","voffcut","hfov2","vfov2","height","transposed","yawRange","pitchRange","isNaN","renderHotSpots","transform","webkitTransform","Quaternion","w","z","prototype","multiply","q","toEulerAngles","phi","theta","asin","psi","taitBryanToQuaternion","alpha","beta","gamma","r","computeQuaternion","quaternion","angle","orientationListener","params","renderInitCallback","maxWidth","sceneFadeDuration","fadeImg","removeChild","createHotSpots","createHotSpot","hs","cssClass","escapeHTML","span","text","video","vidp","imgp","paddingTop","attributes","key","setAttribute","sceneId","onclick","ontouchend","clicked","loadScene","targetPitch","targetYaw","targetHfov","createTooltipFunc","createTooltipArgs","scrollWidth","marginLeft","offsetWidth","marginTop","scrollHeight","clickHandlerFunc","clickHandlerArgs","hotSpots","sort","b","forEach","destroyHotSpots","current","parentNode","renderHotSpot","hsPitchSin","hsPitchCos","configPitchSin","configPitchCos","yawCos","visibility","yawSin","hfovTan","coord","rollSin","rollCos","offsetHeight","scale","MozTransform","k","photoSphereExcludes","hasOwnProperty","scenes","scene","isPreview","backgroundImage","sanitizeURLForCss","previewTitle","previewAuthor","authorText","authorURL","authorLink","link","message","requestFullscreen","mozRequestFullScreen","msRequestFullscreen","webkitRequestFullScreen","exitFullscreen","mozCancelFullScreen","webkitCancelFullScreen","msExitFullscreen","resize","fullscreenElement","mozFullScreen","webkitIsFullScreen","msFullscreenElement","constrainHfov","cubeResolution","newHfov","fadeDone","workingPitch","workingYaw","workingHfov","data","returnImage","transition","removeEventListener","DeviceMotionEvent","requestPermission","then","String","split","join","decoded_url","decodeURIComponent","unescape","html","_","n","charAt","fromCharCode","parseInt","isLoaded","Boolean","setPitch","animated","callback","callbackArgs","getPitchBounds","setPitchBounds","setYaw","getYawBounds","setYawBounds","getHfovBounds","setHfovBounds","getNorthOffset","setNorthOffset","getHorizonRoll","setHorizonRoll","setPose","getHorizonPitch","setHorizonPitch","startAutoRotate","stopAutoRotate","stopMovement","getRenderer","setUpdate","bool","getScene","addScene","removeScene","getConfig","getContainer","addHotSpot","id","removeHotSpot","hotSpotId","splice","j","isOrientationSupported","isOrientationActive","on","listener","off","apply","call","arguments","destroy","viewer"],"mappings":"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","sourcesContent":["/*\r\n * Pannellum - An HTML5 based Panorama Viewer\r\n * Copyright (c) 2011-2019 Matthew Petroff\r\n * \r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n * \r\n * The above copyright notice and this permission notice shall be included in\r\n * all copies or substantial portions of the Software.\r\n * \r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n * THE SOFTWARE.\r\n */\r\n\r\nwindow.pannellum = (function(window, document, undefined) {\r\n\r\n'use strict';\r\n\r\n/**\r\n * Creates a new panorama viewer.\r\n * @constructor\r\n * @param {HTMLElement|string} container - The container (div) element for the\r\n *      viewer, or its ID.\r\n * @param {Object} initialConfig - Inital configuration for viewer.\r\n */\r\nfunction Viewer(container, initialConfig) {\r\n\r\nvar _this = this;\r\n\r\n// Declare variables\r\nvar config,\r\n    renderer,\r\n    preview,\r\n    isUserInteracting = false,\r\n    latestInteraction = Date.now(),\r\n    onPointerDownPointerX = 0,\r\n    onPointerDownPointerY = 0,\r\n    onPointerDownPointerDist = -1,\r\n    onPointerDownYaw = 0,\r\n    onPointerDownPitch = 0,\r\n    keysDown = new Array(10),\r\n    fullscreenActive = false,\r\n    loaded,\r\n    error = false,\r\n    isTimedOut = false,\r\n    listenersAdded = false,\r\n    panoImage,\r\n    prevTime,\r\n    speed = {'yaw': 0, 'pitch': 0, 'hfov': 0},\r\n    animating = false,\r\n    orientation = false,\r\n    orientationYawOffset = 0,\r\n    autoRotateStart,\r\n    autoRotateSpeed = 0,\r\n    origHfov,\r\n    origPitch,\r\n    animatedMove = {},\r\n    externalEventListeners = {},\r\n    specifiedPhotoSphereExcludes = [],\r\n    update = false, // Should we update when still to render dynamic content\r\n    eps = 1e-6,\r\n    hotspotsCreated = false,\r\n    destroyed = false;\r\n\r\nvar defaultConfig = {\r\n    hfov: 100,\r\n    minHfov: 50,\r\n    multiResMinHfov: false,\r\n    maxHfov: 120,\r\n    pitch: 0,\r\n    minPitch: undefined,\r\n    maxPitch: undefined,\r\n    yaw: 0,\r\n    minYaw: -180,\r\n    maxYaw: 180,\r\n    roll: 0,\r\n    haov: 360,\r\n    vaov: 180,\r\n    vOffset: 0,\r\n    autoRotate: false,\r\n    autoRotateInactivityDelay: -1,\r\n    autoRotateStopDelay: undefined,\r\n    type: 'equirectangular',\r\n    northOffset: 0,\r\n    showFullscreenCtrl: true,\r\n    dynamic: false,\r\n    dynamicUpdate: false,\r\n    doubleClickZoom: true,\r\n    keyboardZoom: true,\r\n    mouseZoom: true,\r\n    showZoomCtrl: true,\r\n    autoLoad: false,\r\n    showControls: true,\r\n    orientationOnByDefault: false,\r\n    hotSpotDebug: false,\r\n    backgroundColor: [0, 0, 0],\r\n    avoidShowingBackground: false,\r\n    animationTimingFunction: timingFunction,\r\n    draggable: true,\r\n    disableKeyboardCtrl: false,\r\n    crossOrigin: 'anonymous',\r\n    touchPanSpeedCoeffFactor: 1,\r\n    capturedKeyNumbers: [16, 17, 27, 37, 38, 39, 40, 61, 65, 68, 83, 87, 107, 109, 173, 187, 189],\r\n    friction: 0.15\r\n};\r\n\r\n// Translatable / configurable strings\r\n// Some strings contain '%s', which is a placeholder for inserted values\r\n// When setting strings in external configuration, `\\n` should be used instead of `<br>` to insert line breaks\r\ndefaultConfig.strings = {\r\n    // Labels\r\n    loadButtonLabel: 'Click to<br>Load<br>Panorama',\r\n    loadingLabel: 'Loading...',\r\n    bylineLabel: 'by %s',    // One substitution: author\r\n\r\n    // Errors\r\n    noPanoramaError: 'No panorama image was specified.',\r\n    fileAccessError: 'The file %s could not be accessed.',  // One substitution: file URL\r\n    malformedURLError: 'There is something wrong with the panorama URL.',\r\n    iOS8WebGLError: \"Due to iOS 8's broken WebGL implementation, only \" +\r\n                    \"progressive encoded JPEGs work for your device (this \" +\r\n                    \"panorama uses standard encoding).\",\r\n    genericWebGLError: 'Your browser does not have the necessary WebGL support to display this panorama.',\r\n    textureSizeError: 'This panorama is too big for your device! It\\'s ' +\r\n                '%spx wide, but your device only supports images up to ' +\r\n                '%spx wide. Try another device.' +\r\n                ' (If you\\'re the author, try scaling down the image.)',    // Two substitutions: image width, max image width\r\n    unknownError: 'Unknown error. Check developer console.',\r\n};\r\n\r\n// Initialize container\r\ncontainer = typeof container === 'string' ? document.getElementById(container) : container;\r\ncontainer.classList.add('pnlm-container');\r\ncontainer.tabIndex = 0;\r\n\r\n// Create container for ui\r\nvar uiContainer = document.createElement('div');\r\nuiContainer.className = 'pnlm-ui';\r\ncontainer.appendChild(uiContainer);\r\n\r\n// Create container for renderer\r\nvar renderContainer = document.createElement('div');\r\nrenderContainer.className = 'pnlm-render-container';\r\ncontainer.appendChild(renderContainer);\r\nvar dragFix = document.createElement('div');\r\ndragFix.className = 'pnlm-dragfix';\r\nuiContainer.appendChild(dragFix);\r\n\r\n// Display about information on right click\r\nvar aboutMsg = document.createElement('span');\r\naboutMsg.className = 'pnlm-about-msg';\r\naboutMsg.innerHTML = '<a href=\"https://pannellum.org/\" target=\"_blank\">Pannellum</a>';\r\nuiContainer.appendChild(aboutMsg);\r\ndragFix.addEventListener('contextmenu', aboutMessage);\r\n\r\n// Create info display\r\nvar infoDisplay = {};\r\n\r\n// Hot spot debug indicator\r\nvar hotSpotDebugIndicator = document.createElement('div');\r\nhotSpotDebugIndicator.className = 'pnlm-sprite pnlm-hot-spot-debug-indicator';\r\nuiContainer.appendChild(hotSpotDebugIndicator);\r\n\r\n// Panorama info\r\ninfoDisplay.container = document.createElement('div');\r\ninfoDisplay.container.className = 'pnlm-panorama-info';\r\ninfoDisplay.title = document.createElement('div');\r\ninfoDisplay.title.className = 'pnlm-title-box';\r\ninfoDisplay.container.appendChild(infoDisplay.title);\r\ninfoDisplay.author = document.createElement('div');\r\ninfoDisplay.author.className = 'pnlm-author-box';\r\ninfoDisplay.container.appendChild(infoDisplay.author);\r\nuiContainer.appendChild(infoDisplay.container);\r\n\r\n// Load box\r\ninfoDisplay.load = {};\r\ninfoDisplay.load.box = document.createElement('div');\r\ninfoDisplay.load.box.className = 'pnlm-load-box';\r\ninfoDisplay.load.boxp = document.createElement('p');\r\ninfoDisplay.load.box.appendChild(infoDisplay.load.boxp);\r\ninfoDisplay.load.lbox = document.createElement('div');\r\ninfoDisplay.load.lbox.className = 'pnlm-lbox';\r\ninfoDisplay.load.lbox.innerHTML = '<div class=\"pnlm-loading\"></div>';\r\ninfoDisplay.load.box.appendChild(infoDisplay.load.lbox);\r\ninfoDisplay.load.lbar = document.createElement('div');\r\ninfoDisplay.load.lbar.className = 'pnlm-lbar';\r\ninfoDisplay.load.lbarFill = document.createElement('div');\r\ninfoDisplay.load.lbarFill.className = 'pnlm-lbar-fill';\r\ninfoDisplay.load.lbar.appendChild(infoDisplay.load.lbarFill);\r\ninfoDisplay.load.box.appendChild(infoDisplay.load.lbar);\r\ninfoDisplay.load.msg = document.createElement('p');\r\ninfoDisplay.load.msg.className = 'pnlm-lmsg';\r\ninfoDisplay.load.box.appendChild(infoDisplay.load.msg);\r\nuiContainer.appendChild(infoDisplay.load.box);\r\n\r\n// Error message\r\ninfoDisplay.errorMsg = document.createElement('div');\r\ninfoDisplay.errorMsg.className = 'pnlm-error-msg pnlm-info-box';\r\nuiContainer.appendChild(infoDisplay.errorMsg);\r\n\r\n// Create controls\r\nvar controls = {};\r\ncontrols.container = document.createElement('div');\r\ncontrols.container.className = 'pnlm-controls-container';\r\nuiContainer.appendChild(controls.container);\r\n\r\n// Load button\r\ncontrols.load = document.createElement('div');\r\ncontrols.load.className = 'pnlm-load-button';\r\ncontrols.load.addEventListener('click', function() {\r\n    processOptions();\r\n    load();\r\n});\r\nuiContainer.appendChild(controls.load);\r\n\r\n// Zoom controls\r\ncontrols.zoom = document.createElement('div');\r\ncontrols.zoom.className = 'pnlm-zoom-controls pnlm-controls';\r\ncontrols.zoomIn = document.createElement('div');\r\ncontrols.zoomIn.className = 'pnlm-zoom-in pnlm-sprite pnlm-control';\r\ncontrols.zoomIn.addEventListener('click', zoomIn);\r\ncontrols.zoom.appendChild(controls.zoomIn);\r\ncontrols.zoomOut = document.createElement('div');\r\ncontrols.zoomOut.className = 'pnlm-zoom-out pnlm-sprite pnlm-control';\r\ncontrols.zoomOut.addEventListener('click', zoomOut);\r\ncontrols.zoom.appendChild(controls.zoomOut);\r\ncontrols.container.appendChild(controls.zoom);\r\n\r\n// Fullscreen toggle\r\ncontrols.fullscreen = document.createElement('div');\r\ncontrols.fullscreen.addEventListener('click', toggleFullscreen);\r\ncontrols.fullscreen.className = 'pnlm-fullscreen-toggle-button pnlm-sprite pnlm-fullscreen-toggle-button-inactive pnlm-controls pnlm-control';\r\nif (document.fullscreenEnabled || document.mozFullScreenEnabled || document.webkitFullscreenEnabled || document.msFullscreenEnabled)\r\n    controls.container.appendChild(controls.fullscreen);\r\n\r\n// Device orientation toggle\r\ncontrols.orientation = document.createElement('div');\r\ncontrols.orientation.addEventListener('click', function(e) {\r\n    if (orientation)\r\n        stopOrientation();\r\n    else\r\n        startOrientation();\r\n});\r\ncontrols.orientation.addEventListener('mousedown', function(e) {e.stopPropagation();});\r\ncontrols.orientation.addEventListener('touchstart', function(e) {e.stopPropagation();});\r\ncontrols.orientation.addEventListener('pointerdown', function(e) {e.stopPropagation();});\r\ncontrols.orientation.className = 'pnlm-orientation-button pnlm-orientation-button-inactive pnlm-sprite pnlm-controls pnlm-control';\r\nvar orientationSupport = false;\r\nif (window.DeviceOrientationEvent && location.protocol == 'https:' &&\r\n    navigator.userAgent.toLowerCase().indexOf('mobi') >= 0) {\r\n    // This user agent check is here because there's no way to check if a\r\n    // device has an inertia measurement unit. We used to be able to check if a\r\n    // DeviceOrientationEvent had non-null values, but with iOS 13 requiring a\r\n    // permission prompt to access such events, this is no longer possible.\r\n    controls.container.appendChild(controls.orientation);\r\n    orientationSupport = true;\r\n}\r\n\r\n// Compass\r\nvar compass = document.createElement('div');\r\ncompass.className = 'pnlm-compass pnlm-controls pnlm-control';\r\nuiContainer.appendChild(compass);\r\n\r\n// Load and process configuration\r\nif (initialConfig.firstScene) {\r\n    // Activate first scene if specified in URL\r\n    mergeConfig(initialConfig.firstScene);\r\n} else if (initialConfig.default && initialConfig.default.firstScene) {\r\n    // Activate first scene if specified in file\r\n    mergeConfig(initialConfig.default.firstScene);\r\n} else {\r\n    mergeConfig(null);\r\n}\r\nprocessOptions(true);\r\n\r\n/**\r\n * Initializes viewer.\r\n * @private\r\n */\r\nfunction init() {\r\n    // Display an error for IE 9 as it doesn't work but also doesn't otherwise\r\n    // show an error (older versions don't work at all)\r\n    // Based on: http://stackoverflow.com/a/10965203\r\n    var div = document.createElement(\"div\");\r\n    div.innerHTML = \"<!--[if lte IE 9]><i></i><![endif]-->\";\r\n    if (div.getElementsByTagName(\"i\").length == 1) {\r\n        anError();\r\n        return;\r\n    }\r\n\r\n    origHfov = config.hfov;\r\n    origPitch = config.pitch;\r\n\r\n    var i, p;\r\n    \r\n    if (config.type == 'cubemap') {\r\n        panoImage = [];\r\n        for (i = 0; i < 6; i++) {\r\n            panoImage.push(new Image());\r\n            panoImage[i].crossOrigin = config.crossOrigin;\r\n        }\r\n        infoDisplay.load.lbox.style.display = 'block';\r\n        infoDisplay.load.lbar.style.display = 'none';\r\n    } else if (config.type == 'multires') {\r\n        var c = JSON.parse(JSON.stringify(config.multiRes));    // Deep copy\r\n        // Avoid \"undefined\" in path, check (optional) multiRes.basePath, too\r\n        // Use only multiRes.basePath if it's an absolute URL\r\n        if (config.basePath && config.multiRes.basePath &&\r\n            !(/^(?:[a-z]+:)?\\/\\//i.test(config.multiRes.basePath))) {\r\n            c.basePath = config.basePath + config.multiRes.basePath;\r\n        } else if (config.multiRes.basePath) {\r\n            c.basePath = config.multiRes.basePath;\r\n        } else if(config.basePath) {\r\n            c.basePath = config.basePath;\r\n        }\r\n        panoImage = c;\r\n    } else {\r\n        if (config.dynamic === true) {\r\n            panoImage = config.panorama;\r\n        } else {\r\n            if (config.panorama === undefined) {\r\n                anError(config.strings.noPanoramaError);\r\n                return;\r\n            }\r\n            panoImage = new Image();\r\n        }\r\n    }\r\n\r\n    // Configure image loading\r\n    if (config.type == 'cubemap') {\r\n        // Quick loading counter for synchronous loading\r\n        var itemsToLoad = 6;\r\n        \r\n        var onLoad = function() {\r\n            itemsToLoad--;\r\n            if (itemsToLoad === 0) {\r\n                onImageLoad();\r\n            }\r\n        };\r\n        \r\n        var onError = function(e) {\r\n            var a = document.createElement('a');\r\n            a.href = e.target.src;\r\n            a.textContent = a.href;\r\n            anError(config.strings.fileAccessError.replace('%s', a.outerHTML));\r\n        };\r\n        \r\n        for (i = 0; i < panoImage.length; i++) {\r\n            p = config.cubeMap[i];\r\n            if (p == \"null\") { // support partial cubemap image with explicitly empty faces\r\n                console.log('Will use background instead of missing cubemap face ' + i);\r\n                onLoad();\r\n            } else {\r\n                if (config.basePath && !absoluteURL(p)) {\r\n                    p = config.basePath + p;\r\n                }\r\n                panoImage[i].onload = onLoad;\r\n                panoImage[i].onerror = onError;\r\n                panoImage[i].src = sanitizeURL(p);\r\n            }\r\n        }\r\n    } else if (config.type == 'multires') {\r\n        onImageLoad();\r\n    } else {\r\n        p = '';\r\n        if (config.basePath) {\r\n            p = config.basePath;\r\n        }\r\n        \r\n        if (config.dynamic !== true) {\r\n            // Still image\r\n            p = absoluteURL(config.panorama) ? config.panorama : p + config.panorama;\r\n            \r\n            panoImage.onload = function() {\r\n                window.URL.revokeObjectURL(this.src);  // Clean up\r\n                onImageLoad();\r\n            };\r\n            \r\n            var xhr = new XMLHttpRequest();\r\n            xhr.onloadend = function() {\r\n                if (xhr.status != 200) {\r\n                    // Display error if image can't be loaded\r\n                    var a = document.createElement('a');\r\n                    a.href = p;\r\n                    a.textContent = a.href;\r\n                    anError(config.strings.fileAccessError.replace('%s', a.outerHTML));\r\n                }\r\n                var img = this.response;\r\n                parseGPanoXMP(img);\r\n                infoDisplay.load.msg.innerHTML = '';\r\n            };\r\n            xhr.onprogress = function(e) {\r\n                if (e.lengthComputable) {\r\n                    // Display progress\r\n                    var percent = e.loaded / e.total * 100;\r\n                    infoDisplay.load.lbarFill.style.width = percent + '%';\r\n                    var unit, numerator, denominator;\r\n                    if (e.total > 1e6) {\r\n                        unit = 'MB';\r\n                        numerator = (e.loaded / 1e6).toFixed(2);\r\n                        denominator = (e.total / 1e6).toFixed(2);\r\n                    } else if (e.total > 1e3) {\r\n                        unit = 'kB';\r\n                        numerator = (e.loaded / 1e3).toFixed(1);\r\n                        denominator = (e.total / 1e3).toFixed(1);\r\n                    } else {\r\n                        unit = 'B';\r\n                        numerator = e.loaded;\r\n                        denominator = e.total;\r\n                    }\r\n                    infoDisplay.load.msg.innerHTML = numerator + ' / ' + denominator + ' ' + unit;\r\n                } else {\r\n                    // Display loading spinner\r\n                    infoDisplay.load.lbox.style.display = 'block';\r\n                    infoDisplay.load.lbar.style.display = 'none';\r\n                }\r\n            };\r\n            try {\r\n                xhr.open('GET', p, true);\r\n            } catch (e) {\r\n                // Malformed URL\r\n                anError(config.strings.malformedURLError);\r\n            }\r\n            xhr.responseType = 'blob';\r\n            xhr.setRequestHeader('Accept', 'image/*,*/*;q=0.9');\r\n            xhr.withCredentials = config.crossOrigin === 'use-credentials';\r\n            xhr.send();\r\n        }\r\n    }\r\n    \r\n    if (config.draggable)\r\n        uiContainer.classList.add('pnlm-grab');\r\n    uiContainer.classList.remove('pnlm-grabbing');\r\n\r\n    // Properly handle switching to dynamic scenes\r\n    update = config.dynamicUpdate === true;\r\n    if (config.dynamic && update) {\r\n        panoImage = config.panorama;\r\n        onImageLoad();\r\n    }\r\n}\r\n\r\n/**\r\n * Test if URL is absolute or relative.\r\n * @private\r\n * @param {string} url - URL to test\r\n * @returns {boolean} True if absolute, else false\r\n */\r\nfunction absoluteURL(url) {\r\n    // From http://stackoverflow.com/a/19709846\r\n    return new RegExp('^(?:[a-z]+:)?//', 'i').test(url) || url[0] == '/' || url.slice(0, 5) == 'blob:';\r\n}\r\n\r\n/**\r\n * Create renderer and initialize event listeners once image is loaded.\r\n * @private\r\n */\r\nfunction onImageLoad() {\r\n    if (!renderer)\r\n        renderer = new libpannellum.renderer(renderContainer);\r\n\r\n    // Only add event listeners once\r\n    if (!listenersAdded) {\r\n        listenersAdded = true;\r\n        dragFix.addEventListener('mousedown', onDocumentMouseDown, false);\r\n        document.addEventListener('mousemove', onDocumentMouseMove, false);\r\n        document.addEventListener('mouseup', onDocumentMouseUp, false);\r\n        if (config.mouseZoom) {\r\n            uiContainer.addEventListener('mousewheel', onDocumentMouseWheel, false);\r\n            uiContainer.addEventListener('DOMMouseScroll', onDocumentMouseWheel, false);\r\n        }\r\n        if (config.doubleClickZoom) {\r\n            dragFix.addEventListener('dblclick', onDocumentDoubleClick, false);\r\n        }\r\n        container.addEventListener('mozfullscreenchange', onFullScreenChange, false);\r\n        container.addEventListener('webkitfullscreenchange', onFullScreenChange, false);\r\n        container.addEventListener('msfullscreenchange', onFullScreenChange, false);\r\n        container.addEventListener('fullscreenchange', onFullScreenChange, false);\r\n        window.addEventListener('resize', onDocumentResize, false);\r\n        window.addEventListener('orientationchange', onDocumentResize, false);\r\n        if (!config.disableKeyboardCtrl) {\r\n            container.addEventListener('keydown', onDocumentKeyPress, false);\r\n            container.addEventListener('keyup', onDocumentKeyUp, false);\r\n            container.addEventListener('blur', clearKeys, false);\r\n        }\r\n        document.addEventListener('mouseleave', onDocumentMouseUp, false);\r\n        if (document.documentElement.style.pointerAction === '' &&\r\n            document.documentElement.style.touchAction === '') {\r\n            dragFix.addEventListener('pointerdown', onDocumentPointerDown, false);\r\n            dragFix.addEventListener('pointermove', onDocumentPointerMove, false);\r\n            dragFix.addEventListener('pointerup', onDocumentPointerUp, false);\r\n            dragFix.addEventListener('pointerleave', onDocumentPointerUp, false);\r\n        } else {\r\n            dragFix.addEventListener('touchstart', onDocumentTouchStart, false);\r\n            dragFix.addEventListener('touchmove', onDocumentTouchMove, false);\r\n            dragFix.addEventListener('touchend', onDocumentTouchEnd, false);\r\n        }\r\n\r\n        // Deal with MS pointer events\r\n        if (window.navigator.pointerEnabled)\r\n            container.style.touchAction = 'none';\r\n    }\r\n\r\n    renderInit();\r\n    setHfov(config.hfov); // possibly adapt hfov after configuration and canvas is complete; prevents empty space on top or bottom by zomming out too much\r\n    setTimeout(function(){isTimedOut = true;}, 500);\r\n}\r\n\r\n/**\r\n * Parses Google Photo Sphere XMP Metadata.\r\n * https://developers.google.com/photo-sphere/metadata/\r\n * @private\r\n * @param {Image} image - Image to read XMP metadata from.\r\n */\r\nfunction parseGPanoXMP(image) {\r\n    var reader = new FileReader();\r\n    reader.addEventListener('loadend', function() {\r\n        var img = reader.result;\r\n\r\n        // This awful browser specific test exists because iOS 8 does not work\r\n        // with non-progressive encoded JPEGs.\r\n        if (navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 8_/)) {\r\n            var flagIndex = img.indexOf('\\xff\\xc2');\r\n            if (flagIndex < 0 || flagIndex > 65536)\r\n                anError(config.strings.iOS8WebGLError);\r\n        }\r\n\r\n        var start = img.indexOf('<x:xmpmeta');\r\n        if (start > -1 && config.ignoreGPanoXMP !== true) {\r\n            var xmpData = img.substring(start, img.indexOf('</x:xmpmeta>') + 12);\r\n            \r\n            // Extract the requested tag from the XMP data\r\n            var getTag = function(tag) {\r\n                var result;\r\n                if (xmpData.indexOf(tag + '=\"') >= 0) {\r\n                    result = xmpData.substring(xmpData.indexOf(tag + '=\"') + tag.length + 2);\r\n                    result = result.substring(0, result.indexOf('\"'));\r\n                } else if (xmpData.indexOf(tag + '>') >= 0) {\r\n                    result = xmpData.substring(xmpData.indexOf(tag + '>') + tag.length + 1);\r\n                    result = result.substring(0, result.indexOf('<'));\r\n                }\r\n                if (result !== undefined) {\r\n                    return Number(result);\r\n                }\r\n                return null;\r\n            };\r\n            \r\n            // Relevant XMP data\r\n            var xmp = {\r\n                fullWidth: getTag('GPano:FullPanoWidthPixels'),\r\n                croppedWidth: getTag('GPano:CroppedAreaImageWidthPixels'),\r\n                fullHeight: getTag('GPano:FullPanoHeightPixels'),\r\n                croppedHeight: getTag('GPano:CroppedAreaImageHeightPixels'),\r\n                topPixels: getTag('GPano:CroppedAreaTopPixels'),\r\n                heading: getTag('GPano:PoseHeadingDegrees'),\r\n                horizonPitch: getTag('GPano:PosePitchDegrees'),\r\n                horizonRoll: getTag('GPano:PoseRollDegrees')\r\n            };\r\n            \r\n            if (xmp.fullWidth !== null && xmp.croppedWidth !== null &&\r\n                xmp.fullHeight !== null && xmp.croppedHeight !== null &&\r\n                xmp.topPixels !== null) {\r\n                \r\n                // Set up viewer using GPano XMP data\r\n                if (specifiedPhotoSphereExcludes.indexOf('haov') < 0)\r\n                    config.haov = xmp.croppedWidth / xmp.fullWidth * 360;\r\n                if (specifiedPhotoSphereExcludes.indexOf('vaov') < 0)\r\n                    config.vaov = xmp.croppedHeight / xmp.fullHeight * 180;\r\n                if (specifiedPhotoSphereExcludes.indexOf('vOffset') < 0)\r\n                    config.vOffset = ((xmp.topPixels + xmp.croppedHeight / 2) / xmp.fullHeight - 0.5) * -180;\r\n                if (xmp.heading !== null && specifiedPhotoSphereExcludes.indexOf('northOffset') < 0) {\r\n                    // TODO: make sure this works correctly for partial panoramas\r\n                    config.northOffset = xmp.heading;\r\n                    if (config.compass !== false) {\r\n                        config.compass = true;\r\n                    }\r\n                }\r\n                if (xmp.horizonPitch !== null && xmp.horizonRoll !== null) {\r\n                    if (specifiedPhotoSphereExcludes.indexOf('horizonPitch') < 0)\r\n                        config.horizonPitch = xmp.horizonPitch;\r\n                    if (specifiedPhotoSphereExcludes.indexOf('horizonRoll') < 0)\r\n                        config.horizonRoll = xmp.horizonRoll;\r\n                }\r\n                \r\n                // TODO: add support for initial view settings\r\n            }\r\n        }\r\n        \r\n        // Load panorama\r\n        panoImage.src = window.URL.createObjectURL(image);\r\n    });\r\n    if (reader.readAsBinaryString !== undefined)\r\n        reader.readAsBinaryString(image);\r\n    else\r\n        reader.readAsText(image);\r\n}\r\n\r\n/**\r\n * Displays an error message.\r\n * @private\r\n * @param {string} errorMsg - Error message to display. If not specified, a\r\n *      generic WebGL error is displayed.\r\n */\r\nfunction anError(errorMsg) {\r\n    if (errorMsg === undefined)\r\n        errorMsg = config.strings.genericWebGLError;\r\n    infoDisplay.errorMsg.innerHTML = '<p>' + errorMsg + '</p>';\r\n    controls.load.style.display = 'none';\r\n    infoDisplay.load.box.style.display = 'none';\r\n    infoDisplay.errorMsg.style.display = 'table';\r\n    error = true;\r\n    loaded = undefined;\r\n    renderContainer.style.display = 'none';\r\n    fireEvent('error', errorMsg);\r\n}\r\n\r\n/**\r\n * Hides error message display.\r\n * @private\r\n */\r\nfunction clearError() {\r\n    if (error) {\r\n        infoDisplay.load.box.style.display = 'none';\r\n        infoDisplay.errorMsg.style.display = 'none';\r\n        error = false;\r\n        renderContainer.style.display = 'block';\r\n        fireEvent('errorcleared');\r\n    }\r\n}\r\n\r\n/**\r\n * Displays about message.\r\n * @private\r\n * @param {MouseEvent} event - Right click location\r\n */\r\nfunction aboutMessage(event) {\r\n    var pos = mousePosition(event);\r\n    aboutMsg.style.left = pos.x + 'px';\r\n    aboutMsg.style.top = pos.y + 'px';\r\n    clearTimeout(aboutMessage.t1);\r\n    clearTimeout(aboutMessage.t2);\r\n    aboutMsg.style.display = 'block';\r\n    aboutMsg.style.opacity = 1;\r\n    aboutMessage.t1 = setTimeout(function() {aboutMsg.style.opacity = 0;}, 2000);\r\n    aboutMessage.t2 = setTimeout(function() {aboutMsg.style.display = 'none';}, 2500);\r\n    event.preventDefault();\r\n}\r\n\r\n/**\r\n * Calculate mouse position relative to top left of viewer container.\r\n * @private\r\n * @param {MouseEvent} event - Mouse event to use in calculation\r\n * @returns {Object} Calculated X and Y coordinates\r\n */\r\nfunction mousePosition(event) {\r\n    var bounds = container.getBoundingClientRect();\r\n    var pos = {};\r\n    // pageX / pageY needed for iOS\r\n    pos.x = (event.clientX || event.pageX) - bounds.left;\r\n    pos.y = (event.clientY || event.pageY) - bounds.top;\r\n    return pos;\r\n}\r\n\r\n/**\r\n * Event handler for mouse clicks. Initializes panning. Prints center and click\r\n * location coordinates when hot spot debugging is enabled.\r\n * @private\r\n * @param {MouseEvent} event - Document mouse down event.\r\n */\r\nfunction onDocumentMouseDown(event) {\r\n    // Override default action\r\n    event.preventDefault();\r\n    // But not all of it\r\n    container.focus();\r\n    \r\n    // Only do something if the panorama is loaded\r\n    if (!loaded || !config.draggable) {\r\n        return;\r\n    }\r\n    \r\n    // Calculate mouse position relative to top left of viewer container\r\n    var pos = mousePosition(event);\r\n\r\n    // Log pitch / yaw of mouse click when debugging / placing hot spots\r\n    if (config.hotSpotDebug) {\r\n        var coords = mouseEventToCoords(event);\r\n        console.log('Pitch: ' + coords[0] + ', Yaw: ' + coords[1] + ', Center Pitch: ' +\r\n            config.pitch + ', Center Yaw: ' + config.yaw + ', HFOV: ' + config.hfov);\r\n    }\r\n    \r\n    // Turn off auto-rotation if enabled\r\n    stopAnimation();\r\n\r\n    stopOrientation();\r\n    config.roll = 0;\r\n\r\n    speed.hfov = 0;\r\n\r\n    isUserInteracting = true;\r\n    latestInteraction = Date.now();\r\n    \r\n    onPointerDownPointerX = pos.x;\r\n    onPointerDownPointerY = pos.y;\r\n    \r\n    onPointerDownYaw = config.yaw;\r\n    onPointerDownPitch = config.pitch;\r\n    \r\n    uiContainer.classList.add('pnlm-grabbing');\r\n    uiContainer.classList.remove('pnlm-grab');\r\n    \r\n    fireEvent('mousedown', event);\r\n    animateInit();\r\n}\r\n\r\n/**\r\n * Event handler for double clicks. Zooms in at clicked location\r\n * @private\r\n * @param {MouseEvent} event - Document mouse down event.\r\n */\r\nfunction onDocumentDoubleClick(event) {\r\n    if (config.minHfov === config.hfov) {\r\n        _this.setHfov(origHfov, 1000);\r\n    } else {\r\n        var coords = mouseEventToCoords(event);\r\n        _this.lookAt(coords[0], coords[1], config.minHfov, 1000);\r\n    }\r\n}\r\n\r\n/**\r\n * Calculate panorama pitch and yaw from location of mouse event.\r\n * @private\r\n * @param {MouseEvent} event - Document mouse down event.\r\n * @returns {number[]} [pitch, yaw]\r\n */\r\nfunction mouseEventToCoords(event) {\r\n    var pos = mousePosition(event);\r\n    var canvas = renderer.getCanvas();\r\n    var canvasWidth = canvas.clientWidth,\r\n        canvasHeight = canvas.clientHeight;\r\n    var x = pos.x / canvasWidth * 2 - 1;\r\n    var y = (1 - pos.y / canvasHeight * 2) * canvasHeight / canvasWidth;\r\n    var focal = 1 / Math.tan(config.hfov * Math.PI / 360);\r\n    var s = Math.sin(config.pitch * Math.PI / 180);\r\n    var c = Math.cos(config.pitch * Math.PI / 180);\r\n    var a = focal * c - y * s;\r\n    var root = Math.sqrt(x*x + a*a);\r\n    var pitch = Math.atan((y * c + focal * s) / root) * 180 / Math.PI;\r\n    var yaw = Math.atan2(x / root, a / root) * 180 / Math.PI + config.yaw;\r\n    if (yaw < -180)\r\n        yaw += 360;\r\n    if (yaw > 180)\r\n        yaw -= 360;\r\n    return [pitch, yaw];\r\n}\r\n\r\n/**\r\n * Event handler for mouse moves. Pans center of view.\r\n * @private\r\n * @param {MouseEvent} event - Document mouse move event.\r\n */\r\nfunction onDocumentMouseMove(event) {\r\n    if (isUserInteracting && loaded) {\r\n        latestInteraction = Date.now();\r\n        var canvas = renderer.getCanvas();\r\n        var canvasWidth = canvas.clientWidth,\r\n            canvasHeight = canvas.clientHeight;\r\n        var pos = mousePosition(event);\r\n        //TODO: This still isn't quite right\r\n        var yaw = ((Math.atan(onPointerDownPointerX / canvasWidth * 2 - 1) - Math.atan(pos.x / canvasWidth * 2 - 1)) * 180 / Math.PI * config.hfov / 90) + onPointerDownYaw;\r\n        speed.yaw = (yaw - config.yaw) % 360 * 0.2;\r\n        config.yaw = yaw;\r\n        \r\n        var vfov = 2 * Math.atan(Math.tan(config.hfov/360*Math.PI) * canvasHeight / canvasWidth) * 180 / Math.PI;\r\n        \r\n        var pitch = ((Math.atan(pos.y / canvasHeight * 2 - 1) - Math.atan(onPointerDownPointerY / canvasHeight * 2 - 1)) * 180 / Math.PI * vfov / 90) + onPointerDownPitch;\r\n        speed.pitch = (pitch - config.pitch) * 0.2;\r\n        config.pitch = pitch;\r\n    }\r\n}\r\n\r\n/**\r\n * Event handler for mouse up events. Stops panning.\r\n * @private\r\n */\r\nfunction onDocumentMouseUp(event) {\r\n    if (!isUserInteracting) {\r\n        return;\r\n    }\r\n    isUserInteracting = false;\r\n    if (Date.now() - latestInteraction > 15) {\r\n        // Prevents jump when user rapidly moves mouse, stops, and then\r\n        // releases the mouse button\r\n        speed.pitch = speed.yaw = 0;\r\n    }\r\n    uiContainer.classList.add('pnlm-grab');\r\n    uiContainer.classList.remove('pnlm-grabbing');\r\n    latestInteraction = Date.now();\r\n\r\n    fireEvent('mouseup', event);\r\n}\r\n\r\n/**\r\n * Event handler for touches. Initializes panning if one touch or zooming if\r\n * two touches.\r\n * @private\r\n * @param {TouchEvent} event - Document touch start event.\r\n */\r\nfunction onDocumentTouchStart(event) {\r\n    // Only do something if the panorama is loaded\r\n    if (!loaded || !config.draggable) {\r\n        return;\r\n    }\r\n\r\n    // Turn off auto-rotation if enabled\r\n    stopAnimation();\r\n\r\n    stopOrientation();\r\n    config.roll = 0;\r\n\r\n    speed.hfov = 0;\r\n\r\n    // Calculate touch position relative to top left of viewer container\r\n    var pos0 = mousePosition(event.targetTouches[0]);\r\n\r\n    onPointerDownPointerX = pos0.x;\r\n    onPointerDownPointerY = pos0.y;\r\n    \r\n    if (event.targetTouches.length == 2) {\r\n        // Down pointer is the center of the two fingers\r\n        var pos1 = mousePosition(event.targetTouches[1]);\r\n        onPointerDownPointerX += (pos1.x - pos0.x) * 0.5;\r\n        onPointerDownPointerY += (pos1.y - pos0.y) * 0.5;\r\n        onPointerDownPointerDist = Math.sqrt((pos0.x - pos1.x) * (pos0.x - pos1.x) +\r\n                                             (pos0.y - pos1.y) * (pos0.y - pos1.y));\r\n    }\r\n    isUserInteracting = true;\r\n    latestInteraction = Date.now();\r\n    \r\n    onPointerDownYaw = config.yaw;\r\n    onPointerDownPitch = config.pitch;\r\n\r\n    fireEvent('touchstart', event);\r\n    animateInit();\r\n}\r\n\r\n/**\r\n * Event handler for touch movements. Pans center of view if one touch or\r\n * adjusts zoom if two touches.\r\n * @private\r\n * @param {TouchEvent} event - Document touch move event.\r\n */\r\nfunction onDocumentTouchMove(event) {\r\n    if (!config.draggable) {\r\n        return;\r\n    }\r\n\r\n    // Override default action\r\n    event.preventDefault();\r\n    if (loaded) {\r\n        latestInteraction = Date.now();\r\n    }\r\n    if (isUserInteracting && loaded) {\r\n        var pos0 = mousePosition(event.targetTouches[0]);\r\n        var clientX = pos0.x;\r\n        var clientY = pos0.y;\r\n        \r\n        if (event.targetTouches.length == 2 && onPointerDownPointerDist != -1) {\r\n            var pos1 = mousePosition(event.targetTouches[1]);\r\n            clientX += (pos1.x - pos0.x) * 0.5;\r\n            clientY += (pos1.y - pos0.y) * 0.5;\r\n            var clientDist = Math.sqrt((pos0.x - pos1.x) * (pos0.x - pos1.x) +\r\n                                       (pos0.y - pos1.y) * (pos0.y - pos1.y));\r\n            setHfov(config.hfov + (onPointerDownPointerDist - clientDist) * 0.1);\r\n            onPointerDownPointerDist = clientDist;\r\n        }\r\n\r\n        // The smaller the config.hfov value (the more zoomed-in the user is), the faster\r\n        // yaw/pitch are perceived to change on one-finger touchmove (panning) events and vice versa.\r\n        // To improve usability at both small and large zoom levels (config.hfov values)\r\n        // we introduce a dynamic pan speed coefficient.\r\n        //\r\n        // Currently this seems to *roughly* keep initial drag/pan start position close to\r\n        // the user's finger while panning regardless of zoom level / config.hfov value.\r\n        var touchmovePanSpeedCoeff = (config.hfov / 360) * config.touchPanSpeedCoeffFactor;\r\n\r\n        var yaw = (onPointerDownPointerX - clientX) * touchmovePanSpeedCoeff + onPointerDownYaw;\r\n        speed.yaw = (yaw - config.yaw) % 360 * 0.2;\r\n        config.yaw = yaw;\r\n\r\n        var pitch = (clientY - onPointerDownPointerY) * touchmovePanSpeedCoeff + onPointerDownPitch;\r\n        speed.pitch = (pitch - config.pitch) * 0.2;\r\n        config.pitch = pitch;\r\n    }\r\n}\r\n\r\n/**\r\n * Event handler for end of touches. Stops panning and/or zooming.\r\n * @private\r\n */\r\nfunction onDocumentTouchEnd() {\r\n    isUserInteracting = false;\r\n    if (Date.now() - latestInteraction > 150) {\r\n        speed.pitch = speed.yaw = 0;\r\n    }\r\n    onPointerDownPointerDist = -1;\r\n    latestInteraction = Date.now();\r\n\r\n    fireEvent('touchend', event);\r\n}\r\n\r\nvar pointerIDs = [],\r\n    pointerCoordinates = [];\r\n/**\r\n * Event handler for touch starts in IE / Edge.\r\n * @private\r\n * @param {PointerEvent} event - Document pointer down event.\r\n */\r\nfunction onDocumentPointerDown(event) {\r\n    if (event.pointerType == 'touch') {\r\n        // Only do something if the panorama is loaded\r\n        if (!loaded || !config.draggable)\r\n            return;\r\n        pointerIDs.push(event.pointerId);\r\n        pointerCoordinates.push({clientX: event.clientX, clientY: event.clientY});\r\n        event.targetTouches = pointerCoordinates;\r\n        onDocumentTouchStart(event);\r\n        event.preventDefault();\r\n    }\r\n}\r\n\r\n/**\r\n * Event handler for touch moves in IE / Edge.\r\n * @private\r\n * @param {PointerEvent} event - Document pointer move event.\r\n */\r\nfunction onDocumentPointerMove(event) {\r\n    if (event.pointerType == 'touch') {\r\n        if (!config.draggable)\r\n            return;\r\n        for (var i = 0; i < pointerIDs.length; i++) {\r\n            if (event.pointerId == pointerIDs[i]) {\r\n                pointerCoordinates[i].clientX = event.clientX;\r\n                pointerCoordinates[i].clientY = event.clientY;\r\n                event.targetTouches = pointerCoordinates;\r\n                onDocumentTouchMove(event);\r\n                event.preventDefault();\r\n                return;\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Event handler for touch ends in IE / Edge.\r\n * @private\r\n * @param {PointerEvent} event - Document pointer up event.\r\n */\r\nfunction onDocumentPointerUp(event) {\r\n    if (event.pointerType == 'touch') {\r\n        var defined = false;\r\n        for (var i = 0; i < pointerIDs.length; i++) {\r\n            if (event.pointerId == pointerIDs[i])\r\n                pointerIDs[i] = undefined;\r\n            if (pointerIDs[i])\r\n                defined = true;\r\n        }\r\n        if (!defined) {\r\n            pointerIDs = [];\r\n            pointerCoordinates = [];\r\n            onDocumentTouchEnd();\r\n        }\r\n        event.preventDefault();\r\n    }\r\n}\r\n\r\n/**\r\n * Event handler for mouse wheel. Changes zoom.\r\n * @private\r\n * @param {WheelEvent} event - Document mouse wheel event.\r\n */\r\nfunction onDocumentMouseWheel(event) {\r\n    // Only do something if the panorama is loaded and mouse wheel zoom is enabled\r\n    if (!loaded || (config.mouseZoom == 'fullscreenonly' && !fullscreenActive)) {\r\n        return;\r\n    }\r\n\r\n    event.preventDefault();\r\n\r\n    // Turn off auto-rotation if enabled\r\n    stopAnimation();\r\n    latestInteraction = Date.now();\r\n\r\n    if (event.wheelDeltaY) {\r\n        // WebKit\r\n        setHfov(config.hfov - event.wheelDeltaY * 0.05);\r\n        speed.hfov = event.wheelDelta < 0 ? 1 : -1;\r\n    } else if (event.wheelDelta) {\r\n        // Opera / Explorer 9\r\n        setHfov(config.hfov - event.wheelDelta * 0.05);\r\n        speed.hfov = event.wheelDelta < 0 ? 1 : -1;\r\n    } else if (event.detail) {\r\n        // Firefox\r\n        setHfov(config.hfov + event.detail * 1.5);\r\n        speed.hfov = event.detail > 0 ? 1 : -1;\r\n    }\r\n    animateInit();\r\n}\r\n\r\n/**\r\n * Event handler for key presses. Updates list of currently pressed keys.\r\n * @private\r\n * @param {KeyboardEvent} event - Document key press event.\r\n */\r\nfunction onDocumentKeyPress(event) {\r\n    // Turn off auto-rotation if enabled\r\n    stopAnimation();\r\n    latestInteraction = Date.now();\r\n\r\n    stopOrientation();\r\n    config.roll = 0;\r\n\r\n    // Record key pressed\r\n    var keynumber = event.which || event.keycode;\r\n\r\n    // Override default action for keys that are used\r\n    if (config.capturedKeyNumbers.indexOf(keynumber) < 0)\r\n        return;\r\n    event.preventDefault();\r\n    \r\n    // If escape key is pressed\r\n    if (keynumber == 27) {\r\n        // If in fullscreen mode\r\n        if (fullscreenActive) {\r\n            toggleFullscreen();\r\n        }\r\n    } else {\r\n        // Change key\r\n        changeKey(keynumber, true);\r\n    }\r\n}\r\n\r\n/**\r\n * Clears list of currently pressed keys.\r\n * @private\r\n */\r\nfunction clearKeys() {\r\n    for (var i = 0; i < 10; i++) {\r\n        keysDown[i] = false;\r\n    }\r\n}\r\n\r\n/**\r\n * Event handler for key releases. Updates list of currently pressed keys.\r\n * @private\r\n * @param {KeyboardEvent} event - Document key up event.\r\n */\r\nfunction onDocumentKeyUp(event) {\r\n    // Record key pressed\r\n    var keynumber = event.which || event.keycode;\r\n    \r\n    // Override default action for keys that are used\r\n    if (config.capturedKeyNumbers.indexOf(keynumber) < 0)\r\n        return;\r\n    event.preventDefault();\r\n    \r\n    // Change key\r\n    changeKey(keynumber, false);\r\n}\r\n\r\n/**\r\n * Updates list of currently pressed keys.\r\n * @private\r\n * @param {number} keynumber - Key number.\r\n * @param {boolean} value - Whether or not key is pressed.\r\n */\r\nfunction changeKey(keynumber, value) {\r\n    var keyChanged = false;\r\n    switch(keynumber) {\r\n        // If minus key is released\r\n        case 109: case 189: case 17: case 173:\r\n            if (keysDown[0] != value) { keyChanged = true; }\r\n            keysDown[0] = value; break;\r\n        \r\n        // If plus key is released\r\n        case 107: case 187: case 16: case 61:\r\n            if (keysDown[1] != value) { keyChanged = true; }\r\n            keysDown[1] = value; break;\r\n        \r\n        // If up arrow is released\r\n        case 38:\r\n            if (keysDown[2] != value) { keyChanged = true; }\r\n            keysDown[2] = value; break;\r\n        \r\n        // If \"w\" is released\r\n        case 87:\r\n            if (keysDown[6] != value) { keyChanged = true; }\r\n            keysDown[6] = value; break;\r\n        \r\n        // If down arrow is released\r\n        case 40:\r\n            if (keysDown[3] != value) { keyChanged = true; }\r\n            keysDown[3] = value; break;\r\n        \r\n        // If \"s\" is released\r\n        case 83:\r\n            if (keysDown[7] != value) { keyChanged = true; }\r\n            keysDown[7] = value; break;\r\n        \r\n        // If left arrow is released\r\n        case 37:\r\n            if (keysDown[4] != value) { keyChanged = true; }\r\n            keysDown[4] = value; break;\r\n        \r\n        // If \"a\" is released\r\n        case 65:\r\n            if (keysDown[8] != value) { keyChanged = true; }\r\n            keysDown[8] = value; break;\r\n        \r\n        // If right arrow is released\r\n        case 39:\r\n            if (keysDown[5] != value) { keyChanged = true; }\r\n            keysDown[5] = value; break;\r\n        \r\n        // If \"d\" is released\r\n        case 68:\r\n            if (keysDown[9] != value) { keyChanged = true; }\r\n            keysDown[9] = value;\r\n    }\r\n    \r\n    if (keyChanged && value) {\r\n        if (typeof performance !== 'undefined' && performance.now()) {\r\n            prevTime = performance.now();\r\n        } else {\r\n            prevTime = Date.now();\r\n        }\r\n        animateInit();\r\n    }\r\n}\r\n\r\n/**\r\n * Pans and/or zooms panorama based on currently pressed keys. Also handles\r\n * panorama \"inertia\" and auto rotation.\r\n * @private\r\n */\r\nfunction keyRepeat() {\r\n    // Only do something if the panorama is loaded\r\n    if (!loaded) {\r\n        return;\r\n    }\r\n\r\n    var isKeyDown = false;\r\n\r\n    var prevPitch = config.pitch;\r\n    var prevYaw = config.yaw;\r\n    var prevZoom = config.hfov;\r\n    \r\n    var newTime;\r\n    if (typeof performance !== 'undefined' && performance.now()) {\r\n        newTime = performance.now();\r\n    } else {\r\n        newTime = Date.now();\r\n    }\r\n    if (prevTime === undefined) {\r\n        prevTime = newTime;\r\n    }\r\n    var diff = (newTime - prevTime) * config.hfov / 1700;\r\n    diff = Math.min(diff, 1.0);\r\n    \r\n    // If minus key is down\r\n    if (keysDown[0] && config.keyboardZoom === true) {\r\n        setHfov(config.hfov + (speed.hfov * 0.8 + 0.5) * diff);\r\n        isKeyDown = true;\r\n    }\r\n    \r\n    // If plus key is down\r\n    if (keysDown[1] && config.keyboardZoom === true) {\r\n        setHfov(config.hfov + (speed.hfov * 0.8 - 0.2) * diff);\r\n        isKeyDown = true;\r\n    }\r\n    \r\n    // If up arrow or \"w\" is down\r\n    if (keysDown[2] || keysDown[6]) {\r\n        // Pan up\r\n        config.pitch += (speed.pitch * 0.8 + 0.2) * diff;\r\n        isKeyDown = true;\r\n    }\r\n    \r\n    // If down arrow or \"s\" is down\r\n    if (keysDown[3] || keysDown[7]) {\r\n        // Pan down\r\n        config.pitch += (speed.pitch * 0.8 - 0.2) * diff;\r\n        isKeyDown = true;\r\n    }\r\n    \r\n    // If left arrow or \"a\" is down\r\n    if (keysDown[4] || keysDown[8]) {\r\n        // Pan left\r\n        config.yaw += (speed.yaw * 0.8 - 0.2) * diff;\r\n        isKeyDown = true;\r\n    }\r\n    \r\n    // If right arrow or \"d\" is down\r\n    if (keysDown[5] || keysDown[9]) {\r\n        // Pan right\r\n        config.yaw += (speed.yaw * 0.8 + 0.2) * diff;\r\n        isKeyDown = true;\r\n    }\r\n\r\n    if (isKeyDown)\r\n        latestInteraction = Date.now();\r\n\r\n    // If auto-rotate\r\n    if (config.autoRotate) {\r\n        // Pan\r\n        if (newTime - prevTime > 0.001) {\r\n            var timeDiff = (newTime - prevTime) / 1000;\r\n            var yawDiff = (speed.yaw / timeDiff * diff - config.autoRotate * 0.2) * timeDiff;\r\n            yawDiff = (-config.autoRotate > 0 ? 1 : -1) * Math.min(Math.abs(config.autoRotate * timeDiff), Math.abs(yawDiff));\r\n            config.yaw += yawDiff;\r\n        }\r\n        \r\n        // Deal with stopping auto rotation after a set delay\r\n        if (config.autoRotateStopDelay) {\r\n            config.autoRotateStopDelay -= newTime - prevTime;\r\n            if (config.autoRotateStopDelay <= 0) {\r\n                config.autoRotateStopDelay = false;\r\n                autoRotateSpeed = config.autoRotate;\r\n                config.autoRotate = 0;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Animated moves\r\n    if (animatedMove.pitch) {\r\n        animateMove('pitch');\r\n        prevPitch = config.pitch;\r\n    }\r\n    if (animatedMove.yaw) {\r\n        animateMove('yaw');\r\n        prevYaw = config.yaw;\r\n    }\r\n    if (animatedMove.hfov) {\r\n        animateMove('hfov');\r\n        prevZoom = config.hfov;\r\n    }\r\n\r\n    // \"Inertia\"\r\n    if (diff > 0 && !config.autoRotate) {\r\n        // \"Friction\"\r\n        var slowDownFactor = 1 - config.friction;\r\n\r\n        // Yaw\r\n        if (!keysDown[4] && !keysDown[5] && !keysDown[8] && !keysDown[9] && !animatedMove.yaw) {\r\n            config.yaw += speed.yaw * diff * slowDownFactor;\r\n        }\r\n        // Pitch\r\n        if (!keysDown[2] && !keysDown[3] && !keysDown[6] && !keysDown[7] && !animatedMove.pitch) {\r\n            config.pitch += speed.pitch * diff * slowDownFactor;\r\n        }\r\n        // Zoom\r\n        if (!keysDown[0] && !keysDown[1] && !animatedMove.hfov) {\r\n            setHfov(config.hfov + speed.hfov * diff * slowDownFactor);\r\n        }\r\n    }\r\n\r\n    prevTime = newTime;\r\n    if (diff > 0) {\r\n        speed.yaw = speed.yaw * 0.8 + (config.yaw - prevYaw) / diff * 0.2;\r\n        speed.pitch = speed.pitch * 0.8 + (config.pitch - prevPitch) / diff * 0.2;\r\n        speed.hfov = speed.hfov * 0.8 + (config.hfov - prevZoom) / diff * 0.2;\r\n        \r\n        // Limit speed\r\n        var maxSpeed = config.autoRotate ? Math.abs(config.autoRotate) : 5;\r\n        speed.yaw = Math.min(maxSpeed, Math.max(speed.yaw, -maxSpeed));\r\n        speed.pitch = Math.min(maxSpeed, Math.max(speed.pitch, -maxSpeed));\r\n        speed.hfov = Math.min(maxSpeed, Math.max(speed.hfov, -maxSpeed));\r\n    }\r\n    \r\n    // Stop movement if opposite controls are pressed\r\n    if (keysDown[0] && keysDown[1]) {\r\n        speed.hfov = 0;\r\n    }\r\n    if ((keysDown[2] || keysDown[6]) && (keysDown[3] || keysDown[7])) {\r\n        speed.pitch = 0;\r\n    }\r\n    if ((keysDown[4] || keysDown[8]) && (keysDown[5] || keysDown[9])) {\r\n        speed.yaw = 0;\r\n    }\r\n}\r\n\r\n/**\r\n * Animates moves.\r\n * @param {string} axis - Axis to animate\r\n * @private\r\n */\r\nfunction animateMove(axis) {\r\n    var t = animatedMove[axis];\r\n    var normTime = Math.min(1, Math.max((Date.now() - t.startTime) / 1000 / (t.duration / 1000), 0));\r\n    var result = t.startPosition + config.animationTimingFunction(normTime) * (t.endPosition - t.startPosition);\r\n    if ((t.endPosition > t.startPosition && result >= t.endPosition) ||\r\n        (t.endPosition < t.startPosition && result <= t.endPosition) ||\r\n        t.endPosition === t.startPosition) {\r\n        result = t.endPosition;\r\n        speed[axis] = 0;\r\n        delete animatedMove[axis];\r\n    }\r\n    config[axis] = result;\r\n}\r\n\r\n/**\r\n * @param {number} t - Normalized time in animation\r\n * @return {number} Position in animation\r\n * @private\r\n */\r\nfunction timingFunction(t) {\r\n    // easeInOutQuad from https://gist.github.com/gre/1650294\r\n    return t < 0.5 ? 2*t*t : -1+(4-2*t)*t;\r\n}\r\n\r\n/**\r\n * Event handler for document resizes. Updates viewer size and rerenders view.\r\n * @private\r\n */\r\nfunction onDocumentResize() {\r\n    // Resize panorama renderer (moved to onFullScreenChange)\r\n    //renderer.resize();\r\n    //animateInit();\r\n\r\n    // Kludge to deal with WebKit regression: https://bugs.webkit.org/show_bug.cgi?id=93525\r\n    onFullScreenChange('resize');\r\n}\r\n\r\n/**\r\n * Initializes animation.\r\n * @private\r\n */\r\nfunction animateInit() {\r\n    if (animating) {\r\n        return;\r\n    }\r\n    animating = true;\r\n    animate();\r\n}\r\n\r\n/**\r\n * Animates view, using requestAnimationFrame to trigger rendering.\r\n * @private\r\n */\r\nfunction animate() {\r\n    if (destroyed) {\r\n        return;\r\n    }\r\n\r\n    render();\r\n    if (autoRotateStart)\r\n        clearTimeout(autoRotateStart);\r\n    if (isUserInteracting || orientation === true) {\r\n        requestAnimationFrame(animate);\r\n    } else if (keysDown[0] || keysDown[1] || keysDown[2] || keysDown[3] ||\r\n        keysDown[4] || keysDown[5] || keysDown[6] || keysDown[7] ||\r\n        keysDown[8] || keysDown[9] || config.autoRotate ||\r\n        animatedMove.pitch || animatedMove.yaw || animatedMove.hfov ||\r\n        Math.abs(speed.yaw) > 0.01 || Math.abs(speed.pitch) > 0.01 ||\r\n        Math.abs(speed.hfov) > 0.01) {\r\n\r\n        keyRepeat();\r\n        if (config.autoRotateInactivityDelay >= 0 && autoRotateSpeed &&\r\n            Date.now() - latestInteraction > config.autoRotateInactivityDelay &&\r\n            !config.autoRotate) {\r\n            config.autoRotate = autoRotateSpeed;\r\n            _this.lookAt(origPitch, undefined, origHfov, 3000);\r\n        }\r\n        requestAnimationFrame(animate);\r\n    } else if (renderer && (renderer.isLoading() || (config.dynamic === true && update))) {\r\n        requestAnimationFrame(animate);\r\n    } else {\r\n        fireEvent('animatefinished', {pitch: _this.getPitch(), yaw: _this.getYaw(), hfov: _this.getHfov()});\r\n        animating = false;\r\n        prevTime = undefined;\r\n        var autoRotateStartTime = config.autoRotateInactivityDelay -\r\n            (Date.now() - latestInteraction);\r\n        if (autoRotateStartTime > 0) {\r\n            autoRotateStart = setTimeout(function() {\r\n                config.autoRotate = autoRotateSpeed;\r\n                _this.lookAt(origPitch, undefined, origHfov, 3000);\r\n                animateInit();\r\n            }, autoRotateStartTime);\r\n        } else if (config.autoRotateInactivityDelay >= 0 && autoRotateSpeed) {\r\n            config.autoRotate = autoRotateSpeed;\r\n            _this.lookAt(origPitch, undefined, origHfov, 3000);\r\n            animateInit();\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Renders panorama view.\r\n * @private\r\n */\r\nfunction render() {\r\n    var tmpyaw;\r\n\r\n    if (loaded) {\r\n        var canvas = renderer.getCanvas();\r\n\r\n        if (config.autoRotate !== false) {\r\n            // When auto-rotating this check needs to happen first (see issue #764)\r\n            if (config.yaw > 360) {\r\n                config.yaw -= 360;\r\n            } else if (config.yaw < -360) {\r\n                config.yaw += 360;\r\n            }\r\n        }\r\n\r\n        // Keep a tmp value of yaw for autoRotate comparison later\r\n        tmpyaw = config.yaw;\r\n\r\n        // Optionally avoid showing background (empty space) on left or right by adapting min/max yaw\r\n        var hoffcut = 0,\r\n            voffcut = 0;\r\n        if (config.avoidShowingBackground) {\r\n            var hfov2 = config.hfov / 2,\r\n                vfov2 = Math.atan2(Math.tan(hfov2 / 180 * Math.PI), (canvas.width / canvas.height)) * 180 / Math.PI,\r\n                transposed = config.vaov > config.haov;\r\n            if (transposed) {\r\n                voffcut = vfov2 * (1 - Math.min(Math.cos((config.pitch - hfov2) / 180 * Math.PI),\r\n                                                Math.cos((config.pitch + hfov2) / 180 * Math.PI)));\r\n            } else {\r\n                hoffcut = hfov2 * (1 - Math.min(Math.cos((config.pitch - vfov2) / 180 * Math.PI),\r\n                                                Math.cos((config.pitch + vfov2) / 180 * Math.PI)));\r\n            }\r\n        }\r\n\r\n        // Ensure the yaw is within min and max allowed\r\n        var yawRange = config.maxYaw - config.minYaw,\r\n            minYaw = -180,\r\n            maxYaw = 180;\r\n        if (yawRange < 360) {\r\n            minYaw = config.minYaw + config.hfov / 2 + hoffcut;\r\n            maxYaw = config.maxYaw - config.hfov / 2 - hoffcut;\r\n            if (yawRange < config.hfov) {\r\n                // Lock yaw to average of min and max yaw when both can be seen at once\r\n                minYaw = maxYaw = (minYaw + maxYaw) / 2;\r\n            }\r\n            config.yaw = Math.max(minYaw, Math.min(maxYaw, config.yaw));\r\n        }\r\n        \r\n        if (!(config.autoRotate !== false)) {\r\n            // When not auto-rotating, this check needs to happen after the\r\n            // previous check (see issue #698)\r\n            if (config.yaw > 360) {\r\n                config.yaw -= 360;\r\n            } else if (config.yaw < -360) {\r\n                config.yaw += 360;\r\n            }\r\n        }\r\n\r\n        // Check if we autoRotate in a limited by min and max yaw\r\n        // If so reverse direction\r\n        if (config.autoRotate !== false && tmpyaw != config.yaw &&\r\n            prevTime !== undefined) { // this condition prevents changing the direction initially\r\n            config.autoRotate *= -1;\r\n        }\r\n\r\n        // Ensure the calculated pitch is within min and max allowed\r\n        var vfov = 2 * Math.atan(Math.tan(config.hfov / 180 * Math.PI * 0.5) /\r\n            (canvas.width / canvas.height)) / Math.PI * 180;\r\n        var minPitch = config.minPitch + vfov / 2,\r\n            maxPitch = config.maxPitch - vfov / 2;\r\n        var pitchRange = config.maxPitch - config.minPitch;\r\n        if (pitchRange < vfov) {\r\n            // Lock pitch to average of min and max pitch when both can be seen at once\r\n            minPitch = maxPitch = (minPitch + maxPitch) / 2;\r\n        }\r\n        if (isNaN(minPitch))\r\n            minPitch = -90;\r\n        if (isNaN(maxPitch))\r\n            maxPitch = 90;\r\n        config.pitch = Math.max(minPitch, Math.min(maxPitch, config.pitch));\r\n        \r\n        renderer.render(config.pitch * Math.PI / 180, config.yaw * Math.PI / 180, config.hfov * Math.PI / 180, {roll: config.roll * Math.PI / 180});\r\n        \r\n        renderHotSpots();\r\n        \r\n        // Update compass\r\n        if (config.compass) {\r\n            compass.style.transform = 'rotate(' + (-config.yaw - config.northOffset) + 'deg)';\r\n            compass.style.webkitTransform = 'rotate(' + (-config.yaw - config.northOffset) + 'deg)';\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Creates a new quaternion.\r\n * @private\r\n * @constructor\r\n * @param {Number} w - W value\r\n * @param {Number} x - X value\r\n * @param {Number} y - Y value\r\n * @param {Number} z - Z value\r\n */\r\nfunction Quaternion(w, x, y, z) {\r\n    this.w = w;\r\n    this.x = x;\r\n    this.y = y;\r\n    this.z = z;\r\n}\r\n\r\n/**\r\n * Multiplies quaternions.\r\n * @private\r\n * @param {Quaternion} q - Quaternion to multiply\r\n * @returns {Quaternion} Result of multiplication\r\n */\r\nQuaternion.prototype.multiply = function(q) {\r\n    return new Quaternion(this.w*q.w - this.x*q.x - this.y*q.y - this.z*q.z,\r\n                          this.x*q.w + this.w*q.x + this.y*q.z - this.z*q.y,\r\n                          this.y*q.w + this.w*q.y + this.z*q.x - this.x*q.z,\r\n                          this.z*q.w + this.w*q.z + this.x*q.y - this.y*q.x);\r\n};\r\n\r\n/**\r\n * Converts quaternion to Euler angles.\r\n * @private\r\n * @returns {Number[]} [phi angle, theta angle, psi angle]\r\n */\r\nQuaternion.prototype.toEulerAngles = function() {\r\n    var phi = Math.atan2(2 * (this.w * this.x + this.y * this.z),\r\n                         1 - 2 * (this.x * this.x + this.y * this.y)),\r\n        theta = Math.asin(2 * (this.w * this.y - this.z * this.x)),\r\n        psi = Math.atan2(2 * (this.w * this.z + this.x * this.y),\r\n                         1 - 2 * (this.y * this.y + this.z * this.z));\r\n    return [phi, theta, psi];\r\n};\r\n\r\n/**\r\n * Converts device orientation API Tait-Bryan angles to a quaternion.\r\n * @private\r\n * @param {Number} alpha - Alpha angle (in degrees)\r\n * @param {Number} beta - Beta angle (in degrees)\r\n * @param {Number} gamma - Gamma angle (in degrees)\r\n * @returns {Quaternion} Orientation quaternion\r\n */\r\nfunction taitBryanToQuaternion(alpha, beta, gamma) {\r\n    var r = [beta ? beta * Math.PI / 180 / 2 : 0,\r\n             gamma ? gamma * Math.PI / 180 / 2 : 0,\r\n             alpha ? alpha * Math.PI / 180 / 2 : 0];\r\n    var c = [Math.cos(r[0]), Math.cos(r[1]), Math.cos(r[2])],\r\n        s = [Math.sin(r[0]), Math.sin(r[1]), Math.sin(r[2])];\r\n\r\n    return new Quaternion(c[0]*c[1]*c[2] - s[0]*s[1]*s[2],\r\n                          s[0]*c[1]*c[2] - c[0]*s[1]*s[2],\r\n                          c[0]*s[1]*c[2] + s[0]*c[1]*s[2],\r\n                          c[0]*c[1]*s[2] + s[0]*s[1]*c[2]);\r\n}\r\n\r\n/**\r\n * Computes current device orientation quaternion from device orientation API\r\n * Tait-Bryan angles.\r\n * @private\r\n * @param {Number} alpha - Alpha angle (in degrees)\r\n * @param {Number} beta - Beta angle (in degrees)\r\n * @param {Number} gamma - Gamma angle (in degrees)\r\n * @returns {Quaternion} Orientation quaternion\r\n */\r\nfunction computeQuaternion(alpha, beta, gamma) {\r\n    // Convert Tait-Bryan angles to quaternion\r\n    var quaternion = taitBryanToQuaternion(alpha, beta, gamma);\r\n    // Apply world transform\r\n    quaternion = quaternion.multiply(new Quaternion(Math.sqrt(0.5), -Math.sqrt(0.5), 0, 0));\r\n    // Apply screen transform\r\n    var angle = window.orientation ? -window.orientation * Math.PI / 180 / 2 : 0;\r\n    return quaternion.multiply(new Quaternion(Math.cos(angle), 0, -Math.sin(angle), 0));\r\n}\r\n\r\n/**\r\n * Event handler for device orientation API. Controls pointing.\r\n * @private\r\n * @param {DeviceOrientationEvent} event - Device orientation event.\r\n */\r\nfunction orientationListener(e) {\r\n    var q = computeQuaternion(e.alpha, e.beta, e.gamma).toEulerAngles();\r\n    if (typeof(orientation) == 'number' && orientation < 10) {\r\n        // This kludge is necessary because iOS sometimes provides a few stale\r\n        // device orientation events when the listener is removed and then\r\n        // readded. Thus, we skip the first 10 events to prevent this from\r\n        // causing problems.\r\n        orientation += 1;\r\n    } else if (orientation === 10) {\r\n        // Record starting yaw to prevent jumping\r\n        orientationYawOffset = q[2] / Math.PI * 180 + config.yaw;\r\n        orientation = true;\r\n        requestAnimationFrame(animate);\r\n    } else {\r\n        config.pitch = q[0] / Math.PI * 180;\r\n        config.roll = -q[1] / Math.PI * 180;\r\n        config.yaw = -q[2] / Math.PI * 180 + orientationYawOffset;\r\n    }\r\n}\r\n\r\n/**\r\n * Initializes renderer.\r\n * @private\r\n */\r\nfunction renderInit() {\r\n    try {\r\n        var params = {};\r\n        if (config.horizonPitch !== undefined)\r\n            params.horizonPitch = config.horizonPitch * Math.PI / 180;\r\n        if (config.horizonRoll !== undefined)\r\n            params.horizonRoll = config.horizonRoll * Math.PI / 180;\r\n        if (config.backgroundColor !== undefined)\r\n            params.backgroundColor = config.backgroundColor;\r\n        renderer.init(panoImage, config.type, config.dynamic, config.haov * Math.PI / 180, config.vaov * Math.PI / 180, config.vOffset * Math.PI / 180, renderInitCallback, params);\r\n        if (config.dynamic !== true) {\r\n            // Allow image to be garbage collected\r\n            panoImage = undefined;\r\n        }\r\n    } catch(event) {\r\n        // Panorama not loaded\r\n        \r\n        // Display error if there is a bad texture\r\n        if (event.type == 'webgl error' || event.type == 'no webgl') {\r\n            anError();\r\n        } else if (event.type == 'webgl size error') {\r\n            anError(config.strings.textureSizeError.replace('%s', event.width).replace('%s', event.maxWidth));\r\n        } else {\r\n            anError(config.strings.unknownError);\r\n            throw event;\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Triggered when render initialization finishes. Handles fading between\r\n * scenes as well as showing the compass and hotspots and hiding the loading\r\n * display.\r\n * @private\r\n */\r\nfunction renderInitCallback() {\r\n    // Fade if specified\r\n    if (config.sceneFadeDuration && renderer.fadeImg !== undefined) {\r\n        renderer.fadeImg.style.opacity = 0;\r\n        // Remove image\r\n        var fadeImg = renderer.fadeImg;\r\n        delete renderer.fadeImg;\r\n        setTimeout(function() {\r\n            renderContainer.removeChild(fadeImg);\r\n            fireEvent('scenechangefadedone');\r\n        }, config.sceneFadeDuration);\r\n    }\r\n    \r\n    // Show compass if applicable\r\n    if (config.compass) {\r\n        compass.style.display = 'inline';\r\n    } else {\r\n        compass.style.display = 'none';\r\n    }\r\n    \r\n    // Show hotspots\r\n    createHotSpots();\r\n    \r\n    // Hide loading display\r\n    infoDisplay.load.box.style.display = 'none';\r\n    if (preview !== undefined) {\r\n        renderContainer.removeChild(preview);\r\n        preview = undefined;\r\n    }\r\n    loaded = true;\r\n\r\n    fireEvent('load');\r\n    \r\n    animateInit();\r\n}\r\n\r\n/**\r\n * Creates hot spot element for the current scene.\r\n * @private\r\n * @param {Object} hs - The configuration for the hotspot\r\n */\r\nfunction createHotSpot(hs) {\r\n    // Make sure hot spot pitch and yaw are numbers\r\n    hs.pitch = Number(hs.pitch) || 0;\r\n    hs.yaw = Number(hs.yaw) || 0;\r\n\r\n    var div = document.createElement('div');\r\n    div.className = 'pnlm-hotspot-base';\r\n    if (hs.cssClass)\r\n        div.className += ' ' + hs.cssClass;\r\n    else\r\n        div.className += ' pnlm-hotspot pnlm-sprite pnlm-' + escapeHTML(hs.type);\r\n\r\n    var span = document.createElement('span');\r\n    if (hs.text)\r\n        span.innerHTML = escapeHTML(hs.text);\r\n\r\n    var a;\r\n    if (hs.video) {\r\n        var video = document.createElement('video'),\r\n            vidp = hs.video;\r\n        if (config.basePath && !absoluteURL(vidp))\r\n            vidp = config.basePath + vidp;\r\n        video.src = sanitizeURL(vidp);\r\n        video.controls = true;\r\n        video.style.width = hs.width + 'px';\r\n        renderContainer.appendChild(div);\r\n        span.appendChild(video);\r\n    } else if (hs.image) {\r\n        var imgp = hs.image;\r\n        if (config.basePath && !absoluteURL(imgp))\r\n            imgp = config.basePath + imgp;\r\n        a = document.createElement('a');\r\n        a.href = sanitizeURL(hs.URL ? hs.URL : imgp, true);\r\n        a.target = '_blank';\r\n        span.appendChild(a);\r\n        var image = document.createElement('img');\r\n        image.src = sanitizeURL(imgp);\r\n        image.style.width = hs.width + 'px';\r\n        image.style.paddingTop = '5px';\r\n        renderContainer.appendChild(div);\r\n        a.appendChild(image);\r\n        span.style.maxWidth = 'initial';\r\n    } else if (hs.URL) {\r\n        a = document.createElement('a');\r\n        a.href = sanitizeURL(hs.URL, true);\r\n        if (hs.attributes) {\r\n            for (var key in hs.attributes) {\r\n                a.setAttribute(key, hs.attributes[key]);\r\n            }\r\n        } else {\r\n            a.target = '_blank';\r\n        }\r\n        renderContainer.appendChild(a);\r\n        div.className += ' pnlm-pointer';\r\n        span.className += ' pnlm-pointer';\r\n        a.appendChild(div);\r\n    } else {\r\n        if (hs.sceneId) {\r\n            div.onclick = div.ontouchend = function() {\r\n                if (!div.clicked) {\r\n                    div.clicked = true;\r\n                    loadScene(hs.sceneId, hs.targetPitch, hs.targetYaw, hs.targetHfov);\r\n                }\r\n                return false;\r\n            };\r\n            div.className += ' pnlm-pointer';\r\n            span.className += ' pnlm-pointer';\r\n        }\r\n        renderContainer.appendChild(div);\r\n    }\r\n\r\n    if (hs.createTooltipFunc) {\r\n        hs.createTooltipFunc(div, hs.createTooltipArgs);\r\n    } else if (hs.text || hs.video || hs.image) {\r\n        div.classList.add('pnlm-tooltip');\r\n        div.appendChild(span);\r\n        span.style.width = span.scrollWidth - 20 + 'px';\r\n        span.style.marginLeft = -(span.scrollWidth - div.offsetWidth) / 2 + 'px';\r\n        span.style.marginTop = -span.scrollHeight - 12 + 'px';\r\n    }\r\n    if (hs.clickHandlerFunc) {\r\n        div.addEventListener('click', function(e) {\r\n            hs.clickHandlerFunc(e, hs.clickHandlerArgs);\r\n        }, 'false');\r\n        div.className += ' pnlm-pointer';\r\n        span.className += ' pnlm-pointer';\r\n    }\r\n    hs.div = div;\r\n}\r\n\r\n/**\r\n * Creates hot spot elements for the current scene.\r\n * @private\r\n */\r\nfunction createHotSpots() {\r\n    if (hotspotsCreated) return;\r\n\r\n    if (!config.hotSpots) {\r\n        config.hotSpots = [];\r\n    } else {\r\n        // Sort by pitch so tooltip is never obscured by another hot spot\r\n        config.hotSpots = config.hotSpots.sort(function(a, b) {\r\n            return a.pitch < b.pitch;\r\n        });\r\n        config.hotSpots.forEach(createHotSpot);\r\n    }\r\n    hotspotsCreated = true;\r\n    renderHotSpots();\r\n}\r\n\r\n/**\r\n * Destroys currently created hot spot elements.\r\n * @private\r\n */\r\nfunction destroyHotSpots() {\r\n    var hs = config.hotSpots;\r\n    hotspotsCreated = false;\r\n    delete config.hotSpots;\r\n    if (hs) {\r\n        for (var i = 0; i < hs.length; i++) {\r\n            var current = hs[i].div;\r\n            if (current) {\r\n                while (current.parentNode && current.parentNode != renderContainer) {\r\n                    current = current.parentNode;\r\n                }\r\n                renderContainer.removeChild(current);\r\n            }\r\n            delete hs[i].div;\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Renders hot spot, updating its position and visibility.\r\n * @private\r\n */\r\nfunction renderHotSpot(hs) {\r\n    var hsPitchSin = Math.sin(hs.pitch * Math.PI / 180),\r\n        hsPitchCos = Math.cos(hs.pitch * Math.PI / 180),\r\n        configPitchSin = Math.sin(config.pitch * Math.PI / 180),\r\n        configPitchCos = Math.cos(config.pitch * Math.PI / 180),\r\n        yawCos = Math.cos((-hs.yaw + config.yaw) * Math.PI / 180);\r\n    var z = hsPitchSin * configPitchSin + hsPitchCos * yawCos * configPitchCos;\r\n    if ((hs.yaw <= 90 && hs.yaw > -90 && z <= 0) ||\r\n      ((hs.yaw > 90 || hs.yaw <= -90) && z <= 0)) {\r\n        hs.div.style.visibility = 'hidden';\r\n    } else {\r\n        var yawSin = Math.sin((-hs.yaw + config.yaw) * Math.PI / 180),\r\n            hfovTan = Math.tan(config.hfov * Math.PI / 360);\r\n        hs.div.style.visibility = 'visible';\r\n        // Subpixel rendering doesn't work in Firefox\r\n        // https://bugzilla.mozilla.org/show_bug.cgi?id=739176\r\n        var canvas = renderer.getCanvas(),\r\n            canvasWidth = canvas.clientWidth,\r\n            canvasHeight = canvas.clientHeight;\r\n        var coord = [-canvasWidth / hfovTan * yawSin * hsPitchCos / z / 2,\r\n            -canvasWidth / hfovTan * (hsPitchSin * configPitchCos -\r\n            hsPitchCos * yawCos * configPitchSin) / z / 2];\r\n        // Apply roll\r\n        var rollSin = Math.sin(config.roll * Math.PI / 180),\r\n            rollCos = Math.cos(config.roll * Math.PI / 180);\r\n        coord = [coord[0] * rollCos - coord[1] * rollSin,\r\n                 coord[0] * rollSin + coord[1] * rollCos];\r\n        // Apply transform\r\n        coord[0] += (canvasWidth - hs.div.offsetWidth) / 2;\r\n        coord[1] += (canvasHeight - hs.div.offsetHeight) / 2;\r\n        var transform = 'translate(' + coord[0] + 'px, ' + coord[1] +\r\n            'px) translateZ(9999px) rotate(' + config.roll + 'deg)';\r\n        if (hs.scale) {\r\n            transform += ' scale(' + (origHfov/config.hfov) / z + ')';\r\n        }\r\n        hs.div.style.webkitTransform = transform;\r\n        hs.div.style.MozTransform = transform;\r\n        hs.div.style.transform = transform;\r\n    }\r\n}\r\n\r\n/**\r\n * Renders hot spots, updating their positions and visibility.\r\n * @private\r\n */\r\nfunction renderHotSpots() {\r\n    config.hotSpots.forEach(renderHotSpot);\r\n}\r\n\r\n/**\r\n * Merges a scene configuration into the current configuration.\r\n * @private\r\n * @param {string} sceneId - Identifier of scene configuration to merge in.\r\n */\r\nfunction mergeConfig(sceneId) {\r\n    config = {};\r\n    var k, s;\r\n    var photoSphereExcludes = ['haov', 'vaov', 'vOffset', 'northOffset', 'horizonPitch', 'horizonRoll'];\r\n    specifiedPhotoSphereExcludes = [];\r\n    \r\n    // Merge default config\r\n    for (k in defaultConfig) {\r\n        if (defaultConfig.hasOwnProperty(k)) {\r\n            config[k] = defaultConfig[k];\r\n        }\r\n    }\r\n    \r\n    // Merge default scene config\r\n    for (k in initialConfig.default) {\r\n        if (initialConfig.default.hasOwnProperty(k)) {\r\n            if (k == 'strings') {\r\n                for (s in initialConfig.default.strings) {\r\n                    if (initialConfig.default.strings.hasOwnProperty(s)) {\r\n                        config.strings[s] = escapeHTML(initialConfig.default.strings[s]);\r\n                    }\r\n                }\r\n            } else {\r\n                config[k] = initialConfig.default[k];\r\n                if (photoSphereExcludes.indexOf(k) >= 0) {\r\n                    specifiedPhotoSphereExcludes.push(k);\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Merge current scene config\r\n    if ((sceneId !== null) && (sceneId !== '') && (initialConfig.scenes) && (initialConfig.scenes[sceneId])) {\r\n        var scene = initialConfig.scenes[sceneId];\r\n        for (k in scene) {\r\n            if (scene.hasOwnProperty(k)) {\r\n                if (k == 'strings') {\r\n                    for (s in scene.strings) {\r\n                        if (scene.strings.hasOwnProperty(s)) {\r\n                            config.strings[s] = escapeHTML(scene.strings[s]);\r\n                        }\r\n                    }\r\n                } else {\r\n                    config[k] = scene[k];\r\n                    if (photoSphereExcludes.indexOf(k) >= 0) {\r\n                        specifiedPhotoSphereExcludes.push(k);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        config.scene = sceneId;\r\n    }\r\n    \r\n    // Merge initial config\r\n    for (k in initialConfig) {\r\n        if (initialConfig.hasOwnProperty(k)) {\r\n            if (k == 'strings') {\r\n                for (s in initialConfig.strings) {\r\n                    if (initialConfig.strings.hasOwnProperty(s)) {\r\n                        config.strings[s] = escapeHTML(initialConfig.strings[s]);\r\n                    }\r\n                }\r\n            } else {\r\n                config[k] = initialConfig[k];\r\n                if (photoSphereExcludes.indexOf(k) >= 0) {\r\n                    specifiedPhotoSphereExcludes.push(k);\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Processes configuration options.\r\n * @param {boolean} [isPreview] - Whether or not the preview is being displayed\r\n * @private\r\n */\r\nfunction processOptions(isPreview) {\r\n    isPreview = isPreview ? isPreview : false;\r\n\r\n    // Process preview first so it always loads before the browser hits its\r\n    // maximum number of connections to a server as can happen with cubic\r\n    // panoramas\r\n    if (isPreview && 'preview' in config) {\r\n        var p = config.preview;\r\n        if (config.basePath && !absoluteURL(p))\r\n            p = config.basePath + p;\r\n        preview = document.createElement('div');\r\n        preview.className = 'pnlm-preview-img';\r\n        preview.style.backgroundImage = \"url('\" + sanitizeURLForCss(p) + \"')\";\r\n        renderContainer.appendChild(preview);\r\n    }\r\n\r\n    // Handle different preview values\r\n    var title = config.title,\r\n        author = config.author;\r\n    if (isPreview) {\r\n        if ('previewTitle' in config)\r\n            config.title = config.previewTitle;\r\n        if ('previewAuthor' in config)\r\n            config.author = config.previewAuthor;\r\n    }\r\n\r\n    // Reset title / author display\r\n    if (!config.hasOwnProperty('title'))\r\n        infoDisplay.title.innerHTML = '';\r\n    if (!config.hasOwnProperty('author'))\r\n        infoDisplay.author.innerHTML = '';\r\n    if (!config.hasOwnProperty('title') && !config.hasOwnProperty('author'))\r\n        infoDisplay.container.style.display = 'none';\r\n\r\n    // Fill in load button label and loading box text\r\n    controls.load.innerHTML = '<p>' + config.strings.loadButtonLabel + '</p>';\r\n    infoDisplay.load.boxp.innerHTML = config.strings.loadingLabel;\r\n\r\n    // Process other options\r\n    for (var key in config) {\r\n      if (config.hasOwnProperty(key)) {\r\n        switch(key) {\r\n            case 'title':\r\n                infoDisplay.title.innerHTML = escapeHTML(config[key]);\r\n                infoDisplay.container.style.display = 'inline';\r\n                break;\r\n            \r\n            case 'author':\r\n                var authorText = escapeHTML(config[key]);\r\n                if (config.authorURL) {\r\n                    var authorLink = document.createElement('a');\r\n                    authorLink.href = sanitizeURL(config['authorURL'], true);\r\n                    authorLink.target = '_blank';\r\n                    authorLink.innerHTML = escapeHTML(config[key]);\r\n                    authorText = authorLink.outerHTML;\r\n                }\r\n                infoDisplay.author.innerHTML = config.strings.bylineLabel.replace('%s', authorText);\r\n                infoDisplay.container.style.display = 'inline';\r\n                break;\r\n            \r\n            case 'fallback':\r\n                var link = document.createElement('a');\r\n                link.href = sanitizeURL(config[key], true);\r\n                link.target = '_blank';\r\n                link.textContent = 'Click here to view this panorama in an alternative viewer.';\r\n                var message = document.createElement('p');\r\n                message.textContent = 'Your browser does not support WebGL.';\r\n                message.appendChild(document.createElement('br'));\r\n                message.appendChild(link);\r\n                infoDisplay.errorMsg.innerHTML = ''; // Removes all children nodes\r\n                infoDisplay.errorMsg.appendChild(message);\r\n                break;\r\n            \r\n            case 'hfov':\r\n                setHfov(Number(config[key]));\r\n                break;\r\n            \r\n            case 'autoLoad':\r\n                if (config[key] === true && renderer === undefined) {\r\n                    // Show loading box\r\n                    infoDisplay.load.box.style.display = 'inline';\r\n                    // Hide load button\r\n                    controls.load.style.display = 'none';\r\n                    // Initialize\r\n                    init();\r\n                }\r\n                break;\r\n            \r\n            case 'showZoomCtrl':\r\n                if (config[key] && config.showControls != false) {\r\n                    // Show zoom controls\r\n                    controls.zoom.style.display = 'block';\r\n                } else {\r\n                    // Hide zoom controls\r\n                    controls.zoom.style.display = 'none';\r\n                }\r\n                break;\r\n\r\n            case 'showFullscreenCtrl':\r\n                if (config[key] && config.showControls != false && ('fullscreen' in document || 'mozFullScreen' in document ||\r\n                    'webkitIsFullScreen' in document || 'msFullscreenElement' in document)) {\r\n                    \r\n                    // Show fullscreen control\r\n                    controls.fullscreen.style.display = 'block';\r\n                } else {\r\n                    // Hide fullscreen control\r\n                    controls.fullscreen.style.display = 'none';\r\n                }\r\n                break;\r\n\r\n            case 'hotSpotDebug':\r\n                if (config[key])\r\n                    hotSpotDebugIndicator.style.display = 'block';\r\n                else\r\n                    hotSpotDebugIndicator.style.display = 'none';\r\n                break;\r\n\r\n            case 'showControls':\r\n                if (!config[key]) {\r\n                    controls.orientation.style.display = 'none';\r\n                    controls.zoom.style.display = 'none';\r\n                    controls.fullscreen.style.display = 'none';\r\n                }\r\n                break;\r\n\r\n            case 'orientationOnByDefault':\r\n                if (config[key])\r\n                    startOrientation();\r\n                break;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (isPreview) {\r\n        // Restore original values if changed for preview\r\n        if (title)\r\n            config.title = title;\r\n        else\r\n            delete config.title;\r\n        if (author)\r\n            config.author = author;\r\n        else\r\n            delete config.author;\r\n    }\r\n}\r\n\r\n/**\r\n * Toggles fullscreen mode.\r\n * @private\r\n */\r\nfunction toggleFullscreen() {\r\n    if (loaded && !error) {\r\n        if (!fullscreenActive) {\r\n            try {\r\n                if (container.requestFullscreen) {\r\n                    container.requestFullscreen();\r\n                } else if (container.mozRequestFullScreen) {\r\n                    container.mozRequestFullScreen();\r\n                } else if (container.msRequestFullscreen) {\r\n                    container.msRequestFullscreen();\r\n                } else {\r\n                    container.webkitRequestFullScreen();\r\n                }\r\n            } catch(event) {\r\n                // Fullscreen doesn't work\r\n            }\r\n        } else {\r\n            if (document.exitFullscreen) {\r\n                document.exitFullscreen();\r\n            } else if (document.mozCancelFullScreen) {\r\n                document.mozCancelFullScreen();\r\n            } else if (document.webkitCancelFullScreen) {\r\n                document.webkitCancelFullScreen();\r\n            } else if (document.msExitFullscreen) {\r\n                document.msExitFullscreen();\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Event handler for fullscreen changes.\r\n * @private\r\n */\r\nfunction onFullScreenChange(resize) {\r\n    if (document.fullscreenElement || document.fullscreen || document.mozFullScreen || document.webkitIsFullScreen || document.msFullscreenElement) {\r\n        controls.fullscreen.classList.add('pnlm-fullscreen-toggle-button-active');\r\n        fullscreenActive = true;\r\n    } else {\r\n        controls.fullscreen.classList.remove('pnlm-fullscreen-toggle-button-active');\r\n        fullscreenActive = false;\r\n    }\r\n    if (resize !== 'resize')\r\n        fireEvent('fullscreenchange', fullscreenActive);\r\n    // Resize renderer (deal with browser quirks and fixes #155)\r\n    renderer.resize();\r\n    setHfov(config.hfov);\r\n    animateInit();\r\n}\r\n\r\n/**\r\n * Increases panorama zoom. For use with zoom button.\r\n * @private\r\n */\r\nfunction zoomIn() {\r\n    if (loaded) {\r\n        setHfov(config.hfov - 5);\r\n        animateInit();\r\n    }\r\n}\r\n\r\n/**\r\n * Decreases panorama zoom. For use with zoom button.\r\n * @private\r\n */\r\nfunction zoomOut() {\r\n    if (loaded) {\r\n        setHfov(config.hfov + 5);\r\n        animateInit();\r\n    }\r\n}\r\n\r\n/**\r\n * Clamps horzontal field of view to viewer's limits.\r\n * @private\r\n * @param {number} hfov - Input horizontal field of view (in degrees)\r\n * @return {number} - Clamped horizontal field of view (in degrees)\r\n */\r\nfunction constrainHfov(hfov) {\r\n    // Keep field of view within bounds\r\n    var minHfov = config.minHfov;\r\n    if (config.type == 'multires' && renderer && !config.multiResMinHfov) {\r\n        minHfov = Math.min(minHfov, renderer.getCanvas().width / (config.multiRes.cubeResolution / 90 * 0.9));\r\n    }\r\n    if (minHfov > config.maxHfov) {\r\n        // Don't change view if bounds don't make sense\r\n        console.log('HFOV bounds do not make sense (minHfov > maxHfov).');\r\n        return config.hfov;\r\n    }\r\n    var newHfov = config.hfov;\r\n    if (hfov < minHfov) {\r\n        newHfov = minHfov;\r\n    } else if (hfov > config.maxHfov) {\r\n        newHfov = config.maxHfov;\r\n    } else {\r\n        newHfov = hfov;\r\n    }\r\n    // Optionally avoid showing background (empty space) on top or bottom by adapting newHfov\r\n    if (config.avoidShowingBackground && renderer) {\r\n        var canvas = renderer.getCanvas();\r\n        newHfov = Math.min(newHfov,\r\n                           Math.atan(Math.tan((config.maxPitch - config.minPitch) / 360 * Math.PI) /\r\n                                     canvas.height * canvas.width) * 360 / Math.PI);\r\n    }\r\n    return newHfov;\r\n}\r\n\r\n/**\r\n * Sets viewer's horizontal field of view.\r\n * @private\r\n * @param {number} hfov - Desired horizontal field of view in degrees.\r\n */\r\nfunction setHfov(hfov) {\r\n    config.hfov = constrainHfov(hfov);\r\n    fireEvent('zoomchange', config.hfov);\r\n}\r\n\r\n/**\r\n * Stops auto rotation and animated moves.\r\n * @private\r\n */\r\nfunction stopAnimation() {\r\n    animatedMove = {};\r\n    autoRotateSpeed = config.autoRotate ? config.autoRotate : autoRotateSpeed;\r\n    config.autoRotate = false;\r\n}\r\n\r\n/**\r\n * Loads panorama.\r\n * @private\r\n */\r\nfunction load() {\r\n    // Since WebGL error handling is very general, first we clear any error box\r\n    // since it is a new scene and the error from previous maybe because of lacking\r\n    // memory etc and not because of a lack of WebGL support etc\r\n    clearError();\r\n    loaded = false;\r\n\r\n    controls.load.style.display = 'none';\r\n    infoDisplay.load.box.style.display = 'inline';\r\n    init();\r\n}\r\n\r\n/**\r\n * Loads scene.\r\n * @private\r\n * @param {string} sceneId - Identifier of scene configuration to merge in.\r\n * @param {number} targetPitch - Pitch viewer should be centered on once scene loads.\r\n * @param {number} targetYaw - Yaw viewer should be centered on once scene loads.\r\n * @param {number} targetHfov - HFOV viewer should use once scene loads.\r\n * @param {boolean} [fadeDone] - If `true`, fade setup is skipped.\r\n */\r\nfunction loadScene(sceneId, targetPitch, targetYaw, targetHfov, fadeDone) {\r\n    if (!loaded)\r\n        fadeDone = true;    // Don't try to fade when there isn't a scene loaded\r\n    loaded = false;\r\n    animatedMove = {};\r\n    \r\n    // Set up fade if specified\r\n    var fadeImg, workingPitch, workingYaw, workingHfov;\r\n    if (config.sceneFadeDuration && !fadeDone) {\r\n        var data = renderer.render(config.pitch * Math.PI / 180, config.yaw * Math.PI / 180, config.hfov * Math.PI / 180, {returnImage: true});\r\n        if (data !== undefined) {\r\n            fadeImg = new Image();\r\n            fadeImg.className = 'pnlm-fade-img';\r\n            fadeImg.style.transition = 'opacity ' + (config.sceneFadeDuration / 1000) + 's';\r\n            fadeImg.style.width = '100%';\r\n            fadeImg.style.height = '100%';\r\n            fadeImg.onload = function() {\r\n                loadScene(sceneId, targetPitch, targetYaw, targetHfov, true);\r\n            };\r\n            fadeImg.src = data;\r\n            renderContainer.appendChild(fadeImg);\r\n            renderer.fadeImg = fadeImg;\r\n            return;\r\n        }\r\n    }\r\n    \r\n    // Set new pointing\r\n    if (targetPitch === 'same') {\r\n        workingPitch = config.pitch;\r\n    } else {\r\n        workingPitch = targetPitch;\r\n    }\r\n    if (targetYaw === 'same') {\r\n        workingYaw = config.yaw;\r\n    } else if (targetYaw === 'sameAzimuth') {\r\n        workingYaw = config.yaw + (config.northOffset || 0) - (initialConfig.scenes[sceneId].northOffset || 0);\r\n    } else {\r\n        workingYaw = targetYaw;\r\n    }\r\n    if (targetHfov === 'same') {\r\n        workingHfov = config.hfov;\r\n    } else {\r\n        workingHfov = targetHfov;\r\n    }\r\n    \r\n    // Destroy hot spots from previous scene\r\n    destroyHotSpots();\r\n    \r\n    // Create the new config for the scene\r\n    mergeConfig(sceneId);\r\n\r\n    // Stop motion\r\n    speed.yaw = speed.pitch = speed.hfov = 0;\r\n\r\n    // Reload scene\r\n    processOptions();\r\n    if (workingPitch !== undefined) {\r\n        config.pitch = workingPitch;\r\n    }\r\n    if (workingYaw !== undefined) {\r\n        config.yaw = workingYaw;\r\n    }\r\n    if (workingHfov !== undefined) {\r\n        config.hfov = workingHfov;\r\n    }\r\n    fireEvent('scenechange', sceneId);\r\n    load();\r\n}\r\n\r\n/**\r\n * Stop using device orientation.\r\n * @private\r\n */\r\nfunction stopOrientation() {\r\n    window.removeEventListener('deviceorientation', orientationListener);\r\n    controls.orientation.classList.remove('pnlm-orientation-button-active');\r\n    orientation = false;\r\n}\r\n\r\n/**\r\n * Start using device orientation.\r\n * @private\r\n */\r\nfunction startOrientation() {\r\n    if (typeof DeviceMotionEvent.requestPermission === 'function') {\r\n        DeviceOrientationEvent.requestPermission().then(function(response) {\r\n            if (response == 'granted') {\r\n                orientation = 1;\r\n                window.addEventListener('deviceorientation', orientationListener);\r\n                controls.orientation.classList.add('pnlm-orientation-button-active');\r\n            }\r\n        });\r\n    } else {\r\n        orientation = 1;\r\n        window.addEventListener('deviceorientation', orientationListener);\r\n        controls.orientation.classList.add('pnlm-orientation-button-active');\r\n    }\r\n}\r\n\r\n/**\r\n * Escapes HTML string (to mitigate possible DOM XSS attacks).\r\n * @private\r\n * @param {string} s - String to escape\r\n * @returns {string} Escaped string\r\n */\r\nfunction escapeHTML(s) {\r\n    if (!initialConfig.escapeHTML)\r\n        return String(s).split('\\n').join('<br>');\r\n    return String(s).split(/&/g).join('&amp;')\r\n        .split('\"').join('&quot;')\r\n        .split(\"'\").join('&#39;')\r\n        .split('<').join('&lt;')\r\n        .split('>').join('&gt;')\r\n        .split('/').join('&#x2f;')\r\n        .split('\\n').join('<br>');  // Allow line breaks\r\n}\r\n\r\n/**\r\n * Removes possibility of XSS attacks with URLs.\r\n * The URL cannot be of protocol 'javascript'.\r\n * @private\r\n * @param {string} url - URL to sanitize\r\n * @param {boolean} href - True if URL is for link (blocks data URIs)\r\n * @returns {string} Sanitized URL\r\n */\r\nfunction sanitizeURL(url, href) {\r\n    try {\r\n        var decoded_url = decodeURIComponent(unescape(url)).replace(/[^\\w:]/g, '').toLowerCase();\r\n    } catch (e) {\r\n        return 'about:blank';\r\n    }\r\n    if (decoded_url.indexOf('javascript:') === 0 ||\r\n        decoded_url.indexOf('vbscript:') === 0) {\r\n        console.log('Script URL removed.');\r\n        return 'about:blank';\r\n    }\r\n    if (href && decoded_url.indexOf('data:') === 0) {\r\n        console.log('Data URI removed from link.');\r\n        return 'about:blank';\r\n    }\r\n    return url;\r\n}\r\n\r\n/**\r\n * Unescapes HTML entities.\r\n * Copied from Marked.js 0.7.0.\r\n * @private\r\n * @param {string} url - URL to sanitize\r\n * @param {boolean} href - True if URL is for link (blocks data URIs)\r\n * @returns {string} Sanitized URL\r\n */\r\nfunction unescape(html) {\r\n    // Explicitly match decimal, hex, and named HTML entities\r\n    return html.replace(/&(#(?:\\d+)|(?:#x[0-9A-Fa-f]+)|(?:\\w+));?/ig, function(_, n) {\r\n        n = n.toLowerCase();\r\n        if (n === 'colon') return ':';\r\n        if (n.charAt(0) === '#') {\r\n            return n.charAt(1) === 'x'\r\n                ? String.fromCharCode(parseInt(n.substring(2), 16))\r\n                : String.fromCharCode(+n.substring(1));\r\n        }\r\n        return '';\r\n    });\r\n}\r\n\r\n/**\r\n * Removes possibility of XSS atacks with URLs for CSS.\r\n * The URL will be sanitized with `sanitizeURL()` and single quotes\r\n * and double quotes escaped.\r\n * @private\r\n * @param {string} url - URL to sanitize\r\n * @returns {string} Sanitized URL\r\n */\r\nfunction sanitizeURLForCss(url) {\r\n    return sanitizeURL(url)\r\n        .replace(/\"/g, '%22')\r\n        .replace(/'/g, '%27');\r\n}\r\n\r\n/**\r\n * Checks whether or not a panorama is loaded.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {boolean} `true` if a panorama is loaded, else `false`\r\n */\r\nthis.isLoaded = function() {\r\n    return Boolean(loaded);\r\n};\r\n\r\n/**\r\n * Returns the pitch of the center of the view.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {number} Pitch in degrees\r\n */\r\nthis.getPitch = function() {\r\n    return config.pitch;\r\n};\r\n\r\n/**\r\n * Sets the pitch of the center of the view.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {number} pitch - Pitch in degrees\r\n * @param {boolean|number} [animated=1000] - Animation duration in milliseconds or false for no animation\r\n * @param {function} [callback] - Function to call when animation finishes\r\n * @param {object} [callbackArgs] - Arguments to pass to callback function\r\n * @returns {Viewer} `this`\r\n */\r\nthis.setPitch = function(pitch, animated, callback, callbackArgs) {\r\n    latestInteraction = Date.now();\r\n    if (Math.abs(pitch - config.pitch) <= eps) {\r\n        if (typeof callback == 'function')\r\n            callback(callbackArgs);\r\n        return this;\r\n    }\r\n    animated = animated == undefined ? 1000: Number(animated);\r\n    if (animated) {\r\n        animatedMove.pitch = {\r\n            'startTime': Date.now(),\r\n            'startPosition': config.pitch,\r\n            'endPosition': pitch,\r\n            'duration': animated\r\n        };\r\n        if (typeof callback == 'function')\r\n            setTimeout(function(){callback(callbackArgs);}, animated);\r\n    } else {\r\n        config.pitch = pitch;\r\n    }\r\n    animateInit();\r\n    return this;\r\n};\r\n\r\n/**\r\n * Returns the minimum and maximum allowed pitches (in degrees).\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {number[]} [minimum pitch, maximum pitch]\r\n */\r\nthis.getPitchBounds = function() {\r\n    return [config.minPitch, config.maxPitch];\r\n};\r\n\r\n/**\r\n * Set the minimum and maximum allowed pitches (in degrees).\r\n * @memberof Viewer\r\n * @instance\r\n * @param {number[]} bounds - [minimum pitch, maximum pitch]\r\n * @returns {Viewer} `this`\r\n */\r\nthis.setPitchBounds = function(bounds) {\r\n    config.minPitch = Math.max(-90, Math.min(bounds[0], 90));\r\n    config.maxPitch = Math.max(-90, Math.min(bounds[1], 90));\r\n    return this;\r\n};\r\n\r\n/**\r\n * Returns the yaw of the center of the view.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {number} Yaw in degrees\r\n */\r\nthis.getYaw = function() {\r\n    return (config.yaw + 540) % 360 - 180;\r\n};\r\n\r\n/**\r\n * Sets the yaw of the center of the view.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {number} yaw - Yaw in degrees [-180, 180]\r\n * @param {boolean|number} [animated=1000] - Animation duration in milliseconds or false for no animation\r\n * @param {function} [callback] - Function to call when animation finishes\r\n * @param {object} [callbackArgs] - Arguments to pass to callback function\r\n * @returns {Viewer} `this`\r\n */\r\nthis.setYaw = function(yaw, animated, callback, callbackArgs) {\r\n    latestInteraction = Date.now();\r\n    if (Math.abs(yaw - config.yaw) <= eps) {\r\n        if (typeof callback == 'function')\r\n            callback(callbackArgs);\r\n        return this;\r\n    }\r\n    animated = animated == undefined ? 1000: Number(animated);\r\n    yaw = ((yaw + 180) % 360) - 180; // Keep in bounds\r\n    if (animated) {\r\n        // Animate in shortest direction\r\n        if (config.yaw - yaw > 180)\r\n            yaw += 360;\r\n        else if (yaw - config.yaw > 180)\r\n            yaw -= 360;\r\n\r\n        animatedMove.yaw = {\r\n            'startTime': Date.now(),\r\n            'startPosition': config.yaw,\r\n            'endPosition': yaw,\r\n            'duration': animated\r\n        };\r\n        if (typeof callback == 'function')\r\n            setTimeout(function(){callback(callbackArgs);}, animated);\r\n    } else {\r\n        config.yaw = yaw;\r\n    }\r\n    animateInit();\r\n    return this;\r\n};\r\n\r\n/**\r\n * Returns the minimum and maximum allowed pitches (in degrees).\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {number[]} [yaw pitch, maximum yaw]\r\n */\r\nthis.getYawBounds = function() {\r\n    return [config.minYaw, config.maxYaw];\r\n};\r\n\r\n/**\r\n * Set the minimum and maximum allowed yaws (in degrees [-360, 360]).\r\n * @memberof Viewer\r\n * @instance\r\n * @param {number[]} bounds - [minimum yaw, maximum yaw]\r\n * @returns {Viewer} `this`\r\n */\r\nthis.setYawBounds = function(bounds) {\r\n    config.minYaw = Math.max(-360, Math.min(bounds[0], 360));\r\n    config.maxYaw = Math.max(-360, Math.min(bounds[1], 360));\r\n    return this;\r\n};\r\n\r\n/**\r\n * Returns the horizontal field of view.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {number} Horizontal field of view in degrees\r\n */\r\nthis.getHfov = function() {\r\n    return config.hfov;\r\n};\r\n\r\n/**\r\n * Sets the horizontal field of view.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {number} hfov - Horizontal field of view in degrees\r\n * @param {boolean|number} [animated=1000] - Animation duration in milliseconds or false for no animation\r\n * @param {function} [callback] - Function to call when animation finishes\r\n * @param {object} [callbackArgs] - Arguments to pass to callback function\r\n * @returns {Viewer} `this`\r\n */\r\nthis.setHfov = function(hfov, animated, callback, callbackArgs) {\r\n    latestInteraction = Date.now();\r\n    if (Math.abs(hfov - config.hfov) <= eps) {\r\n        if (typeof callback == 'function')\r\n            callback(callbackArgs);\r\n        return this;\r\n    }\r\n    animated = animated == undefined ? 1000: Number(animated);\r\n    if (animated) {\r\n        animatedMove.hfov = {\r\n            'startTime': Date.now(),\r\n            'startPosition': config.hfov,\r\n            'endPosition': constrainHfov(hfov),\r\n            'duration': animated\r\n        };\r\n        if (typeof callback == 'function')\r\n            setTimeout(function(){callback(callbackArgs);}, animated);\r\n    } else {\r\n        setHfov(hfov);\r\n    }\r\n    animateInit();\r\n    return this;\r\n};\r\n\r\n/**\r\n * Returns the minimum and maximum allowed horizontal fields of view\r\n * (in degrees).\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {number[]} [minimum hfov, maximum hfov]\r\n */\r\nthis.getHfovBounds = function() {\r\n    return [config.minHfov, config.maxHfov];\r\n};\r\n\r\n/**\r\n * Set the minimum and maximum allowed horizontal fields of view (in degrees).\r\n * @memberof Viewer\r\n * @instance\r\n * @param {number[]} bounds - [minimum hfov, maximum hfov]\r\n * @returns {Viewer} `this`\r\n */\r\nthis.setHfovBounds = function(bounds) {\r\n    config.minHfov = Math.max(0, bounds[0]);\r\n    config.maxHfov = Math.max(0, bounds[1]);\r\n    return this;\r\n};\r\n\r\n/**\r\n * Set a new view. Any parameters not specified remain the same.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {number} [pitch] - Target pitch\r\n * @param {number} [yaw] - Target yaw\r\n * @param {number} [hfov] - Target hfov\r\n * @param {boolean|number} [animated=1000] - Animation duration in milliseconds or false for no animation\r\n * @param {function} [callback] - Function to call when animation finishes\r\n * @param {object} [callbackArgs] - Arguments to pass to callback function\r\n * @returns {Viewer} `this`\r\n */\r\nthis.lookAt = function(pitch, yaw, hfov, animated, callback, callbackArgs) {\r\n    animated = animated == undefined ? 1000: Number(animated);\r\n    if (pitch !== undefined && Math.abs(pitch - config.pitch) > eps) {\r\n        this.setPitch(pitch, animated, callback, callbackArgs);\r\n        callback = undefined;\r\n    }\r\n    if (yaw !== undefined && Math.abs(yaw - config.yaw) > eps) {\r\n        this.setYaw(yaw, animated, callback, callbackArgs);\r\n        callback = undefined;\r\n    }\r\n    if (hfov !== undefined && Math.abs(hfov - config.hfov) > eps) {\r\n        this.setHfov(hfov, animated, callback, callbackArgs);\r\n        callback = undefined;\r\n    }\r\n    if (typeof callback == 'function')\r\n        callback(callbackArgs);\r\n    return this;\r\n};\r\n\r\n/**\r\n * Returns the panorama's north offset.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {number} North offset in degrees\r\n */\r\nthis.getNorthOffset = function() {\r\n    return config.northOffset;\r\n};\r\n\r\n/**\r\n * Sets the panorama's north offset.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {number} heading - North offset in degrees\r\n * @returns {Viewer} `this`\r\n */\r\nthis.setNorthOffset = function(heading) {\r\n    config.northOffset = Math.min(360, Math.max(0, heading));\r\n    animateInit();\r\n    return this;\r\n};\r\n\r\n/**\r\n * Returns the panorama's horizon roll.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {number} Horizon roll in degrees\r\n */\r\nthis.getHorizonRoll = function() {\r\n    return config.horizonRoll;\r\n};\r\n\r\n/**\r\n * Sets the panorama's horizon roll.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {number} roll - Horizon roll in degrees [-90, 90]\r\n * @returns {Viewer} `this`\r\n */\r\nthis.setHorizonRoll = function(roll) {\r\n    config.horizonRoll = Math.min(90, Math.max(-90, roll));\r\n    renderer.setPose(config.horizonPitch * Math.PI / 180, config.horizonRoll * Math.PI / 180);\r\n    animateInit();\r\n    return this;\r\n};\r\n\r\n/**\r\n * Returns the panorama's horizon pitch.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {number} Horizon pitch in degrees\r\n */\r\nthis.getHorizonPitch = function() {\r\n    return config.horizonPitch;\r\n};\r\n\r\n/**\r\n * Sets the panorama's horizon pitch.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {number} pitch - Horizon pitch in degrees [-90, 90]\r\n * @returns {Viewer} `this`\r\n */\r\nthis.setHorizonPitch = function(pitch) {\r\n    config.horizonPitch = Math.min(90, Math.max(-90, pitch));\r\n    renderer.setPose(config.horizonPitch * Math.PI / 180, config.horizonRoll * Math.PI / 180);\r\n    animateInit();\r\n    return this;\r\n};\r\n\r\n/**\r\n * Start auto rotation.\r\n *\r\n * Before starting rotation, the viewer is panned to `pitch`.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {number} [speed] - Auto rotation speed / direction. If not specified, previous value is used.\r\n * @param {number} [pitch] - The pitch to rotate at. If not specified, inital pitch is used.\r\n * @returns {Viewer} `this`\r\n */\r\nthis.startAutoRotate = function(speed, pitch) {\r\n    speed = speed || autoRotateSpeed || 1;\r\n    pitch = pitch === undefined ? origPitch : pitch;\r\n    config.autoRotate = speed;\r\n    _this.lookAt(pitch, undefined, origHfov, 3000);\r\n    animateInit();\r\n    return this;\r\n};\r\n\r\n/**\r\n * Stop auto rotation.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {Viewer} `this`\r\n */\r\nthis.stopAutoRotate = function() {\r\n    autoRotateSpeed = config.autoRotate ? config.autoRotate : autoRotateSpeed;\r\n    config.autoRotate = false;\r\n    config.autoRotateInactivityDelay = -1;\r\n    return this;\r\n};\r\n\r\n/**\r\n * Stops all movement.\r\n * @memberof Viewer\r\n * @instance\r\n */\r\nthis.stopMovement = function() {\r\n    stopAnimation();\r\n    speed = {'yaw': 0, 'pitch': 0, 'hfov': 0};\r\n};\r\n\r\n/**\r\n * Returns the panorama renderer.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {Renderer}\r\n */\r\nthis.getRenderer = function() {\r\n    return renderer;\r\n};\r\n\r\n/**\r\n * Sets update flag for dynamic content.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {boolean} bool - Whether or not viewer should update even when still\r\n * @returns {Viewer} `this`\r\n */\r\nthis.setUpdate = function(bool) {\r\n    update = bool === true;\r\n    if (renderer === undefined)\r\n        onImageLoad();\r\n    else\r\n        animateInit();\r\n    return this;\r\n};\r\n\r\n/**\r\n * Calculate panorama pitch and yaw from location of mouse event.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {MouseEvent} event - Document mouse down event.\r\n * @returns {number[]} [pitch, yaw]\r\n */\r\nthis.mouseEventToCoords = function(event) {\r\n    return mouseEventToCoords(event);\r\n};\r\n\r\n/**\r\n * Change scene being viewed.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {string} sceneId - Identifier of scene to switch to.\r\n * @param {number} [pitch] - Pitch to use with new scene\r\n * @param {number} [yaw] - Yaw to use with new scene\r\n * @param {number} [hfov] - HFOV to use with new scene\r\n * @returns {Viewer} `this`\r\n */\r\nthis.loadScene = function(sceneId, pitch, yaw, hfov) {\r\n    if (loaded !== false)\r\n        loadScene(sceneId, pitch, yaw, hfov);\r\n    return this;\r\n};\r\n\r\n/**\r\n * Get ID of current scene.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {string} ID of current scene\r\n */\r\nthis.getScene = function() {\r\n    return config.scene;\r\n};\r\n\r\n/**\r\n * Add a new scene.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {string} sceneId - The ID of the new scene\r\n * @param {string} config - The configuration of the new scene\r\n * @returns {Viewer} `this`\r\n */\r\nthis.addScene = function(sceneId, config) {\r\n    initialConfig.scenes[sceneId] = config;\r\n    return this;\r\n};\r\n\r\n/**\r\n * Remove a scene.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {string} sceneId - The ID of the scene\r\n * @returns {boolean} False if the scene is the current scene or if the scene doesn't exists, else true\r\n */\r\nthis.removeScene = function(sceneId) {\r\n    if (config.scene === sceneId || !initialConfig.scenes.hasOwnProperty(sceneId))\r\n        return false;\r\n    delete initialConfig.scenes[sceneId];\r\n    return true;\r\n};\r\n\r\n/**\r\n * Toggle fullscreen.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {Viewer} `this`\r\n */\r\nthis.toggleFullscreen = function() {\r\n    toggleFullscreen();\r\n    return this;\r\n};\r\n\r\n/**\r\n * Get configuration of current scene.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {Object} Configuration of current scene\r\n */\r\nthis.getConfig = function() {\r\n    return config;\r\n};\r\n\r\n/**\r\n * Get viewer's container element.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {HTMLElement} Container `div` element\r\n */\r\nthis.getContainer = function() {\r\n    return container;\r\n};\r\n\r\n/**\r\n * Add a new hot spot.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {Object} hs - The configuration for the hot spot\r\n * @param {string} [sceneId] - Adds hot spot to specified scene if provided, else to current scene\r\n * @returns {Viewer} `this`\r\n * @throws Throws an error if the scene ID is provided but invalid\r\n */\r\nthis.addHotSpot = function(hs, sceneId) {\r\n    if (sceneId === undefined && config.scene === undefined) {\r\n        // Not a tour\r\n        config.hotSpots.push(hs);\r\n    } else {\r\n        // Tour\r\n        var id = sceneId !== undefined ? sceneId : config.scene;\r\n        if (initialConfig.scenes.hasOwnProperty(id)) {\r\n            if (!initialConfig.scenes[id].hasOwnProperty('hotSpots')) {\r\n                initialConfig.scenes[id].hotSpots = []; // Create hot spots array if needed\r\n                if (id == config.scene)\r\n                    config.hotSpots = initialConfig.scenes[id].hotSpots;    // Link to current config\r\n            }\r\n            initialConfig.scenes[id].hotSpots.push(hs); // Add hot spot to config\r\n        } else {\r\n            throw 'Invalid scene ID!';\r\n        }\r\n    }\r\n    if (sceneId === undefined || config.scene == sceneId) {\r\n        // Add to current scene\r\n        createHotSpot(hs);\r\n        if (loaded)\r\n            renderHotSpot(hs);\r\n    }\r\n    return this;\r\n};\r\n\r\n/**\r\n * Remove a hot spot.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {string} hotSpotId - The ID of the hot spot\r\n * @param {string} [sceneId] - Removes hot spot from specified scene if provided, else from current scene\r\n * @returns {boolean} True if deletion is successful, else false\r\n */\r\nthis.removeHotSpot = function(hotSpotId, sceneId) {\r\n    if (sceneId === undefined || config.scene == sceneId) {\r\n        if (!config.hotSpots)\r\n            return false;\r\n        for (var i = 0; i < config.hotSpots.length; i++) {\r\n            if (config.hotSpots[i].hasOwnProperty('id') &&\r\n                config.hotSpots[i].id === hotSpotId) {\r\n                // Delete hot spot DOM elements\r\n                var current = config.hotSpots[i].div;\r\n                while (current.parentNode != renderContainer)\r\n                    current = current.parentNode;\r\n                renderContainer.removeChild(current);\r\n                delete config.hotSpots[i].div;\r\n                // Remove hot spot from configuration\r\n                config.hotSpots.splice(i, 1);\r\n                return true;\r\n            }\r\n        }\r\n    } else {\r\n        if (initialConfig.scenes.hasOwnProperty(sceneId)) {\r\n            if (!initialConfig.scenes[sceneId].hasOwnProperty('hotSpots'))\r\n                return false;\r\n            for (var j = 0; j < initialConfig.scenes[sceneId].hotSpots.length; j++) {\r\n                if (initialConfig.scenes[sceneId].hotSpots[j].hasOwnProperty('id') &&\r\n                    initialConfig.scenes[sceneId].hotSpots[j].id === hotSpotId) {\r\n                    // Remove hot spot from configuration\r\n                    initialConfig.scenes[sceneId].hotSpots.splice(j, 1);\r\n                    return true;\r\n                }\r\n            }\r\n        } else {\r\n            return false;\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * This method should be called if the viewer's container is resized.\r\n * @memberof Viewer\r\n * @instance\r\n */\r\nthis.resize = function() {\r\n    if (renderer)\r\n        onDocumentResize();\r\n};\r\n\r\n/**\r\n * Check if a panorama is loaded.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {boolean} True if a panorama is loaded, else false\r\n */\r\nthis.isLoaded = function() {\r\n    return loaded;\r\n};\r\n\r\n/**\r\n * Check if device orientation control is supported.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {boolean} True if supported, else false\r\n */\r\nthis.isOrientationSupported = function() {\r\n    return orientationSupport || false;\r\n};\r\n\r\n/**\r\n * Stop using device orientation.\r\n * @memberof Viewer\r\n * @instance\r\n */\r\nthis.stopOrientation = function() {\r\n    stopOrientation();\r\n};\r\n\r\n/**\r\n * Start using device orientation (does nothing if not supported).\r\n * @memberof Viewer\r\n * @instance\r\n */\r\nthis.startOrientation = function() {\r\n    if (orientationSupport)\r\n        startOrientation();\r\n};\r\n\r\n/**\r\n * Check if device orientation control is currently activated.\r\n * @memberof Viewer\r\n * @instance\r\n * @returns {boolean} True if active, else false\r\n */\r\nthis.isOrientationActive = function() {\r\n    return Boolean(orientation);\r\n};\r\n\r\n/**\r\n * Subscribe listener to specified event.\r\n * @memberof Viewer\r\n * @instance\r\n * @param {string} type - Type of event to subscribe to.\r\n * @param {Function} listener - Listener function to subscribe to event.\r\n * @returns {Viewer} `this`\r\n */\r\nthis.on = function(type, listener) {\r\n    externalEventListeners[type] = externalEventListeners[type] || [];\r\n    externalEventListeners[type].push(listener);\r\n    return this;\r\n};\r\n\r\n/**\r\n * Remove an event listener (or listeners).\r\n * @memberof Viewer\r\n * @param {string} [type] - Type of event to remove listeners from. If not specified, all listeners are removed.\r\n * @param {Function} [listener] - Listener function to remove. If not specified, all listeners of specified type are removed.\r\n * @returns {Viewer} `this`\r\n */\r\nthis.off = function(type, listener) {\r\n    if (!type) {\r\n        // Remove all listeners if type isn't specified\r\n        externalEventListeners = {};\r\n        return this;\r\n    }\r\n    if (listener) {\r\n        var i = externalEventListeners[type].indexOf(listener);\r\n        if (i >= 0) {\r\n            // Remove listener if found\r\n            externalEventListeners[type].splice(i, 1);\r\n        }\r\n        if (externalEventListeners[type].length == 0) {\r\n            // Remove category if empty\r\n            delete externalEventListeners[type];\r\n        }\r\n    } else {\r\n        // Remove category of listeners if listener isn't specified\r\n        delete externalEventListeners[type];\r\n    }\r\n    return this;\r\n};\r\n\r\n/**\r\n * Fire listeners attached to specified event.\r\n * @private\r\n * @param {string} [type] - Type of event to fire listeners for.\r\n */\r\nfunction fireEvent(type) {\r\n    if (type in externalEventListeners) {\r\n        // Reverse iteration is useful, if event listener is removed inside its definition\r\n        for (var i = externalEventListeners[type].length; i > 0; i--) {\r\n            externalEventListeners[type][externalEventListeners[type].length - i].apply(null, [].slice.call(arguments, 1));\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Destructor.\r\n * @instance\r\n * @memberof Viewer\r\n */\r\nthis.destroy = function() {\r\n    destroyed = true;\r\n    clearTimeout(autoRotateStart);\r\n\r\n    if (renderer)\r\n        renderer.destroy();\r\n    if (listenersAdded) {\r\n        document.removeEventListener('mousemove', onDocumentMouseMove, false);\r\n        document.removeEventListener('mouseup', onDocumentMouseUp, false);\r\n        container.removeEventListener('mozfullscreenchange', onFullScreenChange, false);\r\n        container.removeEventListener('webkitfullscreenchange', onFullScreenChange, false);\r\n        container.removeEventListener('msfullscreenchange', onFullScreenChange, false);\r\n        container.removeEventListener('fullscreenchange', onFullScreenChange, false);\r\n        window.removeEventListener('resize', onDocumentResize, false);\r\n        window.removeEventListener('orientationchange', onDocumentResize, false);\r\n        container.removeEventListener('keydown', onDocumentKeyPress, false);\r\n        container.removeEventListener('keyup', onDocumentKeyUp, false);\r\n        container.removeEventListener('blur', clearKeys, false);\r\n        document.removeEventListener('mouseleave', onDocumentMouseUp, false);\r\n    }\r\n    container.innerHTML = '';\r\n    container.classList.remove('pnlm-container');\r\n};\r\n\r\n}\r\n\r\nreturn {\r\n    viewer: function(container, config) {\r\n        return new Viewer(container, config);\r\n    }\r\n};\r\n\r\n})(window, document);\r\n"]}]}