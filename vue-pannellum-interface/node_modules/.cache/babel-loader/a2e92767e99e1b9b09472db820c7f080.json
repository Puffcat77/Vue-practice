{"remainingRequest":"D:\\Практика\\Vue practice\\vue-pannellum-interface\\node_modules\\babel-loader\\lib\\index.js!D:\\Практика\\Vue practice\\vue-pannellum-interface\\node_modules\\eslint-loader\\index.js??ref--13-0!D:\\Практика\\Vue practice\\vue-pannellum-interface\\src\\pannellum-2.5.6\\src\\js\\libpannellum.js","dependencies":[{"path":"D:\\Практика\\Vue practice\\vue-pannellum-interface\\src\\pannellum-2.5.6\\src\\js\\libpannellum.js","mtime":1607675807635},{"path":"D:\\Практика\\Vue practice\\vue-pannellum-interface\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Практика\\Vue practice\\vue-pannellum-interface\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000},{"path":"D:\\Практика\\Vue practice\\vue-pannellum-interface\\node_modules\\eslint-loader\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:cmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmNvbmNhdCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmluZGV4LW9mIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuam9pbiIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNsaWNlIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc3BsaWNlIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LmtleXMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QudG8tc3RyaW5nIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMucmVnZXhwLmV4ZWMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcubWF0Y2giKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcucmVwbGFjZSIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LmZsb2F0MzItYXJyYXkiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS51aW50OC1jbGFtcGVkLWFycmF5Iik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkudWludDE2LWFycmF5Iik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkuY29weS13aXRoaW4iKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5ldmVyeSIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LmZpbGwiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5maWx0ZXIiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5maW5kIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkuZmluZC1pbmRleCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LmZvci1lYWNoIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkuaW5jbHVkZXMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5pbmRleC1vZiIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5Lml0ZXJhdG9yIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkuam9pbiIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5Lmxhc3QtaW5kZXgtb2YiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5tYXAiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5yZWR1Y2UiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5yZWR1Y2UtcmlnaHQiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5yZXZlcnNlIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkuc2V0Iik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkuc2xpY2UiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy50eXBlZC1hcnJheS5zb21lIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkuc29ydCIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LnN1YmFycmF5Iik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMudHlwZWQtYXJyYXkudG8tbG9jYWxlLXN0cmluZyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnR5cGVkLWFycmF5LnRvLXN0cmluZyIpOwoKLyoNCiAqIGxpYnBhbm5lbGx1bSAtIEEgV2ViR0wgYW5kIENTUyAzRCB0cmFuc2Zvcm0gYmFzZWQgUGFub3JhbWEgUmVuZGVyZXINCiAqIENvcHlyaWdodCAoYykgMjAxMi0yMDE5IE1hdHRoZXcgUGV0cm9mZg0KICogDQogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5DQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbA0KICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cw0KICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbA0KICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzDQogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOg0KICogDQogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbg0KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuDQogKiANCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SDQogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwNCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQ0KICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUg0KICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwNCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4NCiAqIFRIRSBTT0ZUV0FSRS4NCiAqLwp3aW5kb3cubGlicGFubmVsbHVtID0gZnVuY3Rpb24gKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCkgewogICd1c2Ugc3RyaWN0JzsKICAvKioNCiAgICogQ3JlYXRlcyBhIG5ldyBwYW5vcmFtYSByZW5kZXJlci4NCiAgICogQGNvbnN0cnVjdG9yDQogICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGNvbnRhaW5lciAtIFRoZSBjb250YWluZXIgZWxlbWVudCBmb3IgdGhlIHJlbmRlcmVyLg0KICAgKi8KCiAgZnVuY3Rpb24gUmVuZGVyZXIoY29udGFpbmVyKSB7CiAgICB2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICBjYW52YXMuc3R5bGUud2lkdGggPSBjYW52YXMuc3R5bGUuaGVpZ2h0ID0gJzEwMCUnOwogICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGNhbnZhcyk7CiAgICB2YXIgcHJvZ3JhbSwgZ2wsIHZzLCBmczsKICAgIHZhciBmYWxsYmFja0ltZ1NpemU7CiAgICB2YXIgd29ybGQ7CiAgICB2YXIgdnRtcHM7CiAgICB2YXIgcG9zZTsKICAgIHZhciBpbWFnZSwgaW1hZ2VUeXBlLCBkeW5hbWljOwogICAgdmFyIHRleENvb3JkQnVmZmVyLCBjdWJlVmVydEJ1ZiwgY3ViZVZlcnRUZXhDb29yZEJ1ZiwgY3ViZVZlcnRJbmRCdWY7CiAgICB2YXIgZ2xvYmFsUGFyYW1zOwogICAgLyoqDQogICAgICogSW5pdGlhbGl6ZSByZW5kZXJlci4NCiAgICAgKiBAbWVtYmVyb2YgUmVuZGVyZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcGFyYW0ge0ltYWdlfEFycmF5fE9iamVjdH0gaW1hZ2UgLSBJbnB1dCBpbWFnZTsgZm9ybWF0IHZhcmllcyBiYXNlZCBvbg0KICAgICAqICAgICAgYGltYWdlVHlwZWAuIEZvciBgZXF1aXJlY3Rhbmd1bGFyYCwgdGhpcyBpcyBhbiBpbWFnZTsgZm9yDQogICAgICogICAgICBgY3ViZW1hcGAsIHRoaXMgaXMgYW4gYXJyYXkgb2YgaW1hZ2VzIGZvciB0aGUgY3ViZSBmYWNlcyBpbiB0aGUNCiAgICAgKiAgICAgIG9yZGVyIFsreiwgK3gsIC16LCAteCwgK3ksIC15XTsgZm9yIGBtdWx0aXJlc2AsIHRoaXMgaXMgYQ0KICAgICAqICAgICAgY29uZmlndXJhdGlvbiBvYmplY3QuDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGltYWdlVHlwZSAtIFRoZSB0eXBlIG9mIHRoZSBpbWFnZTogYGVxdWlyZWN0YW5ndWxhcmAsDQogICAgICogICAgICBgY3ViZW1hcGAsIG9yIGBtdWx0aXJlc2AuDQogICAgICogQHBhcmFtIHtib29sZWFufSBkeW5hbWljIC0gV2hldGhlciBvciBub3QgdGhlIGltYWdlIGlzIGR5bmFtaWMgKGUuZy4gdmlkZW8pLg0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBoYW92IC0gSW5pdGlhbCBob3Jpem9udGFsIGFuZ2xlIG9mIHZpZXcuDQogICAgICogQHBhcmFtIHtudW1iZXJ9IHZhb3YgLSBJbml0aWFsIHZlcnRpY2FsIGFuZ2xlIG9mIHZpZXcuDQogICAgICogQHBhcmFtIHtudW1iZXJ9IHZvZmZzZXQgLSBJbml0aWFsIHZlcnRpY2FsIG9mZnNldCBhbmdsZS4NCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIExvYWQgY2FsbGJhY2sgZnVuY3Rpb24uDQogICAgICogQHBhcmFtIHtPYmplY3R9IFtwYXJhbXNdIC0gT3RoZXIgY29uZmlndXJhdGlvbiBwYXJhbWV0ZXJzIChgaG9yaXpvblBpdGNoYCwgYGhvcml6b25Sb2xsYCwgYGJhY2tncm91bmRDb2xvcmApLg0KICAgICAqLwoKICAgIHRoaXMuaW5pdCA9IGZ1bmN0aW9uIChfaW1hZ2UsIF9pbWFnZVR5cGUsIF9keW5hbWljLCBoYW92LCB2YW92LCB2b2Zmc2V0LCBjYWxsYmFjaywgcGFyYW1zKSB7CiAgICAgIC8vIERlZmF1bHQgYXJndW1lbnQgZm9yIGltYWdlIHR5cGUKICAgICAgaWYgKF9pbWFnZVR5cGUgPT09IHVuZGVmaW5lZCkgX2ltYWdlVHlwZSA9ICdlcXVpcmVjdGFuZ3VsYXInOwoKICAgICAgaWYgKF9pbWFnZVR5cGUgIT0gJ2VxdWlyZWN0YW5ndWxhcicgJiYgX2ltYWdlVHlwZSAhPSAnY3ViZW1hcCcgJiYgX2ltYWdlVHlwZSAhPSAnbXVsdGlyZXMnKSB7CiAgICAgICAgY29uc29sZS5sb2coJ0Vycm9yOiBpbnZhbGlkIGltYWdlIHR5cGUgc3BlY2lmaWVkIScpOwogICAgICAgIHRocm93IHsKICAgICAgICAgIHR5cGU6ICdjb25maWcgZXJyb3InCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgaW1hZ2VUeXBlID0gX2ltYWdlVHlwZTsKICAgICAgaW1hZ2UgPSBfaW1hZ2U7CiAgICAgIGR5bmFtaWMgPSBfZHluYW1pYzsKICAgICAgZ2xvYmFsUGFyYW1zID0gcGFyYW1zIHx8IHt9OyAvLyBDbGVhciBvbGQgZGF0YQoKICAgICAgaWYgKHByb2dyYW0pIHsKICAgICAgICBpZiAodnMpIHsKICAgICAgICAgIGdsLmRldGFjaFNoYWRlcihwcm9ncmFtLCB2cyk7CiAgICAgICAgICBnbC5kZWxldGVTaGFkZXIodnMpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGZzKSB7CiAgICAgICAgICBnbC5kZXRhY2hTaGFkZXIocHJvZ3JhbSwgZnMpOwogICAgICAgICAgZ2wuZGVsZXRlU2hhZGVyKGZzKTsKICAgICAgICB9CgogICAgICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBudWxsKTsKICAgICAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBudWxsKTsKICAgICAgICBpZiAocHJvZ3JhbS50ZXh0dXJlKSBnbC5kZWxldGVUZXh0dXJlKHByb2dyYW0udGV4dHVyZSk7CiAgICAgICAgaWYgKHByb2dyYW0ubm9kZUNhY2hlKSBmb3IgKHZhciBpID0gMDsgaSA8IHByb2dyYW0ubm9kZUNhY2hlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBnbC5kZWxldGVUZXh0dXJlKHByb2dyYW0ubm9kZUNhY2hlW2ldLnRleHR1cmUpOwogICAgICAgIH0KICAgICAgICBnbC5kZWxldGVQcm9ncmFtKHByb2dyYW0pOwogICAgICAgIHByb2dyYW0gPSB1bmRlZmluZWQ7CiAgICAgIH0KCiAgICAgIHBvc2UgPSB1bmRlZmluZWQ7CiAgICAgIHZhciBzOwogICAgICB2YXIgZmFjZU1pc3NpbmcgPSBmYWxzZTsKICAgICAgdmFyIGN1YmVJbWdXaWR0aDsKCiAgICAgIGlmIChpbWFnZVR5cGUgPT0gJ2N1YmVtYXAnKSB7CiAgICAgICAgZm9yIChzID0gMDsgcyA8IDY7IHMrKykgewogICAgICAgICAgaWYgKGltYWdlW3NdLndpZHRoID4gMCkgewogICAgICAgICAgICBpZiAoY3ViZUltZ1dpZHRoID09PSB1bmRlZmluZWQpIGN1YmVJbWdXaWR0aCA9IGltYWdlW3NdLndpZHRoOwogICAgICAgICAgICBpZiAoY3ViZUltZ1dpZHRoICE9IGltYWdlW3NdLndpZHRoKSBjb25zb2xlLmxvZygnQ3ViZSBmYWNlcyBoYXZlIGluY29uc2lzdGVudCB3aWR0aHM6ICcgKyBjdWJlSW1nV2lkdGggKyAnIHZzLiAnICsgaW1hZ2Vbc10ud2lkdGgpOwogICAgICAgICAgfSBlbHNlIGZhY2VNaXNzaW5nID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGZpbGxNaXNzaW5nRmFjZXMoaW1nU2l6ZSkgewogICAgICAgIGlmIChmYWNlTWlzc2luZykgewogICAgICAgICAgLy8gRmlsbCBhbnkgbWlzc2luZyBmYWxsYmFjay9jdWJlbWFwIGZhY2VzIHdpdGggYmFja2dyb3VuZAogICAgICAgICAgdmFyIG5ieXRlcyA9IGltZ1NpemUgKiBpbWdTaXplICogNDsgLy8gUkdCLCBwbHVzIG5vbi1mdW5jdGlvbmFsIGFscGhhCgogICAgICAgICAgdmFyIGltYWdlQXJyYXkgPSBuZXcgVWludDhDbGFtcGVkQXJyYXkobmJ5dGVzKTsKICAgICAgICAgIHZhciByZ2IgPSBwYXJhbXMuYmFja2dyb3VuZENvbG9yID8gcGFyYW1zLmJhY2tncm91bmRDb2xvciA6IFswLCAwLCAwXTsKICAgICAgICAgIHJnYlswXSAqPSAyNTU7CiAgICAgICAgICByZ2JbMV0gKj0gMjU1OwogICAgICAgICAgcmdiWzJdICo9IDI1NTsgLy8gTWF5YmUgZmlsbGluZyBjb3VsZCBiZSBkb25lIGZhc3Rlciwgc2VlIGUuZy4gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTI5NTU4NC9tb3N0LWVmZmljaWVudC13YXktdG8tY3JlYXRlLWEtemVyby1maWxsZWQtamF2YXNjcmlwdC1hcnJheQoKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmJ5dGVzOyBpKyspIHsKICAgICAgICAgICAgaW1hZ2VBcnJheVtpKytdID0gcmdiWzBdOwogICAgICAgICAgICBpbWFnZUFycmF5W2krK10gPSByZ2JbMV07CiAgICAgICAgICAgIGltYWdlQXJyYXlbaSsrXSA9IHJnYlsyXTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgYmFja2dyb3VuZFNxdWFyZSA9IG5ldyBJbWFnZURhdGEoaW1hZ2VBcnJheSwgaW1nU2l6ZSwgaW1nU2l6ZSk7CgogICAgICAgICAgZm9yIChzID0gMDsgcyA8IDY7IHMrKykgewogICAgICAgICAgICBpZiAoaW1hZ2Vbc10ud2lkdGggPT0gMCkgaW1hZ2Vbc10gPSBiYWNrZ3JvdW5kU3F1YXJlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAvLyBUaGlzIGF3ZnVsIGJyb3dzZXIgc3BlY2lmaWMgdGVzdCBleGlzdHMgYmVjYXVzZSBpT1MgOC85IGFuZCBJRSAxMQogICAgICAvLyBkb24ndCBkaXNwbGF5IG5vbi1wb3dlci1vZi10d28gY3ViZW1hcCB0ZXh0dXJlcyBidXQgYWxzbyBkb24ndAogICAgICAvLyB0aHJvdyBhbiBlcnJvciAodGVzdGVkIG9uIGFuIGlQaG9uZSA1YyAvIGlPUyA4LjEuMyAvIGlPUyA5LjIgLwogICAgICAvLyBpT1MgMTAuMy4xKS4KICAgICAgLy8gVGhlcmVmb3JlLCB0aGUgV2ViR0wgY29udGV4dCBpcyBuZXZlciBjcmVhdGVkIGZvciB0aGVzZSBicm93c2VycyBmb3IKICAgICAgLy8gTlBPVCBjdWJlbWFwcywgYW5kIHRoZSBDU1MgM0QgdHJhbnNmb3JtIGZhbGxiYWNrIHJlbmRlcmVyIGlzIHVzZWQKICAgICAgLy8gaW5zdGVhZC4KCgogICAgICBpZiAoIShpbWFnZVR5cGUgPT0gJ2N1YmVtYXAnICYmIChjdWJlSW1nV2lkdGggJiBjdWJlSW1nV2lkdGggLSAxKSAhPT0gMCAmJiAobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLm1hdGNoKC8oaXBob25lfGlwb2R8aXBhZCkuKiBvcyA4Xy8pIHx8IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5tYXRjaCgvKGlwaG9uZXxpcG9kfGlwYWQpLiogb3MgOV8vKSB8fCBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkubWF0Y2goLyhpcGhvbmV8aXBvZHxpcGFkKS4qIG9zIDEwXy8pIHx8IG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL1RyaWRlbnQuKnJ2WyA6XSoxMVwuLykpKSkgewogICAgICAgIC8vIEVuYWJsZSBXZWJHTCBvbiBjYW52YXMKICAgICAgICBpZiAoIWdsKSBnbCA9IGNhbnZhcy5nZXRDb250ZXh0KCdleHBlcmltZW50YWwtd2ViZ2wnLCB7CiAgICAgICAgICBhbHBoYTogZmFsc2UsCiAgICAgICAgICBkZXB0aDogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBpZiAoZ2wgJiYgZ2wuZ2V0RXJyb3IoKSA9PSAxMjg2KSBoYW5kbGVXZWJHTEVycm9yMTI4NigpOwogICAgICB9IC8vIElmIHRoZXJlIGlzIG5vIFdlYkdMLCBmYWxsIGJhY2sgdG8gQ1NTIDNEIHRyYW5zZm9ybSByZW5kZXJlci4KICAgICAgLy8gVGhpcyB3aWxsIGRpc2NhcmQgdGhlIGltYWdlIGxvYWRlZCBzbyBmYXIgYW5kIGxvYWQgdGhlIGZhbGxiYWNrIGltYWdlLgogICAgICAvLyBXaGlsZSBicm93c2VyIHNwZWNpZmljIHRlc3RzIGFyZSB1c3VhbGx5IGZyb3duZWQgdXBvbiwgdGhlCiAgICAgIC8vIGZhbGxiYWNrIHZpZXdlciBvbmx5IHJlYWxseSB3b3JrcyB3aXRoIFdlYktpdC9CbGluayBhbmQgSUUgMTAvMTEKICAgICAgLy8gKGl0IGRvZXNuJ3Qgd29yayBwcm9wZXJseSBpbiBGaXJlZm94KS4KCgogICAgICBpZiAoIWdsICYmIChpbWFnZVR5cGUgPT0gJ211bHRpcmVzJyAmJiBpbWFnZS5oYXNPd25Qcm9wZXJ0eSgnZmFsbGJhY2tQYXRoJykgfHwgaW1hZ2VUeXBlID09ICdjdWJlbWFwJykgJiYgKCdXZWJraXRBcHBlYXJhbmNlJyBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUgfHwgbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvVHJpZGVudC4qcnZbIDpdKjExXC4vKSB8fCBuYXZpZ2F0b3IuYXBwVmVyc2lvbi5pbmRleE9mKCdNU0lFIDEwJykgIT09IC0xKSkgewogICAgICAgIC8vIFJlbW92ZSBvbGQgd29ybGQgaWYgaXQgZXhpc3RzCiAgICAgICAgaWYgKHdvcmxkKSB7CiAgICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQod29ybGQpOwogICAgICAgIH0gLy8gSW5pdGlhbGl6ZSByZW5kZXJlcgoKCiAgICAgICAgd29ybGQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICB3b3JsZC5jbGFzc05hbWUgPSAncG5sbS13b3JsZCc7IC8vIEFkZCBpbWFnZXMKCiAgICAgICAgdmFyIHBhdGg7CgogICAgICAgIGlmIChpbWFnZS5iYXNlUGF0aCkgewogICAgICAgICAgcGF0aCA9IGltYWdlLmJhc2VQYXRoICsgaW1hZ2UuZmFsbGJhY2tQYXRoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwYXRoID0gaW1hZ2UuZmFsbGJhY2tQYXRoOwogICAgICAgIH0KCiAgICAgICAgdmFyIHNpZGVzID0gWydmJywgJ3InLCAnYicsICdsJywgJ3UnLCAnZCddOwogICAgICAgIHZhciBsb2FkZWQgPSAwOwoKICAgICAgICB2YXIgb25Mb2FkID0gZnVuY3Rpb24gb25Mb2FkKCkgewogICAgICAgICAgLy8gRHJhdyBpbWFnZSBvbiBjYW52YXMKICAgICAgICAgIHZhciBmYWNlQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgICBmYWNlQ2FudmFzLmNsYXNzTmFtZSA9ICdwbmxtLWZhY2UgcG5sbS0nICsgc2lkZXNbdGhpcy5zaWRlXSArICdmYWNlJzsKICAgICAgICAgIHdvcmxkLmFwcGVuZENoaWxkKGZhY2VDYW52YXMpOwogICAgICAgICAgdmFyIGZhY2VDb250ZXh0ID0gZmFjZUNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwogICAgICAgICAgZmFjZUNhbnZhcy5zdHlsZS53aWR0aCA9IHRoaXMud2lkdGggKyA0ICsgJ3B4JzsKICAgICAgICAgIGZhY2VDYW52YXMuc3R5bGUuaGVpZ2h0ID0gdGhpcy5oZWlnaHQgKyA0ICsgJ3B4JzsKICAgICAgICAgIGZhY2VDYW52YXMud2lkdGggPSB0aGlzLndpZHRoICsgNDsKICAgICAgICAgIGZhY2VDYW52YXMuaGVpZ2h0ID0gdGhpcy5oZWlnaHQgKyA0OwogICAgICAgICAgZmFjZUNvbnRleHQuZHJhd0ltYWdlKHRoaXMsIDIsIDIpOwogICAgICAgICAgdmFyIGltZ0RhdGEgPSBmYWNlQ29udGV4dC5nZXRJbWFnZURhdGEoMCwgMCwgZmFjZUNhbnZhcy53aWR0aCwgZmFjZUNhbnZhcy5oZWlnaHQpOwogICAgICAgICAgdmFyIGRhdGEgPSBpbWdEYXRhLmRhdGE7IC8vIER1cGxpY2F0ZSBlZGdlIHBpeGVscwoKICAgICAgICAgIHZhciBpOwogICAgICAgICAgdmFyIGo7CgogICAgICAgICAgZm9yIChpID0gMjsgaSA8IGZhY2VDYW52YXMud2lkdGggLSAyOyBpKyspIHsKICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IDQ7IGorKykgewogICAgICAgICAgICAgIGRhdGFbKGkgKyBmYWNlQ2FudmFzLndpZHRoKSAqIDQgKyBqXSA9IGRhdGFbKGkgKyBmYWNlQ2FudmFzLndpZHRoICogMikgKiA0ICsgal07CiAgICAgICAgICAgICAgZGF0YVsoaSArIGZhY2VDYW52YXMud2lkdGggKiAoZmFjZUNhbnZhcy5oZWlnaHQgLSAyKSkgKiA0ICsgal0gPSBkYXRhWyhpICsgZmFjZUNhbnZhcy53aWR0aCAqIChmYWNlQ2FudmFzLmhlaWdodCAtIDMpKSAqIDQgKyBqXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZvciAoaSA9IDI7IGkgPCBmYWNlQ2FudmFzLmhlaWdodCAtIDI7IGkrKykgewogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgNDsgaisrKSB7CiAgICAgICAgICAgICAgZGF0YVsoaSAqIGZhY2VDYW52YXMud2lkdGggKyAxKSAqIDQgKyBqXSA9IGRhdGFbKGkgKiBmYWNlQ2FudmFzLndpZHRoICsgMikgKiA0ICsgal07CiAgICAgICAgICAgICAgZGF0YVsoKGkgKyAxKSAqIGZhY2VDYW52YXMud2lkdGggLSAyKSAqIDQgKyBqXSA9IGRhdGFbKChpICsgMSkgKiBmYWNlQ2FudmFzLndpZHRoIC0gMykgKiA0ICsgal07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgNDsgaisrKSB7CiAgICAgICAgICAgIGRhdGFbKGZhY2VDYW52YXMud2lkdGggKyAxKSAqIDQgKyBqXSA9IGRhdGFbKGZhY2VDYW52YXMud2lkdGggKiAyICsgMikgKiA0ICsgal07CiAgICAgICAgICAgIGRhdGFbKGZhY2VDYW52YXMud2lkdGggKiAyIC0gMikgKiA0ICsgal0gPSBkYXRhWyhmYWNlQ2FudmFzLndpZHRoICogMyAtIDMpICogNCArIGpdOwogICAgICAgICAgICBkYXRhWyhmYWNlQ2FudmFzLndpZHRoICogKGZhY2VDYW52YXMuaGVpZ2h0IC0gMikgKyAxKSAqIDQgKyBqXSA9IGRhdGFbKGZhY2VDYW52YXMud2lkdGggKiAoZmFjZUNhbnZhcy5oZWlnaHQgLSAzKSArIDIpICogNCArIGpdOwogICAgICAgICAgICBkYXRhWyhmYWNlQ2FudmFzLndpZHRoICogKGZhY2VDYW52YXMuaGVpZ2h0IC0gMSkgLSAyKSAqIDQgKyBqXSA9IGRhdGFbKGZhY2VDYW52YXMud2lkdGggKiAoZmFjZUNhbnZhcy5oZWlnaHQgLSAyKSAtIDMpICogNCArIGpdOwogICAgICAgICAgfQoKICAgICAgICAgIGZvciAoaSA9IDE7IGkgPCBmYWNlQ2FudmFzLndpZHRoIC0gMTsgaSsrKSB7CiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCA0OyBqKyspIHsKICAgICAgICAgICAgICBkYXRhW2kgKiA0ICsgal0gPSBkYXRhWyhpICsgZmFjZUNhbnZhcy53aWR0aCkgKiA0ICsgal07CiAgICAgICAgICAgICAgZGF0YVsoaSArIGZhY2VDYW52YXMud2lkdGggKiAoZmFjZUNhbnZhcy5oZWlnaHQgLSAxKSkgKiA0ICsgal0gPSBkYXRhWyhpICsgZmFjZUNhbnZhcy53aWR0aCAqIChmYWNlQ2FudmFzLmhlaWdodCAtIDIpKSAqIDQgKyBqXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZvciAoaSA9IDE7IGkgPCBmYWNlQ2FudmFzLmhlaWdodCAtIDE7IGkrKykgewogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgNDsgaisrKSB7CiAgICAgICAgICAgICAgZGF0YVtpICogZmFjZUNhbnZhcy53aWR0aCAqIDQgKyBqXSA9IGRhdGFbKGkgKiBmYWNlQ2FudmFzLndpZHRoICsgMSkgKiA0ICsgal07CiAgICAgICAgICAgICAgZGF0YVsoKGkgKyAxKSAqIGZhY2VDYW52YXMud2lkdGggLSAxKSAqIDQgKyBqXSA9IGRhdGFbKChpICsgMSkgKiBmYWNlQ2FudmFzLndpZHRoIC0gMikgKiA0ICsgal07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgNDsgaisrKSB7CiAgICAgICAgICAgIGRhdGFbal0gPSBkYXRhWyhmYWNlQ2FudmFzLndpZHRoICsgMSkgKiA0ICsgal07CiAgICAgICAgICAgIGRhdGFbKGZhY2VDYW52YXMud2lkdGggLSAxKSAqIDQgKyBqXSA9IGRhdGFbKGZhY2VDYW52YXMud2lkdGggKiAyIC0gMikgKiA0ICsgal07CiAgICAgICAgICAgIGRhdGFbZmFjZUNhbnZhcy53aWR0aCAqIChmYWNlQ2FudmFzLmhlaWdodCAtIDEpICogNCArIGpdID0gZGF0YVsoZmFjZUNhbnZhcy53aWR0aCAqIChmYWNlQ2FudmFzLmhlaWdodCAtIDIpICsgMSkgKiA0ICsgal07CiAgICAgICAgICAgIGRhdGFbKGZhY2VDYW52YXMud2lkdGggKiBmYWNlQ2FudmFzLmhlaWdodCAtIDEpICogNCArIGpdID0gZGF0YVsoZmFjZUNhbnZhcy53aWR0aCAqIChmYWNlQ2FudmFzLmhlaWdodCAtIDEpIC0gMikgKiA0ICsgal07CiAgICAgICAgICB9IC8vIERyYXcgaW1hZ2Ugd2lkdGggZHVwbGljYXRlZCBlZGdlIHBpeGVscyBvbiBjYW52YXMKCgogICAgICAgICAgZmFjZUNvbnRleHQucHV0SW1hZ2VEYXRhKGltZ0RhdGEsIDAsIDApOwogICAgICAgICAgaW5jTG9hZGVkLmNhbGwodGhpcyk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIGluY0xvYWRlZCA9IGZ1bmN0aW9uIGluY0xvYWRlZCgpIHsKICAgICAgICAgIGlmICh0aGlzLndpZHRoID4gMCkgewogICAgICAgICAgICBpZiAoZmFsbGJhY2tJbWdTaXplID09PSB1bmRlZmluZWQpIGZhbGxiYWNrSW1nU2l6ZSA9IHRoaXMud2lkdGg7CiAgICAgICAgICAgIGlmIChmYWxsYmFja0ltZ1NpemUgIT0gdGhpcy53aWR0aCkgY29uc29sZS5sb2coJ0ZhbGxiYWNrIGZhY2VzIGhhdmUgaW5jb25zaXN0ZW50IHdpZHRoczogJyArIGZhbGxiYWNrSW1nU2l6ZSArICcgdnMuICcgKyB0aGlzLndpZHRoKTsKICAgICAgICAgIH0gZWxzZSBmYWNlTWlzc2luZyA9IHRydWU7CgogICAgICAgICAgbG9hZGVkKys7CgogICAgICAgICAgaWYgKGxvYWRlZCA9PSA2KSB7CiAgICAgICAgICAgIGZhbGxiYWNrSW1nU2l6ZSA9IHRoaXMud2lkdGg7CiAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZCh3b3JsZCk7CiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZmFjZU1pc3NpbmcgPSBmYWxzZTsKCiAgICAgICAgZm9yIChzID0gMDsgcyA8IDY7IHMrKykgewogICAgICAgICAgdmFyIGZhY2VJbWcgPSBuZXcgSW1hZ2UoKTsKICAgICAgICAgIGZhY2VJbWcuY3Jvc3NPcmlnaW4gPSBnbG9iYWxQYXJhbXMuY3Jvc3NPcmlnaW4gPyBnbG9iYWxQYXJhbXMuY3Jvc3NPcmlnaW4gOiAnYW5vbnltb3VzJzsKICAgICAgICAgIGZhY2VJbWcuc2lkZSA9IHM7CiAgICAgICAgICBmYWNlSW1nLm9ubG9hZCA9IG9uTG9hZDsKICAgICAgICAgIGZhY2VJbWcub25lcnJvciA9IGluY0xvYWRlZDsgLy8gaWdub3JlIG1pc3NpbmcgZmFjZSB0byBzdXBwb3J0IHBhcnRpYWwgZmFsbGJhY2sgaW1hZ2UKCiAgICAgICAgICBpZiAoaW1hZ2VUeXBlID09ICdtdWx0aXJlcycpIHsKICAgICAgICAgICAgZmFjZUltZy5zcmMgPSBwYXRoLnJlcGxhY2UoJyVzJywgc2lkZXNbc10pICsgJy4nICsgaW1hZ2UuZXh0ZW5zaW9uOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmFjZUltZy5zcmMgPSBpbWFnZVtzXS5zcmM7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmaWxsTWlzc2luZ0ZhY2VzKGZhbGxiYWNrSW1nU2l6ZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKCFnbCkgewogICAgICAgIGNvbnNvbGUubG9nKCdFcnJvcjogbm8gV2ViR0wgc3VwcG9ydCBkZXRlY3RlZCEnKTsKICAgICAgICB0aHJvdyB7CiAgICAgICAgICB0eXBlOiAnbm8gd2ViZ2wnCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgaWYgKGltYWdlVHlwZSA9PSAnY3ViZW1hcCcpIGZpbGxNaXNzaW5nRmFjZXMoY3ViZUltZ1dpZHRoKTsKCiAgICAgIGlmIChpbWFnZS5iYXNlUGF0aCkgewogICAgICAgIGltYWdlLmZ1bGxwYXRoID0gaW1hZ2UuYmFzZVBhdGggKyBpbWFnZS5wYXRoOwogICAgICB9IGVsc2UgewogICAgICAgIGltYWdlLmZ1bGxwYXRoID0gaW1hZ2UucGF0aDsKICAgICAgfQoKICAgICAgaW1hZ2UuaW52VGlsZVJlc29sdXRpb24gPSAxIC8gaW1hZ2UudGlsZVJlc29sdXRpb247CiAgICAgIHZhciB2ZXJ0aWNlcyA9IGNyZWF0ZUN1YmUoKTsKICAgICAgdnRtcHMgPSBbXTsKCiAgICAgIGZvciAocyA9IDA7IHMgPCA2OyBzKyspIHsKICAgICAgICB2dG1wc1tzXSA9IHZlcnRpY2VzLnNsaWNlKHMgKiAxMiwgcyAqIDEyICsgMTIpOwogICAgICAgIHZlcnRpY2VzID0gY3JlYXRlQ3ViZSgpOwogICAgICB9IC8vIE1ha2Ugc3VyZSBpbWFnZSBpc24ndCB0b28gYmlnCgoKICAgICAgdmFyIG1heFdpZHRoID0gMDsKCiAgICAgIGlmIChpbWFnZVR5cGUgPT0gJ2VxdWlyZWN0YW5ndWxhcicpIHsKICAgICAgICBtYXhXaWR0aCA9IGdsLmdldFBhcmFtZXRlcihnbC5NQVhfVEVYVFVSRV9TSVpFKTsKCiAgICAgICAgaWYgKE1hdGgubWF4KGltYWdlLndpZHRoIC8gMiwgaW1hZ2UuaGVpZ2h0KSA+IG1heFdpZHRoKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygnRXJyb3I6IFRoZSBpbWFnZSBpcyB0b28gYmlnOyBpdFwncyAnICsgaW1hZ2Uud2lkdGggKyAncHggd2lkZSwgJyArICdidXQgdGhpcyBkZXZpY2VcJ3MgbWF4aW11bSBzdXBwb3J0ZWQgc2l6ZSBpcyAnICsgbWF4V2lkdGggKiAyICsgJ3B4LicpOwogICAgICAgICAgdGhyb3cgewogICAgICAgICAgICB0eXBlOiAnd2ViZ2wgc2l6ZSBlcnJvcicsCiAgICAgICAgICAgIHdpZHRoOiBpbWFnZS53aWR0aCwKICAgICAgICAgICAgbWF4V2lkdGg6IG1heFdpZHRoICogMgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaW1hZ2VUeXBlID09ICdjdWJlbWFwJykgewogICAgICAgIGlmIChjdWJlSW1nV2lkdGggPiBnbC5nZXRQYXJhbWV0ZXIoZ2wuTUFYX0NVQkVfTUFQX1RFWFRVUkVfU0laRSkpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCdFcnJvcjogVGhlIGltYWdlIGlzIHRvbyBiaWc7IGl0XCdzICcgKyBjdWJlSW1nV2lkdGggKyAncHggd2lkZSwgJyArICdidXQgdGhpcyBkZXZpY2VcJ3MgbWF4aW11bSBzdXBwb3J0ZWQgc2l6ZSBpcyAnICsgbWF4V2lkdGggKyAncHguJyk7CiAgICAgICAgICB0aHJvdyB7CiAgICAgICAgICAgIHR5cGU6ICd3ZWJnbCBzaXplIGVycm9yJywKICAgICAgICAgICAgd2lkdGg6IGN1YmVJbWdXaWR0aCwKICAgICAgICAgICAgbWF4V2lkdGg6IG1heFdpZHRoCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSAvLyBTdG9yZSBob3Jpem9uIHBpdGNoIGFuZCByb2xsIGlmIGFwcGxpY2FibGUKCgogICAgICBpZiAocGFyYW1zICE9PSB1bmRlZmluZWQgJiYgKHBhcmFtcy5ob3Jpem9uUGl0Y2ggIT09IHVuZGVmaW5lZCB8fCBwYXJhbXMuaG9yaXpvblJvbGwgIT09IHVuZGVmaW5lZCkpIHBvc2UgPSBbcGFyYW1zLmhvcml6b25QaXRjaCA9PSB1bmRlZmluZWQgPyAwIDogcGFyYW1zLmhvcml6b25QaXRjaCwgcGFyYW1zLmhvcml6b25Sb2xsID09IHVuZGVmaW5lZCA/IDAgOiBwYXJhbXMuaG9yaXpvblJvbGxdOyAvLyBTZXQgMmQgdGV4dHVyZSBiaW5kaW5nCgogICAgICB2YXIgZ2xCaW5kVHlwZSA9IGdsLlRFWFRVUkVfMkQ7IC8vIENyZWF0ZSB2aWV3cG9ydCBmb3IgZW50aXJlIGNhbnZhcwoKICAgICAgZ2wudmlld3BvcnQoMCwgMCwgZ2wuZHJhd2luZ0J1ZmZlcldpZHRoLCBnbC5kcmF3aW5nQnVmZmVySGVpZ2h0KTsgLy8gQ2hlY2sgcHJlY2lzaW9uIHN1cHBvcnQKCiAgICAgIGlmIChnbC5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQpIHsKICAgICAgICB2YXIgcHJlY2lzaW9uID0gZ2wuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGdsLkZSQUdNRU5UX1NIQURFUiwgZ2wuSElHSF9GTE9BVCk7CgogICAgICAgIGlmIChwcmVjaXNpb24gJiYgcHJlY2lzaW9uLnByZWNpc2lvbiA8IDEpIHsKICAgICAgICAgIC8vIGBoaWdocGAgcHJlY2lzaW9uIG5vdCBzdXBwb3J0ZWQ7IGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8zMzMwODkyNwogICAgICAgICAgZnJhZ0VxdWlDdWJlQmFzZSA9IGZyYWdFcXVpQ3ViZUJhc2UucmVwbGFjZSgnaGlnaHAnLCAnbWVkaXVtcCcpOwogICAgICAgIH0KICAgICAgfSAvLyBDcmVhdGUgdmVydGV4IHNoYWRlcgoKCiAgICAgIHZzID0gZ2wuY3JlYXRlU2hhZGVyKGdsLlZFUlRFWF9TSEFERVIpOwogICAgICB2YXIgdmVydGV4U3JjID0gdjsKCiAgICAgIGlmIChpbWFnZVR5cGUgPT0gJ211bHRpcmVzJykgewogICAgICAgIHZlcnRleFNyYyA9IHZNdWx0aTsKICAgICAgfQoKICAgICAgZ2wuc2hhZGVyU291cmNlKHZzLCB2ZXJ0ZXhTcmMpOwogICAgICBnbC5jb21waWxlU2hhZGVyKHZzKTsgLy8gQ3JlYXRlIGZyYWdtZW50IHNoYWRlcgoKICAgICAgZnMgPSBnbC5jcmVhdGVTaGFkZXIoZ2wuRlJBR01FTlRfU0hBREVSKTsKICAgICAgdmFyIGZyYWdtZW50U3JjID0gZnJhZ0VxdWlyZWN0YW5ndWxhcjsKCiAgICAgIGlmIChpbWFnZVR5cGUgPT0gJ2N1YmVtYXAnKSB7CiAgICAgICAgZ2xCaW5kVHlwZSA9IGdsLlRFWFRVUkVfQ1VCRV9NQVA7CiAgICAgICAgZnJhZ21lbnRTcmMgPSBmcmFnQ3ViZTsKICAgICAgfSBlbHNlIGlmIChpbWFnZVR5cGUgPT0gJ211bHRpcmVzJykgewogICAgICAgIGZyYWdtZW50U3JjID0gZnJhZ011bHRpOwogICAgICB9CgogICAgICBnbC5zaGFkZXJTb3VyY2UoZnMsIGZyYWdtZW50U3JjKTsKICAgICAgZ2wuY29tcGlsZVNoYWRlcihmcyk7IC8vIExpbmsgV2ViR0wgcHJvZ3JhbQoKICAgICAgcHJvZ3JhbSA9IGdsLmNyZWF0ZVByb2dyYW0oKTsKICAgICAgZ2wuYXR0YWNoU2hhZGVyKHByb2dyYW0sIHZzKTsKICAgICAgZ2wuYXR0YWNoU2hhZGVyKHByb2dyYW0sIGZzKTsKICAgICAgZ2wubGlua1Byb2dyYW0ocHJvZ3JhbSk7IC8vIExvZyBlcnJvcnMKCiAgICAgIGlmICghZ2wuZ2V0U2hhZGVyUGFyYW1ldGVyKHZzLCBnbC5DT01QSUxFX1NUQVRVUykpIGNvbnNvbGUubG9nKGdsLmdldFNoYWRlckluZm9Mb2codnMpKTsKICAgICAgaWYgKCFnbC5nZXRTaGFkZXJQYXJhbWV0ZXIoZnMsIGdsLkNPTVBJTEVfU1RBVFVTKSkgY29uc29sZS5sb2coZ2wuZ2V0U2hhZGVySW5mb0xvZyhmcykpOwogICAgICBpZiAoIWdsLmdldFByb2dyYW1QYXJhbWV0ZXIocHJvZ3JhbSwgZ2wuTElOS19TVEFUVVMpKSBjb25zb2xlLmxvZyhnbC5nZXRQcm9ncmFtSW5mb0xvZyhwcm9ncmFtKSk7IC8vIFVzZSBXZWJHTCBwcm9ncmFtCgogICAgICBnbC51c2VQcm9ncmFtKHByb2dyYW0pOwogICAgICBwcm9ncmFtLmRyYXdJblByb2dyZXNzID0gZmFsc2U7IC8vIFNldCBiYWNrZ3JvdW5kIGNsZWFyIGNvbG9yIChkb2VzIG5vdCBhcHBseSB0byBjdWJlbWFwL2ZhbGxiYWNrIGltYWdlKQoKICAgICAgdmFyIGNvbG9yID0gcGFyYW1zLmJhY2tncm91bmRDb2xvciA/IHBhcmFtcy5iYWNrZ3JvdW5kQ29sb3IgOiBbMCwgMCwgMF07CiAgICAgIGdsLmNsZWFyQ29sb3IoY29sb3JbMF0sIGNvbG9yWzFdLCBjb2xvclsyXSwgMS4wKTsKICAgICAgZ2wuY2xlYXIoZ2wuQ09MT1JfQlVGRkVSX0JJVCk7IC8vIExvb2sgdXAgdGV4dHVyZSBjb29yZGluYXRlcyBsb2NhdGlvbgoKICAgICAgcHJvZ3JhbS50ZXhDb29yZExvY2F0aW9uID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24ocHJvZ3JhbSwgJ2FfdGV4Q29vcmQnKTsKICAgICAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkocHJvZ3JhbS50ZXhDb29yZExvY2F0aW9uKTsKCiAgICAgIGlmIChpbWFnZVR5cGUgIT0gJ211bHRpcmVzJykgewogICAgICAgIC8vIFByb3ZpZGUgdGV4dHVyZSBjb29yZGluYXRlcyBmb3IgcmVjdGFuZ2xlCiAgICAgICAgaWYgKCF0ZXhDb29yZEJ1ZmZlcikgdGV4Q29vcmRCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKICAgICAgICBnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgdGV4Q29vcmRCdWZmZXIpOwogICAgICAgIGdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCBuZXcgRmxvYXQzMkFycmF5KFstMSwgMSwgMSwgMSwgMSwgLTEsIC0xLCAxLCAxLCAtMSwgLTEsIC0xXSksIGdsLlNUQVRJQ19EUkFXKTsKICAgICAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHByb2dyYW0udGV4Q29vcmRMb2NhdGlvbiwgMiwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsgLy8gUGFzcyBhc3BlY3QgcmF0aW8KCiAgICAgICAgcHJvZ3JhbS5hc3BlY3RSYXRpbyA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAndV9hc3BlY3RSYXRpbycpOwogICAgICAgIGdsLnVuaWZvcm0xZihwcm9ncmFtLmFzcGVjdFJhdGlvLCBnbC5kcmF3aW5nQnVmZmVyV2lkdGggLyBnbC5kcmF3aW5nQnVmZmVySGVpZ2h0KTsgLy8gTG9jYXRlIHBzaSwgdGhldGEsIGZvY2FsIGxlbmd0aCwgaG9yaXpvbnRhbCBleHRlbnQsIHZlcnRpY2FsIGV4dGVudCwgYW5kIHZlcnRpY2FsIG9mZnNldAoKICAgICAgICBwcm9ncmFtLnBzaSA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAndV9wc2knKTsKICAgICAgICBwcm9ncmFtLnRoZXRhID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICd1X3RoZXRhJyk7CiAgICAgICAgcHJvZ3JhbS5mID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICd1X2YnKTsKICAgICAgICBwcm9ncmFtLmggPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgJ3VfaCcpOwogICAgICAgIHByb2dyYW0udiA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAndV92Jyk7CiAgICAgICAgcHJvZ3JhbS52byA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAndV92bycpOwogICAgICAgIHByb2dyYW0ucm90ID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICd1X3JvdCcpOyAvLyBQYXNzIGhvcml6b250YWwgZXh0ZW50LCB2ZXJ0aWNhbCBleHRlbnQsIGFuZCB2ZXJ0aWNhbCBvZmZzZXQKCiAgICAgICAgZ2wudW5pZm9ybTFmKHByb2dyYW0uaCwgaGFvdiAvIChNYXRoLlBJICogMi4wKSk7CiAgICAgICAgZ2wudW5pZm9ybTFmKHByb2dyYW0udiwgdmFvdiAvIE1hdGguUEkpOwogICAgICAgIGdsLnVuaWZvcm0xZihwcm9ncmFtLnZvLCB2b2Zmc2V0IC8gTWF0aC5QSSAqIDIpOyAvLyBTZXQgYmFja2dyb3VuZCBjb2xvcgoKICAgICAgICBpZiAoaW1hZ2VUeXBlID09ICdlcXVpcmVjdGFuZ3VsYXInKSB7CiAgICAgICAgICBwcm9ncmFtLmJhY2tncm91bmRDb2xvciA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAndV9iYWNrZ3JvdW5kQ29sb3InKTsKICAgICAgICAgIGdsLnVuaWZvcm00ZnYocHJvZ3JhbS5iYWNrZ3JvdW5kQ29sb3IsIGNvbG9yLmNvbmNhdChbMV0pKTsKICAgICAgICB9IC8vIENyZWF0ZSB0ZXh0dXJlCgoKICAgICAgICBwcm9ncmFtLnRleHR1cmUgPSBnbC5jcmVhdGVUZXh0dXJlKCk7CiAgICAgICAgZ2wuYmluZFRleHR1cmUoZ2xCaW5kVHlwZSwgcHJvZ3JhbS50ZXh0dXJlKTsgLy8gVXBsb2FkIGltYWdlcyB0byB0ZXh0dXJlIGRlcGVuZGluZyBvbiB0eXBlCgogICAgICAgIGlmIChpbWFnZVR5cGUgPT0gJ2N1YmVtYXAnKSB7CiAgICAgICAgICAvLyBMb2FkIGFsbCBzaXggc2lkZXMgb2YgdGhlIGN1YmUgbWFwCiAgICAgICAgICBnbC50ZXhJbWFnZTJEKGdsLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCwgMCwgZ2wuUkdCLCBnbC5SR0IsIGdsLlVOU0lHTkVEX0JZVEUsIGltYWdlWzFdKTsKICAgICAgICAgIGdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV9DVUJFX01BUF9ORUdBVElWRV9YLCAwLCBnbC5SR0IsIGdsLlJHQiwgZ2wuVU5TSUdORURfQllURSwgaW1hZ2VbM10pOwogICAgICAgICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1ksIDAsIGdsLlJHQiwgZ2wuUkdCLCBnbC5VTlNJR05FRF9CWVRFLCBpbWFnZVs0XSk7CiAgICAgICAgICBnbC50ZXhJbWFnZTJEKGdsLlRFWFRVUkVfQ1VCRV9NQVBfTkVHQVRJVkVfWSwgMCwgZ2wuUkdCLCBnbC5SR0IsIGdsLlVOU0lHTkVEX0JZVEUsIGltYWdlWzVdKTsKICAgICAgICAgIGdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9aLCAwLCBnbC5SR0IsIGdsLlJHQiwgZ2wuVU5TSUdORURfQllURSwgaW1hZ2VbMF0pOwogICAgICAgICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFX0NVQkVfTUFQX05FR0FUSVZFX1osIDAsIGdsLlJHQiwgZ2wuUkdCLCBnbC5VTlNJR05FRF9CWVRFLCBpbWFnZVsyXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpbWFnZS53aWR0aCA8PSBtYXhXaWR0aCkgewogICAgICAgICAgICBnbC51bmlmb3JtMWkoZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICd1X3NwbGl0SW1hZ2UnKSwgMCk7IC8vIFVwbG9hZCBpbWFnZSB0byB0aGUgdGV4dHVyZQoKICAgICAgICAgICAgZ2wudGV4SW1hZ2UyRChnbEJpbmRUeXBlLCAwLCBnbC5SR0IsIGdsLlJHQiwgZ2wuVU5TSUdORURfQllURSwgaW1hZ2UpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gSW1hZ2UgbmVlZHMgdG8gYmUgc3BsaXQgaW50byB0d28gcGFydHMgZHVlIHRvIHRleHR1cmUgc2l6ZSBsaW1pdHMKICAgICAgICAgICAgZ2wudW5pZm9ybTFpKGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAndV9zcGxpdEltYWdlJyksIDEpOyAvLyBEcmF3IGltYWdlIG9uIGNhbnZhcwoKICAgICAgICAgICAgdmFyIGNyb3BDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICAgICAgY3JvcENhbnZhcy53aWR0aCA9IGltYWdlLndpZHRoIC8gMjsKICAgICAgICAgICAgY3JvcENhbnZhcy5oZWlnaHQgPSBpbWFnZS5oZWlnaHQ7CiAgICAgICAgICAgIHZhciBjcm9wQ29udGV4dCA9IGNyb3BDYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgY3JvcENvbnRleHQuZHJhd0ltYWdlKGltYWdlLCAwLCAwKTsgLy8gVXBsb2FkIGZpcnN0IGhhbGYgb2YgaW1hZ2UgdG8gdGhlIHRleHR1cmUKCiAgICAgICAgICAgIHZhciBjcm9wSW1hZ2UgPSBjcm9wQ29udGV4dC5nZXRJbWFnZURhdGEoMCwgMCwgaW1hZ2Uud2lkdGggLyAyLCBpbWFnZS5oZWlnaHQpOwogICAgICAgICAgICBnbC50ZXhJbWFnZTJEKGdsQmluZFR5cGUsIDAsIGdsLlJHQiwgZ2wuUkdCLCBnbC5VTlNJR05FRF9CWVRFLCBjcm9wSW1hZ2UpOyAvLyBDcmVhdGUgYW5kIGJpbmQgdGV4dHVyZSBmb3Igc2Vjb25kIGhhbGYgb2YgaW1hZ2UKCiAgICAgICAgICAgIHByb2dyYW0udGV4dHVyZTIgPSBnbC5jcmVhdGVUZXh0dXJlKCk7CiAgICAgICAgICAgIGdsLmFjdGl2ZVRleHR1cmUoZ2wuVEVYVFVSRTEpOwogICAgICAgICAgICBnbC5iaW5kVGV4dHVyZShnbEJpbmRUeXBlLCBwcm9ncmFtLnRleHR1cmUyKTsKICAgICAgICAgICAgZ2wudW5pZm9ybTFpKGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAndV9pbWFnZTEnKSwgMSk7IC8vIFVwbG9hZCBzZWNvbmQgaGFsZiBvZiBpbWFnZSB0byB0aGUgdGV4dHVyZQoKICAgICAgICAgICAgY3JvcENvbnRleHQuZHJhd0ltYWdlKGltYWdlLCAtaW1hZ2Uud2lkdGggLyAyLCAwKTsKICAgICAgICAgICAgY3JvcEltYWdlID0gY3JvcENvbnRleHQuZ2V0SW1hZ2VEYXRhKDAsIDAsIGltYWdlLndpZHRoIC8gMiwgaW1hZ2UuaGVpZ2h0KTsKICAgICAgICAgICAgZ2wudGV4SW1hZ2UyRChnbEJpbmRUeXBlLCAwLCBnbC5SR0IsIGdsLlJHQiwgZ2wuVU5TSUdORURfQllURSwgY3JvcEltYWdlKTsgLy8gU2V0IHBhcmFtZXRlcnMgZm9yIHJlbmRlcmluZyBhbnkgc2l6ZQoKICAgICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaShnbEJpbmRUeXBlLCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSk7CiAgICAgICAgICAgIGdsLnRleFBhcmFtZXRlcmkoZ2xCaW5kVHlwZSwgZ2wuVEVYVFVSRV9XUkFQX1QsIGdsLkNMQU1QX1RPX0VER0UpOwogICAgICAgICAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsQmluZFR5cGUsIGdsLlRFWFRVUkVfTUlOX0ZJTFRFUiwgZ2wuTElORUFSKTsKICAgICAgICAgICAgZ2wudGV4UGFyYW1ldGVyaShnbEJpbmRUeXBlLCBnbC5URVhUVVJFX01BR19GSUxURVIsIGdsLkxJTkVBUik7IC8vIFJlYWN0aXZhdGUgZmlyc3QgdGV4dHVyZSB1bml0CgogICAgICAgICAgICBnbC5hY3RpdmVUZXh0dXJlKGdsLlRFWFRVUkUwKTsKICAgICAgICAgIH0KICAgICAgICB9IC8vIFNldCBwYXJhbWV0ZXJzIGZvciByZW5kZXJpbmcgYW55IHNpemUKCgogICAgICAgIGdsLnRleFBhcmFtZXRlcmkoZ2xCaW5kVHlwZSwgZ2wuVEVYVFVSRV9XUkFQX1MsIGdsLkNMQU1QX1RPX0VER0UpOwogICAgICAgIGdsLnRleFBhcmFtZXRlcmkoZ2xCaW5kVHlwZSwgZ2wuVEVYVFVSRV9XUkFQX1QsIGdsLkNMQU1QX1RPX0VER0UpOwogICAgICAgIGdsLnRleFBhcmFtZXRlcmkoZ2xCaW5kVHlwZSwgZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBnbC5MSU5FQVIpOwogICAgICAgIGdsLnRleFBhcmFtZXRlcmkoZ2xCaW5kVHlwZSwgZ2wuVEVYVFVSRV9NQUdfRklMVEVSLCBnbC5MSU5FQVIpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIExvb2sgdXAgdmVydGV4IGNvb3JkaW5hdGVzIGxvY2F0aW9uCiAgICAgICAgcHJvZ3JhbS52ZXJ0UG9zTG9jYXRpb24gPSBnbC5nZXRBdHRyaWJMb2NhdGlvbihwcm9ncmFtLCAnYV92ZXJ0Q29vcmQnKTsKICAgICAgICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShwcm9ncmFtLnZlcnRQb3NMb2NhdGlvbik7IC8vIENyZWF0ZSBidWZmZXJzCgogICAgICAgIGlmICghY3ViZVZlcnRCdWYpIGN1YmVWZXJ0QnVmID0gZ2wuY3JlYXRlQnVmZmVyKCk7CiAgICAgICAgaWYgKCFjdWJlVmVydFRleENvb3JkQnVmKSBjdWJlVmVydFRleENvb3JkQnVmID0gZ2wuY3JlYXRlQnVmZmVyKCk7CiAgICAgICAgaWYgKCFjdWJlVmVydEluZEJ1ZikgY3ViZVZlcnRJbmRCdWYgPSBnbC5jcmVhdGVCdWZmZXIoKTsgLy8gQmluZCB0ZXh0dXJlIGNvb3JkaW5hdGUgYnVmZmVyIGFuZCBwYXNzIGNvb3JkaW5hdGVzIHRvIFdlYkdMCgogICAgICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBjdWJlVmVydFRleENvb3JkQnVmKTsKICAgICAgICBnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgbmV3IEZsb2F0MzJBcnJheShbMCwgMCwgMSwgMCwgMSwgMSwgMCwgMV0pLCBnbC5TVEFUSUNfRFJBVyk7IC8vIEJpbmQgc3F1YXJlIGluZGV4IGJ1ZmZlciBhbmQgcGFzcyBpbmRpY2llcyB0byBXZWJHTAoKICAgICAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBjdWJlVmVydEluZEJ1Zik7CiAgICAgICAgZ2wuYnVmZmVyRGF0YShnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgbmV3IFVpbnQxNkFycmF5KFswLCAxLCAyLCAwLCAyLCAzXSksIGdsLlNUQVRJQ19EUkFXKTsgLy8gRmluZCB1bmlmb3JtcwoKICAgICAgICBwcm9ncmFtLnBlcnNwVW5pZm9ybSA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAndV9wZXJzcE1hdHJpeCcpOwogICAgICAgIHByb2dyYW0uY3ViZVVuaWZvcm0gPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgJ3VfY3ViZU1hdHJpeCcpOyAvL3Byb2dyYW0uY29sb3JVbmlmb3JtID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICd1X2NvbG9yJyk7CgogICAgICAgIHByb2dyYW0ubGV2ZWwgPSAtMTsKICAgICAgICBwcm9ncmFtLmN1cnJlbnROb2RlcyA9IFtdOwogICAgICAgIHByb2dyYW0ubm9kZUNhY2hlID0gW107CiAgICAgICAgcHJvZ3JhbS5ub2RlQ2FjaGVUaW1lc3RhbXAgPSAwOwogICAgICB9IC8vIENoZWNrIGlmIHRoZXJlIHdhcyBhbiBlcnJvcgoKCiAgICAgIHZhciBlcnIgPSBnbC5nZXRFcnJvcigpOwoKICAgICAgaWYgKGVyciAhPT0gMCkgewogICAgICAgIGNvbnNvbGUubG9nKCdFcnJvcjogU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2l0aCBXZWJHTCEnLCBlcnIpOwogICAgICAgIHRocm93IHsKICAgICAgICAgIHR5cGU6ICd3ZWJnbCBlcnJvcicKICAgICAgICB9OwogICAgICB9CgogICAgICBjYWxsYmFjaygpOwogICAgfTsKICAgIC8qKg0KICAgICAqIERlc3Ryb3kgcmVuZGVyZXIuDQogICAgICogQG1lbWJlcm9mIFJlbmRlcmVyDQogICAgICogQGluc3RhbmNlDQogICAgICovCgoKICAgIHRoaXMuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGNvbnRhaW5lciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKGNhbnZhcyAhPT0gdW5kZWZpbmVkICYmIGNvbnRhaW5lci5jb250YWlucyhjYW52YXMpKSB7CiAgICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoY2FudmFzKTsKICAgICAgICB9CgogICAgICAgIGlmICh3b3JsZCAhPT0gdW5kZWZpbmVkICYmIGNvbnRhaW5lci5jb250YWlucyh3b3JsZCkpIHsKICAgICAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZCh3b3JsZCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoZ2wpIHsKICAgICAgICAvLyBUaGUgc3BlYyBzYXlzIHRoaXMgaXMgb25seSBzdXBwb3NlZCB0byBzaW11bGF0ZSBsb3NpbmcgdGhlIFdlYkdMCiAgICAgICAgLy8gY29udGV4dCwgYnV0IGluIHByYWN0aWNlIGl0IHRlbmRzIHRvIGFjdHVhbGx5IGZyZWUgdGhlIG1lbW9yeS4KICAgICAgICB2YXIgZXh0ZW5zaW9uID0gZ2wuZ2V0RXh0ZW5zaW9uKCdXRUJHTF9sb3NlX2NvbnRleHQnKTsKICAgICAgICBpZiAoZXh0ZW5zaW9uKSBleHRlbnNpb24ubG9zZUNvbnRleHQoKTsKICAgICAgfQogICAgfTsKICAgIC8qKg0KICAgICAqIFJlc2l6ZSByZW5kZXJlciAoY2FsbCBhZnRlciByZXNpemluZyBjb250YWluZXIpLg0KICAgICAqIEBtZW1iZXJvZiBSZW5kZXJlcg0KICAgICAqIEBpbnN0YW5jZQ0KICAgICAqLwoKCiAgICB0aGlzLnJlc2l6ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHBpeGVsUmF0aW8gPSB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyB8fCAxOwogICAgICBjYW52YXMud2lkdGggPSBjYW52YXMuY2xpZW50V2lkdGggKiBwaXhlbFJhdGlvOwogICAgICBjYW52YXMuaGVpZ2h0ID0gY2FudmFzLmNsaWVudEhlaWdodCAqIHBpeGVsUmF0aW87CgogICAgICBpZiAoZ2wpIHsKICAgICAgICBpZiAoZ2wuZ2V0RXJyb3IoKSA9PSAxMjg2KSBoYW5kbGVXZWJHTEVycm9yMTI4NigpOwogICAgICAgIGdsLnZpZXdwb3J0KDAsIDAsIGdsLmRyYXdpbmdCdWZmZXJXaWR0aCwgZ2wuZHJhd2luZ0J1ZmZlckhlaWdodCk7CgogICAgICAgIGlmIChpbWFnZVR5cGUgIT0gJ211bHRpcmVzJykgewogICAgICAgICAgZ2wudW5pZm9ybTFmKHByb2dyYW0uYXNwZWN0UmF0aW8sIGNhbnZhcy5jbGllbnRXaWR0aCAvIGNhbnZhcy5jbGllbnRIZWlnaHQpOwogICAgICAgIH0KICAgICAgfQogICAgfTsgLy8gSW5pdGlhbGl6ZSBjYW52YXMgc2l6ZQoKCiAgICB0aGlzLnJlc2l6ZSgpOwogICAgLyoqDQogICAgICogU2V0IHJlbmRlcmVyIGhvcml6b24gcGl0Y2ggYW5kIHJvbGwuDQogICAgICogQG1lbWJlcm9mIFJlbmRlcmVyDQogICAgICogQGluc3RhbmNlDQogICAgICovCgogICAgdGhpcy5zZXRQb3NlID0gZnVuY3Rpb24gKGhvcml6b25QaXRjaCwgaG9yaXpvblJvbGwpIHsKICAgICAgcG9zZSA9IFtob3Jpem9uUGl0Y2gsIGhvcml6b25Sb2xsXTsKICAgIH07CiAgICAvKioNCiAgICAgKiBSZW5kZXIgbmV3IHZpZXcgb2YgcGFub3JhbWEuDQogICAgICogQG1lbWJlcm9mIFJlbmRlcmVyDQogICAgICogQGluc3RhbmNlDQogICAgICogQHBhcmFtIHtudW1iZXJ9IHBpdGNoIC0gUGl0Y2ggdG8gcmVuZGVyIGF0IChpbiByYWRpYW5zKS4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0geWF3IC0gWWF3IHRvIHJlbmRlciBhdCAoaW4gcmFkaWFucykuDQogICAgICogQHBhcmFtIHtudW1iZXJ9IGhmb3YgLSBIb3Jpem9udGFsIGZpZWxkIG9mIHZpZXcgdG8gcmVuZGVyIHdpdGggKGluIHJhZGlhbnMpLg0KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbcGFyYW1zXSAtIEV4dHJhIGNvbmZpZ3VyYXRpb24gcGFyYW1ldGVycy4gDQogICAgICogQHBhcmFtIHtudW1iZXJ9IFtwYXJhbXMucm9sbF0gLSBDYW1lcmEgcm9sbCAoaW4gcmFkaWFucykuDQogICAgICogQHBhcmFtIHtib29sZWFufSBbcGFyYW1zLnJldHVybkltYWdlXSAtIFJldHVybiByZW5kZXJlZCBpbWFnZT8NCiAgICAgKi8KCgogICAgdGhpcy5yZW5kZXIgPSBmdW5jdGlvbiAocGl0Y2gsIHlhdywgaGZvdiwgcGFyYW1zKSB7CiAgICAgIHZhciBmb2NhbCwKICAgICAgICAgIGksCiAgICAgICAgICBzLAogICAgICAgICAgcm9sbCA9IDA7CiAgICAgIGlmIChwYXJhbXMgPT09IHVuZGVmaW5lZCkgcGFyYW1zID0ge307CiAgICAgIGlmIChwYXJhbXMucm9sbCkgcm9sbCA9IHBhcmFtcy5yb2xsOyAvLyBBcHBseSBwaXRjaCBhbmQgcm9sbCB0cmFuc2Zvcm1hdGlvbiBpZiBhcHBsaWNhYmxlCgogICAgICBpZiAocG9zZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdmFyIGhvcml6b25QaXRjaCA9IHBvc2VbMF0sCiAgICAgICAgICAgIGhvcml6b25Sb2xsID0gcG9zZVsxXTsgLy8gQ2FsY3VsYXRlIG5ldyBwaXRjaCBhbmQgeWF3CgogICAgICAgIHZhciBvcmlnX3BpdGNoID0gcGl0Y2gsCiAgICAgICAgICAgIG9yaWdfeWF3ID0geWF3LAogICAgICAgICAgICB4ID0gTWF0aC5jb3MoaG9yaXpvblJvbGwpICogTWF0aC5zaW4ocGl0Y2gpICogTWF0aC5zaW4oaG9yaXpvblBpdGNoKSArIE1hdGguY29zKHBpdGNoKSAqIChNYXRoLmNvcyhob3Jpem9uUGl0Y2gpICogTWF0aC5jb3MoeWF3KSArIE1hdGguc2luKGhvcml6b25Sb2xsKSAqIE1hdGguc2luKGhvcml6b25QaXRjaCkgKiBNYXRoLnNpbih5YXcpKSwKICAgICAgICAgICAgeSA9IC1NYXRoLnNpbihwaXRjaCkgKiBNYXRoLnNpbihob3Jpem9uUm9sbCkgKyBNYXRoLmNvcyhwaXRjaCkgKiBNYXRoLmNvcyhob3Jpem9uUm9sbCkgKiBNYXRoLnNpbih5YXcpLAogICAgICAgICAgICB6ID0gTWF0aC5jb3MoaG9yaXpvblJvbGwpICogTWF0aC5jb3MoaG9yaXpvblBpdGNoKSAqIE1hdGguc2luKHBpdGNoKSArIE1hdGguY29zKHBpdGNoKSAqICgtTWF0aC5jb3MoeWF3KSAqIE1hdGguc2luKGhvcml6b25QaXRjaCkgKyBNYXRoLmNvcyhob3Jpem9uUGl0Y2gpICogTWF0aC5zaW4oaG9yaXpvblJvbGwpICogTWF0aC5zaW4oeWF3KSk7CiAgICAgICAgcGl0Y2ggPSBNYXRoLmFzaW4oTWF0aC5tYXgoTWF0aC5taW4oeiwgMSksIC0xKSk7CiAgICAgICAgeWF3ID0gTWF0aC5hdGFuMih5LCB4KTsgLy8gQ2FsY3VsYXRlIHJvbGwKCiAgICAgICAgdmFyIHYgPSBbTWF0aC5jb3Mob3JpZ19waXRjaCkgKiAoTWF0aC5zaW4oaG9yaXpvblJvbGwpICogTWF0aC5zaW4oaG9yaXpvblBpdGNoKSAqIE1hdGguY29zKG9yaWdfeWF3KSAtIE1hdGguY29zKGhvcml6b25QaXRjaCkgKiBNYXRoLnNpbihvcmlnX3lhdykpLCBNYXRoLmNvcyhvcmlnX3BpdGNoKSAqIE1hdGguY29zKGhvcml6b25Sb2xsKSAqIE1hdGguY29zKG9yaWdfeWF3KSwgTWF0aC5jb3Mob3JpZ19waXRjaCkgKiAoTWF0aC5jb3MoaG9yaXpvblBpdGNoKSAqIE1hdGguc2luKGhvcml6b25Sb2xsKSAqIE1hdGguY29zKG9yaWdfeWF3KSArIE1hdGguc2luKG9yaWdfeWF3KSAqIE1hdGguc2luKGhvcml6b25QaXRjaCkpXSwKICAgICAgICAgICAgdyA9IFstTWF0aC5jb3MocGl0Y2gpICogTWF0aC5zaW4oeWF3KSwgTWF0aC5jb3MocGl0Y2gpICogTWF0aC5jb3MoeWF3KV07CiAgICAgICAgdmFyIHJvbGxfYWRqID0gTWF0aC5hY29zKE1hdGgubWF4KE1hdGgubWluKCh2WzBdICogd1swXSArIHZbMV0gKiB3WzFdKSAvIChNYXRoLnNxcnQodlswXSAqIHZbMF0gKyB2WzFdICogdlsxXSArIHZbMl0gKiB2WzJdKSAqIE1hdGguc3FydCh3WzBdICogd1swXSArIHdbMV0gKiB3WzFdKSksIDEpLCAtMSkpOwogICAgICAgIGlmICh2WzJdIDwgMCkgcm9sbF9hZGogPSAyICogTWF0aC5QSSAtIHJvbGxfYWRqOwogICAgICAgIHJvbGwgKz0gcm9sbF9hZGo7CiAgICAgIH0gLy8gSWYgbm8gV2ViR0wKCgogICAgICBpZiAoIWdsICYmIChpbWFnZVR5cGUgPT0gJ211bHRpcmVzJyB8fCBpbWFnZVR5cGUgPT0gJ2N1YmVtYXAnKSkgewogICAgICAgIC8vIERldGVybWluZSBmYWNlIHRyYW5zZm9ybXMKICAgICAgICBzID0gZmFsbGJhY2tJbWdTaXplIC8gMjsKICAgICAgICB2YXIgdHJhbnNmb3JtcyA9IHsKICAgICAgICAgIGY6ICd0cmFuc2xhdGUzZCgtJyArIChzICsgMikgKyAncHgsIC0nICsgKHMgKyAyKSArICdweCwgLScgKyBzICsgJ3B4KScsCiAgICAgICAgICBiOiAndHJhbnNsYXRlM2QoJyArIChzICsgMikgKyAncHgsIC0nICsgKHMgKyAyKSArICdweCwgJyArIHMgKyAncHgpIHJvdGF0ZVgoMTgwZGVnKSByb3RhdGVaKDE4MGRlZyknLAogICAgICAgICAgdTogJ3RyYW5zbGF0ZTNkKC0nICsgKHMgKyAyKSArICdweCwgLScgKyBzICsgJ3B4LCAnICsgKHMgKyAyKSArICdweCkgcm90YXRlWCgyNzBkZWcpJywKICAgICAgICAgIGQ6ICd0cmFuc2xhdGUzZCgtJyArIChzICsgMikgKyAncHgsICcgKyBzICsgJ3B4LCAtJyArIChzICsgMikgKyAncHgpIHJvdGF0ZVgoOTBkZWcpJywKICAgICAgICAgIGw6ICd0cmFuc2xhdGUzZCgtJyArIHMgKyAncHgsIC0nICsgKHMgKyAyKSArICdweCwgJyArIChzICsgMikgKyAncHgpIHJvdGF0ZVgoMTgwZGVnKSByb3RhdGVZKDkwZGVnKSByb3RhdGVaKDE4MGRlZyknLAogICAgICAgICAgcjogJ3RyYW5zbGF0ZTNkKCcgKyBzICsgJ3B4LCAtJyArIChzICsgMikgKyAncHgsIC0nICsgKHMgKyAyKSArICdweCkgcm90YXRlWSgyNzBkZWcpJwogICAgICAgIH07CiAgICAgICAgZm9jYWwgPSAxIC8gTWF0aC50YW4oaGZvdiAvIDIpOwogICAgICAgIHZhciB6b29tID0gZm9jYWwgKiBjYW52YXMuY2xpZW50V2lkdGggLyAyICsgJ3B4JzsKICAgICAgICB2YXIgdHJhbnNmb3JtID0gJ3BlcnNwZWN0aXZlKCcgKyB6b29tICsgJykgdHJhbnNsYXRlWignICsgem9vbSArICcpIHJvdGF0ZVgoJyArIHBpdGNoICsgJ3JhZCkgcm90YXRlWSgnICsgeWF3ICsgJ3JhZCkgJzsgLy8gQXBwbHkgZmFjZSB0cmFuc2Zvcm1zCgogICAgICAgIHZhciBmYWNlcyA9IE9iamVjdC5rZXlzKHRyYW5zZm9ybXMpOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgNjsgaSsrKSB7CiAgICAgICAgICB2YXIgZmFjZSA9IHdvcmxkLnF1ZXJ5U2VsZWN0b3IoJy5wbmxtLScgKyBmYWNlc1tpXSArICdmYWNlJyk7CiAgICAgICAgICBpZiAoIWZhY2UpIGNvbnRpbnVlOyAvLyBpZ25vcmUgbWlzc2luZyBmYWNlIHRvIHN1cHBvcnQgcGFydGlhbCBjdWJlbWFwL2ZhbGxiYWNrIGltYWdlCgogICAgICAgICAgZmFjZS5zdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSB0cmFuc2Zvcm0gKyB0cmFuc2Zvcm1zW2ZhY2VzW2ldXTsKICAgICAgICAgIGZhY2Uuc3R5bGUudHJhbnNmb3JtID0gdHJhbnNmb3JtICsgdHJhbnNmb3Jtc1tmYWNlc1tpXV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChpbWFnZVR5cGUgIT0gJ211bHRpcmVzJykgewogICAgICAgIC8vIENhbGN1bGF0ZSBmb2NhbCBsZW5ndGggZnJvbSB2ZXJ0aWNhbCBmaWVsZCBvZiB2aWV3CiAgICAgICAgdmFyIHZmb3YgPSAyICogTWF0aC5hdGFuKE1hdGgudGFuKGhmb3YgKiAwLjUpIC8gKGdsLmRyYXdpbmdCdWZmZXJXaWR0aCAvIGdsLmRyYXdpbmdCdWZmZXJIZWlnaHQpKTsKICAgICAgICBmb2NhbCA9IDEgLyBNYXRoLnRhbih2Zm92ICogMC41KTsgLy8gUGFzcyBwc2ksIHRoZXRhLCByb2xsLCBhbmQgZm9jYWwgbGVuZ3RoCgogICAgICAgIGdsLnVuaWZvcm0xZihwcm9ncmFtLnBzaSwgeWF3KTsKICAgICAgICBnbC51bmlmb3JtMWYocHJvZ3JhbS50aGV0YSwgcGl0Y2gpOwogICAgICAgIGdsLnVuaWZvcm0xZihwcm9ncmFtLnJvdCwgcm9sbCk7CiAgICAgICAgZ2wudW5pZm9ybTFmKHByb2dyYW0uZiwgZm9jYWwpOwoKICAgICAgICBpZiAoZHluYW1pYyA9PT0gdHJ1ZSkgewogICAgICAgICAgLy8gVXBkYXRlIHRleHR1cmUgaWYgZHluYW1pYwogICAgICAgICAgaWYgKGltYWdlVHlwZSA9PSAnZXF1aXJlY3Rhbmd1bGFyJykgewogICAgICAgICAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCBwcm9ncmFtLnRleHR1cmUpOwogICAgICAgICAgICBnbC50ZXhJbWFnZTJEKGdsLlRFWFRVUkVfMkQsIDAsIGdsLlJHQiwgZ2wuUkdCLCBnbC5VTlNJR05FRF9CWVRFLCBpbWFnZSk7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBEcmF3IHVzaW5nIGN1cnJlbnQgYnVmZmVyCgoKICAgICAgICBnbC5kcmF3QXJyYXlzKGdsLlRSSUFOR0xFUywgMCwgNik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQ3JlYXRlIHBlcnNwZWN0aXZlIG1hdHJpeAogICAgICAgIHZhciBwZXJzcE1hdHJpeCA9IG1ha2VQZXJzcChoZm92LCBnbC5kcmF3aW5nQnVmZmVyV2lkdGggLyBnbC5kcmF3aW5nQnVmZmVySGVpZ2h0LCAwLjEsIDEwMC4wKTsgLy8gRmluZCBjb3JyZWN0IHpvb20gbGV2ZWwKCiAgICAgICAgY2hlY2tab29tKGhmb3YpOyAvLyBDcmVhdGUgcm90YXRpb24gbWF0cml4CgogICAgICAgIHZhciBtYXRyaXggPSBpZGVudGl0eU1hdHJpeDMoKTsKICAgICAgICBtYXRyaXggPSByb3RhdGVNYXRyaXgobWF0cml4LCAtcm9sbCwgJ3onKTsKICAgICAgICBtYXRyaXggPSByb3RhdGVNYXRyaXgobWF0cml4LCAtcGl0Y2gsICd4Jyk7CiAgICAgICAgbWF0cml4ID0gcm90YXRlTWF0cml4KG1hdHJpeCwgeWF3LCAneScpOwogICAgICAgIG1hdHJpeCA9IG1ha2VNYXRyaXg0KG1hdHJpeCk7IC8vIFNldCBtYXRyaXggdW5pZm9ybXMKCiAgICAgICAgZ2wudW5pZm9ybU1hdHJpeDRmdihwcm9ncmFtLnBlcnNwVW5pZm9ybSwgZmFsc2UsIG5ldyBGbG9hdDMyQXJyYXkodHJhbnNwb3NlTWF0cml4NChwZXJzcE1hdHJpeCkpKTsKICAgICAgICBnbC51bmlmb3JtTWF0cml4NGZ2KHByb2dyYW0uY3ViZVVuaWZvcm0sIGZhbHNlLCBuZXcgRmxvYXQzMkFycmF5KHRyYW5zcG9zZU1hdHJpeDQobWF0cml4KSkpOyAvLyBGaW5kIGN1cnJlbnQgbm9kZXMKCiAgICAgICAgdmFyIHJvdFBlcnNwID0gcm90YXRlUGVyc3AocGVyc3BNYXRyaXgsIG1hdHJpeCk7CiAgICAgICAgcHJvZ3JhbS5ub2RlQ2FjaGUuc29ydChtdWx0aXJlc05vZGVTb3J0KTsKCiAgICAgICAgaWYgKHByb2dyYW0ubm9kZUNhY2hlLmxlbmd0aCA+IDIwMCAmJiBwcm9ncmFtLm5vZGVDYWNoZS5sZW5ndGggPiBwcm9ncmFtLmN1cnJlbnROb2Rlcy5sZW5ndGggKyA1MCkgewogICAgICAgICAgLy8gUmVtb3ZlIG9sZGVyIG5vZGVzIGZyb20gY2FjaGUKICAgICAgICAgIHZhciByZW1vdmVkID0gcHJvZ3JhbS5ub2RlQ2FjaGUuc3BsaWNlKDIwMCwgcHJvZ3JhbS5ub2RlQ2FjaGUubGVuZ3RoIC0gMjAwKTsKCiAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJlbW92ZWQubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgLy8gRXhwbGljaXRseSBkZWxldGUgdGV4dHVyZXMKICAgICAgICAgICAgZ2wuZGVsZXRlVGV4dHVyZShyZW1vdmVkW2pdLnRleHR1cmUpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcHJvZ3JhbS5jdXJyZW50Tm9kZXMgPSBbXTsKICAgICAgICB2YXIgc2lkZXMgPSBbJ2YnLCAnYicsICd1JywgJ2QnLCAnbCcsICdyJ107CgogICAgICAgIGZvciAocyA9IDA7IHMgPCA2OyBzKyspIHsKICAgICAgICAgIHZhciBudG1wID0gbmV3IE11bHRpcmVzTm9kZSh2dG1wc1tzXSwgc2lkZXNbc10sIDEsIDAsIDAsIGltYWdlLmZ1bGxwYXRoKTsKICAgICAgICAgIHRlc3RNdWx0aXJlc05vZGUocm90UGVyc3AsIG50bXAsIHBpdGNoLCB5YXcsIGhmb3YpOwogICAgICAgIH0KCiAgICAgICAgcHJvZ3JhbS5jdXJyZW50Tm9kZXMuc29ydChtdWx0aXJlc05vZGVSZW5kZXJTb3J0KTsgLy8gVW5xdWV1ZSBhbnkgcGVuZGluZyByZXF1ZXN0cyBmb3Igbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIHZpc2libGUKCiAgICAgICAgZm9yIChpID0gcGVuZGluZ1RleHR1cmVSZXF1ZXN0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgaWYgKHByb2dyYW0uY3VycmVudE5vZGVzLmluZGV4T2YocGVuZGluZ1RleHR1cmVSZXF1ZXN0c1tpXS5ub2RlKSA9PT0gLTEpIHsKICAgICAgICAgICAgcGVuZGluZ1RleHR1cmVSZXF1ZXN0c1tpXS5ub2RlLnRleHR1cmVMb2FkID0gZmFsc2U7CiAgICAgICAgICAgIHBlbmRpbmdUZXh0dXJlUmVxdWVzdHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgfQogICAgICAgIH0gLy8gQWxsb3cgb25lIHJlcXVlc3QgdG8gYmUgcGVuZGluZywgc28gdGhhdCB3ZSBjYW4gY3JlYXRlIGEgdGV4dHVyZSBidWZmZXIgZm9yIHRoYXQgaW4gYWR2YW5jZSBvZiBsb2FkaW5nIGFjdHVhbGx5IGJlZ2lubmluZwoKCiAgICAgICAgaWYgKHBlbmRpbmdUZXh0dXJlUmVxdWVzdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHJvZ3JhbS5jdXJyZW50Tm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBwcm9ncmFtLmN1cnJlbnROb2Rlc1tpXTsKCiAgICAgICAgICAgIGlmICghbm9kZS50ZXh0dXJlICYmICFub2RlLnRleHR1cmVMb2FkKSB7CiAgICAgICAgICAgICAgbm9kZS50ZXh0dXJlTG9hZCA9IHRydWU7CiAgICAgICAgICAgICAgc2V0VGltZW91dChwcm9jZXNzTmV4dFRpbGUsIDAsIG5vZGUpOyAvLyBPbmx5IHByb2Nlc3Mgb25lIHRpbGUgcGVyIGZyYW1lIHRvIGltcHJvdmUgcmVzcG9uc2l2ZW5lc3MKCiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IC8vIERyYXcgdGlsZXMKCgogICAgICAgIG11bHRpcmVzRHJhdygpOwogICAgICB9CgogICAgICBpZiAocGFyYW1zLnJldHVybkltYWdlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gY2FudmFzLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyk7CiAgICAgIH0KICAgIH07CiAgICAvKioNCiAgICAgKiBDaGVjayBpZiBpbWFnZXMgYXJlIGxvYWRpbmcuDQogICAgICogQG1lbWJlcm9mIFJlbmRlcmVyDQogICAgICogQGluc3RhbmNlDQogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgb3Igbm90IGltYWdlcyBhcmUgbG9hZGluZy4NCiAgICAgKi8KCgogICAgdGhpcy5pc0xvYWRpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChnbCAmJiBpbWFnZVR5cGUgPT0gJ211bHRpcmVzJykgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvZ3JhbS5jdXJyZW50Tm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICghcHJvZ3JhbS5jdXJyZW50Tm9kZXNbaV0udGV4dHVyZUxvYWRlZCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CiAgICAvKioNCiAgICAgKiBSZXRyaWV2ZSByZW5kZXJlcidzIGNhbnZhcy4NCiAgICAgKiBAbWVtYmVyb2YgUmVuZGVyZXINCiAgICAgKiBAaW5zdGFuY2UNCiAgICAgKiBAcmV0dXJucyB7SFRNTEVsZW1lbnR9IFJlbmRlcmVyJ3MgY2FudmFzLg0KICAgICAqLwoKCiAgICB0aGlzLmdldENhbnZhcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGNhbnZhczsKICAgIH07CiAgICAvKioNCiAgICAgKiBTb3J0aW5nIG1ldGhvZCBmb3IgbXVsdGlyZXMgbm9kZXMuDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge011bHRpcmVzTm9kZX0gYSAtIEZpcnN0IG5vZGUuDQogICAgICogQHBhcmFtIHtNdWx0aXJlc05vZGV9IGIgLSBTZWNvbmQgbm9kZS4NCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBCYXNlIHRpbGVzIGZpcnN0LCB0aGVuIGhpZ2hlciB0aW1lc3RhbXAgZmlyc3QuDQogICAgICovCgoKICAgIGZ1bmN0aW9uIG11bHRpcmVzTm9kZVNvcnQoYSwgYikgewogICAgICAvLyBCYXNlIHRpbGVzIGFyZSBhbHdheXMgZmlyc3QKICAgICAgaWYgKGEubGV2ZWwgPT0gMSAmJiBiLmxldmVsICE9IDEpIHsKICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0KCiAgICAgIGlmIChiLmxldmVsID09IDEgJiYgYS5sZXZlbCAhPSAxKSB7CiAgICAgICAgcmV0dXJuIDE7CiAgICAgIH0gLy8gSGlnaGVyIHRpbWVzdGFtcCBmaXJzdAoKCiAgICAgIHJldHVybiBiLnRpbWVzdGFtcCAtIGEudGltZXN0YW1wOwogICAgfQogICAgLyoqDQogICAgICogU29ydGluZyBtZXRob2QgZm9yIG11bHRpcmVzIG5vZGUgcmVuZGVyaW5nLg0KICAgICAqIEBwcml2YXRlDQogICAgICogQHBhcmFtIHtNdWx0aXJlc05vZGV9IGEgLSBGaXJzdCBub2RlLg0KICAgICAqIEBwYXJhbSB7TXVsdGlyZXNOb2RlfSBiIC0gU2Vjb25kIG5vZGUuDQogICAgICogQHJldHVybnMge251bWJlcn0gTG93ZXIgem9vbSBsZXZlbHMgZmlyc3QsIHRoZW4gY2xvc2VzdCB0byBjZW50ZXIgZmlyc3QuDQogICAgICovCgoKICAgIGZ1bmN0aW9uIG11bHRpcmVzTm9kZVJlbmRlclNvcnQoYSwgYikgewogICAgICAvLyBMb3dlciB6b29tIGxldmVscyBmaXJzdAogICAgICBpZiAoYS5sZXZlbCAhPSBiLmxldmVsKSB7CiAgICAgICAgcmV0dXJuIGEubGV2ZWwgLSBiLmxldmVsOwogICAgICB9IC8vIExvd2VyIGRpc3RhbmNlIGZyb20gY2VudGVyIGZpcnN0CgoKICAgICAgcmV0dXJuIGEuZGlmZiAtIGIuZGlmZjsKICAgIH0KICAgIC8qKg0KICAgICAqIERyYXdzIG11bHRpcmVzIG5vZGVzLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCgoKICAgIGZ1bmN0aW9uIG11bHRpcmVzRHJhdygpIHsKICAgICAgaWYgKCFwcm9ncmFtLmRyYXdJblByb2dyZXNzKSB7CiAgICAgICAgcHJvZ3JhbS5kcmF3SW5Qcm9ncmVzcyA9IHRydWU7CiAgICAgICAgZ2wuY2xlYXIoZ2wuQ09MT1JfQlVGRkVSX0JJVCk7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvZ3JhbS5jdXJyZW50Tm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChwcm9ncmFtLmN1cnJlbnROb2Rlc1tpXS50ZXh0dXJlTG9hZGVkID4gMSkgewogICAgICAgICAgICAvL3ZhciBjb2xvciA9IHByb2dyYW0uY3VycmVudE5vZGVzW2ldLmNvbG9yOwogICAgICAgICAgICAvL2dsLnVuaWZvcm00Zihwcm9ncmFtLmNvbG9yVW5pZm9ybSwgY29sb3JbMF0sIGNvbG9yWzFdLCBjb2xvclsyXSwgMS4wKTsKICAgICAgICAgICAgLy8gQmluZCB2ZXJ0ZXggYnVmZmVyIGFuZCBwYXNzIHZlcnRpY2VzIHRvIFdlYkdMCiAgICAgICAgICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBjdWJlVmVydEJ1Zik7CiAgICAgICAgICAgIGdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCBuZXcgRmxvYXQzMkFycmF5KHByb2dyYW0uY3VycmVudE5vZGVzW2ldLnZlcnRpY2VzKSwgZ2wuU1RBVElDX0RSQVcpOwogICAgICAgICAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHByb2dyYW0udmVydFBvc0xvY2F0aW9uLCAzLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOyAvLyBQcmVwIGZvciB0ZXh0dXJlCgogICAgICAgICAgICBnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgY3ViZVZlcnRUZXhDb29yZEJ1Zik7CiAgICAgICAgICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIocHJvZ3JhbS50ZXhDb29yZExvY2F0aW9uLCAyLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOyAvLyBCaW5kIHRleHR1cmUgYW5kIGRyYXcgdGlsZQoKICAgICAgICAgICAgZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgcHJvZ3JhbS5jdXJyZW50Tm9kZXNbaV0udGV4dHVyZSk7IC8vIEJpbmQgcHJvZ3JhbS5jdXJyZW50Tm9kZXNbaV0udGV4dHVyZSB0byBURVhUVVJFMAoKICAgICAgICAgICAgZ2wuZHJhd0VsZW1lbnRzKGdsLlRSSUFOR0xFUywgNiwgZ2wuVU5TSUdORURfU0hPUlQsIDApOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcHJvZ3JhbS5kcmF3SW5Qcm9ncmVzcyA9IGZhbHNlOwogICAgICB9CiAgICB9CiAgICAvKioNCiAgICAgKiBDcmVhdGVzIG5ldyBtdWx0aXJlcyBub2RlLg0KICAgICAqIEBjb25zdHJ1Y3Rvcg0KICAgICAqIEBwcml2YXRlDQogICAgICogQHBhcmFtIHtudW1iZXJbXX0gdmVydGljZXMgLSBOb2RlJ3MgdmVydGljaWVzLg0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzaWRlIC0gTm9kZSdzIGN1YmUgZmFjZS4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbGV2ZWwgLSBOb2RlJ3Mgem9vbSBsZXZlbC4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0geCAtIE5vZGUncyB4IHBvc2l0aW9uLg0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gTm9kZSdzIHkgcG9zaXRpb24uDQogICAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggLSBOb2RlJ3MgcGF0aC4NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gTXVsdGlyZXNOb2RlKHZlcnRpY2VzLCBzaWRlLCBsZXZlbCwgeCwgeSwgcGF0aCkgewogICAgICB0aGlzLnZlcnRpY2VzID0gdmVydGljZXM7CiAgICAgIHRoaXMuc2lkZSA9IHNpZGU7CiAgICAgIHRoaXMubGV2ZWwgPSBsZXZlbDsKICAgICAgdGhpcy54ID0geDsKICAgICAgdGhpcy55ID0geTsKICAgICAgdGhpcy5wYXRoID0gcGF0aC5yZXBsYWNlKCclcycsIHNpZGUpLnJlcGxhY2UoJyVsJywgbGV2ZWwpLnJlcGxhY2UoJyV4JywgeCkucmVwbGFjZSgnJXknLCB5KTsKICAgIH0KICAgIC8qKg0KICAgICAqIFRlc3QgaWYgbXVsdGlyZXMgbm9kZSBpcyB2aXNpYmxlLiBJZiBpdCBpcywgYWRkIGl0IHRvIGN1cnJlbnQgbm9kZXMsDQogICAgICogbG9hZCBpdHMgdGV4dHVyZSwgYW5kIGxvYWQgYXBwcm9wcmlhdGUgY2hpbGQgbm9kZXMuDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge251bWJlcltdfSByb3RQZXJzcCAtIFJvdGF0ZWQgcGVyc3BlY3RpdmUgbWF0cml4Lg0KICAgICAqIEBwYXJhbSB7TXVsdGlyZXNOb2RlfSBub2RlIC0gTXVsdGlyZXMgbm9kZSB0byBjaGVjay4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gcGl0Y2ggLSBQaXRjaCB0byBjaGVjayBhdC4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0geWF3IC0gWWF3IHRvIGNoZWNrIGF0Lg0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZm92IC0gSG9yaXpvbnRhbCBmaWVsZCBvZiB2aWV3IHRvIGNoZWNrIGF0Lg0KICAgICAqLwoKCiAgICBmdW5jdGlvbiB0ZXN0TXVsdGlyZXNOb2RlKHJvdFBlcnNwLCBub2RlLCBwaXRjaCwgeWF3LCBoZm92KSB7CiAgICAgIGlmIChjaGVja1NxdWFyZUluVmlldyhyb3RQZXJzcCwgbm9kZS52ZXJ0aWNlcykpIHsKICAgICAgICAvLyBDYWxjdWxhdGUgY2VudHJhbCBhbmdsZSBiZXR3ZWVuIGNlbnRlciBvZiB2aWV3IGFuZCBjZW50ZXIgb2YgdGlsZQogICAgICAgIHZhciB2ID0gbm9kZS52ZXJ0aWNlczsKICAgICAgICB2YXIgeCA9IHZbMF0gKyB2WzNdICsgdls2XSArIHZbOV07CiAgICAgICAgdmFyIHkgPSB2WzFdICsgdls0XSArIHZbN10gKyB2WzEwXTsKICAgICAgICB2YXIgeiA9IHZbMl0gKyB2WzVdICsgdls4XSArIHZbMTFdOwogICAgICAgIHZhciByID0gTWF0aC5zcXJ0KHggKiB4ICsgeSAqIHkgKyB6ICogeik7CiAgICAgICAgdmFyIHRoZXRhID0gTWF0aC5hc2luKHogLyByKTsKICAgICAgICB2YXIgcGhpID0gTWF0aC5hdGFuMih5LCB4KTsKICAgICAgICB2YXIgeWRpZmYgPSBwaGkgLSB5YXc7CiAgICAgICAgeWRpZmYgKz0geWRpZmYgPiBNYXRoLlBJID8gLTIgKiBNYXRoLlBJIDogeWRpZmYgPCAtTWF0aC5QSSA/IDIgKiBNYXRoLlBJIDogMDsKICAgICAgICB5ZGlmZiA9IE1hdGguYWJzKHlkaWZmKTsKICAgICAgICBub2RlLmRpZmYgPSBNYXRoLmFjb3MoTWF0aC5zaW4ocGl0Y2gpICogTWF0aC5zaW4odGhldGEpICsgTWF0aC5jb3MocGl0Y2gpICogTWF0aC5jb3ModGhldGEpICogTWF0aC5jb3MoeWRpZmYpKTsgLy8gQWRkIG5vZGUgdG8gY3VycmVudCBub2RlcyBhbmQgbG9hZCB0ZXh0dXJlIGlmIG5lZWRlZAoKICAgICAgICB2YXIgaW5DdXJyZW50ID0gZmFsc2U7CgogICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgcHJvZ3JhbS5ub2RlQ2FjaGUubGVuZ3RoOyBrKyspIHsKICAgICAgICAgIGlmIChwcm9ncmFtLm5vZGVDYWNoZVtrXS5wYXRoID09IG5vZGUucGF0aCkgewogICAgICAgICAgICBpbkN1cnJlbnQgPSB0cnVlOwogICAgICAgICAgICBwcm9ncmFtLm5vZGVDYWNoZVtrXS50aW1lc3RhbXAgPSBwcm9ncmFtLm5vZGVDYWNoZVRpbWVzdGFtcCsrOwogICAgICAgICAgICBwcm9ncmFtLm5vZGVDYWNoZVtrXS5kaWZmID0gbm9kZS5kaWZmOwogICAgICAgICAgICBwcm9ncmFtLmN1cnJlbnROb2Rlcy5wdXNoKHByb2dyYW0ubm9kZUNhY2hlW2tdKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWluQ3VycmVudCkgewogICAgICAgICAgLy9ub2RlLmNvbG9yID0gW01hdGgucmFuZG9tKCksIE1hdGgucmFuZG9tKCksIE1hdGgucmFuZG9tKCldOwogICAgICAgICAgbm9kZS50aW1lc3RhbXAgPSBwcm9ncmFtLm5vZGVDYWNoZVRpbWVzdGFtcCsrOwogICAgICAgICAgcHJvZ3JhbS5jdXJyZW50Tm9kZXMucHVzaChub2RlKTsKICAgICAgICAgIHByb2dyYW0ubm9kZUNhY2hlLnB1c2gobm9kZSk7CiAgICAgICAgfSAvLyBUT0RPOiBUZXN0IGVycm9yCiAgICAgICAgLy8gQ3JlYXRlIGNoaWxkIG5vZGVzCgoKICAgICAgICBpZiAobm9kZS5sZXZlbCA8IHByb2dyYW0ubGV2ZWwpIHsKICAgICAgICAgIHZhciBjdWJlU2l6ZSA9IGltYWdlLmN1YmVSZXNvbHV0aW9uICogTWF0aC5wb3coMiwgbm9kZS5sZXZlbCAtIGltYWdlLm1heExldmVsKTsKICAgICAgICAgIHZhciBudW1UaWxlcyA9IE1hdGguY2VpbChjdWJlU2l6ZSAqIGltYWdlLmludlRpbGVSZXNvbHV0aW9uKSAtIDE7CiAgICAgICAgICB2YXIgZG91YmxlVGlsZVNpemUgPSBjdWJlU2l6ZSAlIGltYWdlLnRpbGVSZXNvbHV0aW9uICogMjsKICAgICAgICAgIHZhciBsYXN0VGlsZVNpemUgPSBjdWJlU2l6ZSAqIDIgJSBpbWFnZS50aWxlUmVzb2x1dGlvbjsKCiAgICAgICAgICBpZiAobGFzdFRpbGVTaXplID09PSAwKSB7CiAgICAgICAgICAgIGxhc3RUaWxlU2l6ZSA9IGltYWdlLnRpbGVSZXNvbHV0aW9uOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChkb3VibGVUaWxlU2l6ZSA9PT0gMCkgewogICAgICAgICAgICBkb3VibGVUaWxlU2l6ZSA9IGltYWdlLnRpbGVSZXNvbHV0aW9uICogMjsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgZiA9IDAuNTsKCiAgICAgICAgICBpZiAobm9kZS54ID09IG51bVRpbGVzIHx8IG5vZGUueSA9PSBudW1UaWxlcykgewogICAgICAgICAgICBmID0gMS4wIC0gaW1hZ2UudGlsZVJlc29sdXRpb24gLyAoaW1hZ2UudGlsZVJlc29sdXRpb24gKyBsYXN0VGlsZVNpemUpOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBpID0gMS4wIC0gZjsKICAgICAgICAgIHZhciBjaGlsZHJlbiA9IFtdOwogICAgICAgICAgdmFyIHZ0bXAsIG50bXA7CiAgICAgICAgICB2YXIgZjEgPSBmLAogICAgICAgICAgICAgIGYyID0gZiwKICAgICAgICAgICAgICBmMyA9IGYsCiAgICAgICAgICAgICAgaTEgPSBpLAogICAgICAgICAgICAgIGkyID0gaSwKICAgICAgICAgICAgICBpMyA9IGk7IC8vIEhhbmRsZSBub24tc3ltbWV0cmljIHRpbGVzCgogICAgICAgICAgaWYgKGxhc3RUaWxlU2l6ZSA8IGltYWdlLnRpbGVSZXNvbHV0aW9uKSB7CiAgICAgICAgICAgIGlmIChub2RlLnggPT0gbnVtVGlsZXMgJiYgbm9kZS55ICE9IG51bVRpbGVzKSB7CiAgICAgICAgICAgICAgZjIgPSAwLjU7CiAgICAgICAgICAgICAgaTIgPSAwLjU7CgogICAgICAgICAgICAgIGlmIChub2RlLnNpZGUgPT0gJ2QnIHx8IG5vZGUuc2lkZSA9PSAndScpIHsKICAgICAgICAgICAgICAgIGYzID0gMC41OwogICAgICAgICAgICAgICAgaTMgPSAwLjU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUueCAhPSBudW1UaWxlcyAmJiBub2RlLnkgPT0gbnVtVGlsZXMpIHsKICAgICAgICAgICAgICBmMSA9IDAuNTsKICAgICAgICAgICAgICBpMSA9IDAuNTsKCiAgICAgICAgICAgICAgaWYgKG5vZGUuc2lkZSA9PSAnbCcgfHwgbm9kZS5zaWRlID09ICdyJykgewogICAgICAgICAgICAgICAgZjMgPSAwLjU7CiAgICAgICAgICAgICAgICBpMyA9IDAuNTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gLy8gSGFuZGxlIHNtYWxsIHRpbGVzIHRoYXQgaGF2ZSBmZXdlciB0aGFuIGZvdXIgY2hpbGRyZW4KCgogICAgICAgICAgaWYgKGRvdWJsZVRpbGVTaXplIDw9IGltYWdlLnRpbGVSZXNvbHV0aW9uKSB7CiAgICAgICAgICAgIGlmIChub2RlLnggPT0gbnVtVGlsZXMpIHsKICAgICAgICAgICAgICBmMSA9IDA7CiAgICAgICAgICAgICAgaTEgPSAxOwoKICAgICAgICAgICAgICBpZiAobm9kZS5zaWRlID09ICdsJyB8fCBub2RlLnNpZGUgPT0gJ3InKSB7CiAgICAgICAgICAgICAgICBmMyA9IDA7CiAgICAgICAgICAgICAgICBpMyA9IDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobm9kZS55ID09IG51bVRpbGVzKSB7CiAgICAgICAgICAgICAgZjIgPSAwOwogICAgICAgICAgICAgIGkyID0gMTsKCiAgICAgICAgICAgICAgaWYgKG5vZGUuc2lkZSA9PSAnZCcgfHwgbm9kZS5zaWRlID09ICd1JykgewogICAgICAgICAgICAgICAgZjMgPSAwOwogICAgICAgICAgICAgICAgaTMgPSAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHZ0bXAgPSBbdlswXSwgdlsxXSwgdlsyXSwgdlswXSAqIGYxICsgdlszXSAqIGkxLCB2WzFdICogZiArIHZbNF0gKiBpLCB2WzJdICogZjMgKyB2WzVdICogaTMsIHZbMF0gKiBmMSArIHZbNl0gKiBpMSwgdlsxXSAqIGYyICsgdls3XSAqIGkyLCB2WzJdICogZjMgKyB2WzhdICogaTMsIHZbMF0gKiBmICsgdls5XSAqIGksIHZbMV0gKiBmMiArIHZbMTBdICogaTIsIHZbMl0gKiBmMyArIHZbMTFdICogaTNdOwogICAgICAgICAgbnRtcCA9IG5ldyBNdWx0aXJlc05vZGUodnRtcCwgbm9kZS5zaWRlLCBub2RlLmxldmVsICsgMSwgbm9kZS54ICogMiwgbm9kZS55ICogMiwgaW1hZ2UuZnVsbHBhdGgpOwogICAgICAgICAgY2hpbGRyZW4ucHVzaChudG1wKTsKCiAgICAgICAgICBpZiAoIShub2RlLnggPT0gbnVtVGlsZXMgJiYgZG91YmxlVGlsZVNpemUgPD0gaW1hZ2UudGlsZVJlc29sdXRpb24pKSB7CiAgICAgICAgICAgIHZ0bXAgPSBbdlswXSAqIGYxICsgdlszXSAqIGkxLCB2WzFdICogZiArIHZbNF0gKiBpLCB2WzJdICogZjMgKyB2WzVdICogaTMsIHZbM10sIHZbNF0sIHZbNV0sIHZbM10gKiBmICsgdls2XSAqIGksIHZbNF0gKiBmMiArIHZbN10gKiBpMiwgdls1XSAqIGYzICsgdls4XSAqIGkzLCB2WzBdICogZjEgKyB2WzZdICogaTEsIHZbMV0gKiBmMiArIHZbN10gKiBpMiwgdlsyXSAqIGYzICsgdls4XSAqIGkzXTsKICAgICAgICAgICAgbnRtcCA9IG5ldyBNdWx0aXJlc05vZGUodnRtcCwgbm9kZS5zaWRlLCBub2RlLmxldmVsICsgMSwgbm9kZS54ICogMiArIDEsIG5vZGUueSAqIDIsIGltYWdlLmZ1bGxwYXRoKTsKICAgICAgICAgICAgY2hpbGRyZW4ucHVzaChudG1wKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIShub2RlLnggPT0gbnVtVGlsZXMgJiYgZG91YmxlVGlsZVNpemUgPD0gaW1hZ2UudGlsZVJlc29sdXRpb24pICYmICEobm9kZS55ID09IG51bVRpbGVzICYmIGRvdWJsZVRpbGVTaXplIDw9IGltYWdlLnRpbGVSZXNvbHV0aW9uKSkgewogICAgICAgICAgICB2dG1wID0gW3ZbMF0gKiBmMSArIHZbNl0gKiBpMSwgdlsxXSAqIGYyICsgdls3XSAqIGkyLCB2WzJdICogZjMgKyB2WzhdICogaTMsIHZbM10gKiBmICsgdls2XSAqIGksIHZbNF0gKiBmMiArIHZbN10gKiBpMiwgdls1XSAqIGYzICsgdls4XSAqIGkzLCB2WzZdLCB2WzddLCB2WzhdLCB2WzldICogZjEgKyB2WzZdICogaTEsIHZbMTBdICogZiArIHZbN10gKiBpLCB2WzExXSAqIGYzICsgdls4XSAqIGkzXTsKICAgICAgICAgICAgbnRtcCA9IG5ldyBNdWx0aXJlc05vZGUodnRtcCwgbm9kZS5zaWRlLCBub2RlLmxldmVsICsgMSwgbm9kZS54ICogMiArIDEsIG5vZGUueSAqIDIgKyAxLCBpbWFnZS5mdWxscGF0aCk7CiAgICAgICAgICAgIGNoaWxkcmVuLnB1c2gobnRtcCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCEobm9kZS55ID09IG51bVRpbGVzICYmIGRvdWJsZVRpbGVTaXplIDw9IGltYWdlLnRpbGVSZXNvbHV0aW9uKSkgewogICAgICAgICAgICB2dG1wID0gW3ZbMF0gKiBmICsgdls5XSAqIGksIHZbMV0gKiBmMiArIHZbMTBdICogaTIsIHZbMl0gKiBmMyArIHZbMTFdICogaTMsIHZbMF0gKiBmMSArIHZbNl0gKiBpMSwgdlsxXSAqIGYyICsgdls3XSAqIGkyLCB2WzJdICogZjMgKyB2WzhdICogaTMsIHZbOV0gKiBmMSArIHZbNl0gKiBpMSwgdlsxMF0gKiBmICsgdls3XSAqIGksIHZbMTFdICogZjMgKyB2WzhdICogaTMsIHZbOV0sIHZbMTBdLCB2WzExXV07CiAgICAgICAgICAgIG50bXAgPSBuZXcgTXVsdGlyZXNOb2RlKHZ0bXAsIG5vZGUuc2lkZSwgbm9kZS5sZXZlbCArIDEsIG5vZGUueCAqIDIsIG5vZGUueSAqIDIgKyAxLCBpbWFnZS5mdWxscGF0aCk7CiAgICAgICAgICAgIGNoaWxkcmVuLnB1c2gobnRtcCk7CiAgICAgICAgICB9CgogICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBjaGlsZHJlbi5sZW5ndGg7IGorKykgewogICAgICAgICAgICB0ZXN0TXVsdGlyZXNOb2RlKHJvdFBlcnNwLCBjaGlsZHJlbltqXSwgcGl0Y2gsIHlhdywgaGZvdik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioNCiAgICAgKiBDcmVhdGVzIGN1YmUgdmVydGV4IGFycmF5Lg0KICAgICAqIEBwcml2YXRlDQogICAgICogQHJldHVybnMge251bWJlcltdfSBDdWJlIHZlcnRleCBhcnJheS4NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gY3JlYXRlQ3ViZSgpIHsKICAgICAgcmV0dXJuIFstMSwgMSwgLTEsIDEsIDEsIC0xLCAxLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC8vIEZyb250IGZhY2UKICAgICAgMSwgMSwgMSwgLTEsIDEsIDEsIC0xLCAtMSwgMSwgMSwgLTEsIDEsIC8vIEJhY2sgZmFjZQogICAgICAtMSwgMSwgMSwgMSwgMSwgMSwgMSwgMSwgLTEsIC0xLCAxLCAtMSwgLy8gVXAgZmFjZQogICAgICAtMSwgLTEsIC0xLCAxLCAtMSwgLTEsIDEsIC0xLCAxLCAtMSwgLTEsIDEsIC8vIERvd24gZmFjZQogICAgICAtMSwgMSwgMSwgLTEsIDEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIDEsIC8vIExlZnQgZmFjZQogICAgICAxLCAxLCAtMSwgMSwgMSwgMSwgMSwgLTEsIDEsIDEsIC0xLCAtMSAvLyBSaWdodCBmYWNlCiAgICAgIF07CiAgICB9CiAgICAvKioNCiAgICAgKiBDcmVhdGVzIDN4MyBpZGVudGl0eSBtYXRyaXguDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyW119IElkZW50aXR5IG1hdHJpeC4NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gaWRlbnRpdHlNYXRyaXgzKCkgewogICAgICByZXR1cm4gWzEsIDAsIDAsIDAsIDEsIDAsIDAsIDAsIDFdOwogICAgfQogICAgLyoqDQogICAgICogUm90YXRlcyBhIDN4MyBtYXRyaXguDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge251bWJlcltdfSBtIC0gTWF0cml4IHRvIHJvdGF0ZS4NCiAgICAgKiBAcGFyYW0ge251bWJlcltdfSBhbmdsZSAtIEFuZ2xlIHRvIHJvdGF0ZSBieSBpbiByYWRpYW5zLg0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBheGlzIC0gQXhpcyB0byByb3RhdGUgYWJvdXQgKGB4YCwgYHlgLCBvciBgemApLg0KICAgICAqIEByZXR1cm5zIHtudW1iZXJbXX0gUm90YXRlZCBtYXRyaXguDQogICAgICovCgoKICAgIGZ1bmN0aW9uIHJvdGF0ZU1hdHJpeChtLCBhbmdsZSwgYXhpcykgewogICAgICB2YXIgcyA9IE1hdGguc2luKGFuZ2xlKTsKICAgICAgdmFyIGMgPSBNYXRoLmNvcyhhbmdsZSk7CgogICAgICBpZiAoYXhpcyA9PSAneCcpIHsKICAgICAgICByZXR1cm4gW21bMF0sIGMgKiBtWzFdICsgcyAqIG1bMl0sIGMgKiBtWzJdIC0gcyAqIG1bMV0sIG1bM10sIGMgKiBtWzRdICsgcyAqIG1bNV0sIGMgKiBtWzVdIC0gcyAqIG1bNF0sIG1bNl0sIGMgKiBtWzddICsgcyAqIG1bOF0sIGMgKiBtWzhdIC0gcyAqIG1bN11dOwogICAgICB9CgogICAgICBpZiAoYXhpcyA9PSAneScpIHsKICAgICAgICByZXR1cm4gW2MgKiBtWzBdIC0gcyAqIG1bMl0sIG1bMV0sIGMgKiBtWzJdICsgcyAqIG1bMF0sIGMgKiBtWzNdIC0gcyAqIG1bNV0sIG1bNF0sIGMgKiBtWzVdICsgcyAqIG1bM10sIGMgKiBtWzZdIC0gcyAqIG1bOF0sIG1bN10sIGMgKiBtWzhdICsgcyAqIG1bNl1dOwogICAgICB9CgogICAgICBpZiAoYXhpcyA9PSAneicpIHsKICAgICAgICByZXR1cm4gW2MgKiBtWzBdICsgcyAqIG1bMV0sIGMgKiBtWzFdIC0gcyAqIG1bMF0sIG1bMl0sIGMgKiBtWzNdICsgcyAqIG1bNF0sIGMgKiBtWzRdIC0gcyAqIG1bM10sIG1bNV0sIGMgKiBtWzZdICsgcyAqIG1bN10sIGMgKiBtWzddIC0gcyAqIG1bNl0sIG1bOF1dOwogICAgICB9CiAgICB9CiAgICAvKioNCiAgICAgKiBUdXJucyBhIDN4MyBtYXRyaXggaW50byBhIDR4NCBtYXRyaXguDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge251bWJlcltdfSBtIC0gSW5wdXQgbWF0cml4Lg0KICAgICAqIEByZXR1cm5zIHtudW1iZXJbXX0gRXhwYW5kZWQgbWF0cml4Lg0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBtYWtlTWF0cml4NChtKSB7CiAgICAgIHJldHVybiBbbVswXSwgbVsxXSwgbVsyXSwgMCwgbVszXSwgbVs0XSwgbVs1XSwgMCwgbVs2XSwgbVs3XSwgbVs4XSwgMCwgMCwgMCwgMCwgMV07CiAgICB9CiAgICAvKioNCiAgICAgKiBUcmFuc3Bvc2VzIGEgNHg0IG1hdHJpeC4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7bnVtYmVyW119IG0gLSBJbnB1dCBtYXRyaXguDQogICAgICogQHJldHVybnMge251bWJlcltdfSBUcmFuc3Bvc2VkIG1hdHJpeC4NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gdHJhbnNwb3NlTWF0cml4NChtKSB7CiAgICAgIHJldHVybiBbbVswXSwgbVs0XSwgbVs4XSwgbVsxMl0sIG1bMV0sIG1bNV0sIG1bOV0sIG1bMTNdLCBtWzJdLCBtWzZdLCBtWzEwXSwgbVsxNF0sIG1bM10sIG1bN10sIG1bMTFdLCBtWzE1XV07CiAgICB9CiAgICAvKioNCiAgICAgKiBDcmVhdGVzIGEgcGVyc3BlY3RpdmUgbWF0cml4Lg0KICAgICAqIEBwcml2YXRlDQogICAgICogQHBhcmFtIHtudW1iZXJ9IGhmb3YgLSBEZXNpcmVkIGhvcml6b250YWwgZmllbGQgb2Ygdmlldy4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gYXNwZWN0IC0gRGVzaXJlZCBhc3BlY3QgcmF0aW8uDQogICAgICogQHBhcmFtIHtudW1iZXJ9IHpuZWFyIC0gTmVhciBkaXN0YW5jZS4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gemZhciAtIEZhciBkaXN0YW5jZS4NCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyW119IEdlbmVyYXRlZCBwZXJzcGVjdGl2ZSBtYXRyaXguDQogICAgICovCgoKICAgIGZ1bmN0aW9uIG1ha2VQZXJzcChoZm92LCBhc3BlY3QsIHpuZWFyLCB6ZmFyKSB7CiAgICAgIHZhciBmb3Z5ID0gMiAqIE1hdGguYXRhbihNYXRoLnRhbihoZm92IC8gMikgKiBnbC5kcmF3aW5nQnVmZmVySGVpZ2h0IC8gZ2wuZHJhd2luZ0J1ZmZlcldpZHRoKTsKICAgICAgdmFyIGYgPSAxIC8gTWF0aC50YW4oZm92eSAvIDIpOwogICAgICByZXR1cm4gW2YgLyBhc3BlY3QsIDAsIDAsIDAsIDAsIGYsIDAsIDAsIDAsIDAsICh6ZmFyICsgem5lYXIpIC8gKHpuZWFyIC0gemZhciksIDIgKiB6ZmFyICogem5lYXIgLyAoem5lYXIgLSB6ZmFyKSwgMCwgMCwgLTEsIDBdOwogICAgfQogICAgLyoqDQogICAgICogUHJvY2Vzc2VzIGEgbG9hZGVkIHRleHR1cmUgaW1hZ2UgaW50byBhIFdlYkdMIHRleHR1cmUuDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge0ltYWdlfSBpbWcgLSBJbnB1dCBpbWFnZS4NCiAgICAgKiBAcGFyYW0ge1dlYkdMVGV4dHVyZX0gdGV4IC0gVGV4dHVyZSB0byBiaW5kIGltYWdlIHRvLg0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBwcm9jZXNzTG9hZGVkVGV4dHVyZShpbWcsIHRleCkgewogICAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0ZXgpOwogICAgICBnbC50ZXhJbWFnZTJEKGdsLlRFWFRVUkVfMkQsIDAsIGdsLlJHQiwgZ2wuUkdCLCBnbC5VTlNJR05FRF9CWVRFLCBpbWcpOwogICAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUFHX0ZJTFRFUiwgZ2wuTElORUFSKTsKICAgICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01JTl9GSUxURVIsIGdsLkxJTkVBUik7CiAgICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1MsIGdsLkNMQU1QX1RPX0VER0UpOwogICAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5DTEFNUF9UT19FREdFKTsKICAgICAgZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgbnVsbCk7CiAgICB9CgogICAgdmFyIHBlbmRpbmdUZXh0dXJlUmVxdWVzdHMgPSBbXTsgLy8gQmFzZWQgb24gaHR0cDovL2Jsb2cudG9qaWNvZGUuY29tLzIwMTIvMDMvamF2YXNjcmlwdC1tZW1vcnktb3B0aW1pemF0aW9uLWFuZC5odG1sCgogICAgdmFyIGxvYWRUZXh0dXJlID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgY2FjaGVUb3AgPSA0OyAvLyBNYXhpbXVtIG51bWJlciBvZiBjb25jdXJyZW50cyBsb2FkcwoKICAgICAgdmFyIHRleHR1cmVJbWFnZUNhY2hlID0ge307CiAgICAgIHZhciBjcm9zc09yaWdpbjsKCiAgICAgIGZ1bmN0aW9uIFRleHR1cmVJbWFnZUxvYWRlcigpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgdGhpcy50ZXh0dXJlID0gdGhpcy5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgdGhpcy5pbWFnZSA9IG5ldyBJbWFnZSgpOwogICAgICAgIHRoaXMuaW1hZ2UuY3Jvc3NPcmlnaW4gPSBjcm9zc09yaWdpbiA/IGNyb3NzT3JpZ2luIDogJ2Fub255bW91cyc7CgogICAgICAgIHZhciBsb2FkRm4gPSBmdW5jdGlvbiBsb2FkRm4oKSB7CiAgICAgICAgICBpZiAoc2VsZi5pbWFnZS53aWR0aCA+IDAgJiYgc2VsZi5pbWFnZS5oZWlnaHQgPiAwKSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSBtaXNzaW5nIHRpbGUgdG8gc3VwcG9ydGluZyBwYXJ0aWFsIGltYWdlCiAgICAgICAgICAgIHByb2Nlc3NMb2FkZWRUZXh0dXJlKHNlbGYuaW1hZ2UsIHNlbGYudGV4dHVyZSk7CiAgICAgICAgICAgIHNlbGYuY2FsbGJhY2soc2VsZi50ZXh0dXJlLCB0cnVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYuY2FsbGJhY2soc2VsZi50ZXh0dXJlLCBmYWxzZSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmVsZWFzZVRleHR1cmVJbWFnZUxvYWRlcihzZWxmKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmltYWdlLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBsb2FkRm4pOwogICAgICAgIHRoaXMuaW1hZ2UuYWRkRXZlbnRMaXN0ZW5lcignZXJyb3InLCBsb2FkRm4pOyAvLyBpZ25vcmUgbWlzc2luZyB0aWxlIGZpbGUgdG8gc3VwcG9ydCBwYXJ0aWFsIGltYWdlLCBvdGhlcndpc2UgcmV0cnkgbG9vcCBjYXVzZXMgaGlnaCBDUFUgbG9hZAogICAgICB9CgogICAgICBUZXh0dXJlSW1hZ2VMb2FkZXIucHJvdG90eXBlLmxvYWRUZXh0dXJlID0gZnVuY3Rpb24gKHNyYywgdGV4dHVyZSwgY2FsbGJhY2spIHsKICAgICAgICB0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwogICAgICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICB0aGlzLmltYWdlLnNyYyA9IHNyYzsKICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIFBlbmRpbmdUZXh0dXJlUmVxdWVzdChub2RlLCBzcmMsIHRleHR1cmUsIGNhbGxiYWNrKSB7CiAgICAgICAgdGhpcy5ub2RlID0gbm9kZTsKICAgICAgICB0aGlzLnNyYyA9IHNyYzsKICAgICAgICB0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwogICAgICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcmVsZWFzZVRleHR1cmVJbWFnZUxvYWRlcih0aWwpIHsKICAgICAgICBpZiAocGVuZGluZ1RleHR1cmVSZXF1ZXN0cy5sZW5ndGgpIHsKICAgICAgICAgIHZhciByZXEgPSBwZW5kaW5nVGV4dHVyZVJlcXVlc3RzLnNoaWZ0KCk7CiAgICAgICAgICB0aWwubG9hZFRleHR1cmUocmVxLnNyYywgcmVxLnRleHR1cmUsIHJlcS5jYWxsYmFjayk7CiAgICAgICAgfSBlbHNlIHRleHR1cmVJbWFnZUNhY2hlW2NhY2hlVG9wKytdID0gdGlsOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhY2hlVG9wOyBpKyspIHsKICAgICAgICB0ZXh0dXJlSW1hZ2VDYWNoZVtpXSA9IG5ldyBUZXh0dXJlSW1hZ2VMb2FkZXIoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChub2RlLCBzcmMsIGNhbGxiYWNrLCBfY3Jvc3NPcmlnaW4pIHsKICAgICAgICBjcm9zc09yaWdpbiA9IF9jcm9zc09yaWdpbjsKICAgICAgICB2YXIgdGV4dHVyZSA9IGdsLmNyZWF0ZVRleHR1cmUoKTsKICAgICAgICBpZiAoY2FjaGVUb3ApIHRleHR1cmVJbWFnZUNhY2hlWy0tY2FjaGVUb3BdLmxvYWRUZXh0dXJlKHNyYywgdGV4dHVyZSwgY2FsbGJhY2spO2Vsc2UgcGVuZGluZ1RleHR1cmVSZXF1ZXN0cy5wdXNoKG5ldyBQZW5kaW5nVGV4dHVyZVJlcXVlc3Qobm9kZSwgc3JjLCB0ZXh0dXJlLCBjYWxsYmFjaykpOwogICAgICAgIHJldHVybiB0ZXh0dXJlOwogICAgICB9OwogICAgfSgpOwogICAgLyoqDQogICAgICogTG9hZHMgaW1hZ2UgYW5kIGNyZWF0ZXMgdGV4dHVyZSBmb3IgYSBtdWx0aXJlcyBub2RlIC8gdGlsZS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7TXVsdGlyZXNOb2RlfSBub2RlIC0gSW5wdXQgbm9kZS4NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gcHJvY2Vzc05leHRUaWxlKG5vZGUpIHsKICAgICAgbG9hZFRleHR1cmUobm9kZSwgbm9kZS5wYXRoICsgJy4nICsgaW1hZ2UuZXh0ZW5zaW9uLCBmdW5jdGlvbiAodGV4dHVyZSwgbG9hZGVkKSB7CiAgICAgICAgbm9kZS50ZXh0dXJlID0gdGV4dHVyZTsKICAgICAgICBub2RlLnRleHR1cmVMb2FkZWQgPSBsb2FkZWQgPyAyIDogMTsKICAgICAgfSwgZ2xvYmFsUGFyYW1zLmNyb3NzT3JpZ2luKTsKICAgIH0KICAgIC8qKg0KICAgICAqIEZpbmRzIGFuZCBhcHBsaWVzIG9wdGltYWwgbXVsdGlyZXMgem9vbSBsZXZlbC4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZm92IC0gSG9yaXpvbnRhbCBmaWVsZCBvZiB2aWV3IHRvIGNoZWNrIGF0Lg0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBjaGVja1pvb20oaGZvdikgewogICAgICAvLyBGaW5kIG9wdGltYWwgbGV2ZWwKICAgICAgdmFyIG5ld0xldmVsID0gMTsKCiAgICAgIHdoaWxlIChuZXdMZXZlbCA8IGltYWdlLm1heExldmVsICYmIGdsLmRyYXdpbmdCdWZmZXJXaWR0aCA+IGltYWdlLnRpbGVSZXNvbHV0aW9uICogTWF0aC5wb3coMiwgbmV3TGV2ZWwgLSAxKSAqIE1hdGgudGFuKGhmb3YgLyAyKSAqIDAuNzA3KSB7CiAgICAgICAgbmV3TGV2ZWwrKzsKICAgICAgfSAvLyBBcHBseSBjaGFuZ2UKCgogICAgICBwcm9ncmFtLmxldmVsID0gbmV3TGV2ZWw7CiAgICB9CiAgICAvKioNCiAgICAgKiBSb3RhdGVzIHBlcnNwZWN0aXZlIG1hdHJpeC4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7bnVtYmVyW119IHAgLSBQZXJzcGVjdGl2ZSBtYXRyaXguDQogICAgICogQHBhcmFtIHtudW1iZXJbXX0gciAtIFJvdGF0aW9uIG1hdHJpeC4NCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyW119IFJvdGF0ZWQgbWF0cml4Lg0KICAgICAqLwoKCiAgICBmdW5jdGlvbiByb3RhdGVQZXJzcChwLCByKSB7CiAgICAgIHJldHVybiBbcFswXSAqIHJbMF0sIHBbMF0gKiByWzFdLCBwWzBdICogclsyXSwgMCwgcFs1XSAqIHJbNF0sIHBbNV0gKiByWzVdLCBwWzVdICogcls2XSwgMCwgcFsxMF0gKiByWzhdLCBwWzEwXSAqIHJbOV0sIHBbMTBdICogclsxMF0sIHBbMTFdLCAtcls4XSwgLXJbOV0sIC1yWzEwXSwgMF07CiAgICB9CiAgICAvKioNCiAgICAgKiBBcHBsaWVzIHJvdGF0ZWQgcGVyc3BlY3RpdmUgbWF0cml4IHRvIGEgMy12ZWN0b3INCiAgICAgKiAobGFzdCBlbGVtZW50IGlzIGludmVydGVkKS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqIEBwYXJhbSB7bnVtYmVyW119IG0gLSBSb3RhdGVkIHBlcnNwZWN0aXZlIG1hdHJpeC4NCiAgICAgKiBAcGFyYW0ge251bWJlcltdfSB2IC0gSW5wdXQgMy12ZWN0b3IuDQogICAgICogQHJldHVybnMge251bWJlcltdfSBSZXN1bHRpbmcgNC12ZWN0b3IuDQogICAgICovCgoKICAgIGZ1bmN0aW9uIGFwcGx5Um90UGVyc3BUb1ZlYyhtLCB2KSB7CiAgICAgIHJldHVybiBbbVswXSAqIHZbMF0gKyBtWzFdICogdlsxXSArIG1bMl0gKiB2WzJdLCBtWzRdICogdlswXSArIG1bNV0gKiB2WzFdICsgbVs2XSAqIHZbMl0sIG1bMTFdICsgbVs4XSAqIHZbMF0gKyBtWzldICogdlsxXSArIG1bMTBdICogdlsyXSwgMSAvIChtWzEyXSAqIHZbMF0gKyBtWzEzXSAqIHZbMV0gKyBtWzE0XSAqIHZbMl0pXTsKICAgIH0KICAgIC8qKg0KICAgICAqIENoZWNrcyBpZiBhIHZlcnRleCBpcyB2aXNpYmxlLg0KICAgICAqIEBwcml2YXRlDQogICAgICogQHBhcmFtIHtudW1iZXJbXX0gbSAtIFJvdGF0ZWQgcGVyc3BlY3RpdmUgbWF0cml4Lg0KICAgICAqIEBwYXJhbSB7bnVtYmVyW119IHYgLSBJbnB1dCB2ZXJ0ZXguDQogICAgICogQHJldHVybnMge251bWJlcn0gMSBvciAtMSBpZiB0aGUgdmVydGV4IGlzIG9yIGlzIG5vdCB2aXNpYmxlLA0KICAgICAqICAgICAgcmVzcGVjdGl2ZWx5Lg0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBjaGVja0luVmlldyhtLCB2KSB7CiAgICAgIHZhciB2cHAgPSBhcHBseVJvdFBlcnNwVG9WZWMobSwgdik7CiAgICAgIHZhciB3aW5YID0gdnBwWzBdICogdnBwWzNdOwogICAgICB2YXIgd2luWSA9IHZwcFsxXSAqIHZwcFszXTsKICAgICAgdmFyIHdpblogPSB2cHBbMl0gKiB2cHBbM107CiAgICAgIHZhciByZXQgPSBbMCwgMCwgMF07CiAgICAgIGlmICh3aW5YIDwgLTEpIHJldFswXSA9IC0xOwogICAgICBpZiAod2luWCA+IDEpIHJldFswXSA9IDE7CiAgICAgIGlmICh3aW5ZIDwgLTEpIHJldFsxXSA9IC0xOwogICAgICBpZiAod2luWSA+IDEpIHJldFsxXSA9IDE7CiAgICAgIGlmICh3aW5aIDwgLTEgfHwgd2luWiA+IDEpIHJldFsyXSA9IDE7CiAgICAgIHJldHVybiByZXQ7CiAgICB9CiAgICAvKioNCiAgICAgKiBDaGVja3MgaWYgYSBzcXVhcmUgKHRpbGUpIGlzIHZpc2libGUuDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge251bWJlcltdfSBtIC0gUm90YXRlZCBwZXJzcGVjdGl2ZSBtYXRyaXguDQogICAgICogQHBhcmFtIHtudW1iZXJbXX0gdiAtIFNxdWFyZSdzIHZlcnRleCBhcnJheS4NCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciBvciBub3QgdGhlIHNxdWFyZSBpcyB2aXNpYmxlLg0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBjaGVja1NxdWFyZUluVmlldyhtLCB2KSB7CiAgICAgIHZhciBjaGVjazEgPSBjaGVja0luVmlldyhtLCB2LnNsaWNlKDAsIDMpKTsKICAgICAgdmFyIGNoZWNrMiA9IGNoZWNrSW5WaWV3KG0sIHYuc2xpY2UoMywgNikpOwogICAgICB2YXIgY2hlY2szID0gY2hlY2tJblZpZXcobSwgdi5zbGljZSg2LCA5KSk7CiAgICAgIHZhciBjaGVjazQgPSBjaGVja0luVmlldyhtLCB2LnNsaWNlKDksIDEyKSk7CiAgICAgIHZhciB0ZXN0WCA9IGNoZWNrMVswXSArIGNoZWNrMlswXSArIGNoZWNrM1swXSArIGNoZWNrNFswXTsKICAgICAgaWYgKHRlc3RYID09IC00IHx8IHRlc3RYID09IDQpIHJldHVybiBmYWxzZTsKICAgICAgdmFyIHRlc3RZID0gY2hlY2sxWzFdICsgY2hlY2syWzFdICsgY2hlY2szWzFdICsgY2hlY2s0WzFdOwogICAgICBpZiAodGVzdFkgPT0gLTQgfHwgdGVzdFkgPT0gNCkgcmV0dXJuIGZhbHNlOwogICAgICB2YXIgdGVzdFogPSBjaGVjazFbMl0gKyBjaGVjazJbMl0gKyBjaGVjazNbMl0gKyBjaGVjazRbMl07CiAgICAgIHJldHVybiB0ZXN0WiAhPSA0OwogICAgfQogICAgLyoqDQogICAgICogT24gaU9TIChpUGhvbmUgNWMsIGlPUyAxMC4zKSwgdGhpcyBXZWJHTCBlcnJvciBvY2N1cnMgd2hlbiB0aGUgY2FudmFzIGlzDQogICAgICogdG9vIGJpZy4gVW5mb3J0dWF0ZWx5LCB0aGVyZSdzIG5vIHdheSB0byB0ZXN0IGZvciB0aGlzIGJlZm9yZWhhbmQsIHNvIHdlDQogICAgICogcmVkdWNlIHRoZSBjYW52YXMgc2l6ZSBpZiB0aGlzIGVycm9yIGlzIHRocm93bi4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKCiAgICBmdW5jdGlvbiBoYW5kbGVXZWJHTEVycm9yMTI4NigpIHsKICAgICAgY29uc29sZS5sb2coJ1JlZHVjaW5nIGNhbnZhcyBzaXplIGR1ZSB0byBlcnJvciAxMjg2IScpOwogICAgICBjYW52YXMud2lkdGggPSBNYXRoLnJvdW5kKGNhbnZhcy53aWR0aCAvIDIpOwogICAgICBjYW52YXMuaGVpZ2h0ID0gTWF0aC5yb3VuZChjYW52YXMuaGVpZ2h0IC8gMik7CiAgICB9CiAgfSAvLyBWZXJ0ZXggc2hhZGVyIGZvciBlcXVpcmVjdGFuZ3VsYXIgYW5kIGN1YmUKCgogIHZhciB2ID0gWydhdHRyaWJ1dGUgdmVjMiBhX3RleENvb3JkOycsICd2YXJ5aW5nIHZlYzIgdl90ZXhDb29yZDsnLCAndm9pZCBtYWluKCkgeycsIC8vIFNldCBwb3NpdGlvbgogICdnbF9Qb3NpdGlvbiA9IHZlYzQoYV90ZXhDb29yZCwgMC4wLCAxLjApOycsIC8vIFBhc3MgdGhlIGNvb3JkaW5hdGVzIHRvIHRoZSBmcmFnbWVudCBzaGFkZXIKICAndl90ZXhDb29yZCA9IGFfdGV4Q29vcmQ7JywgJ30nXS5qb2luKCcnKTsgLy8gVmVydGV4IHNoYWRlciBmb3IgbXVsdGlyZXMKCiAgdmFyIHZNdWx0aSA9IFsnYXR0cmlidXRlIHZlYzMgYV92ZXJ0Q29vcmQ7JywgJ2F0dHJpYnV0ZSB2ZWMyIGFfdGV4Q29vcmQ7JywgJ3VuaWZvcm0gbWF0NCB1X2N1YmVNYXRyaXg7JywgJ3VuaWZvcm0gbWF0NCB1X3BlcnNwTWF0cml4OycsICd2YXJ5aW5nIG1lZGl1bXAgdmVjMiB2X3RleENvb3JkOycsICd2b2lkIG1haW4odm9pZCkgeycsIC8vIFNldCBwb3NpdGlvbgogICdnbF9Qb3NpdGlvbiA9IHVfcGVyc3BNYXRyaXggKiB1X2N1YmVNYXRyaXggKiB2ZWM0KGFfdmVydENvb3JkLCAxLjApOycsIC8vIFBhc3MgdGhlIGNvb3JkaW5hdGVzIHRvIHRoZSBmcmFnbWVudCBzaGFkZXIKICAndl90ZXhDb29yZCA9IGFfdGV4Q29vcmQ7JywgJ30nXS5qb2luKCcnKTsgLy8gRnJhZ21lbnQgc2hhZGVyCgogIHZhciBmcmFnRXF1aUN1YmVCYXNlID0gWydwcmVjaXNpb24gaGlnaHAgZmxvYXQ7JywgLy8gbWVkaXVtcCBsb29rcyBiYWQgb24gc29tZSBtb2JpbGUgZGV2aWNlcwogICd1bmlmb3JtIGZsb2F0IHVfYXNwZWN0UmF0aW87JywgJ3VuaWZvcm0gZmxvYXQgdV9wc2k7JywgJ3VuaWZvcm0gZmxvYXQgdV90aGV0YTsnLCAndW5pZm9ybSBmbG9hdCB1X2Y7JywgJ3VuaWZvcm0gZmxvYXQgdV9oOycsICd1bmlmb3JtIGZsb2F0IHVfdjsnLCAndW5pZm9ybSBmbG9hdCB1X3ZvOycsICd1bmlmb3JtIGZsb2F0IHVfcm90OycsICdjb25zdCBmbG9hdCBQSSA9IDMuMTQxNTkyNjUzNTg5NzkzMjM4NDYyNjQ7JywgLy8gVGV4dHVyZQogICd1bmlmb3JtIHNhbXBsZXIyRCB1X2ltYWdlMDsnLCAndW5pZm9ybSBzYW1wbGVyMkQgdV9pbWFnZTE7JywgJ3VuaWZvcm0gYm9vbCB1X3NwbGl0SW1hZ2U7JywgJ3VuaWZvcm0gc2FtcGxlckN1YmUgdV9pbWFnZUN1YmU7JywgLy8gQ29vcmRpbmF0ZXMgcGFzc2VkIGluIGZyb20gdmVydGV4IHNoYWRlcgogICd2YXJ5aW5nIHZlYzIgdl90ZXhDb29yZDsnLCAvLyBCYWNrZ3JvdW5kIGNvbG9yIChkaXNwbGF5IGZvciBwYXJ0aWFsIHBhbm9yYW1hcykKICAndW5pZm9ybSB2ZWM0IHVfYmFja2dyb3VuZENvbG9yOycsICd2b2lkIG1haW4oKSB7JywgLy8gTWFwIGNhbnZhcy9jYW1lcmEgdG8gc3BoZXJlCiAgJ2Zsb2F0IHggPSB2X3RleENvb3JkLnggKiB1X2FzcGVjdFJhdGlvOycsICdmbG9hdCB5ID0gdl90ZXhDb29yZC55OycsICdmbG9hdCBzaW5yb3QgPSBzaW4odV9yb3QpOycsICdmbG9hdCBjb3Nyb3QgPSBjb3ModV9yb3QpOycsICdmbG9hdCByb3RfeCA9IHggKiBjb3Nyb3QgLSB5ICogc2lucm90OycsICdmbG9hdCByb3RfeSA9IHggKiBzaW5yb3QgKyB5ICogY29zcm90OycsICdmbG9hdCBzaW50aGV0YSA9IHNpbih1X3RoZXRhKTsnLCAnZmxvYXQgY29zdGhldGEgPSBjb3ModV90aGV0YSk7JywgJ2Zsb2F0IGEgPSB1X2YgKiBjb3N0aGV0YSAtIHJvdF95ICogc2ludGhldGE7JywgJ2Zsb2F0IHJvb3QgPSBzcXJ0KHJvdF94ICogcm90X3ggKyBhICogYSk7JywgJ2Zsb2F0IGxhbWJkYSA9IGF0YW4ocm90X3ggLyByb290LCBhIC8gcm9vdCkgKyB1X3BzaTsnLCAnZmxvYXQgcGhpID0gYXRhbigocm90X3kgKiBjb3N0aGV0YSArIHVfZiAqIHNpbnRoZXRhKSAvIHJvb3QpOyddLmpvaW4oJ1xuJyk7IC8vIEZyYWdtZW50IHNoYWRlcgoKICB2YXIgZnJhZ0N1YmUgPSBmcmFnRXF1aUN1YmVCYXNlICsgWy8vIExvb2sgdXAgY29sb3IgZnJvbSB0ZXh0dXJlCiAgJ2Zsb2F0IGNvc3BoaSA9IGNvcyhwaGkpOycsICdnbF9GcmFnQ29sb3IgPSB0ZXh0dXJlQ3ViZSh1X2ltYWdlQ3ViZSwgdmVjMyhjb3NwaGkqc2luKGxhbWJkYSksIHNpbihwaGkpLCBjb3NwaGkqY29zKGxhbWJkYSkpKTsnLCAnfSddLmpvaW4oJ1xuJyk7IC8vIEZyYWdtZW50IHNoYWRlcgoKICB2YXIgZnJhZ0VxdWlyZWN0YW5ndWxhciA9IGZyYWdFcXVpQ3ViZUJhc2UgKyBbLy8gV3JhcCBpbWFnZQogICdsYW1iZGEgPSBtb2QobGFtYmRhICsgUEksIFBJICogMi4wKSAtIFBJOycsIC8vIE1hcCB0ZXh0dXJlIHRvIHNwaGVyZQogICd2ZWMyIGNvb3JkID0gdmVjMihsYW1iZGEgLyBQSSwgcGhpIC8gKFBJIC8gMi4wKSk7JywgLy8gTG9vayB1cCBjb2xvciBmcm9tIHRleHR1cmUKICAvLyBNYXAgZnJvbSBbLTEsMV0gdG8gWzAsMV0gYW5kIGZsaXAgeS1heGlzCiAgJ2lmKGNvb3JkLnggPCAtdV9oIHx8IGNvb3JkLnggPiB1X2ggfHwgY29vcmQueSA8IC11X3YgKyB1X3ZvIHx8IGNvb3JkLnkgPiB1X3YgKyB1X3ZvKScsICdnbF9GcmFnQ29sb3IgPSB1X2JhY2tncm91bmRDb2xvcjsnLCAnZWxzZSB7JywgJ2lmKHVfc3BsaXRJbWFnZSkgeycsIC8vIEltYWdlIHdhcyBzcGxpdCBpbnRvIHR3byB0ZXh0dXJlcyB0byB3b3JrIGFyb3VuZCB0ZXh0dXJlIHNpemUgbGltaXRzCiAgJ2lmKGNvb3JkLnggPCAwLjApJywgJ2dsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCh1X2ltYWdlMCwgdmVjMigoY29vcmQueCArIHVfaCkgLyB1X2gsICgtY29vcmQueSArIHVfdiArIHVfdm8pIC8gKHVfdiAqIDIuMCkpKTsnLCAnZWxzZScsICdnbF9GcmFnQ29sb3IgPSB0ZXh0dXJlMkQodV9pbWFnZTEsIHZlYzIoKGNvb3JkLnggKyB1X2gpIC8gdV9oIC0gMS4wLCAoLWNvb3JkLnkgKyB1X3YgKyB1X3ZvKSAvICh1X3YgKiAyLjApKSk7JywgJ30gZWxzZSB7JywgJ2dsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCh1X2ltYWdlMCwgdmVjMigoY29vcmQueCArIHVfaCkgLyAodV9oICogMi4wKSwgKC1jb29yZC55ICsgdV92ICsgdV92bykgLyAodV92ICogMi4wKSkpOycsICd9JywgJ30nLCAnfSddLmpvaW4oJ1xuJyk7IC8vIEZyYWdtZW50IHNoYWRlcgoKICB2YXIgZnJhZ011bHRpID0gWyd2YXJ5aW5nIG1lZGl1bXAgdmVjMiB2X3RleENvb3JkOycsICd1bmlmb3JtIHNhbXBsZXIyRCB1X3NhbXBsZXI7JywgLy8ndW5pZm9ybSBtZWRpdW1wIHZlYzQgdV9jb2xvcjsnLAogICd2b2lkIG1haW4odm9pZCkgeycsIC8vIExvb2sgdXAgY29sb3IgZnJvbSB0ZXh0dXJlCiAgJ2dsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCh1X3NhbXBsZXIsIHZfdGV4Q29vcmQpOycsIC8vICAgICdnbF9GcmFnQ29sb3IgPSB1X2NvbG9yOycsCiAgJ30nXS5qb2luKCcnKTsKICByZXR1cm4gewogICAgcmVuZGVyZXI6IGZ1bmN0aW9uIHJlbmRlcmVyKGNvbnRhaW5lciwgaW1hZ2UsIGltYWdldHlwZSwgZHluYW1pYykgewogICAgICByZXR1cm4gbmV3IFJlbmRlcmVyKGNvbnRhaW5lciwgaW1hZ2UsIGltYWdldHlwZSwgZHluYW1pYyk7CiAgICB9CiAgfTsKfSh3aW5kb3csIGRvY3VtZW50KTs="},{"version":3,"sources":["D:/Практика/Vue practice/vue-pannellum-interface/src/pannellum-2.5.6/src/js/libpannellum.js"],"names":["window","libpannellum","document","undefined","Renderer","container","canvas","createElement","style","width","height","appendChild","program","gl","vs","fs","fallbackImgSize","world","vtmps","pose","image","imageType","dynamic","texCoordBuffer","cubeVertBuf","cubeVertTexCoordBuf","cubeVertIndBuf","globalParams","init","_image","_imageType","_dynamic","haov","vaov","voffset","callback","params","console","log","type","detachShader","deleteShader","bindBuffer","ARRAY_BUFFER","ELEMENT_ARRAY_BUFFER","texture","deleteTexture","nodeCache","i","length","deleteProgram","s","faceMissing","cubeImgWidth","fillMissingFaces","imgSize","nbytes","imageArray","Uint8ClampedArray","rgb","backgroundColor","backgroundSquare","ImageData","navigator","userAgent","toLowerCase","match","getContext","alpha","depth","getError","handleWebGLError1286","hasOwnProperty","documentElement","appVersion","indexOf","removeChild","className","path","basePath","fallbackPath","sides","loaded","onLoad","faceCanvas","side","faceContext","drawImage","imgData","getImageData","data","j","putImageData","incLoaded","call","faceImg","Image","crossOrigin","onload","onerror","src","replace","extension","fullpath","invTileResolution","tileResolution","vertices","createCube","slice","maxWidth","getParameter","MAX_TEXTURE_SIZE","Math","max","MAX_CUBE_MAP_TEXTURE_SIZE","horizonPitch","horizonRoll","glBindType","TEXTURE_2D","viewport","drawingBufferWidth","drawingBufferHeight","getShaderPrecisionFormat","precision","FRAGMENT_SHADER","HIGH_FLOAT","fragEquiCubeBase","createShader","VERTEX_SHADER","vertexSrc","v","vMulti","shaderSource","compileShader","fragmentSrc","fragEquirectangular","TEXTURE_CUBE_MAP","fragCube","fragMulti","createProgram","attachShader","linkProgram","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","getProgramParameter","LINK_STATUS","getProgramInfoLog","useProgram","drawInProgress","color","clearColor","clear","COLOR_BUFFER_BIT","texCoordLocation","getAttribLocation","enableVertexAttribArray","createBuffer","bufferData","Float32Array","STATIC_DRAW","vertexAttribPointer","FLOAT","aspectRatio","getUniformLocation","uniform1f","psi","theta","f","h","vo","rot","PI","uniform4fv","concat","createTexture","bindTexture","texImage2D","TEXTURE_CUBE_MAP_POSITIVE_X","RGB","UNSIGNED_BYTE","TEXTURE_CUBE_MAP_NEGATIVE_X","TEXTURE_CUBE_MAP_POSITIVE_Y","TEXTURE_CUBE_MAP_NEGATIVE_Y","TEXTURE_CUBE_MAP_POSITIVE_Z","TEXTURE_CUBE_MAP_NEGATIVE_Z","uniform1i","cropCanvas","cropContext","cropImage","texture2","activeTexture","TEXTURE1","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","TEXTURE_MIN_FILTER","LINEAR","TEXTURE_MAG_FILTER","TEXTURE0","vertPosLocation","Uint16Array","perspUniform","cubeUniform","level","currentNodes","nodeCacheTimestamp","err","destroy","contains","getExtension","loseContext","resize","pixelRatio","devicePixelRatio","clientWidth","clientHeight","setPose","render","pitch","yaw","hfov","focal","roll","orig_pitch","orig_yaw","x","cos","sin","y","z","asin","min","atan2","w","roll_adj","acos","sqrt","transforms","b","u","d","l","r","tan","zoom","transform","faces","Object","keys","face","querySelector","webkitTransform","vfov","atan","drawArrays","TRIANGLES","perspMatrix","makePersp","checkZoom","matrix","identityMatrix3","rotateMatrix","makeMatrix4","uniformMatrix4fv","transposeMatrix4","rotPersp","rotatePersp","sort","multiresNodeSort","removed","splice","ntmp","MultiresNode","testMultiresNode","multiresNodeRenderSort","pendingTextureRequests","node","textureLoad","setTimeout","processNextTile","multiresDraw","returnImage","toDataURL","isLoading","textureLoaded","getCanvas","a","timestamp","diff","drawElements","UNSIGNED_SHORT","checkSquareInView","phi","ydiff","abs","inCurrent","k","push","cubeSize","cubeResolution","pow","maxLevel","numTiles","ceil","doubleTileSize","lastTileSize","children","vtmp","f1","f2","f3","i1","i2","i3","m","angle","axis","c","aspect","znear","zfar","fovy","processLoadedTexture","img","tex","loadTexture","cacheTop","textureImageCache","TextureImageLoader","self","loadFn","releaseTextureImageLoader","addEventListener","prototype","PendingTextureRequest","til","req","shift","_crossOrigin","newLevel","p","applyRotPerspToVec","checkInView","vpp","winX","winY","winZ","ret","check1","check2","check3","check4","testX","testY","testZ","round","join","renderer","imagetype"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEAA,MAAM,CAACC,YAAP,GAAuB,UAASD,MAAT,EAAiBE,QAAjB,EAA2BC,SAA3B,EAAsC;AAE7D;AAEA;AACA;AACA;AACA;AACA;;AACA,WAASC,QAAT,CAAkBC,SAAlB,EAA6B;AACzB,QAAIC,MAAM,GAAGJ,QAAQ,CAACK,aAAT,CAAuB,QAAvB,CAAb;AACAD,IAAAA,MAAM,CAACE,KAAP,CAAaC,KAAb,GAAqBH,MAAM,CAACE,KAAP,CAAaE,MAAb,GAAsB,MAA3C;AACAL,IAAAA,SAAS,CAACM,WAAV,CAAsBL,MAAtB;AAEA,QAAIM,OAAJ,EAAaC,EAAb,EAAiBC,EAAjB,EAAqBC,EAArB;AACA,QAAIC,eAAJ;AACA,QAAIC,KAAJ;AACA,QAAIC,KAAJ;AACA,QAAIC,IAAJ;AACA,QAAIC,KAAJ,EAAWC,SAAX,EAAsBC,OAAtB;AACA,QAAIC,cAAJ,EAAoBC,WAApB,EAAiCC,mBAAjC,EAAsDC,cAAtD;AACA,QAAIC,YAAJ;AAEA;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACI,SAAKC,IAAL,GAAY,UAASC,MAAT,EAAiBC,UAAjB,EAA6BC,QAA7B,EAAuCC,IAAvC,EAA6CC,IAA7C,EAAmDC,OAAnD,EAA4DC,QAA5D,EAAsEC,MAAtE,EAA8E;AACtF;AACA,UAAIN,UAAU,KAAK3B,SAAnB,EACI2B,UAAU,GAAG,iBAAb;;AAEJ,UAAIA,UAAU,IAAI,iBAAd,IAAmCA,UAAU,IAAI,SAAjD,IACAA,UAAU,IAAI,UADlB,EAC8B;AAC1BO,QAAAA,OAAO,CAACC,GAAR,CAAY,sCAAZ;AACA,cAAM;AAACC,UAAAA,IAAI,EAAE;AAAP,SAAN;AACH;;AAEDlB,MAAAA,SAAS,GAAGS,UAAZ;AACAV,MAAAA,KAAK,GAAGS,MAAR;AACAP,MAAAA,OAAO,GAAGS,QAAV;AACAJ,MAAAA,YAAY,GAAGS,MAAM,IAAI,EAAzB,CAdsF,CAgBtF;;AACA,UAAIxB,OAAJ,EAAa;AACT,YAAIE,EAAJ,EAAQ;AACJD,UAAAA,EAAE,CAAC2B,YAAH,CAAgB5B,OAAhB,EAAyBE,EAAzB;AACAD,UAAAA,EAAE,CAAC4B,YAAH,CAAgB3B,EAAhB;AACH;;AACD,YAAIC,EAAJ,EAAQ;AACJF,UAAAA,EAAE,CAAC2B,YAAH,CAAgB5B,OAAhB,EAAyBG,EAAzB;AACAF,UAAAA,EAAE,CAAC4B,YAAH,CAAgB1B,EAAhB;AACH;;AACDF,QAAAA,EAAE,CAAC6B,UAAH,CAAc7B,EAAE,CAAC8B,YAAjB,EAA+B,IAA/B;AACA9B,QAAAA,EAAE,CAAC6B,UAAH,CAAc7B,EAAE,CAAC+B,oBAAjB,EAAuC,IAAvC;AACA,YAAIhC,OAAO,CAACiC,OAAZ,EACIhC,EAAE,CAACiC,aAAH,CAAiBlC,OAAO,CAACiC,OAAzB;AACJ,YAAIjC,OAAO,CAACmC,SAAZ,EACI,KAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGpC,OAAO,CAACmC,SAAR,CAAkBE,MAAtC,EAA8CD,CAAC,EAA/C;AACInC,UAAAA,EAAE,CAACiC,aAAH,CAAiBlC,OAAO,CAACmC,SAAR,CAAkBC,CAAlB,EAAqBH,OAAtC;AADJ;AAEJhC,QAAAA,EAAE,CAACqC,aAAH,CAAiBtC,OAAjB;AACAA,QAAAA,OAAO,GAAGT,SAAV;AACH;;AACDgB,MAAAA,IAAI,GAAGhB,SAAP;AAEA,UAAIgD,CAAJ;AACA,UAAIC,WAAW,GAAG,KAAlB;AACA,UAAIC,YAAJ;;AACA,UAAIhC,SAAS,IAAI,SAAjB,EAA4B;AACxB,aAAK8B,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,CAAhB,EAAmBA,CAAC,EAApB,EAAwB;AACpB,cAAI/B,KAAK,CAAC+B,CAAD,CAAL,CAAS1C,KAAT,GAAiB,CAArB,EAAwB;AACpB,gBAAI4C,YAAY,KAAKlD,SAArB,EACIkD,YAAY,GAAGjC,KAAK,CAAC+B,CAAD,CAAL,CAAS1C,KAAxB;AACJ,gBAAI4C,YAAY,IAAIjC,KAAK,CAAC+B,CAAD,CAAL,CAAS1C,KAA7B,EACI4B,OAAO,CAACC,GAAR,CAAY,0CAA0Ce,YAA1C,GAAyD,OAAzD,GAAmEjC,KAAK,CAAC+B,CAAD,CAAL,CAAS1C,KAAxF;AACP,WALD,MAMI2C,WAAW,GAAG,IAAd;AACP;AACJ;;AACD,eAASE,gBAAT,CAA0BC,OAA1B,EAAmC;AAC/B,YAAIH,WAAJ,EAAiB;AAAE;AACf,cAAII,MAAM,GAAGD,OAAO,GAAGA,OAAV,GAAoB,CAAjC,CADa,CACuB;;AACpC,cAAIE,UAAU,GAAG,IAAIC,iBAAJ,CAAsBF,MAAtB,CAAjB;AACA,cAAIG,GAAG,GAAGvB,MAAM,CAACwB,eAAP,GAAyBxB,MAAM,CAACwB,eAAhC,GAAkD,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAA5D;AACAD,UAAAA,GAAG,CAAC,CAAD,CAAH,IAAU,GAAV;AACAA,UAAAA,GAAG,CAAC,CAAD,CAAH,IAAU,GAAV;AACAA,UAAAA,GAAG,CAAC,CAAD,CAAH,IAAU,GAAV,CANa,CAOb;;AACA,eAAK,IAAIX,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGQ,MAApB,EAA4BR,CAAC,EAA7B,EAAiC;AAC7BS,YAAAA,UAAU,CAACT,CAAC,EAAF,CAAV,GAAkBW,GAAG,CAAC,CAAD,CAArB;AACAF,YAAAA,UAAU,CAACT,CAAC,EAAF,CAAV,GAAkBW,GAAG,CAAC,CAAD,CAArB;AACAF,YAAAA,UAAU,CAACT,CAAC,EAAF,CAAV,GAAkBW,GAAG,CAAC,CAAD,CAArB;AACH;;AACD,cAAIE,gBAAgB,GAAG,IAAIC,SAAJ,CAAcL,UAAd,EAA0BF,OAA1B,EAAmCA,OAAnC,CAAvB;;AACA,eAAKJ,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,CAAhB,EAAmBA,CAAC,EAApB,EAAwB;AACpB,gBAAI/B,KAAK,CAAC+B,CAAD,CAAL,CAAS1C,KAAT,IAAkB,CAAtB,EACIW,KAAK,CAAC+B,CAAD,CAAL,GAAWU,gBAAX;AACP;AACJ;AACJ,OAxEqF,CA0EtF;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,UAAI,EAAExC,SAAS,IAAI,SAAb,IACF,CAACgC,YAAY,GAAIA,YAAY,GAAG,CAAhC,MAAwC,CADtC,KAEDU,SAAS,CAACC,SAAV,CAAoBC,WAApB,GAAkCC,KAAlC,CAAwC,4BAAxC,KACDH,SAAS,CAACC,SAAV,CAAoBC,WAApB,GAAkCC,KAAlC,CAAwC,4BAAxC,CADC,IAEDH,SAAS,CAACC,SAAV,CAAoBC,WAApB,GAAkCC,KAAlC,CAAwC,6BAAxC,CAFC,IAGDH,SAAS,CAACC,SAAV,CAAoBE,KAApB,CAA0B,sBAA1B,CALE,CAAF,CAAJ,EAKyD;AACrD;AACA,YAAI,CAACrD,EAAL,EACIA,EAAE,GAAGP,MAAM,CAAC6D,UAAP,CAAkB,oBAAlB,EAAwC;AAACC,UAAAA,KAAK,EAAE,KAAR;AAAeC,UAAAA,KAAK,EAAE;AAAtB,SAAxC,CAAL;AACJ,YAAIxD,EAAE,IAAIA,EAAE,CAACyD,QAAH,MAAiB,IAA3B,EACIC,oBAAoB;AAC3B,OA5FqF,CA8FtF;AACA;AACA;AACA;AACA;;;AACA,UAAI,CAAC1D,EAAD,KAASQ,SAAS,IAAI,UAAb,IAA2BD,KAAK,CAACoD,cAAN,CAAqB,cAArB,CAA5B,IACRnD,SAAS,IAAI,SADb,MAEC,sBAAsBnB,QAAQ,CAACuE,eAAT,CAAyBjE,KAA/C,IACDuD,SAAS,CAACC,SAAV,CAAoBE,KAApB,CAA0B,sBAA1B,CADC,IAEDH,SAAS,CAACW,UAAV,CAAqBC,OAArB,CAA6B,SAA7B,MAA4C,CAAC,CAJ7C,CAAJ,EAIqD;AACjD;AACA,YAAI1D,KAAJ,EAAW;AACPZ,UAAAA,SAAS,CAACuE,WAAV,CAAsB3D,KAAtB;AACH,SAJgD,CAMjD;;;AACAA,QAAAA,KAAK,GAAGf,QAAQ,CAACK,aAAT,CAAuB,KAAvB,CAAR;AACAU,QAAAA,KAAK,CAAC4D,SAAN,GAAkB,YAAlB,CARiD,CAUjD;;AACA,YAAIC,IAAJ;;AACA,YAAI1D,KAAK,CAAC2D,QAAV,EAAoB;AAChBD,UAAAA,IAAI,GAAG1D,KAAK,CAAC2D,QAAN,GAAiB3D,KAAK,CAAC4D,YAA9B;AACH,SAFD,MAEO;AACHF,UAAAA,IAAI,GAAG1D,KAAK,CAAC4D,YAAb;AACH;;AACD,YAAIC,KAAK,GAAG,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,EAAgB,GAAhB,EAAqB,GAArB,EAA0B,GAA1B,CAAZ;AACA,YAAIC,MAAM,GAAG,CAAb;;AACA,YAAIC,MAAM,GAAG,SAATA,MAAS,GAAW;AACpB;AACA,cAAIC,UAAU,GAAGlF,QAAQ,CAACK,aAAT,CAAuB,QAAvB,CAAjB;AACA6E,UAAAA,UAAU,CAACP,SAAX,GAAuB,oBAAoBI,KAAK,CAAC,KAAKI,IAAN,CAAzB,GAAuC,MAA9D;AACApE,UAAAA,KAAK,CAACN,WAAN,CAAkByE,UAAlB;AACA,cAAIE,WAAW,GAAGF,UAAU,CAACjB,UAAX,CAAsB,IAAtB,CAAlB;AACAiB,UAAAA,UAAU,CAAC5E,KAAX,CAAiBC,KAAjB,GAAyB,KAAKA,KAAL,GAAa,CAAb,GAAiB,IAA1C;AACA2E,UAAAA,UAAU,CAAC5E,KAAX,CAAiBE,MAAjB,GAA0B,KAAKA,MAAL,GAAc,CAAd,GAAkB,IAA5C;AACA0E,UAAAA,UAAU,CAAC3E,KAAX,GAAmB,KAAKA,KAAL,GAAa,CAAhC;AACA2E,UAAAA,UAAU,CAAC1E,MAAX,GAAoB,KAAKA,MAAL,GAAc,CAAlC;AACA4E,UAAAA,WAAW,CAACC,SAAZ,CAAsB,IAAtB,EAA4B,CAA5B,EAA+B,CAA/B;AACA,cAAIC,OAAO,GAAGF,WAAW,CAACG,YAAZ,CAAyB,CAAzB,EAA4B,CAA5B,EAA+BL,UAAU,CAAC3E,KAA1C,EAAiD2E,UAAU,CAAC1E,MAA5D,CAAd;AACA,cAAIgF,IAAI,GAAGF,OAAO,CAACE,IAAnB,CAZoB,CAcpB;;AACA,cAAI1C,CAAJ;AACA,cAAI2C,CAAJ;;AACA,eAAK3C,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAGoC,UAAU,CAAC3E,KAAX,GAAmB,CAAnC,EAAsCuC,CAAC,EAAvC,EAA2C;AACvC,iBAAK2C,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,CAAhB,EAAmBA,CAAC,EAApB,EAAwB;AACpBD,cAAAA,IAAI,CAAC,CAAC1C,CAAC,GAAGoC,UAAU,CAAC3E,KAAhB,IAAyB,CAAzB,GAA6BkF,CAA9B,CAAJ,GAAuCD,IAAI,CAAC,CAAC1C,CAAC,GAAGoC,UAAU,CAAC3E,KAAX,GAAmB,CAAxB,IAA6B,CAA7B,GAAiCkF,CAAlC,CAA3C;AACAD,cAAAA,IAAI,CAAC,CAAC1C,CAAC,GAAGoC,UAAU,CAAC3E,KAAX,IAAoB2E,UAAU,CAAC1E,MAAX,GAAoB,CAAxC,CAAL,IAAmD,CAAnD,GAAuDiF,CAAxD,CAAJ,GAAiED,IAAI,CAAC,CAAC1C,CAAC,GAAGoC,UAAU,CAAC3E,KAAX,IAAoB2E,UAAU,CAAC1E,MAAX,GAAoB,CAAxC,CAAL,IAAmD,CAAnD,GAAuDiF,CAAxD,CAArE;AACH;AACJ;;AACD,eAAK3C,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAGoC,UAAU,CAAC1E,MAAX,GAAoB,CAApC,EAAuCsC,CAAC,EAAxC,EAA4C;AACxC,iBAAK2C,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,CAAhB,EAAmBA,CAAC,EAApB,EAAwB;AACpBD,cAAAA,IAAI,CAAC,CAAC1C,CAAC,GAAGoC,UAAU,CAAC3E,KAAf,GAAuB,CAAxB,IAA6B,CAA7B,GAAiCkF,CAAlC,CAAJ,GAA2CD,IAAI,CAAC,CAAC1C,CAAC,GAAGoC,UAAU,CAAC3E,KAAf,GAAuB,CAAxB,IAA6B,CAA7B,GAAiCkF,CAAlC,CAA/C;AACAD,cAAAA,IAAI,CAAC,CAAC,CAAC1C,CAAC,GAAG,CAAL,IAAUoC,UAAU,CAAC3E,KAArB,GAA6B,CAA9B,IAAmC,CAAnC,GAAuCkF,CAAxC,CAAJ,GAAiDD,IAAI,CAAC,CAAC,CAAC1C,CAAC,GAAG,CAAL,IAAUoC,UAAU,CAAC3E,KAArB,GAA6B,CAA9B,IAAmC,CAAnC,GAAuCkF,CAAxC,CAArD;AACH;AACJ;;AACD,eAAKA,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,CAAhB,EAAmBA,CAAC,EAApB,EAAwB;AACpBD,YAAAA,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,GAAmB,CAApB,IAAyB,CAAzB,GAA6BkF,CAA9B,CAAJ,GAAuCD,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,GAAmB,CAAnB,GAAuB,CAAxB,IAA6B,CAA7B,GAAiCkF,CAAlC,CAA3C;AACAD,YAAAA,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,GAAmB,CAAnB,GAAuB,CAAxB,IAA6B,CAA7B,GAAiCkF,CAAlC,CAAJ,GAA2CD,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,GAAmB,CAAnB,GAAuB,CAAxB,IAA6B,CAA7B,GAAiCkF,CAAlC,CAA/C;AACAD,YAAAA,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,IAAoB2E,UAAU,CAAC1E,MAAX,GAAoB,CAAxC,IAA6C,CAA9C,IAAmD,CAAnD,GAAuDiF,CAAxD,CAAJ,GAAiED,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,IAAoB2E,UAAU,CAAC1E,MAAX,GAAoB,CAAxC,IAA6C,CAA9C,IAAmD,CAAnD,GAAuDiF,CAAxD,CAArE;AACAD,YAAAA,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,IAAoB2E,UAAU,CAAC1E,MAAX,GAAoB,CAAxC,IAA6C,CAA9C,IAAmD,CAAnD,GAAuDiF,CAAxD,CAAJ,GAAiED,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,IAAoB2E,UAAU,CAAC1E,MAAX,GAAoB,CAAxC,IAA6C,CAA9C,IAAmD,CAAnD,GAAuDiF,CAAxD,CAArE;AACH;;AACD,eAAK3C,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAGoC,UAAU,CAAC3E,KAAX,GAAmB,CAAnC,EAAsCuC,CAAC,EAAvC,EAA2C;AACvC,iBAAK2C,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,CAAhB,EAAmBA,CAAC,EAApB,EAAwB;AACpBD,cAAAA,IAAI,CAAC1C,CAAC,GAAG,CAAJ,GAAQ2C,CAAT,CAAJ,GAAkBD,IAAI,CAAC,CAAC1C,CAAC,GAAGoC,UAAU,CAAC3E,KAAhB,IAAyB,CAAzB,GAA6BkF,CAA9B,CAAtB;AACAD,cAAAA,IAAI,CAAC,CAAC1C,CAAC,GAAGoC,UAAU,CAAC3E,KAAX,IAAoB2E,UAAU,CAAC1E,MAAX,GAAoB,CAAxC,CAAL,IAAmD,CAAnD,GAAuDiF,CAAxD,CAAJ,GAAiED,IAAI,CAAC,CAAC1C,CAAC,GAAGoC,UAAU,CAAC3E,KAAX,IAAoB2E,UAAU,CAAC1E,MAAX,GAAoB,CAAxC,CAAL,IAAmD,CAAnD,GAAuDiF,CAAxD,CAArE;AACH;AACJ;;AACD,eAAK3C,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAGoC,UAAU,CAAC1E,MAAX,GAAoB,CAApC,EAAuCsC,CAAC,EAAxC,EAA4C;AACxC,iBAAK2C,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,CAAhB,EAAmBA,CAAC,EAApB,EAAwB;AACpBD,cAAAA,IAAI,CAAE1C,CAAC,GAAGoC,UAAU,CAAC3E,KAAhB,GAAyB,CAAzB,GAA6BkF,CAA9B,CAAJ,GAAuCD,IAAI,CAAC,CAAC1C,CAAC,GAAGoC,UAAU,CAAC3E,KAAf,GAAuB,CAAxB,IAA6B,CAA7B,GAAiCkF,CAAlC,CAA3C;AACAD,cAAAA,IAAI,CAAC,CAAC,CAAC1C,CAAC,GAAG,CAAL,IAAUoC,UAAU,CAAC3E,KAArB,GAA6B,CAA9B,IAAmC,CAAnC,GAAuCkF,CAAxC,CAAJ,GAAiDD,IAAI,CAAC,CAAC,CAAC1C,CAAC,GAAG,CAAL,IAAUoC,UAAU,CAAC3E,KAArB,GAA6B,CAA9B,IAAmC,CAAnC,GAAuCkF,CAAxC,CAArD;AACH;AACJ;;AACD,eAAKA,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,CAAhB,EAAmBA,CAAC,EAApB,EAAwB;AACpBD,YAAAA,IAAI,CAACC,CAAD,CAAJ,GAAUD,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,GAAmB,CAApB,IAAyB,CAAzB,GAA6BkF,CAA9B,CAAd;AACAD,YAAAA,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,GAAmB,CAApB,IAAyB,CAAzB,GAA6BkF,CAA9B,CAAJ,GAAuCD,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,GAAmB,CAAnB,GAAuB,CAAxB,IAA6B,CAA7B,GAAiCkF,CAAlC,CAA3C;AACAD,YAAAA,IAAI,CAAEN,UAAU,CAAC3E,KAAX,IAAoB2E,UAAU,CAAC1E,MAAX,GAAoB,CAAxC,CAAD,GAA+C,CAA/C,GAAmDiF,CAApD,CAAJ,GAA6DD,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,IAAoB2E,UAAU,CAAC1E,MAAX,GAAoB,CAAxC,IAA6C,CAA9C,IAAmD,CAAnD,GAAuDiF,CAAxD,CAAjE;AACAD,YAAAA,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,GAAmB2E,UAAU,CAAC1E,MAA9B,GAAuC,CAAxC,IAA6C,CAA7C,GAAiDiF,CAAlD,CAAJ,GAA2DD,IAAI,CAAC,CAACN,UAAU,CAAC3E,KAAX,IAAoB2E,UAAU,CAAC1E,MAAX,GAAoB,CAAxC,IAA6C,CAA9C,IAAmD,CAAnD,GAAuDiF,CAAxD,CAA/D;AACH,WApDmB,CAsDpB;;;AACAL,UAAAA,WAAW,CAACM,YAAZ,CAAyBJ,OAAzB,EAAkC,CAAlC,EAAqC,CAArC;AAEAK,UAAAA,SAAS,CAACC,IAAV,CAAe,IAAf;AACH,SA1DD;;AA2DA,YAAID,SAAS,GAAG,SAAZA,SAAY,GAAW;AACvB,cAAI,KAAKpF,KAAL,GAAa,CAAjB,EAAoB;AAChB,gBAAIO,eAAe,KAAKb,SAAxB,EACIa,eAAe,GAAG,KAAKP,KAAvB;AACJ,gBAAIO,eAAe,IAAI,KAAKP,KAA5B,EACI4B,OAAO,CAACC,GAAR,CAAY,8CAA8CtB,eAA9C,GAAgE,OAAhE,GAA0E,KAAKP,KAA3F;AACP,WALD,MAMI2C,WAAW,GAAG,IAAd;;AACJ8B,UAAAA,MAAM;;AACN,cAAIA,MAAM,IAAI,CAAd,EAAiB;AACblE,YAAAA,eAAe,GAAG,KAAKP,KAAvB;AACAJ,YAAAA,SAAS,CAACM,WAAV,CAAsBM,KAAtB;AACAkB,YAAAA,QAAQ;AACX;AACJ,SAdD;;AAeAiB,QAAAA,WAAW,GAAG,KAAd;;AACA,aAAKD,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,CAAhB,EAAmBA,CAAC,EAApB,EAAwB;AACpB,cAAI4C,OAAO,GAAG,IAAIC,KAAJ,EAAd;AACAD,UAAAA,OAAO,CAACE,WAAR,GAAsBtE,YAAY,CAACsE,WAAb,GAA2BtE,YAAY,CAACsE,WAAxC,GAAsD,WAA5E;AACAF,UAAAA,OAAO,CAACV,IAAR,GAAelC,CAAf;AACA4C,UAAAA,OAAO,CAACG,MAAR,GAAiBf,MAAjB;AACAY,UAAAA,OAAO,CAACI,OAAR,GAAkBN,SAAlB,CALoB,CAKS;;AAC7B,cAAIxE,SAAS,IAAI,UAAjB,EAA6B;AACzB0E,YAAAA,OAAO,CAACK,GAAR,GAActB,IAAI,CAACuB,OAAL,CAAa,IAAb,EAAmBpB,KAAK,CAAC9B,CAAD,CAAxB,IAA+B,GAA/B,GAAqC/B,KAAK,CAACkF,SAAzD;AACH,WAFD,MAEO;AACHP,YAAAA,OAAO,CAACK,GAAR,GAAchF,KAAK,CAAC+B,CAAD,CAAL,CAASiD,GAAvB;AACH;AACJ;;AACD9C,QAAAA,gBAAgB,CAACtC,eAAD,CAAhB;AACA;AACH,OAhHD,MAgHO,IAAI,CAACH,EAAL,EAAS;AACZwB,QAAAA,OAAO,CAACC,GAAR,CAAY,mCAAZ;AACA,cAAM;AAACC,UAAAA,IAAI,EAAE;AAAP,SAAN;AACH;;AACD,UAAIlB,SAAS,IAAI,SAAjB,EACIiC,gBAAgB,CAACD,YAAD,CAAhB;;AACJ,UAAIjC,KAAK,CAAC2D,QAAV,EAAoB;AAChB3D,QAAAA,KAAK,CAACmF,QAAN,GAAiBnF,KAAK,CAAC2D,QAAN,GAAiB3D,KAAK,CAAC0D,IAAxC;AACH,OAFD,MAEO;AACH1D,QAAAA,KAAK,CAACmF,QAAN,GAAiBnF,KAAK,CAAC0D,IAAvB;AACH;;AACD1D,MAAAA,KAAK,CAACoF,iBAAN,GAA0B,IAAIpF,KAAK,CAACqF,cAApC;AAEA,UAAIC,QAAQ,GAAGC,UAAU,EAAzB;AACAzF,MAAAA,KAAK,GAAG,EAAR;;AACA,WAAKiC,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,CAAhB,EAAmBA,CAAC,EAApB,EAAwB;AACpBjC,QAAAA,KAAK,CAACiC,CAAD,CAAL,GAAWuD,QAAQ,CAACE,KAAT,CAAezD,CAAC,GAAG,EAAnB,EAAuBA,CAAC,GAAG,EAAJ,GAAS,EAAhC,CAAX;AACAuD,QAAAA,QAAQ,GAAGC,UAAU,EAArB;AACH,OArOqF,CAuOtF;;;AACA,UAAIE,QAAQ,GAAG,CAAf;;AACA,UAAIxF,SAAS,IAAI,iBAAjB,EAAoC;AAChCwF,QAAAA,QAAQ,GAAGhG,EAAE,CAACiG,YAAH,CAAgBjG,EAAE,CAACkG,gBAAnB,CAAX;;AACA,YAAIC,IAAI,CAACC,GAAL,CAAS7F,KAAK,CAACX,KAAN,GAAc,CAAvB,EAA0BW,KAAK,CAACV,MAAhC,IAA0CmG,QAA9C,EAAwD;AACpDxE,UAAAA,OAAO,CAACC,GAAR,CAAY,wCAAwClB,KAAK,CAACX,KAA9C,GAAsD,WAAtD,GACA,+CADA,GACmDoG,QAAQ,GAAG,CAD9D,GACmE,KAD/E;AAEA,gBAAM;AAACtE,YAAAA,IAAI,EAAE,kBAAP;AAA2B9B,YAAAA,KAAK,EAAEW,KAAK,CAACX,KAAxC;AAA+CoG,YAAAA,QAAQ,EAAEA,QAAQ,GAAG;AAApE,WAAN;AACH;AACJ,OAPD,MAOO,IAAIxF,SAAS,IAAI,SAAjB,EAA4B;AAC/B,YAAIgC,YAAY,GAAGxC,EAAE,CAACiG,YAAH,CAAgBjG,EAAE,CAACqG,yBAAnB,CAAnB,EAAkE;AAC9D7E,UAAAA,OAAO,CAACC,GAAR,CAAY,wCAAwCe,YAAxC,GAAuD,WAAvD,GACA,+CADA,GACkDwD,QADlD,GAC6D,KADzE;AAEA,gBAAM;AAACtE,YAAAA,IAAI,EAAE,kBAAP;AAA2B9B,YAAAA,KAAK,EAAE4C,YAAlC;AAAgDwD,YAAAA,QAAQ,EAAEA;AAA1D,WAAN;AACH;AACJ,OAtPqF,CAwPtF;;;AACA,UAAIzE,MAAM,KAAKjC,SAAX,KAAyBiC,MAAM,CAAC+E,YAAP,KAAwBhH,SAAxB,IAAqCiC,MAAM,CAACgF,WAAP,KAAuBjH,SAArF,CAAJ,EACIgB,IAAI,GAAG,CAACiB,MAAM,CAAC+E,YAAP,IAAuBhH,SAAvB,GAAmC,CAAnC,GAAuCiC,MAAM,CAAC+E,YAA/C,EACC/E,MAAM,CAACgF,WAAP,IAAsBjH,SAAtB,GAAkC,CAAlC,GAAsCiC,MAAM,CAACgF,WAD9C,CAAP,CA1PkF,CA6PtF;;AACA,UAAIC,UAAU,GAAGxG,EAAE,CAACyG,UAApB,CA9PsF,CAgQtF;;AACAzG,MAAAA,EAAE,CAAC0G,QAAH,CAAY,CAAZ,EAAe,CAAf,EAAkB1G,EAAE,CAAC2G,kBAArB,EAAyC3G,EAAE,CAAC4G,mBAA5C,EAjQsF,CAmQtF;;AACA,UAAI5G,EAAE,CAAC6G,wBAAP,EAAiC;AAC7B,YAAIC,SAAS,GAAG9G,EAAE,CAAC6G,wBAAH,CAA4B7G,EAAE,CAAC+G,eAA/B,EAAgD/G,EAAE,CAACgH,UAAnD,CAAhB;;AACA,YAAIF,SAAS,IAAIA,SAAS,CAACA,SAAV,GAAsB,CAAvC,EAA0C;AACtC;AACAG,UAAAA,gBAAgB,GAAGA,gBAAgB,CAACzB,OAAjB,CAAyB,OAAzB,EAAkC,SAAlC,CAAnB;AACH;AACJ,OA1QqF,CA4QtF;;;AACAvF,MAAAA,EAAE,GAAGD,EAAE,CAACkH,YAAH,CAAgBlH,EAAE,CAACmH,aAAnB,CAAL;AACA,UAAIC,SAAS,GAAGC,CAAhB;;AACA,UAAI7G,SAAS,IAAI,UAAjB,EAA6B;AACzB4G,QAAAA,SAAS,GAAGE,MAAZ;AACH;;AACDtH,MAAAA,EAAE,CAACuH,YAAH,CAAgBtH,EAAhB,EAAoBmH,SAApB;AACApH,MAAAA,EAAE,CAACwH,aAAH,CAAiBvH,EAAjB,EAnRsF,CAqRtF;;AACAC,MAAAA,EAAE,GAAGF,EAAE,CAACkH,YAAH,CAAgBlH,EAAE,CAAC+G,eAAnB,CAAL;AACA,UAAIU,WAAW,GAAGC,mBAAlB;;AACA,UAAIlH,SAAS,IAAI,SAAjB,EAA4B;AACxBgG,QAAAA,UAAU,GAAGxG,EAAE,CAAC2H,gBAAhB;AACAF,QAAAA,WAAW,GAAGG,QAAd;AACH,OAHD,MAGO,IAAIpH,SAAS,IAAI,UAAjB,EAA6B;AAChCiH,QAAAA,WAAW,GAAGI,SAAd;AACH;;AACD7H,MAAAA,EAAE,CAACuH,YAAH,CAAgBrH,EAAhB,EAAoBuH,WAApB;AACAzH,MAAAA,EAAE,CAACwH,aAAH,CAAiBtH,EAAjB,EA/RsF,CAiStF;;AACAH,MAAAA,OAAO,GAAGC,EAAE,CAAC8H,aAAH,EAAV;AACA9H,MAAAA,EAAE,CAAC+H,YAAH,CAAgBhI,OAAhB,EAAyBE,EAAzB;AACAD,MAAAA,EAAE,CAAC+H,YAAH,CAAgBhI,OAAhB,EAAyBG,EAAzB;AACAF,MAAAA,EAAE,CAACgI,WAAH,CAAejI,OAAf,EArSsF,CAuStF;;AACA,UAAI,CAACC,EAAE,CAACiI,kBAAH,CAAsBhI,EAAtB,EAA0BD,EAAE,CAACkI,cAA7B,CAAL,EACI1G,OAAO,CAACC,GAAR,CAAYzB,EAAE,CAACmI,gBAAH,CAAoBlI,EAApB,CAAZ;AACJ,UAAI,CAACD,EAAE,CAACiI,kBAAH,CAAsB/H,EAAtB,EAA0BF,EAAE,CAACkI,cAA7B,CAAL,EACI1G,OAAO,CAACC,GAAR,CAAYzB,EAAE,CAACmI,gBAAH,CAAoBjI,EAApB,CAAZ;AACJ,UAAI,CAACF,EAAE,CAACoI,mBAAH,CAAuBrI,OAAvB,EAAgCC,EAAE,CAACqI,WAAnC,CAAL,EACI7G,OAAO,CAACC,GAAR,CAAYzB,EAAE,CAACsI,iBAAH,CAAqBvI,OAArB,CAAZ,EA7SkF,CA+StF;;AACAC,MAAAA,EAAE,CAACuI,UAAH,CAAcxI,OAAd;AAEAA,MAAAA,OAAO,CAACyI,cAAR,GAAyB,KAAzB,CAlTsF,CAoTtF;;AACA,UAAIC,KAAK,GAAGlH,MAAM,CAACwB,eAAP,GAAyBxB,MAAM,CAACwB,eAAhC,GAAkD,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAA9D;AACA/C,MAAAA,EAAE,CAAC0I,UAAH,CAAcD,KAAK,CAAC,CAAD,CAAnB,EAAwBA,KAAK,CAAC,CAAD,CAA7B,EAAkCA,KAAK,CAAC,CAAD,CAAvC,EAA4C,GAA5C;AACAzI,MAAAA,EAAE,CAAC2I,KAAH,CAAS3I,EAAE,CAAC4I,gBAAZ,EAvTsF,CAyTtF;;AACA7I,MAAAA,OAAO,CAAC8I,gBAAR,GAA2B7I,EAAE,CAAC8I,iBAAH,CAAqB/I,OAArB,EAA8B,YAA9B,CAA3B;AACAC,MAAAA,EAAE,CAAC+I,uBAAH,CAA2BhJ,OAAO,CAAC8I,gBAAnC;;AAEA,UAAIrI,SAAS,IAAI,UAAjB,EAA6B;AACzB;AACA,YAAI,CAACE,cAAL,EACIA,cAAc,GAAGV,EAAE,CAACgJ,YAAH,EAAjB;AACJhJ,QAAAA,EAAE,CAAC6B,UAAH,CAAc7B,EAAE,CAAC8B,YAAjB,EAA+BpB,cAA/B;AACAV,QAAAA,EAAE,CAACiJ,UAAH,CAAcjJ,EAAE,CAAC8B,YAAjB,EAA+B,IAAIoH,YAAJ,CAAiB,CAAC,CAAC,CAAF,EAAI,CAAJ,EAAM,CAAN,EAAQ,CAAR,EAAU,CAAV,EAAY,CAAC,CAAb,EAAe,CAAC,CAAhB,EAAkB,CAAlB,EAAoB,CAApB,EAAsB,CAAC,CAAvB,EAAyB,CAAC,CAA1B,EAA4B,CAAC,CAA7B,CAAjB,CAA/B,EAAkFlJ,EAAE,CAACmJ,WAArF;AACAnJ,QAAAA,EAAE,CAACoJ,mBAAH,CAAuBrJ,OAAO,CAAC8I,gBAA/B,EAAiD,CAAjD,EAAoD7I,EAAE,CAACqJ,KAAvD,EAA8D,KAA9D,EAAqE,CAArE,EAAwE,CAAxE,EANyB,CAQzB;;AACAtJ,QAAAA,OAAO,CAACuJ,WAAR,GAAsBtJ,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,eAA/B,CAAtB;AACAC,QAAAA,EAAE,CAACwJ,SAAH,CAAazJ,OAAO,CAACuJ,WAArB,EAAkCtJ,EAAE,CAAC2G,kBAAH,GAAwB3G,EAAE,CAAC4G,mBAA7D,EAVyB,CAYzB;;AACA7G,QAAAA,OAAO,CAAC0J,GAAR,GAAczJ,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,OAA/B,CAAd;AACAA,QAAAA,OAAO,CAAC2J,KAAR,GAAgB1J,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,SAA/B,CAAhB;AACAA,QAAAA,OAAO,CAAC4J,CAAR,GAAY3J,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,KAA/B,CAAZ;AACAA,QAAAA,OAAO,CAAC6J,CAAR,GAAY5J,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,KAA/B,CAAZ;AACAA,QAAAA,OAAO,CAACsH,CAAR,GAAYrH,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,KAA/B,CAAZ;AACAA,QAAAA,OAAO,CAAC8J,EAAR,GAAa7J,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,MAA/B,CAAb;AACAA,QAAAA,OAAO,CAAC+J,GAAR,GAAc9J,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,OAA/B,CAAd,CAnByB,CAqBzB;;AACAC,QAAAA,EAAE,CAACwJ,SAAH,CAAazJ,OAAO,CAAC6J,CAArB,EAAwBzI,IAAI,IAAIgF,IAAI,CAAC4D,EAAL,GAAU,GAAd,CAA5B;AACA/J,QAAAA,EAAE,CAACwJ,SAAH,CAAazJ,OAAO,CAACsH,CAArB,EAAwBjG,IAAI,GAAG+E,IAAI,CAAC4D,EAApC;AACA/J,QAAAA,EAAE,CAACwJ,SAAH,CAAazJ,OAAO,CAAC8J,EAArB,EAAyBxI,OAAO,GAAG8E,IAAI,CAAC4D,EAAf,GAAoB,CAA7C,EAxByB,CA0BzB;;AACA,YAAIvJ,SAAS,IAAI,iBAAjB,EAAoC;AAChCT,UAAAA,OAAO,CAACgD,eAAR,GAA0B/C,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,mBAA/B,CAA1B;AACAC,UAAAA,EAAE,CAACgK,UAAH,CAAcjK,OAAO,CAACgD,eAAtB,EAAuC0F,KAAK,CAACwB,MAAN,CAAa,CAAC,CAAD,CAAb,CAAvC;AACH,SA9BwB,CAgCzB;;;AACAlK,QAAAA,OAAO,CAACiC,OAAR,GAAkBhC,EAAE,CAACkK,aAAH,EAAlB;AACAlK,QAAAA,EAAE,CAACmK,WAAH,CAAe3D,UAAf,EAA2BzG,OAAO,CAACiC,OAAnC,EAlCyB,CAoCzB;;AACA,YAAIxB,SAAS,IAAI,SAAjB,EAA4B;AACxB;AACAR,UAAAA,EAAE,CAACoK,UAAH,CAAcpK,EAAE,CAACqK,2BAAjB,EAA8C,CAA9C,EAAiDrK,EAAE,CAACsK,GAApD,EAAyDtK,EAAE,CAACsK,GAA5D,EAAiEtK,EAAE,CAACuK,aAApE,EAAmFhK,KAAK,CAAC,CAAD,CAAxF;AACAP,UAAAA,EAAE,CAACoK,UAAH,CAAcpK,EAAE,CAACwK,2BAAjB,EAA8C,CAA9C,EAAiDxK,EAAE,CAACsK,GAApD,EAAyDtK,EAAE,CAACsK,GAA5D,EAAiEtK,EAAE,CAACuK,aAApE,EAAmFhK,KAAK,CAAC,CAAD,CAAxF;AACAP,UAAAA,EAAE,CAACoK,UAAH,CAAcpK,EAAE,CAACyK,2BAAjB,EAA8C,CAA9C,EAAiDzK,EAAE,CAACsK,GAApD,EAAyDtK,EAAE,CAACsK,GAA5D,EAAiEtK,EAAE,CAACuK,aAApE,EAAmFhK,KAAK,CAAC,CAAD,CAAxF;AACAP,UAAAA,EAAE,CAACoK,UAAH,CAAcpK,EAAE,CAAC0K,2BAAjB,EAA8C,CAA9C,EAAiD1K,EAAE,CAACsK,GAApD,EAAyDtK,EAAE,CAACsK,GAA5D,EAAiEtK,EAAE,CAACuK,aAApE,EAAmFhK,KAAK,CAAC,CAAD,CAAxF;AACAP,UAAAA,EAAE,CAACoK,UAAH,CAAcpK,EAAE,CAAC2K,2BAAjB,EAA8C,CAA9C,EAAiD3K,EAAE,CAACsK,GAApD,EAAyDtK,EAAE,CAACsK,GAA5D,EAAiEtK,EAAE,CAACuK,aAApE,EAAmFhK,KAAK,CAAC,CAAD,CAAxF;AACAP,UAAAA,EAAE,CAACoK,UAAH,CAAcpK,EAAE,CAAC4K,2BAAjB,EAA8C,CAA9C,EAAiD5K,EAAE,CAACsK,GAApD,EAAyDtK,EAAE,CAACsK,GAA5D,EAAiEtK,EAAE,CAACuK,aAApE,EAAmFhK,KAAK,CAAC,CAAD,CAAxF;AACH,SARD,MAQO;AACH,cAAIA,KAAK,CAACX,KAAN,IAAeoG,QAAnB,EAA6B;AACzBhG,YAAAA,EAAE,CAAC6K,SAAH,CAAa7K,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,cAA/B,CAAb,EAA6D,CAA7D,EADyB,CAEzB;;AACAC,YAAAA,EAAE,CAACoK,UAAH,CAAc5D,UAAd,EAA0B,CAA1B,EAA6BxG,EAAE,CAACsK,GAAhC,EAAqCtK,EAAE,CAACsK,GAAxC,EAA6CtK,EAAE,CAACuK,aAAhD,EAA+DhK,KAA/D;AACH,WAJD,MAIO;AACH;AACAP,YAAAA,EAAE,CAAC6K,SAAH,CAAa7K,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,cAA/B,CAAb,EAA6D,CAA7D,EAFG,CAIH;;AACA,gBAAI+K,UAAU,GAAGzL,QAAQ,CAACK,aAAT,CAAuB,QAAvB,CAAjB;AACAoL,YAAAA,UAAU,CAAClL,KAAX,GAAmBW,KAAK,CAACX,KAAN,GAAc,CAAjC;AACAkL,YAAAA,UAAU,CAACjL,MAAX,GAAoBU,KAAK,CAACV,MAA1B;AACA,gBAAIkL,WAAW,GAAGD,UAAU,CAACxH,UAAX,CAAsB,IAAtB,CAAlB;AACAyH,YAAAA,WAAW,CAACrG,SAAZ,CAAsBnE,KAAtB,EAA6B,CAA7B,EAAgC,CAAhC,EATG,CAWH;;AACA,gBAAIyK,SAAS,GAAGD,WAAW,CAACnG,YAAZ,CAAyB,CAAzB,EAA4B,CAA5B,EAA+BrE,KAAK,CAACX,KAAN,GAAc,CAA7C,EAAgDW,KAAK,CAACV,MAAtD,CAAhB;AACAG,YAAAA,EAAE,CAACoK,UAAH,CAAc5D,UAAd,EAA0B,CAA1B,EAA6BxG,EAAE,CAACsK,GAAhC,EAAqCtK,EAAE,CAACsK,GAAxC,EAA6CtK,EAAE,CAACuK,aAAhD,EAA+DS,SAA/D,EAbG,CAeH;;AACAjL,YAAAA,OAAO,CAACkL,QAAR,GAAmBjL,EAAE,CAACkK,aAAH,EAAnB;AACAlK,YAAAA,EAAE,CAACkL,aAAH,CAAiBlL,EAAE,CAACmL,QAApB;AACAnL,YAAAA,EAAE,CAACmK,WAAH,CAAe3D,UAAf,EAA2BzG,OAAO,CAACkL,QAAnC;AACAjL,YAAAA,EAAE,CAAC6K,SAAH,CAAa7K,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,UAA/B,CAAb,EAAyD,CAAzD,EAnBG,CAqBH;;AACAgL,YAAAA,WAAW,CAACrG,SAAZ,CAAsBnE,KAAtB,EAA6B,CAACA,KAAK,CAACX,KAAP,GAAe,CAA5C,EAA+C,CAA/C;AACAoL,YAAAA,SAAS,GAAGD,WAAW,CAACnG,YAAZ,CAAyB,CAAzB,EAA4B,CAA5B,EAA+BrE,KAAK,CAACX,KAAN,GAAc,CAA7C,EAAgDW,KAAK,CAACV,MAAtD,CAAZ;AACAG,YAAAA,EAAE,CAACoK,UAAH,CAAc5D,UAAd,EAA0B,CAA1B,EAA6BxG,EAAE,CAACsK,GAAhC,EAAqCtK,EAAE,CAACsK,GAAxC,EAA6CtK,EAAE,CAACuK,aAAhD,EAA+DS,SAA/D,EAxBG,CA0BH;;AACAhL,YAAAA,EAAE,CAACoL,aAAH,CAAiB5E,UAAjB,EAA6BxG,EAAE,CAACqL,cAAhC,EAAgDrL,EAAE,CAACsL,aAAnD;AACAtL,YAAAA,EAAE,CAACoL,aAAH,CAAiB5E,UAAjB,EAA6BxG,EAAE,CAACuL,cAAhC,EAAgDvL,EAAE,CAACsL,aAAnD;AACAtL,YAAAA,EAAE,CAACoL,aAAH,CAAiB5E,UAAjB,EAA6BxG,EAAE,CAACwL,kBAAhC,EAAoDxL,EAAE,CAACyL,MAAvD;AACAzL,YAAAA,EAAE,CAACoL,aAAH,CAAiB5E,UAAjB,EAA6BxG,EAAE,CAAC0L,kBAAhC,EAAoD1L,EAAE,CAACyL,MAAvD,EA9BG,CAgCH;;AACAzL,YAAAA,EAAE,CAACkL,aAAH,CAAiBlL,EAAE,CAAC2L,QAApB;AACH;AACJ,SArFwB,CAuFzB;;;AACA3L,QAAAA,EAAE,CAACoL,aAAH,CAAiB5E,UAAjB,EAA6BxG,EAAE,CAACqL,cAAhC,EAAgDrL,EAAE,CAACsL,aAAnD;AACAtL,QAAAA,EAAE,CAACoL,aAAH,CAAiB5E,UAAjB,EAA6BxG,EAAE,CAACuL,cAAhC,EAAgDvL,EAAE,CAACsL,aAAnD;AACAtL,QAAAA,EAAE,CAACoL,aAAH,CAAiB5E,UAAjB,EAA6BxG,EAAE,CAACwL,kBAAhC,EAAoDxL,EAAE,CAACyL,MAAvD;AACAzL,QAAAA,EAAE,CAACoL,aAAH,CAAiB5E,UAAjB,EAA6BxG,EAAE,CAAC0L,kBAAhC,EAAoD1L,EAAE,CAACyL,MAAvD;AAEH,OA7FD,MA6FO;AACH;AACA1L,QAAAA,OAAO,CAAC6L,eAAR,GAA0B5L,EAAE,CAAC8I,iBAAH,CAAqB/I,OAArB,EAA8B,aAA9B,CAA1B;AACAC,QAAAA,EAAE,CAAC+I,uBAAH,CAA2BhJ,OAAO,CAAC6L,eAAnC,EAHG,CAKH;;AACA,YAAI,CAACjL,WAAL,EACIA,WAAW,GAAGX,EAAE,CAACgJ,YAAH,EAAd;AACJ,YAAI,CAACpI,mBAAL,EACIA,mBAAmB,GAAGZ,EAAE,CAACgJ,YAAH,EAAtB;AACJ,YAAI,CAACnI,cAAL,EACIA,cAAc,GAAGb,EAAE,CAACgJ,YAAH,EAAjB,CAXD,CAaH;;AACAhJ,QAAAA,EAAE,CAAC6B,UAAH,CAAc7B,EAAE,CAAC8B,YAAjB,EAA+BlB,mBAA/B;AACAZ,QAAAA,EAAE,CAACiJ,UAAH,CAAcjJ,EAAE,CAAC8B,YAAjB,EAA+B,IAAIoH,YAAJ,CAAiB,CAAC,CAAD,EAAG,CAAH,EAAK,CAAL,EAAO,CAAP,EAAS,CAAT,EAAW,CAAX,EAAa,CAAb,EAAe,CAAf,CAAjB,CAA/B,EAAoElJ,EAAE,CAACmJ,WAAvE,EAfG,CAiBH;;AACAnJ,QAAAA,EAAE,CAAC6B,UAAH,CAAc7B,EAAE,CAAC+B,oBAAjB,EAAuClB,cAAvC;AACAb,QAAAA,EAAE,CAACiJ,UAAH,CAAcjJ,EAAE,CAAC+B,oBAAjB,EAAuC,IAAI8J,WAAJ,CAAgB,CAAC,CAAD,EAAG,CAAH,EAAK,CAAL,EAAO,CAAP,EAAS,CAAT,EAAW,CAAX,CAAhB,CAAvC,EAAuE7L,EAAE,CAACmJ,WAA1E,EAnBG,CAqBH;;AACApJ,QAAAA,OAAO,CAAC+L,YAAR,GAAuB9L,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,eAA/B,CAAvB;AACAA,QAAAA,OAAO,CAACgM,WAAR,GAAsB/L,EAAE,CAACuJ,kBAAH,CAAsBxJ,OAAtB,EAA+B,cAA/B,CAAtB,CAvBG,CAwBH;;AAEAA,QAAAA,OAAO,CAACiM,KAAR,GAAgB,CAAC,CAAjB;AAEAjM,QAAAA,OAAO,CAACkM,YAAR,GAAuB,EAAvB;AACAlM,QAAAA,OAAO,CAACmC,SAAR,GAAoB,EAApB;AACAnC,QAAAA,OAAO,CAACmM,kBAAR,GAA6B,CAA7B;AACH,OAzbqF,CA2btF;;;AACA,UAAIC,GAAG,GAAGnM,EAAE,CAACyD,QAAH,EAAV;;AACA,UAAI0I,GAAG,KAAK,CAAZ,EAAe;AACX3K,QAAAA,OAAO,CAACC,GAAR,CAAY,yCAAZ,EAAuD0K,GAAvD;AACA,cAAM;AAACzK,UAAAA,IAAI,EAAE;AAAP,SAAN;AACH;;AAEDJ,MAAAA,QAAQ;AACV,KAncF;AAqcA;AACJ;AACA;AACA;AACA;;;AACI,SAAK8K,OAAL,GAAe,YAAW;AACtB,UAAI5M,SAAS,KAAKF,SAAlB,EAA6B;AACzB,YAAIG,MAAM,KAAKH,SAAX,IAAwBE,SAAS,CAAC6M,QAAV,CAAmB5M,MAAnB,CAA5B,EAAwD;AACpDD,UAAAA,SAAS,CAACuE,WAAV,CAAsBtE,MAAtB;AACH;;AACD,YAAIW,KAAK,KAAKd,SAAV,IAAuBE,SAAS,CAAC6M,QAAV,CAAmBjM,KAAnB,CAA3B,EAAsD;AAClDZ,UAAAA,SAAS,CAACuE,WAAV,CAAsB3D,KAAtB;AACH;AACJ;;AACD,UAAIJ,EAAJ,EAAQ;AACJ;AACA;AACA,YAAIyF,SAAS,GAAGzF,EAAE,CAACsM,YAAH,CAAgB,oBAAhB,CAAhB;AACA,YAAI7G,SAAJ,EACIA,SAAS,CAAC8G,WAAV;AACP;AACJ,KAhBD;AAkBA;AACJ;AACA;AACA;AACA;;;AACI,SAAKC,MAAL,GAAc,YAAW;AACrB,UAAIC,UAAU,GAAGtN,MAAM,CAACuN,gBAAP,IAA2B,CAA5C;AACAjN,MAAAA,MAAM,CAACG,KAAP,GAAeH,MAAM,CAACkN,WAAP,GAAqBF,UAApC;AACAhN,MAAAA,MAAM,CAACI,MAAP,GAAgBJ,MAAM,CAACmN,YAAP,GAAsBH,UAAtC;;AACA,UAAIzM,EAAJ,EAAQ;AACJ,YAAIA,EAAE,CAACyD,QAAH,MAAiB,IAArB,EACIC,oBAAoB;AACxB1D,QAAAA,EAAE,CAAC0G,QAAH,CAAY,CAAZ,EAAe,CAAf,EAAkB1G,EAAE,CAAC2G,kBAArB,EAAyC3G,EAAE,CAAC4G,mBAA5C;;AACA,YAAIpG,SAAS,IAAI,UAAjB,EAA6B;AACzBR,UAAAA,EAAE,CAACwJ,SAAH,CAAazJ,OAAO,CAACuJ,WAArB,EAAkC7J,MAAM,CAACkN,WAAP,GAAqBlN,MAAM,CAACmN,YAA9D;AACH;AACJ;AACJ,KAZD,CAjgByB,CA8gBzB;;;AACA,SAAKJ,MAAL;AAEA;AACJ;AACA;AACA;AACA;;AACI,SAAKK,OAAL,GAAe,UAASvG,YAAT,EAAuBC,WAAvB,EAAoC;AAC/CjG,MAAAA,IAAI,GAAG,CAACgG,YAAD,EAAeC,WAAf,CAAP;AACH,KAFD;AAIA;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACI,SAAKuG,MAAL,GAAc,UAASC,KAAT,EAAgBC,GAAhB,EAAqBC,IAArB,EAA2B1L,MAA3B,EAAmC;AAC7C,UAAI2L,KAAJ;AAAA,UAAW/K,CAAX;AAAA,UAAcG,CAAd;AAAA,UAAiB6K,IAAI,GAAG,CAAxB;AACA,UAAI5L,MAAM,KAAKjC,SAAf,EACIiC,MAAM,GAAG,EAAT;AACJ,UAAIA,MAAM,CAAC4L,IAAX,EACIA,IAAI,GAAG5L,MAAM,CAAC4L,IAAd,CALyC,CAO7C;;AACA,UAAI7M,IAAI,KAAKhB,SAAb,EAAwB;AACpB,YAAIgH,YAAY,GAAGhG,IAAI,CAAC,CAAD,CAAvB;AAAA,YACIiG,WAAW,GAAGjG,IAAI,CAAC,CAAD,CADtB,CADoB,CAIpB;;AACA,YAAI8M,UAAU,GAAGL,KAAjB;AAAA,YACIM,QAAQ,GAAGL,GADf;AAAA,YAEIM,CAAC,GAAGnH,IAAI,CAACoH,GAAL,CAAShH,WAAT,IAAwBJ,IAAI,CAACqH,GAAL,CAAST,KAAT,CAAxB,GAA0C5G,IAAI,CAACqH,GAAL,CAASlH,YAAT,CAA1C,GACAH,IAAI,CAACoH,GAAL,CAASR,KAAT,KAAmB5G,IAAI,CAACoH,GAAL,CAASjH,YAAT,IAAyBH,IAAI,CAACoH,GAAL,CAASP,GAAT,CAAzB,GACnB7G,IAAI,CAACqH,GAAL,CAASjH,WAAT,IAAwBJ,IAAI,CAACqH,GAAL,CAASlH,YAAT,CAAxB,GAAiDH,IAAI,CAACqH,GAAL,CAASR,GAAT,CADjD,CAHR;AAAA,YAKIS,CAAC,GAAG,CAACtH,IAAI,CAACqH,GAAL,CAAST,KAAT,CAAD,GAAmB5G,IAAI,CAACqH,GAAL,CAASjH,WAAT,CAAnB,GACAJ,IAAI,CAACoH,GAAL,CAASR,KAAT,IAAkB5G,IAAI,CAACoH,GAAL,CAAShH,WAAT,CAAlB,GAA0CJ,IAAI,CAACqH,GAAL,CAASR,GAAT,CANlD;AAAA,YAOIU,CAAC,GAAGvH,IAAI,CAACoH,GAAL,CAAShH,WAAT,IAAwBJ,IAAI,CAACoH,GAAL,CAASjH,YAAT,CAAxB,GAAiDH,IAAI,CAACqH,GAAL,CAAST,KAAT,CAAjD,GACA5G,IAAI,CAACoH,GAAL,CAASR,KAAT,KAAmB,CAAC5G,IAAI,CAACoH,GAAL,CAASP,GAAT,CAAD,GAAiB7G,IAAI,CAACqH,GAAL,CAASlH,YAAT,CAAjB,GACnBH,IAAI,CAACoH,GAAL,CAASjH,YAAT,IAAyBH,IAAI,CAACqH,GAAL,CAASjH,WAAT,CAAzB,GAAiDJ,IAAI,CAACqH,GAAL,CAASR,GAAT,CADjD,CARR;AAUAD,QAAAA,KAAK,GAAG5G,IAAI,CAACwH,IAAL,CAAUxH,IAAI,CAACC,GAAL,CAASD,IAAI,CAACyH,GAAL,CAASF,CAAT,EAAY,CAAZ,CAAT,EAAyB,CAAC,CAA1B,CAAV,CAAR;AACAV,QAAAA,GAAG,GAAG7G,IAAI,CAAC0H,KAAL,CAAWJ,CAAX,EAAcH,CAAd,CAAN,CAhBoB,CAkBpB;;AACA,YAAIjG,CAAC,GAAG,CAAClB,IAAI,CAACoH,GAAL,CAASH,UAAT,KAAwBjH,IAAI,CAACqH,GAAL,CAASjH,WAAT,IAAwBJ,IAAI,CAACqH,GAAL,CAASlH,YAAT,CAAxB,GAAiDH,IAAI,CAACoH,GAAL,CAASF,QAAT,CAAjD,GACzBlH,IAAI,CAACoH,GAAL,CAASjH,YAAT,IAAyBH,IAAI,CAACqH,GAAL,CAASH,QAAT,CADxB,CAAD,EAEAlH,IAAI,CAACoH,GAAL,CAASH,UAAT,IAAuBjH,IAAI,CAACoH,GAAL,CAAShH,WAAT,CAAvB,GAA+CJ,IAAI,CAACoH,GAAL,CAASF,QAAT,CAF/C,EAGAlH,IAAI,CAACoH,GAAL,CAASH,UAAT,KAAwBjH,IAAI,CAACoH,GAAL,CAASjH,YAAT,IAAyBH,IAAI,CAACqH,GAAL,CAASjH,WAAT,CAAzB,GAAiDJ,IAAI,CAACoH,GAAL,CAASF,QAAT,CAAjD,GACxBlH,IAAI,CAACqH,GAAL,CAASH,QAAT,IAAqBlH,IAAI,CAACqH,GAAL,CAASlH,YAAT,CADrB,CAHA,CAAR;AAAA,YAKIwH,CAAC,GAAG,CAAC,CAAC3H,IAAI,CAACoH,GAAL,CAASR,KAAT,CAAD,GAAmB5G,IAAI,CAACqH,GAAL,CAASR,GAAT,CAApB,EAAmC7G,IAAI,CAACoH,GAAL,CAASR,KAAT,IAAkB5G,IAAI,CAACoH,GAAL,CAASP,GAAT,CAArD,CALR;AAMA,YAAIe,QAAQ,GAAG5H,IAAI,CAAC6H,IAAL,CAAU7H,IAAI,CAACC,GAAL,CAASD,IAAI,CAACyH,GAAL,CAAS,CAACvG,CAAC,CAAC,CAAD,CAAD,GAAKyG,CAAC,CAAC,CAAD,CAAN,GAAYzG,CAAC,CAAC,CAAD,CAAD,GAAKyG,CAAC,CAAC,CAAD,CAAnB,KACtC3H,IAAI,CAAC8H,IAAL,CAAU5G,CAAC,CAAC,CAAD,CAAD,GAAKA,CAAC,CAAC,CAAD,CAAN,GAAUA,CAAC,CAAC,CAAD,CAAD,GAAKA,CAAC,CAAC,CAAD,CAAhB,GAAoBA,CAAC,CAAC,CAAD,CAAD,GAAKA,CAAC,CAAC,CAAD,CAApC,IACDlB,IAAI,CAAC8H,IAAL,CAAUH,CAAC,CAAC,CAAD,CAAD,GAAKA,CAAC,CAAC,CAAD,CAAN,GAAUA,CAAC,CAAC,CAAD,CAAD,GAAKA,CAAC,CAAC,CAAD,CAA1B,CAFuC,CAAT,EAEG,CAFH,CAAT,EAEgB,CAAC,CAFjB,CAAV,CAAf;AAGA,YAAIzG,CAAC,CAAC,CAAD,CAAD,GAAO,CAAX,EACI0G,QAAQ,GAAG,IAAI5H,IAAI,CAAC4D,EAAT,GAAcgE,QAAzB;AACJZ,QAAAA,IAAI,IAAIY,QAAR;AACH,OAvC4C,CAyC7C;;;AACA,UAAI,CAAC/N,EAAD,KAAQQ,SAAS,IAAI,UAAb,IAA2BA,SAAS,IAAI,SAAhD,CAAJ,EAAgE;AAC5D;AACA8B,QAAAA,CAAC,GAAGnC,eAAe,GAAG,CAAtB;AAEA,YAAI+N,UAAU,GAAG;AACbvE,UAAAA,CAAC,EAAE,mBAAmBrH,CAAC,GAAG,CAAvB,IAA4B,OAA5B,IAAuCA,CAAC,GAAG,CAA3C,IAAgD,OAAhD,GAA0DA,CAA1D,GAA8D,KADpD;AAEb6L,UAAAA,CAAC,EAAE,kBAAkB7L,CAAC,GAAG,CAAtB,IAA2B,OAA3B,IAAsCA,CAAC,GAAG,CAA1C,IAA+C,MAA/C,GAAwDA,CAAxD,GAA4D,qCAFlD;AAGb8L,UAAAA,CAAC,EAAE,mBAAmB9L,CAAC,GAAG,CAAvB,IAA4B,OAA5B,GAAsCA,CAAtC,GAA0C,MAA1C,IAAoDA,CAAC,GAAG,CAAxD,IAA6D,qBAHnD;AAIb+L,UAAAA,CAAC,EAAE,mBAAmB/L,CAAC,GAAG,CAAvB,IAA4B,MAA5B,GAAqCA,CAArC,GAAyC,OAAzC,IAAoDA,CAAC,GAAG,CAAxD,IAA6D,oBAJnD;AAKbgM,UAAAA,CAAC,EAAE,kBAAkBhM,CAAlB,GAAsB,OAAtB,IAAiCA,CAAC,GAAG,CAArC,IAA0C,MAA1C,IAAoDA,CAAC,GAAG,CAAxD,IAA6D,oDALnD;AAMbiM,UAAAA,CAAC,EAAE,iBAAiBjM,CAAjB,GAAqB,OAArB,IAAgCA,CAAC,GAAG,CAApC,IAAyC,OAAzC,IAAoDA,CAAC,GAAG,CAAxD,IAA6D;AANnD,SAAjB;AAQA4K,QAAAA,KAAK,GAAG,IAAI/G,IAAI,CAACqI,GAAL,CAASvB,IAAI,GAAG,CAAhB,CAAZ;AACA,YAAIwB,IAAI,GAAGvB,KAAK,GAAGzN,MAAM,CAACkN,WAAf,GAA6B,CAA7B,GAAiC,IAA5C;AACA,YAAI+B,SAAS,GAAG,iBAAiBD,IAAjB,GAAwB,eAAxB,GAA0CA,IAA1C,GAAiD,YAAjD,GAAgE1B,KAAhE,GAAwE,eAAxE,GAA0FC,GAA1F,GAAgG,OAAhH,CAd4D,CAgB5D;;AACA,YAAI2B,KAAK,GAAGC,MAAM,CAACC,IAAP,CAAYX,UAAZ,CAAZ;;AACA,aAAK/L,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,CAAhB,EAAmBA,CAAC,EAApB,EAAwB;AACpB,cAAI2M,IAAI,GAAG1O,KAAK,CAAC2O,aAAN,CAAoB,WAAWJ,KAAK,CAACxM,CAAD,CAAhB,GAAsB,MAA1C,CAAX;AACA,cAAI,CAAC2M,IAAL,EACI,SAHgB,CAGN;;AACdA,UAAAA,IAAI,CAACnP,KAAL,CAAWqP,eAAX,GAA6BN,SAAS,GAAGR,UAAU,CAACS,KAAK,CAACxM,CAAD,CAAN,CAAnD;AACA2M,UAAAA,IAAI,CAACnP,KAAL,CAAW+O,SAAX,GAAuBA,SAAS,GAAGR,UAAU,CAACS,KAAK,CAACxM,CAAD,CAAN,CAA7C;AACH;;AACD;AACH;;AAED,UAAI3B,SAAS,IAAI,UAAjB,EAA6B;AACzB;AACA,YAAIyO,IAAI,GAAG,IAAI9I,IAAI,CAAC+I,IAAL,CAAU/I,IAAI,CAACqI,GAAL,CAASvB,IAAI,GAAG,GAAhB,KAAwBjN,EAAE,CAAC2G,kBAAH,GAAwB3G,EAAE,CAAC4G,mBAAnD,CAAV,CAAf;AACAsG,QAAAA,KAAK,GAAG,IAAI/G,IAAI,CAACqI,GAAL,CAASS,IAAI,GAAG,GAAhB,CAAZ,CAHyB,CAKzB;;AACAjP,QAAAA,EAAE,CAACwJ,SAAH,CAAazJ,OAAO,CAAC0J,GAArB,EAA0BuD,GAA1B;AACAhN,QAAAA,EAAE,CAACwJ,SAAH,CAAazJ,OAAO,CAAC2J,KAArB,EAA4BqD,KAA5B;AACA/M,QAAAA,EAAE,CAACwJ,SAAH,CAAazJ,OAAO,CAAC+J,GAArB,EAA0BqD,IAA1B;AACAnN,QAAAA,EAAE,CAACwJ,SAAH,CAAazJ,OAAO,CAAC4J,CAArB,EAAwBuD,KAAxB;;AAEA,YAAIzM,OAAO,KAAK,IAAhB,EAAsB;AAClB;AACA,cAAID,SAAS,IAAI,iBAAjB,EAAoC;AAChCR,YAAAA,EAAE,CAACmK,WAAH,CAAenK,EAAE,CAACyG,UAAlB,EAA8B1G,OAAO,CAACiC,OAAtC;AACAhC,YAAAA,EAAE,CAACoK,UAAH,CAAcpK,EAAE,CAACyG,UAAjB,EAA6B,CAA7B,EAAgCzG,EAAE,CAACsK,GAAnC,EAAwCtK,EAAE,CAACsK,GAA3C,EAAgDtK,EAAE,CAACuK,aAAnD,EAAkEhK,KAAlE;AACH;AACJ,SAjBwB,CAmBzB;;;AACAP,QAAAA,EAAE,CAACmP,UAAH,CAAcnP,EAAE,CAACoP,SAAjB,EAA4B,CAA5B,EAA+B,CAA/B;AAEH,OAtBD,MAsBO;AACH;AACA,YAAIC,WAAW,GAAGC,SAAS,CAACrC,IAAD,EAAOjN,EAAE,CAAC2G,kBAAH,GAAwB3G,EAAE,CAAC4G,mBAAlC,EAAuD,GAAvD,EAA4D,KAA5D,CAA3B,CAFG,CAIH;;AACA2I,QAAAA,SAAS,CAACtC,IAAD,CAAT,CALG,CAOH;;AACA,YAAIuC,MAAM,GAAGC,eAAe,EAA5B;AACAD,QAAAA,MAAM,GAAGE,YAAY,CAACF,MAAD,EAAS,CAACrC,IAAV,EAAgB,GAAhB,CAArB;AACAqC,QAAAA,MAAM,GAAGE,YAAY,CAACF,MAAD,EAAS,CAACzC,KAAV,EAAiB,GAAjB,CAArB;AACAyC,QAAAA,MAAM,GAAGE,YAAY,CAACF,MAAD,EAASxC,GAAT,EAAc,GAAd,CAArB;AACAwC,QAAAA,MAAM,GAAGG,WAAW,CAACH,MAAD,CAApB,CAZG,CAcH;;AACAxP,QAAAA,EAAE,CAAC4P,gBAAH,CAAoB7P,OAAO,CAAC+L,YAA5B,EAA0C,KAA1C,EAAiD,IAAI5C,YAAJ,CAAiB2G,gBAAgB,CAACR,WAAD,CAAjC,CAAjD;AACArP,QAAAA,EAAE,CAAC4P,gBAAH,CAAoB7P,OAAO,CAACgM,WAA5B,EAAyC,KAAzC,EAAgD,IAAI7C,YAAJ,CAAiB2G,gBAAgB,CAACL,MAAD,CAAjC,CAAhD,EAhBG,CAkBH;;AACA,YAAIM,QAAQ,GAAGC,WAAW,CAACV,WAAD,EAAcG,MAAd,CAA1B;AACAzP,QAAAA,OAAO,CAACmC,SAAR,CAAkB8N,IAAlB,CAAuBC,gBAAvB;;AACA,YAAIlQ,OAAO,CAACmC,SAAR,CAAkBE,MAAlB,GAA2B,GAA3B,IACArC,OAAO,CAACmC,SAAR,CAAkBE,MAAlB,GAA2BrC,OAAO,CAACkM,YAAR,CAAqB7J,MAArB,GAA8B,EAD7D,EACiE;AAC7D;AACA,cAAI8N,OAAO,GAAGnQ,OAAO,CAACmC,SAAR,CAAkBiO,MAAlB,CAAyB,GAAzB,EAA8BpQ,OAAO,CAACmC,SAAR,CAAkBE,MAAlB,GAA2B,GAAzD,CAAd;;AACA,eAAK,IAAI0C,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGoL,OAAO,CAAC9N,MAA5B,EAAoC0C,CAAC,EAArC,EAAyC;AACrC;AACA9E,YAAAA,EAAE,CAACiC,aAAH,CAAiBiO,OAAO,CAACpL,CAAD,CAAP,CAAW9C,OAA5B;AACH;AACJ;;AACDjC,QAAAA,OAAO,CAACkM,YAAR,GAAuB,EAAvB;AAEA,YAAI7H,KAAK,GAAG,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,EAAgB,GAAhB,EAAqB,GAArB,EAA0B,GAA1B,CAAZ;;AACA,aAAK9B,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,CAAhB,EAAmBA,CAAC,EAApB,EAAwB;AACpB,cAAI8N,IAAI,GAAG,IAAIC,YAAJ,CAAiBhQ,KAAK,CAACiC,CAAD,CAAtB,EAA2B8B,KAAK,CAAC9B,CAAD,CAAhC,EAAqC,CAArC,EAAwC,CAAxC,EAA2C,CAA3C,EAA8C/B,KAAK,CAACmF,QAApD,CAAX;AACA4K,UAAAA,gBAAgB,CAACR,QAAD,EAAWM,IAAX,EAAiBrD,KAAjB,EAAwBC,GAAxB,EAA6BC,IAA7B,CAAhB;AACH;;AAEDlN,QAAAA,OAAO,CAACkM,YAAR,CAAqB+D,IAArB,CAA0BO,sBAA1B,EAtCG,CAwCH;;AACA,aAAKpO,CAAC,GAAGqO,sBAAsB,CAACpO,MAAvB,GAAgC,CAAzC,EAA4CD,CAAC,IAAI,CAAjD,EAAoDA,CAAC,EAArD,EAAyD;AACrD,cAAIpC,OAAO,CAACkM,YAAR,CAAqBnI,OAArB,CAA6B0M,sBAAsB,CAACrO,CAAD,CAAtB,CAA0BsO,IAAvD,MAAiE,CAAC,CAAtE,EAAyE;AACrED,YAAAA,sBAAsB,CAACrO,CAAD,CAAtB,CAA0BsO,IAA1B,CAA+BC,WAA/B,GAA6C,KAA7C;AACAF,YAAAA,sBAAsB,CAACL,MAAvB,CAA8BhO,CAA9B,EAAiC,CAAjC;AACH;AACJ,SA9CE,CAgDH;;;AACA,YAAIqO,sBAAsB,CAACpO,MAAvB,KAAkC,CAAtC,EAAyC;AACrC,eAAKD,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAGpC,OAAO,CAACkM,YAAR,CAAqB7J,MAArC,EAA6CD,CAAC,EAA9C,EAAkD;AAC9C,gBAAIsO,IAAI,GAAG1Q,OAAO,CAACkM,YAAR,CAAqB9J,CAArB,CAAX;;AACA,gBAAI,CAACsO,IAAI,CAACzO,OAAN,IAAiB,CAACyO,IAAI,CAACC,WAA3B,EAAwC;AACpCD,cAAAA,IAAI,CAACC,WAAL,GAAmB,IAAnB;AAEAC,cAAAA,UAAU,CAACC,eAAD,EAAkB,CAAlB,EAAqBH,IAArB,CAAV,CAHoC,CAKpC;;AACA;AACH;AACJ;AACJ,SA7DE,CA+DH;;;AACAI,QAAAA,YAAY;AACf;;AAED,UAAItP,MAAM,CAACuP,WAAP,KAAuBxR,SAA3B,EAAsC;AAClC,eAAOG,MAAM,CAACsR,SAAP,CAAiB,WAAjB,CAAP;AACH;AACJ,KAlKD;AAoKA;AACJ;AACA;AACA;AACA;AACA;;;AACI,SAAKC,SAAL,GAAiB,YAAW;AACxB,UAAIhR,EAAE,IAAIQ,SAAS,IAAI,UAAvB,EAAmC;AAC/B,aAAM,IAAI2B,CAAC,GAAG,CAAd,EAAiBA,CAAC,GAAGpC,OAAO,CAACkM,YAAR,CAAqB7J,MAA1C,EAAkDD,CAAC,EAAnD,EAAwD;AACpD,cAAI,CAACpC,OAAO,CAACkM,YAAR,CAAqB9J,CAArB,EAAwB8O,aAA7B,EAA4C;AACxC,mBAAO,IAAP;AACH;AACJ;AACJ;;AACD,aAAO,KAAP;AACH,KATD;AAWA;AACJ;AACA;AACA;AACA;AACA;;;AACI,SAAKC,SAAL,GAAiB,YAAW;AACxB,aAAOzR,MAAP;AACH,KAFD;AAIA;AACJ;AACA;AACA;AACA;AACA;AACA;;;AACI,aAASwQ,gBAAT,CAA0BkB,CAA1B,EAA6BhD,CAA7B,EAAgC;AAC5B;AACA,UAAIgD,CAAC,CAACnF,KAAF,IAAW,CAAX,IAAgBmC,CAAC,CAACnC,KAAF,IAAW,CAA/B,EAAkC;AAC9B,eAAO,CAAC,CAAR;AACH;;AACD,UAAImC,CAAC,CAAEnC,KAAH,IAAY,CAAZ,IAAiBmF,CAAC,CAACnF,KAAF,IAAW,CAAhC,EAAmC;AAC/B,eAAO,CAAP;AACH,OAP2B,CAS5B;;;AACA,aAAOmC,CAAC,CAACiD,SAAF,GAAcD,CAAC,CAACC,SAAvB;AACH;AAED;AACJ;AACA;AACA;AACA;AACA;AACA;;;AACI,aAASb,sBAAT,CAAgCY,CAAhC,EAAmChD,CAAnC,EAAsC;AAClC;AACA,UAAIgD,CAAC,CAACnF,KAAF,IAAWmC,CAAC,CAACnC,KAAjB,EAAwB;AACpB,eAAOmF,CAAC,CAACnF,KAAF,GAAUmC,CAAC,CAACnC,KAAnB;AACH,OAJiC,CAMlC;;;AACA,aAAOmF,CAAC,CAACE,IAAF,GAASlD,CAAC,CAACkD,IAAlB;AACH;AAED;AACJ;AACA;AACA;;;AACI,aAASR,YAAT,GAAwB;AACpB,UAAI,CAAC9Q,OAAO,CAACyI,cAAb,EAA6B;AACzBzI,QAAAA,OAAO,CAACyI,cAAR,GAAyB,IAAzB;AACAxI,QAAAA,EAAE,CAAC2I,KAAH,CAAS3I,EAAE,CAAC4I,gBAAZ;;AACA,aAAM,IAAIzG,CAAC,GAAG,CAAd,EAAiBA,CAAC,GAAGpC,OAAO,CAACkM,YAAR,CAAqB7J,MAA1C,EAAkDD,CAAC,EAAnD,EAAwD;AACpD,cAAIpC,OAAO,CAACkM,YAAR,CAAqB9J,CAArB,EAAwB8O,aAAxB,GAAwC,CAA5C,EAA+C;AAC3C;AACA;AAEA;AACAjR,YAAAA,EAAE,CAAC6B,UAAH,CAAc7B,EAAE,CAAC8B,YAAjB,EAA+BnB,WAA/B;AACAX,YAAAA,EAAE,CAACiJ,UAAH,CAAcjJ,EAAE,CAAC8B,YAAjB,EAA+B,IAAIoH,YAAJ,CAAiBnJ,OAAO,CAACkM,YAAR,CAAqB9J,CAArB,EAAwB0D,QAAzC,CAA/B,EAAmF7F,EAAE,CAACmJ,WAAtF;AACAnJ,YAAAA,EAAE,CAACoJ,mBAAH,CAAuBrJ,OAAO,CAAC6L,eAA/B,EAAgD,CAAhD,EAAmD5L,EAAE,CAACqJ,KAAtD,EAA6D,KAA7D,EAAoE,CAApE,EAAuE,CAAvE,EAP2C,CAS3C;;AACArJ,YAAAA,EAAE,CAAC6B,UAAH,CAAc7B,EAAE,CAAC8B,YAAjB,EAA+BlB,mBAA/B;AACAZ,YAAAA,EAAE,CAACoJ,mBAAH,CAAuBrJ,OAAO,CAAC8I,gBAA/B,EAAiD,CAAjD,EAAoD7I,EAAE,CAACqJ,KAAvD,EAA8D,KAA9D,EAAqE,CAArE,EAAwE,CAAxE,EAX2C,CAa3C;;AACArJ,YAAAA,EAAE,CAACmK,WAAH,CAAenK,EAAE,CAACyG,UAAlB,EAA8B1G,OAAO,CAACkM,YAAR,CAAqB9J,CAArB,EAAwBH,OAAtD,EAd2C,CAcqB;;AAChEhC,YAAAA,EAAE,CAACsR,YAAH,CAAgBtR,EAAE,CAACoP,SAAnB,EAA8B,CAA9B,EAAiCpP,EAAE,CAACuR,cAApC,EAAoD,CAApD;AACH;AACJ;;AACDxR,QAAAA,OAAO,CAACyI,cAAR,GAAyB,KAAzB;AACH;AACJ;AAED;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACI,aAAS6H,YAAT,CAAsBxK,QAAtB,EAAgCrB,IAAhC,EAAsCwH,KAAtC,EAA6CsB,CAA7C,EAAgDG,CAAhD,EAAmDxJ,IAAnD,EAAyD;AACrD,WAAK4B,QAAL,GAAgBA,QAAhB;AACA,WAAKrB,IAAL,GAAYA,IAAZ;AACA,WAAKwH,KAAL,GAAaA,KAAb;AACA,WAAKsB,CAAL,GAASA,CAAT;AACA,WAAKG,CAAL,GAASA,CAAT;AACA,WAAKxJ,IAAL,GAAYA,IAAI,CAACuB,OAAL,CAAa,IAAb,EAAkBhB,IAAlB,EAAwBgB,OAAxB,CAAgC,IAAhC,EAAqCwG,KAArC,EAA4CxG,OAA5C,CAAoD,IAApD,EAAyD8H,CAAzD,EAA4D9H,OAA5D,CAAoE,IAApE,EAAyEiI,CAAzE,CAAZ;AACH;AAED;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACI,aAAS6C,gBAAT,CAA0BR,QAA1B,EAAoCW,IAApC,EAA0C1D,KAA1C,EAAiDC,GAAjD,EAAsDC,IAAtD,EAA4D;AACxD,UAAIuE,iBAAiB,CAAC1B,QAAD,EAAWW,IAAI,CAAC5K,QAAhB,CAArB,EAAgD;AAC5C;AACA,YAAIwB,CAAC,GAAGoJ,IAAI,CAAC5K,QAAb;AACA,YAAIyH,CAAC,GAAGjG,CAAC,CAAC,CAAD,CAAD,GAAOA,CAAC,CAAC,CAAD,CAAR,GAAcA,CAAC,CAAC,CAAD,CAAf,GAAqBA,CAAC,CAAE,CAAF,CAA9B;AACA,YAAIoG,CAAC,GAAGpG,CAAC,CAAC,CAAD,CAAD,GAAOA,CAAC,CAAC,CAAD,CAAR,GAAcA,CAAC,CAAC,CAAD,CAAf,GAAqBA,CAAC,CAAC,EAAD,CAA9B;AACA,YAAIqG,CAAC,GAAGrG,CAAC,CAAC,CAAD,CAAD,GAAOA,CAAC,CAAC,CAAD,CAAR,GAAcA,CAAC,CAAC,CAAD,CAAf,GAAqBA,CAAC,CAAC,EAAD,CAA9B;AACA,YAAIkH,CAAC,GAAGpI,IAAI,CAAC8H,IAAL,CAAUX,CAAC,GAACA,CAAF,GAAMG,CAAC,GAACA,CAAR,GAAYC,CAAC,GAACA,CAAxB,CAAR;AACA,YAAIhE,KAAK,GAAGvD,IAAI,CAACwH,IAAL,CAAUD,CAAC,GAAGa,CAAd,CAAZ;AACA,YAAIkD,GAAG,GAAGtL,IAAI,CAAC0H,KAAL,CAAWJ,CAAX,EAAcH,CAAd,CAAV;AACA,YAAIoE,KAAK,GAAGD,GAAG,GAAGzE,GAAlB;AACA0E,QAAAA,KAAK,IAAKA,KAAK,GAAGvL,IAAI,CAAC4D,EAAd,GAAoB,CAAC,CAAD,GAAK5D,IAAI,CAAC4D,EAA9B,GAAoC2H,KAAK,GAAG,CAACvL,IAAI,CAAC4D,EAAf,GAAqB,IAAI5D,IAAI,CAAC4D,EAA9B,GAAmC,CAA/E;AACA2H,QAAAA,KAAK,GAAGvL,IAAI,CAACwL,GAAL,CAASD,KAAT,CAAR;AACAjB,QAAAA,IAAI,CAACY,IAAL,GAAYlL,IAAI,CAAC6H,IAAL,CAAU7H,IAAI,CAACqH,GAAL,CAAST,KAAT,IAAkB5G,IAAI,CAACqH,GAAL,CAAS9D,KAAT,CAAlB,GAAoCvD,IAAI,CAACoH,GAAL,CAASR,KAAT,IAAkB5G,IAAI,CAACoH,GAAL,CAAS7D,KAAT,CAAlB,GAAoCvD,IAAI,CAACoH,GAAL,CAASmE,KAAT,CAAlF,CAAZ,CAZ4C,CAc5C;;AACA,YAAIE,SAAS,GAAG,KAAhB;;AACA,aAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG9R,OAAO,CAACmC,SAAR,CAAkBE,MAAtC,EAA8CyP,CAAC,EAA/C,EAAmD;AAC/C,cAAI9R,OAAO,CAACmC,SAAR,CAAkB2P,CAAlB,EAAqB5N,IAArB,IAA6BwM,IAAI,CAACxM,IAAtC,EAA4C;AACxC2N,YAAAA,SAAS,GAAG,IAAZ;AACA7R,YAAAA,OAAO,CAACmC,SAAR,CAAkB2P,CAAlB,EAAqBT,SAArB,GAAiCrR,OAAO,CAACmM,kBAAR,EAAjC;AACAnM,YAAAA,OAAO,CAACmC,SAAR,CAAkB2P,CAAlB,EAAqBR,IAArB,GAA4BZ,IAAI,CAACY,IAAjC;AACAtR,YAAAA,OAAO,CAACkM,YAAR,CAAqB6F,IAArB,CAA0B/R,OAAO,CAACmC,SAAR,CAAkB2P,CAAlB,CAA1B;AACA;AACH;AACJ;;AACD,YAAI,CAACD,SAAL,EAAgB;AACZ;AACAnB,UAAAA,IAAI,CAACW,SAAL,GAAiBrR,OAAO,CAACmM,kBAAR,EAAjB;AACAnM,UAAAA,OAAO,CAACkM,YAAR,CAAqB6F,IAArB,CAA0BrB,IAA1B;AACA1Q,UAAAA,OAAO,CAACmC,SAAR,CAAkB4P,IAAlB,CAAuBrB,IAAvB;AACH,SA9B2C,CAgC5C;AACA;;;AACA,YAAIA,IAAI,CAACzE,KAAL,GAAajM,OAAO,CAACiM,KAAzB,EAAgC;AAC5B,cAAI+F,QAAQ,GAAGxR,KAAK,CAACyR,cAAN,GAAuB7L,IAAI,CAAC8L,GAAL,CAAS,CAAT,EAAYxB,IAAI,CAACzE,KAAL,GAAazL,KAAK,CAAC2R,QAA/B,CAAtC;AACA,cAAIC,QAAQ,GAAGhM,IAAI,CAACiM,IAAL,CAAUL,QAAQ,GAAGxR,KAAK,CAACoF,iBAA3B,IAAgD,CAA/D;AACA,cAAI0M,cAAc,GAAGN,QAAQ,GAAGxR,KAAK,CAACqF,cAAjB,GAAkC,CAAvD;AACA,cAAI0M,YAAY,GAAIP,QAAQ,GAAG,CAAZ,GAAiBxR,KAAK,CAACqF,cAA1C;;AACA,cAAI0M,YAAY,KAAK,CAArB,EAAwB;AACpBA,YAAAA,YAAY,GAAG/R,KAAK,CAACqF,cAArB;AACH;;AACD,cAAIyM,cAAc,KAAK,CAAvB,EAA0B;AACtBA,YAAAA,cAAc,GAAG9R,KAAK,CAACqF,cAAN,GAAuB,CAAxC;AACH;;AACD,cAAI+D,CAAC,GAAG,GAAR;;AACA,cAAI8G,IAAI,CAACnD,CAAL,IAAU6E,QAAV,IAAsB1B,IAAI,CAAChD,CAAL,IAAU0E,QAApC,EAA8C;AAC1CxI,YAAAA,CAAC,GAAG,MAAMpJ,KAAK,CAACqF,cAAN,IAAwBrF,KAAK,CAACqF,cAAN,GAAuB0M,YAA/C,CAAV;AACH;;AACD,cAAInQ,CAAC,GAAG,MAAMwH,CAAd;AACA,cAAI4I,QAAQ,GAAG,EAAf;AACA,cAAIC,IAAJ,EAAUpC,IAAV;AACA,cAAIqC,EAAE,GAAG9I,CAAT;AAAA,cAAY+I,EAAE,GAAG/I,CAAjB;AAAA,cAAoBgJ,EAAE,GAAGhJ,CAAzB;AAAA,cAA4BiJ,EAAE,GAAGzQ,CAAjC;AAAA,cAAoC0Q,EAAE,GAAG1Q,CAAzC;AAAA,cAA4C2Q,EAAE,GAAG3Q,CAAjD,CAlB4B,CAmB5B;;AACA,cAAImQ,YAAY,GAAG/R,KAAK,CAACqF,cAAzB,EAAyC;AACrC,gBAAI6K,IAAI,CAACnD,CAAL,IAAU6E,QAAV,IAAsB1B,IAAI,CAAChD,CAAL,IAAU0E,QAApC,EAA8C;AAC1CO,cAAAA,EAAE,GAAG,GAAL;AACAG,cAAAA,EAAE,GAAG,GAAL;;AACA,kBAAIpC,IAAI,CAACjM,IAAL,IAAa,GAAb,IAAoBiM,IAAI,CAACjM,IAAL,IAAa,GAArC,EAA0C;AACtCmO,gBAAAA,EAAE,GAAG,GAAL;AACAG,gBAAAA,EAAE,GAAG,GAAL;AACH;AACJ,aAPD,MAOO,IAAIrC,IAAI,CAACnD,CAAL,IAAU6E,QAAV,IAAsB1B,IAAI,CAAChD,CAAL,IAAU0E,QAApC,EAA8C;AACjDM,cAAAA,EAAE,GAAG,GAAL;AACAG,cAAAA,EAAE,GAAG,GAAL;;AACA,kBAAInC,IAAI,CAACjM,IAAL,IAAa,GAAb,IAAoBiM,IAAI,CAACjM,IAAL,IAAa,GAArC,EAA0C;AACtCmO,gBAAAA,EAAE,GAAG,GAAL;AACAG,gBAAAA,EAAE,GAAG,GAAL;AACH;AACJ;AACJ,WApC2B,CAqC5B;;;AACA,cAAIT,cAAc,IAAI9R,KAAK,CAACqF,cAA5B,EAA4C;AACxC,gBAAI6K,IAAI,CAACnD,CAAL,IAAU6E,QAAd,EAAwB;AACpBM,cAAAA,EAAE,GAAG,CAAL;AACAG,cAAAA,EAAE,GAAG,CAAL;;AACA,kBAAInC,IAAI,CAACjM,IAAL,IAAa,GAAb,IAAoBiM,IAAI,CAACjM,IAAL,IAAa,GAArC,EAA0C;AACtCmO,gBAAAA,EAAE,GAAG,CAAL;AACAG,gBAAAA,EAAE,GAAG,CAAL;AACH;AACJ;;AACD,gBAAIrC,IAAI,CAAChD,CAAL,IAAU0E,QAAd,EAAwB;AACpBO,cAAAA,EAAE,GAAG,CAAL;AACAG,cAAAA,EAAE,GAAG,CAAL;;AACA,kBAAIpC,IAAI,CAACjM,IAAL,IAAa,GAAb,IAAoBiM,IAAI,CAACjM,IAAL,IAAa,GAArC,EAA0C;AACtCmO,gBAAAA,EAAE,GAAG,CAAL;AACAG,gBAAAA,EAAE,GAAG,CAAL;AACH;AACJ;AACJ;;AAEDN,UAAAA,IAAI,GAAG,CAAYnL,CAAC,CAAC,CAAD,CAAb,EAA8BA,CAAC,CAAC,CAAD,CAA/B,EAAgDA,CAAC,CAAC,CAAD,CAAjD,EACCA,CAAC,CAAC,CAAD,CAAD,GAAKoL,EAAL,GAAQpL,CAAC,CAAC,CAAD,CAAD,GAAKuL,EADd,EACqBvL,CAAC,CAAC,CAAD,CAAD,GAAKsC,CAAL,GAAOtC,CAAC,CAAC,CAAD,CAAD,GAAKlF,CADjC,EACqCkF,CAAC,CAAC,CAAD,CAAD,GAAKsL,EAAL,GAAQtL,CAAC,CAAC,CAAD,CAAD,GAAKyL,EADlD,EAECzL,CAAC,CAAC,CAAD,CAAD,GAAKoL,EAAL,GAAQpL,CAAC,CAAC,CAAD,CAAD,GAAKuL,EAFd,EAEmBvL,CAAC,CAAC,CAAD,CAAD,GAAKqL,EAAL,GAAQrL,CAAC,CAAC,CAAD,CAAD,GAAKwL,EAFhC,EAEqCxL,CAAC,CAAC,CAAD,CAAD,GAAKsL,EAAL,GAAQtL,CAAC,CAAC,CAAD,CAAD,GAAKyL,EAFlD,EAGGzL,CAAC,CAAC,CAAD,CAAD,GAAKsC,CAAL,GAAOtC,CAAC,CAAC,CAAD,CAAD,GAAKlF,CAHf,EAGkBkF,CAAC,CAAC,CAAD,CAAD,GAAKqL,EAAL,GAAQrL,CAAC,CAAC,EAAD,CAAD,GAAMwL,EAHhC,EAGoCxL,CAAC,CAAC,CAAD,CAAD,GAAKsL,EAAL,GAAQtL,CAAC,CAAC,EAAD,CAAD,GAAMyL,EAHlD,CAAP;AAKA1C,UAAAA,IAAI,GAAG,IAAIC,YAAJ,CAAiBmC,IAAjB,EAAuB/B,IAAI,CAACjM,IAA5B,EAAkCiM,IAAI,CAACzE,KAAL,GAAa,CAA/C,EAAkDyE,IAAI,CAACnD,CAAL,GAAO,CAAzD,EAA4DmD,IAAI,CAAChD,CAAL,GAAO,CAAnE,EAAsElN,KAAK,CAACmF,QAA5E,CAAP;AACA6M,UAAAA,QAAQ,CAACT,IAAT,CAAc1B,IAAd;;AACA,cAAI,EAAEK,IAAI,CAACnD,CAAL,IAAU6E,QAAV,IAAsBE,cAAc,IAAI9R,KAAK,CAACqF,cAAhD,CAAJ,EAAqE;AACjE4M,YAAAA,IAAI,GAAG,CAACnL,CAAC,CAAC,CAAD,CAAD,GAAKoL,EAAL,GAAQpL,CAAC,CAAC,CAAD,CAAD,GAAKuL,EAAd,EAAqBvL,CAAC,CAAC,CAAD,CAAD,GAAKsC,CAAL,GAAOtC,CAAC,CAAC,CAAD,CAAD,GAAKlF,CAAjC,EAAqCkF,CAAC,CAAC,CAAD,CAAD,GAAKsL,EAAL,GAAQtL,CAAC,CAAC,CAAD,CAAD,GAAKyL,EAAlD,EACYzL,CAAC,CAAC,CAAD,CADb,EAC8BA,CAAC,CAAC,CAAD,CAD/B,EACgDA,CAAC,CAAC,CAAD,CADjD,EAEGA,CAAC,CAAC,CAAD,CAAD,GAAKsC,CAAL,GAAOtC,CAAC,CAAC,CAAD,CAAD,GAAKlF,CAFf,EAEmBkF,CAAC,CAAC,CAAD,CAAD,GAAKqL,EAAL,GAAQrL,CAAC,CAAC,CAAD,CAAD,GAAKwL,EAFhC,EAEqCxL,CAAC,CAAC,CAAD,CAAD,GAAKsL,EAAL,GAAQtL,CAAC,CAAC,CAAD,CAAD,GAAKyL,EAFlD,EAGCzL,CAAC,CAAC,CAAD,CAAD,GAAKoL,EAAL,GAAQpL,CAAC,CAAC,CAAD,CAAD,GAAKuL,EAHd,EAGmBvL,CAAC,CAAC,CAAD,CAAD,GAAKqL,EAAL,GAAQrL,CAAC,CAAC,CAAD,CAAD,GAAKwL,EAHhC,EAGqCxL,CAAC,CAAC,CAAD,CAAD,GAAKsL,EAAL,GAAQtL,CAAC,CAAC,CAAD,CAAD,GAAKyL,EAHlD,CAAP;AAKA1C,YAAAA,IAAI,GAAG,IAAIC,YAAJ,CAAiBmC,IAAjB,EAAuB/B,IAAI,CAACjM,IAA5B,EAAkCiM,IAAI,CAACzE,KAAL,GAAa,CAA/C,EAAkDyE,IAAI,CAACnD,CAAL,GAAO,CAAP,GAAS,CAA3D,EAA8DmD,IAAI,CAAChD,CAAL,GAAO,CAArE,EAAwElN,KAAK,CAACmF,QAA9E,CAAP;AACA6M,YAAAA,QAAQ,CAACT,IAAT,CAAc1B,IAAd;AACH;;AACD,cAAI,EAAEK,IAAI,CAACnD,CAAL,IAAU6E,QAAV,IAAsBE,cAAc,IAAI9R,KAAK,CAACqF,cAAhD,KACA,EAAE6K,IAAI,CAAChD,CAAL,IAAU0E,QAAV,IAAsBE,cAAc,IAAI9R,KAAK,CAACqF,cAAhD,CADJ,EACqE;AACjE4M,YAAAA,IAAI,GAAG,CAACnL,CAAC,CAAC,CAAD,CAAD,GAAKoL,EAAL,GAAQpL,CAAC,CAAC,CAAD,CAAD,GAAKuL,EAAd,EAAmBvL,CAAC,CAAC,CAAD,CAAD,GAAKqL,EAAL,GAAQrL,CAAC,CAAC,CAAD,CAAD,GAAKwL,EAAhC,EAAqCxL,CAAC,CAAC,CAAD,CAAD,GAAKsL,EAAL,GAAQtL,CAAC,CAAC,CAAD,CAAD,GAAKyL,EAAlD,EACGzL,CAAC,CAAC,CAAD,CAAD,GAAKsC,CAAL,GAAOtC,CAAC,CAAC,CAAD,CAAD,GAAKlF,CADf,EACmBkF,CAAC,CAAC,CAAD,CAAD,GAAKqL,EAAL,GAAQrL,CAAC,CAAC,CAAD,CAAD,GAAKwL,EADhC,EACqCxL,CAAC,CAAC,CAAD,CAAD,GAAKsL,EAAL,GAAQtL,CAAC,CAAC,CAAD,CAAD,GAAKyL,EADlD,EAEYzL,CAAC,CAAC,CAAD,CAFb,EAE8BA,CAAC,CAAC,CAAD,CAF/B,EAEgDA,CAAC,CAAC,CAAD,CAFjD,EAGCA,CAAC,CAAC,CAAD,CAAD,GAAKoL,EAAL,GAAQpL,CAAC,CAAC,CAAD,CAAD,GAAKuL,EAHd,EAGoBvL,CAAC,CAAC,EAAD,CAAD,GAAMsC,CAAN,GAAQtC,CAAC,CAAC,CAAD,CAAD,GAAKlF,CAHjC,EAGoCkF,CAAC,CAAC,EAAD,CAAD,GAAMsL,EAAN,GAAStL,CAAC,CAAC,CAAD,CAAD,GAAKyL,EAHlD,CAAP;AAKA1C,YAAAA,IAAI,GAAG,IAAIC,YAAJ,CAAiBmC,IAAjB,EAAuB/B,IAAI,CAACjM,IAA5B,EAAkCiM,IAAI,CAACzE,KAAL,GAAa,CAA/C,EAAkDyE,IAAI,CAACnD,CAAL,GAAO,CAAP,GAAS,CAA3D,EAA8DmD,IAAI,CAAChD,CAAL,GAAO,CAAP,GAAS,CAAvE,EAA0ElN,KAAK,CAACmF,QAAhF,CAAP;AACA6M,YAAAA,QAAQ,CAACT,IAAT,CAAc1B,IAAd;AACH;;AACD,cAAI,EAAEK,IAAI,CAAChD,CAAL,IAAU0E,QAAV,IAAsBE,cAAc,IAAI9R,KAAK,CAACqF,cAAhD,CAAJ,EAAqE;AACjE4M,YAAAA,IAAI,GAAG,CAAGnL,CAAC,CAAC,CAAD,CAAD,GAAKsC,CAAL,GAAOtC,CAAC,CAAC,CAAD,CAAD,GAAKlF,CAAf,EAAkBkF,CAAC,CAAC,CAAD,CAAD,GAAKqL,EAAL,GAAQrL,CAAC,CAAC,EAAD,CAAD,GAAMwL,EAAhC,EAAoCxL,CAAC,CAAC,CAAD,CAAD,GAAKsL,EAAL,GAAQtL,CAAC,CAAC,EAAD,CAAD,GAAMyL,EAAlD,EACCzL,CAAC,CAAC,CAAD,CAAD,GAAKoL,EAAL,GAAQpL,CAAC,CAAC,CAAD,CAAD,GAAKuL,EADd,EACmBvL,CAAC,CAAC,CAAD,CAAD,GAAKqL,EAAL,GAAQrL,CAAC,CAAC,CAAD,CAAD,GAAKwL,EADhC,EACqCxL,CAAC,CAAC,CAAD,CAAD,GAAKsL,EAAL,GAAQtL,CAAC,CAAC,CAAD,CAAD,GAAKyL,EADlD,EAECzL,CAAC,CAAC,CAAD,CAAD,GAAKoL,EAAL,GAAQpL,CAAC,CAAC,CAAD,CAAD,GAAKuL,EAFd,EAEoBvL,CAAC,CAAC,EAAD,CAAD,GAAMsC,CAAN,GAAQtC,CAAC,CAAC,CAAD,CAAD,GAAKlF,CAFjC,EAEoCkF,CAAC,CAAC,EAAD,CAAD,GAAMsL,EAAN,GAAStL,CAAC,CAAC,CAAD,CAAD,GAAKyL,EAFlD,EAGYzL,CAAC,CAAC,CAAD,CAHb,EAG6BA,CAAC,CAAC,EAAD,CAH9B,EAG+CA,CAAC,CAAC,EAAD,CAHhD,CAAP;AAKA+I,YAAAA,IAAI,GAAG,IAAIC,YAAJ,CAAiBmC,IAAjB,EAAuB/B,IAAI,CAACjM,IAA5B,EAAkCiM,IAAI,CAACzE,KAAL,GAAa,CAA/C,EAAkDyE,IAAI,CAACnD,CAAL,GAAO,CAAzD,EAA4DmD,IAAI,CAAChD,CAAL,GAAO,CAAP,GAAS,CAArE,EAAwElN,KAAK,CAACmF,QAA9E,CAAP;AACA6M,YAAAA,QAAQ,CAACT,IAAT,CAAc1B,IAAd;AACH;;AACD,eAAK,IAAItL,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGyN,QAAQ,CAACnQ,MAA7B,EAAqC0C,CAAC,EAAtC,EAA0C;AACtCwL,YAAAA,gBAAgB,CAACR,QAAD,EAAWyC,QAAQ,CAACzN,CAAD,CAAnB,EAAwBiI,KAAxB,EAA+BC,GAA/B,EAAoCC,IAApC,CAAhB;AACH;AACJ;AACJ;AACJ;AAED;AACJ;AACA;AACA;AACA;;;AACI,aAASnH,UAAT,GAAsB;AAClB,aAAO,CAAC,CAAC,CAAF,EAAM,CAAN,EAAS,CAAC,CAAV,EAAc,CAAd,EAAkB,CAAlB,EAAqB,CAAC,CAAtB,EAA0B,CAA1B,EAA6B,CAAC,CAA9B,EAAiC,CAAC,CAAlC,EAAqC,CAAC,CAAtC,EAAyC,CAAC,CAA1C,EAA6C,CAAC,CAA9C,EAAiD;AAC/C,OADF,EACM,CADN,EACU,CADV,EACa,CAAC,CADd,EACkB,CADlB,EACsB,CADtB,EACyB,CAAC,CAD1B,EAC6B,CAAC,CAD9B,EACkC,CADlC,EACsC,CADtC,EACyC,CAAC,CAD1C,EAC8C,CAD9C,EACiD;AAChD,OAAC,CAFF,EAEM,CAFN,EAEU,CAFV,EAEc,CAFd,EAEkB,CAFlB,EAEsB,CAFtB,EAE0B,CAF1B,EAE8B,CAF9B,EAEiC,CAAC,CAFlC,EAEqC,CAAC,CAFtC,EAE0C,CAF1C,EAE6C,CAAC,CAF9C,EAEiD;AAChD,OAAC,CAHF,EAGK,CAAC,CAHN,EAGS,CAAC,CAHV,EAGc,CAHd,EAGiB,CAAC,CAHlB,EAGqB,CAAC,CAHtB,EAG0B,CAH1B,EAG6B,CAAC,CAH9B,EAGkC,CAHlC,EAGqC,CAAC,CAHtC,EAGyC,CAAC,CAH1C,EAG8C,CAH9C,EAGiD;AAChD,OAAC,CAJF,EAIM,CAJN,EAIU,CAJV,EAIa,CAAC,CAJd,EAIkB,CAJlB,EAIqB,CAAC,CAJtB,EAIyB,CAAC,CAJ1B,EAI6B,CAAC,CAJ9B,EAIiC,CAAC,CAJlC,EAIqC,CAAC,CAJtC,EAIyC,CAAC,CAJ1C,EAI8C,CAJ9C,EAIiD;AAC/C,OALF,EAKM,CALN,EAKS,CAAC,CALV,EAKc,CALd,EAKkB,CALlB,EAKsB,CALtB,EAK0B,CAL1B,EAK6B,CAAC,CAL9B,EAKkC,CALlC,EAKsC,CALtC,EAKyC,CAAC,CAL1C,EAK6C,CAAC,CAL9C,CAKiD;AALjD,OAAP;AAOH;AAED;AACJ;AACA;AACA;AACA;;;AACI,aAAS2J,eAAT,GAA2B;AACvB,aAAO,CACH,CADG,EACA,CADA,EACG,CADH,EAEH,CAFG,EAEA,CAFA,EAEG,CAFH,EAGH,CAHG,EAGA,CAHA,EAGG,CAHH,CAAP;AAKH;AAED;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;;;AACI,aAASC,YAAT,CAAsBqD,CAAtB,EAAyBC,KAAzB,EAAgCC,IAAhC,EAAsC;AAClC,UAAI3Q,CAAC,GAAG6D,IAAI,CAACqH,GAAL,CAASwF,KAAT,CAAR;AACA,UAAIE,CAAC,GAAG/M,IAAI,CAACoH,GAAL,CAASyF,KAAT,CAAR;;AACA,UAAIC,IAAI,IAAI,GAAZ,EAAiB;AACb,eAAO,CACHF,CAAC,CAAC,CAAD,CADE,EACGG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CADf,EACoBG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CADhC,EAEHA,CAAC,CAAC,CAAD,CAFE,EAEGG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CAFf,EAEoBG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CAFhC,EAGHA,CAAC,CAAC,CAAD,CAHE,EAGGG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CAHf,EAGoBG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CAHhC,CAAP;AAKH;;AACD,UAAIE,IAAI,IAAI,GAAZ,EAAiB;AACb,eAAO,CACHC,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CADT,EACcA,CAAC,CAAC,CAAD,CADf,EACoBG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CADhC,EAEHG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CAFT,EAEcA,CAAC,CAAC,CAAD,CAFf,EAEoBG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CAFhC,EAGHG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CAHT,EAGcA,CAAC,CAAC,CAAD,CAHf,EAGoBG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CAHhC,CAAP;AAKH;;AACD,UAAIE,IAAI,IAAI,GAAZ,EAAiB;AACb,eAAO,CACHC,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CADT,EACcG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CAD1B,EAC+BA,CAAC,CAAC,CAAD,CADhC,EAEHG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CAFT,EAEcG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CAF1B,EAE+BA,CAAC,CAAC,CAAD,CAFhC,EAGHG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CAHT,EAGcG,CAAC,GAACH,CAAC,CAAC,CAAD,CAAH,GAASzQ,CAAC,GAACyQ,CAAC,CAAC,CAAD,CAH1B,EAG+BA,CAAC,CAAC,CAAD,CAHhC,CAAP;AAKH;AACJ;AAED;AACJ;AACA;AACA;AACA;AACA;;;AACI,aAASpD,WAAT,CAAqBoD,CAArB,EAAwB;AACpB,aAAO,CACHA,CAAC,CAAC,CAAD,CADE,EACGA,CAAC,CAAC,CAAD,CADJ,EACSA,CAAC,CAAC,CAAD,CADV,EACkB,CADlB,EAEHA,CAAC,CAAC,CAAD,CAFE,EAEGA,CAAC,CAAC,CAAD,CAFJ,EAESA,CAAC,CAAC,CAAD,CAFV,EAEkB,CAFlB,EAGHA,CAAC,CAAC,CAAD,CAHE,EAGGA,CAAC,CAAC,CAAD,CAHJ,EAGSA,CAAC,CAAC,CAAD,CAHV,EAGkB,CAHlB,EAIA,CAJA,EAIM,CAJN,EAIY,CAJZ,EAIkB,CAJlB,CAAP;AAMH;AAED;AACJ;AACA;AACA;AACA;AACA;;;AACI,aAASlD,gBAAT,CAA0BkD,CAA1B,EAA6B;AACzB,aAAO,CACHA,CAAC,CAAE,CAAF,CADE,EACIA,CAAC,CAAE,CAAF,CADL,EACWA,CAAC,CAAE,CAAF,CADZ,EACkBA,CAAC,CAAC,EAAD,CADnB,EAEHA,CAAC,CAAE,CAAF,CAFE,EAEIA,CAAC,CAAE,CAAF,CAFL,EAEWA,CAAC,CAAE,CAAF,CAFZ,EAEkBA,CAAC,CAAC,EAAD,CAFnB,EAGHA,CAAC,CAAE,CAAF,CAHE,EAGIA,CAAC,CAAE,CAAF,CAHL,EAGWA,CAAC,CAAC,EAAD,CAHZ,EAGkBA,CAAC,CAAC,EAAD,CAHnB,EAIHA,CAAC,CAAE,CAAF,CAJE,EAIIA,CAAC,CAAE,CAAF,CAJL,EAIWA,CAAC,CAAC,EAAD,CAJZ,EAIkBA,CAAC,CAAC,EAAD,CAJnB,CAAP;AAMH;AAED;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACI,aAASzD,SAAT,CAAmBrC,IAAnB,EAAyBkG,MAAzB,EAAiCC,KAAjC,EAAwCC,IAAxC,EAA8C;AAC1C,UAAIC,IAAI,GAAG,IAAInN,IAAI,CAAC+I,IAAL,CAAU/I,IAAI,CAACqI,GAAL,CAASvB,IAAI,GAAC,CAAd,IAAmBjN,EAAE,CAAC4G,mBAAtB,GAA4C5G,EAAE,CAAC2G,kBAAzD,CAAf;AACA,UAAIgD,CAAC,GAAG,IAAIxD,IAAI,CAACqI,GAAL,CAAS8E,IAAI,GAAC,CAAd,CAAZ;AACA,aAAO,CACH3J,CAAC,GAACwJ,MADC,EACS,CADT,EACa,CADb,EACiB,CADjB,EAEI,CAFJ,EAESxJ,CAFT,EAEa,CAFb,EAEiB,CAFjB,EAGI,CAHJ,EAGS,CAHT,EAGa,CAAC0J,IAAI,GAACD,KAAN,KAAcA,KAAK,GAACC,IAApB,CAHb,EAGyC,IAAEA,IAAF,GAAOD,KAAR,IAAgBA,KAAK,GAACC,IAAtB,CAHxC,EAII,CAJJ,EAIS,CAJT,EAIY,CAAC,CAJb,EAIiB,CAJjB,CAAP;AAMH;AAED;AACJ;AACA;AACA;AACA;AACA;;;AACI,aAASE,oBAAT,CAA8BC,GAA9B,EAAmCC,GAAnC,EAAwC;AACpCzT,MAAAA,EAAE,CAACmK,WAAH,CAAenK,EAAE,CAACyG,UAAlB,EAA8BgN,GAA9B;AACAzT,MAAAA,EAAE,CAACoK,UAAH,CAAcpK,EAAE,CAACyG,UAAjB,EAA6B,CAA7B,EAAgCzG,EAAE,CAACsK,GAAnC,EAAwCtK,EAAE,CAACsK,GAA3C,EAAgDtK,EAAE,CAACuK,aAAnD,EAAkEiJ,GAAlE;AACAxT,MAAAA,EAAE,CAACoL,aAAH,CAAiBpL,EAAE,CAACyG,UAApB,EAAgCzG,EAAE,CAAC0L,kBAAnC,EAAuD1L,EAAE,CAACyL,MAA1D;AACAzL,MAAAA,EAAE,CAACoL,aAAH,CAAiBpL,EAAE,CAACyG,UAApB,EAAgCzG,EAAE,CAACwL,kBAAnC,EAAuDxL,EAAE,CAACyL,MAA1D;AACAzL,MAAAA,EAAE,CAACoL,aAAH,CAAiBpL,EAAE,CAACyG,UAApB,EAAgCzG,EAAE,CAACqL,cAAnC,EAAmDrL,EAAE,CAACsL,aAAtD;AACAtL,MAAAA,EAAE,CAACoL,aAAH,CAAiBpL,EAAE,CAACyG,UAApB,EAAgCzG,EAAE,CAACuL,cAAnC,EAAmDvL,EAAE,CAACsL,aAAtD;AACAtL,MAAAA,EAAE,CAACmK,WAAH,CAAenK,EAAE,CAACyG,UAAlB,EAA8B,IAA9B;AACH;;AAED,QAAI+J,sBAAsB,GAAG,EAA7B,CA5kCyB,CA8kCzB;;AACA,QAAIkD,WAAW,GAAI,YAAW;AAC1B,UAAIC,QAAQ,GAAG,CAAf,CAD0B,CACN;;AACpB,UAAIC,iBAAiB,GAAG,EAAxB;AACA,UAAIxO,WAAJ;;AAEA,eAASyO,kBAAT,GAA8B;AAC1B,YAAIC,IAAI,GAAG,IAAX;AACA,aAAK9R,OAAL,GAAe,KAAKV,QAAL,GAAgB,IAA/B;AACA,aAAKf,KAAL,GAAa,IAAI4E,KAAJ,EAAb;AACA,aAAK5E,KAAL,CAAW6E,WAAX,GAAyBA,WAAW,GAAGA,WAAH,GAAiB,WAArD;;AACA,YAAI2O,MAAM,GAAI,SAAVA,MAAU,GAAW;AACrB,cAAID,IAAI,CAACvT,KAAL,CAAWX,KAAX,GAAmB,CAAnB,IAAwBkU,IAAI,CAACvT,KAAL,CAAWV,MAAX,GAAoB,CAAhD,EAAmD;AAAE;AACjD0T,YAAAA,oBAAoB,CAACO,IAAI,CAACvT,KAAN,EAAauT,IAAI,CAAC9R,OAAlB,CAApB;AACA8R,YAAAA,IAAI,CAACxS,QAAL,CAAcwS,IAAI,CAAC9R,OAAnB,EAA4B,IAA5B;AACH,WAHD,MAGO;AACH8R,YAAAA,IAAI,CAACxS,QAAL,CAAcwS,IAAI,CAAC9R,OAAnB,EAA4B,KAA5B;AACH;;AACDgS,UAAAA,yBAAyB,CAACF,IAAD,CAAzB;AACH,SARD;;AASA,aAAKvT,KAAL,CAAW0T,gBAAX,CAA4B,MAA5B,EAAoCF,MAApC;AACA,aAAKxT,KAAL,CAAW0T,gBAAX,CAA4B,OAA5B,EAAqCF,MAArC,EAf0B,CAeoB;AACjD;;AAEDF,MAAAA,kBAAkB,CAACK,SAAnB,CAA6BR,WAA7B,GAA2C,UAASnO,GAAT,EAAcvD,OAAd,EAAuBV,QAAvB,EAAiC;AACxE,aAAKU,OAAL,GAAeA,OAAf;AACA,aAAKV,QAAL,GAAgBA,QAAhB;AACA,aAAKf,KAAL,CAAWgF,GAAX,GAAiBA,GAAjB;AACH,OAJD;;AAMA,eAAS4O,qBAAT,CAA+B1D,IAA/B,EAAqClL,GAArC,EAA0CvD,OAA1C,EAAmDV,QAAnD,EAA6D;AACzD,aAAKmP,IAAL,GAAYA,IAAZ;AACA,aAAKlL,GAAL,GAAWA,GAAX;AACA,aAAKvD,OAAL,GAAeA,OAAf;AACA,aAAKV,QAAL,GAAgBA,QAAhB;AACH;;AAED,eAAS0S,yBAAT,CAAmCI,GAAnC,EAAwC;AACpC,YAAI5D,sBAAsB,CAACpO,MAA3B,EAAmC;AAC/B,cAAIiS,GAAG,GAAG7D,sBAAsB,CAAC8D,KAAvB,EAAV;AACAF,UAAAA,GAAG,CAACV,WAAJ,CAAgBW,GAAG,CAAC9O,GAApB,EAAyB8O,GAAG,CAACrS,OAA7B,EAAsCqS,GAAG,CAAC/S,QAA1C;AACH,SAHD,MAIIsS,iBAAiB,CAACD,QAAQ,EAAT,CAAjB,GAAgCS,GAAhC;AACP;;AAED,WAAK,IAAIjS,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGwR,QAApB,EAA8BxR,CAAC,EAA/B;AACIyR,QAAAA,iBAAiB,CAACzR,CAAD,CAAjB,GAAuB,IAAI0R,kBAAJ,EAAvB;AADJ;;AAGA,aAAO,UAASpD,IAAT,EAAelL,GAAf,EAAoBjE,QAApB,EAA8BiT,YAA9B,EAA4C;AAC/CnP,QAAAA,WAAW,GAAGmP,YAAd;AACA,YAAIvS,OAAO,GAAGhC,EAAE,CAACkK,aAAH,EAAd;AACA,YAAIyJ,QAAJ,EACIC,iBAAiB,CAAC,EAAED,QAAH,CAAjB,CAA8BD,WAA9B,CAA0CnO,GAA1C,EAA+CvD,OAA/C,EAAwDV,QAAxD,EADJ,KAGIkP,sBAAsB,CAACsB,IAAvB,CAA4B,IAAIqC,qBAAJ,CAA0B1D,IAA1B,EAAgClL,GAAhC,EAAqCvD,OAArC,EAA8CV,QAA9C,CAA5B;AACJ,eAAOU,OAAP;AACH,OARD;AASH,KAxDiB,EAAlB;AA0DA;AACJ;AACA;AACA;AACA;;;AACI,aAAS4O,eAAT,CAAyBH,IAAzB,EAA+B;AAC3BiD,MAAAA,WAAW,CAACjD,IAAD,EAAOA,IAAI,CAACxM,IAAL,GAAY,GAAZ,GAAkB1D,KAAK,CAACkF,SAA/B,EAA0C,UAASzD,OAAT,EAAkBqC,MAAlB,EAA0B;AAC3EoM,QAAAA,IAAI,CAACzO,OAAL,GAAeA,OAAf;AACAyO,QAAAA,IAAI,CAACQ,aAAL,GAAqB5M,MAAM,GAAG,CAAH,GAAO,CAAlC;AACH,OAHU,EAGRvD,YAAY,CAACsE,WAHL,CAAX;AAIH;AAED;AACJ;AACA;AACA;AACA;;;AACI,aAASmK,SAAT,CAAmBtC,IAAnB,EAAyB;AACrB;AACA,UAAIuH,QAAQ,GAAG,CAAf;;AACA,aAAQA,QAAQ,GAAGjU,KAAK,CAAC2R,QAAjB,IACJlS,EAAE,CAAC2G,kBAAH,GAAwBpG,KAAK,CAACqF,cAAN,GACxBO,IAAI,CAAC8L,GAAL,CAAS,CAAT,EAAYuC,QAAQ,GAAG,CAAvB,CADwB,GACIrO,IAAI,CAACqI,GAAL,CAASvB,IAAI,GAAG,CAAhB,CADJ,GACyB,KAFrD,EAE6D;AACzDuH,QAAAA,QAAQ;AACX,OAPoB,CASrB;;;AACAzU,MAAAA,OAAO,CAACiM,KAAR,GAAgBwI,QAAhB;AACH;AAED;AACJ;AACA;AACA;AACA;AACA;AACA;;;AACI,aAASzE,WAAT,CAAqB0E,CAArB,EAAwBlG,CAAxB,EAA2B;AACvB,aAAO,CACHkG,CAAC,CAAE,CAAF,CAAD,GAAMlG,CAAC,CAAC,CAAD,CADJ,EACSkG,CAAC,CAAE,CAAF,CAAD,GAAMlG,CAAC,CAAC,CAAD,CADhB,EACqBkG,CAAC,CAAE,CAAF,CAAD,GAAMlG,CAAC,CAAE,CAAF,CAD5B,EACsC,CADtC,EAEHkG,CAAC,CAAE,CAAF,CAAD,GAAMlG,CAAC,CAAC,CAAD,CAFJ,EAESkG,CAAC,CAAE,CAAF,CAAD,GAAMlG,CAAC,CAAC,CAAD,CAFhB,EAEqBkG,CAAC,CAAE,CAAF,CAAD,GAAMlG,CAAC,CAAE,CAAF,CAF5B,EAEsC,CAFtC,EAGHkG,CAAC,CAAC,EAAD,CAAD,GAAMlG,CAAC,CAAC,CAAD,CAHJ,EAGSkG,CAAC,CAAC,EAAD,CAAD,GAAMlG,CAAC,CAAC,CAAD,CAHhB,EAGqBkG,CAAC,CAAC,EAAD,CAAD,GAAMlG,CAAC,CAAC,EAAD,CAH5B,EAGkCkG,CAAC,CAAC,EAAD,CAHnC,EAIE,CAAClG,CAAC,CAAC,CAAD,CAJJ,EAIc,CAACA,CAAC,CAAC,CAAD,CAJhB,EAI0B,CAACA,CAAC,CAAC,EAAD,CAJ5B,EAIsC,CAJtC,CAAP;AAMH;AAED;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;;;AACI,aAASmG,kBAAT,CAA4B3B,CAA5B,EAA+B1L,CAA/B,EAAkC;AAC9B,aAAO,CACK0L,CAAC,CAAE,CAAF,CAAD,GAAM1L,CAAC,CAAC,CAAD,CAAP,GAAa0L,CAAC,CAAE,CAAF,CAAD,GAAM1L,CAAC,CAAC,CAAD,CAApB,GAA0B0L,CAAC,CAAE,CAAF,CAAD,GAAM1L,CAAC,CAAC,CAAD,CADtC,EAEK0L,CAAC,CAAE,CAAF,CAAD,GAAM1L,CAAC,CAAC,CAAD,CAAP,GAAa0L,CAAC,CAAE,CAAF,CAAD,GAAM1L,CAAC,CAAC,CAAD,CAApB,GAA0B0L,CAAC,CAAE,CAAF,CAAD,GAAM1L,CAAC,CAAC,CAAD,CAFtC,EAGH0L,CAAC,CAAC,EAAD,CAAD,GAAQA,CAAC,CAAE,CAAF,CAAD,GAAM1L,CAAC,CAAC,CAAD,CAAf,GAAqB0L,CAAC,CAAE,CAAF,CAAD,GAAM1L,CAAC,CAAC,CAAD,CAA5B,GAAkC0L,CAAC,CAAC,EAAD,CAAD,GAAM1L,CAAC,CAAC,CAAD,CAHtC,EAIE,KAAG0L,CAAC,CAAC,EAAD,CAAD,GAAM1L,CAAC,CAAC,CAAD,CAAP,GAAa0L,CAAC,CAAC,EAAD,CAAD,GAAM1L,CAAC,CAAC,CAAD,CAApB,GAA0B0L,CAAC,CAAC,EAAD,CAAD,GAAM1L,CAAC,CAAC,CAAD,CAApC,CAJF,CAAP;AAMH;AAED;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;;;AACI,aAASsN,WAAT,CAAqB5B,CAArB,EAAwB1L,CAAxB,EAA2B;AACvB,UAAIuN,GAAG,GAAGF,kBAAkB,CAAC3B,CAAD,EAAI1L,CAAJ,CAA5B;AACA,UAAIwN,IAAI,GAAGD,GAAG,CAAC,CAAD,CAAH,GAAOA,GAAG,CAAC,CAAD,CAArB;AACA,UAAIE,IAAI,GAAGF,GAAG,CAAC,CAAD,CAAH,GAAOA,GAAG,CAAC,CAAD,CAArB;AACA,UAAIG,IAAI,GAAGH,GAAG,CAAC,CAAD,CAAH,GAAOA,GAAG,CAAC,CAAD,CAArB;AACA,UAAII,GAAG,GAAG,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAAV;AAEA,UAAKH,IAAI,GAAG,CAAC,CAAb,EACIG,GAAG,CAAC,CAAD,CAAH,GAAS,CAAC,CAAV;AACJ,UAAKH,IAAI,GAAG,CAAZ,EACIG,GAAG,CAAC,CAAD,CAAH,GAAS,CAAT;AACJ,UAAKF,IAAI,GAAG,CAAC,CAAb,EACIE,GAAG,CAAC,CAAD,CAAH,GAAS,CAAC,CAAV;AACJ,UAAKF,IAAI,GAAG,CAAZ,EACIE,GAAG,CAAC,CAAD,CAAH,GAAS,CAAT;AACJ,UAAKD,IAAI,GAAG,CAAC,CAAR,IAAaA,IAAI,GAAG,CAAzB,EACIC,GAAG,CAAC,CAAD,CAAH,GAAS,CAAT;AACJ,aAAOA,GAAP;AACH;AAED;AACJ;AACA;AACA;AACA;AACA;AACA;;;AACI,aAASxD,iBAAT,CAA2BuB,CAA3B,EAA8B1L,CAA9B,EAAiC;AAC7B,UAAI4N,MAAM,GAAGN,WAAW,CAAC5B,CAAD,EAAI1L,CAAC,CAACtB,KAAF,CAAQ,CAAR,EAAW,CAAX,CAAJ,CAAxB;AACA,UAAImP,MAAM,GAAGP,WAAW,CAAC5B,CAAD,EAAI1L,CAAC,CAACtB,KAAF,CAAQ,CAAR,EAAW,CAAX,CAAJ,CAAxB;AACA,UAAIoP,MAAM,GAAGR,WAAW,CAAC5B,CAAD,EAAI1L,CAAC,CAACtB,KAAF,CAAQ,CAAR,EAAW,CAAX,CAAJ,CAAxB;AACA,UAAIqP,MAAM,GAAGT,WAAW,CAAC5B,CAAD,EAAI1L,CAAC,CAACtB,KAAF,CAAQ,CAAR,EAAW,EAAX,CAAJ,CAAxB;AACA,UAAIsP,KAAK,GAAGJ,MAAM,CAAC,CAAD,CAAN,GAAYC,MAAM,CAAC,CAAD,CAAlB,GAAwBC,MAAM,CAAC,CAAD,CAA9B,GAAoCC,MAAM,CAAC,CAAD,CAAtD;AACA,UAAKC,KAAK,IAAI,CAAC,CAAV,IAAeA,KAAK,IAAI,CAA7B,EACI,OAAO,KAAP;AACJ,UAAIC,KAAK,GAAGL,MAAM,CAAC,CAAD,CAAN,GAAYC,MAAM,CAAC,CAAD,CAAlB,GAAwBC,MAAM,CAAC,CAAD,CAA9B,GAAoCC,MAAM,CAAC,CAAD,CAAtD;AACA,UAAKE,KAAK,IAAI,CAAC,CAAV,IAAeA,KAAK,IAAI,CAA7B,EACI,OAAO,KAAP;AACJ,UAAIC,KAAK,GAAGN,MAAM,CAAC,CAAD,CAAN,GAAYC,MAAM,CAAC,CAAD,CAAlB,GAAwBC,MAAM,CAAC,CAAD,CAA9B,GAAoCC,MAAM,CAAC,CAAD,CAAtD;AACA,aAAOG,KAAK,IAAI,CAAhB;AAGH;AAED;AACJ;AACA;AACA;AACA;AACA;;;AACI,aAAS7R,oBAAT,GAAgC;AAC5BlC,MAAAA,OAAO,CAACC,GAAR,CAAY,yCAAZ;AACAhC,MAAAA,MAAM,CAACG,KAAP,GAAeuG,IAAI,CAACqP,KAAL,CAAW/V,MAAM,CAACG,KAAP,GAAe,CAA1B,CAAf;AACAH,MAAAA,MAAM,CAACI,MAAP,GAAgBsG,IAAI,CAACqP,KAAL,CAAW/V,MAAM,CAACI,MAAP,GAAgB,CAA3B,CAAhB;AACH;AACJ,GAhxC4D,CAkxC7D;;;AACA,MAAIwH,CAAC,GAAG,CACR,4BADQ,EAER,0BAFQ,EAIR,eAJQ,EAKJ;AACA,6CANI,EAQJ;AACA,4BATI,EAUR,GAVQ,EAWNoO,IAXM,CAWD,EAXC,CAAR,CAnxC6D,CAgyC7D;;AACA,MAAInO,MAAM,GAAG,CACb,6BADa,EAEb,4BAFa,EAIb,4BAJa,EAKb,6BALa,EAOb,kCAPa,EASb,mBATa,EAUT;AACA,wEAXS,EAaT;AACA,4BAdS,EAeb,GAfa,EAgBXmO,IAhBW,CAgBN,EAhBM,CAAb,CAjyC6D,CAmzC7D;;AACA,MAAIxO,gBAAgB,GAAG,CACvB,wBADuB,EACG;AAE1B,gCAHuB,EAIvB,sBAJuB,EAKvB,wBALuB,EAMvB,oBANuB,EAOvB,oBAPuB,EAQvB,oBARuB,EASvB,qBATuB,EAUvB,sBAVuB,EAYvB,6CAZuB,EAcvB;AACA,+BAfuB,EAgBvB,6BAhBuB,EAiBvB,4BAjBuB,EAkBvB,kCAlBuB,EAoBvB;AACA,4BArBuB,EAuBvB;AACA,mCAxBuB,EA0BvB,eA1BuB,EA2BnB;AACA,2CA5BmB,EA6BnB,yBA7BmB,EA8BnB,4BA9BmB,EA+BnB,4BA/BmB,EAgCnB,wCAhCmB,EAiCnB,wCAjCmB,EAkCnB,gCAlCmB,EAmCnB,gCAnCmB,EAoCnB,8CApCmB,EAqCnB,2CArCmB,EAsCnB,sDAtCmB,EAuCnB,+DAvCmB,EAwCrBwO,IAxCqB,CAwChB,IAxCgB,CAAvB,CApzC6D,CA81C7D;;AACA,MAAI7N,QAAQ,GAAGX,gBAAgB,GAAG,CAC9B;AACA,4BAF8B,EAG9B,kGAH8B,EAIlC,GAJkC,EAKhCwO,IALgC,CAK3B,IAL2B,CAAlC,CA/1C6D,CAs2C7D;;AACA,MAAI/N,mBAAmB,GAAGT,gBAAgB,GAAG,CACzC;AACA,6CAFyC,EAIzC;AACA,qDALyC,EAOzC;AACA;AACA,wFATyC,EAUrC,mCAVqC,EAWzC,QAXyC,EAYrC,oBAZqC,EAajC;AACA,qBAdiC,EAe7B,yGAf6B,EAgBjC,MAhBiC,EAiB7B,+GAjB6B,EAkBrC,UAlBqC,EAmBjC,iHAnBiC,EAoBrC,GApBqC,EAqBzC,GArByC,EAsB7C,GAtB6C,EAuB3CwO,IAvB2C,CAuBtC,IAvBsC,CAA7C,CAv2C6D,CAg4C7D;;AACA,MAAI5N,SAAS,GAAG,CAChB,kCADgB,EAEhB,8BAFgB,EAGhB;AAEA,qBALgB,EAMZ;AACA,oDAPY,EAQhB;AACA,KATgB,EAUd4N,IAVc,CAUT,EAVS,CAAhB;AAYA,SAAO;AACHC,IAAAA,QAAQ,EAAE,kBAASlW,SAAT,EAAoBe,KAApB,EAA2BoV,SAA3B,EAAsClV,OAAtC,EAA+C;AACrD,aAAO,IAAIlB,QAAJ,CAAaC,SAAb,EAAwBe,KAAxB,EAA+BoV,SAA/B,EAA0ClV,OAA1C,CAAP;AACH;AAHE,GAAP;AAMC,CAn5CqB,CAm5CnBtB,MAn5CmB,EAm5CXE,QAn5CW,CAAtB","sourcesContent":["/*\r\n * libpannellum - A WebGL and CSS 3D transform based Panorama Renderer\r\n * Copyright (c) 2012-2019 Matthew Petroff\r\n * \r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n * \r\n * The above copyright notice and this permission notice shall be included in\r\n * all copies or substantial portions of the Software.\r\n * \r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n * THE SOFTWARE.\r\n */\r\n\r\nwindow.libpannellum = (function(window, document, undefined) {\r\n\r\n'use strict';\r\n\r\n/**\r\n * Creates a new panorama renderer.\r\n * @constructor\r\n * @param {HTMLElement} container - The container element for the renderer.\r\n */\r\nfunction Renderer(container) {\r\n    var canvas = document.createElement('canvas');\r\n    canvas.style.width = canvas.style.height = '100%';\r\n    container.appendChild(canvas);\r\n\r\n    var program, gl, vs, fs;\r\n    var fallbackImgSize;\r\n    var world;\r\n    var vtmps;\r\n    var pose;\r\n    var image, imageType, dynamic;\r\n    var texCoordBuffer, cubeVertBuf, cubeVertTexCoordBuf, cubeVertIndBuf;\r\n    var globalParams;\r\n\r\n    /**\r\n     * Initialize renderer.\r\n     * @memberof Renderer\r\n     * @instance\r\n     * @param {Image|Array|Object} image - Input image; format varies based on\r\n     *      `imageType`. For `equirectangular`, this is an image; for\r\n     *      `cubemap`, this is an array of images for the cube faces in the\r\n     *      order [+z, +x, -z, -x, +y, -y]; for `multires`, this is a\r\n     *      configuration object.\r\n     * @param {string} imageType - The type of the image: `equirectangular`,\r\n     *      `cubemap`, or `multires`.\r\n     * @param {boolean} dynamic - Whether or not the image is dynamic (e.g. video).\r\n     * @param {number} haov - Initial horizontal angle of view.\r\n     * @param {number} vaov - Initial vertical angle of view.\r\n     * @param {number} voffset - Initial vertical offset angle.\r\n     * @param {function} callback - Load callback function.\r\n     * @param {Object} [params] - Other configuration parameters (`horizonPitch`, `horizonRoll`, `backgroundColor`).\r\n     */\r\n    this.init = function(_image, _imageType, _dynamic, haov, vaov, voffset, callback, params) {\r\n        // Default argument for image type\r\n        if (_imageType === undefined)\r\n            _imageType = 'equirectangular';\r\n\r\n        if (_imageType != 'equirectangular' && _imageType != 'cubemap' &&\r\n            _imageType != 'multires') {\r\n            console.log('Error: invalid image type specified!');\r\n            throw {type: 'config error'};\r\n        }\r\n\r\n        imageType = _imageType;\r\n        image = _image;\r\n        dynamic = _dynamic;\r\n        globalParams = params || {};\r\n\r\n        // Clear old data\r\n        if (program) {\r\n            if (vs) {\r\n                gl.detachShader(program, vs);\r\n                gl.deleteShader(vs);\r\n            }\r\n            if (fs) {\r\n                gl.detachShader(program, fs);\r\n                gl.deleteShader(fs);\r\n            }\r\n            gl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null);\r\n            if (program.texture)\r\n                gl.deleteTexture(program.texture);\r\n            if (program.nodeCache)\r\n                for (var i = 0; i < program.nodeCache.length; i++)\r\n                    gl.deleteTexture(program.nodeCache[i].texture);\r\n            gl.deleteProgram(program);\r\n            program = undefined;\r\n        }\r\n        pose = undefined;\r\n\r\n        var s;\r\n        var faceMissing = false;\r\n        var cubeImgWidth;\r\n        if (imageType == 'cubemap') {\r\n            for (s = 0; s < 6; s++) {\r\n                if (image[s].width > 0) {\r\n                    if (cubeImgWidth === undefined)\r\n                        cubeImgWidth = image[s].width;\r\n                    if (cubeImgWidth != image[s].width)\r\n                        console.log('Cube faces have inconsistent widths: ' + cubeImgWidth + ' vs. ' + image[s].width);\r\n                } else\r\n                    faceMissing = true;\r\n            }\r\n        }\r\n        function fillMissingFaces(imgSize) {\r\n            if (faceMissing) { // Fill any missing fallback/cubemap faces with background\r\n                var nbytes = imgSize * imgSize * 4; // RGB, plus non-functional alpha\r\n                var imageArray = new Uint8ClampedArray(nbytes);\r\n                var rgb = params.backgroundColor ? params.backgroundColor : [0, 0, 0];\r\n                rgb[0] *= 255;\r\n                rgb[1] *= 255;\r\n                rgb[2] *= 255;\r\n                // Maybe filling could be done faster, see e.g. https://stackoverflow.com/questions/1295584/most-efficient-way-to-create-a-zero-filled-javascript-array\r\n                for (var i = 0; i < nbytes; i++) {\r\n                    imageArray[i++] = rgb[0];\r\n                    imageArray[i++] = rgb[1];\r\n                    imageArray[i++] = rgb[2];\r\n                }\r\n                var backgroundSquare = new ImageData(imageArray, imgSize, imgSize);\r\n                for (s = 0; s < 6; s++) {\r\n                    if (image[s].width == 0)\r\n                        image[s] = backgroundSquare;\r\n                }\r\n            }\r\n        }\r\n        \r\n        // This awful browser specific test exists because iOS 8/9 and IE 11\r\n        // don't display non-power-of-two cubemap textures but also don't\r\n        // throw an error (tested on an iPhone 5c / iOS 8.1.3 / iOS 9.2 /\r\n        // iOS 10.3.1).\r\n        // Therefore, the WebGL context is never created for these browsers for\r\n        // NPOT cubemaps, and the CSS 3D transform fallback renderer is used\r\n        // instead.\r\n        if (!(imageType == 'cubemap' &&\r\n            (cubeImgWidth & (cubeImgWidth - 1)) !== 0 &&\r\n            (navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 8_/) ||\r\n            navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 9_/) ||\r\n            navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 10_/) ||\r\n            navigator.userAgent.match(/Trident.*rv[ :]*11\\./)))) {\r\n            // Enable WebGL on canvas\r\n            if (!gl)\r\n                gl = canvas.getContext('experimental-webgl', {alpha: false, depth: false});\r\n            if (gl && gl.getError() == 1286)\r\n                handleWebGLError1286();\r\n        }\r\n        \r\n        // If there is no WebGL, fall back to CSS 3D transform renderer.\r\n        // This will discard the image loaded so far and load the fallback image.\r\n        // While browser specific tests are usually frowned upon, the\r\n        // fallback viewer only really works with WebKit/Blink and IE 10/11\r\n        // (it doesn't work properly in Firefox).\r\n        if (!gl && ((imageType == 'multires' && image.hasOwnProperty('fallbackPath')) ||\r\n            imageType == 'cubemap') &&\r\n            ('WebkitAppearance' in document.documentElement.style ||\r\n            navigator.userAgent.match(/Trident.*rv[ :]*11\\./) ||\r\n            navigator.appVersion.indexOf('MSIE 10') !== -1)) {\r\n            // Remove old world if it exists\r\n            if (world) {\r\n                container.removeChild(world);\r\n            }\r\n            \r\n            // Initialize renderer\r\n            world = document.createElement('div');\r\n            world.className = 'pnlm-world';\r\n            \r\n            // Add images\r\n            var path;\r\n            if (image.basePath) {\r\n                path = image.basePath + image.fallbackPath;\r\n            } else {\r\n                path = image.fallbackPath;\r\n            }\r\n            var sides = ['f', 'r', 'b', 'l', 'u', 'd'];\r\n            var loaded = 0;\r\n            var onLoad = function() {\r\n                // Draw image on canvas\r\n                var faceCanvas = document.createElement('canvas');\r\n                faceCanvas.className = 'pnlm-face pnlm-' + sides[this.side] + 'face';\r\n                world.appendChild(faceCanvas);\r\n                var faceContext = faceCanvas.getContext('2d');\r\n                faceCanvas.style.width = this.width + 4 + 'px';\r\n                faceCanvas.style.height = this.height + 4 + 'px';\r\n                faceCanvas.width = this.width + 4;\r\n                faceCanvas.height = this.height + 4;\r\n                faceContext.drawImage(this, 2, 2);\r\n                var imgData = faceContext.getImageData(0, 0, faceCanvas.width, faceCanvas.height);\r\n                var data = imgData.data;\r\n                \r\n                // Duplicate edge pixels\r\n                var i;\r\n                var j;\r\n                for (i = 2; i < faceCanvas.width - 2; i++) {\r\n                    for (j = 0; j < 4; j++) {\r\n                        data[(i + faceCanvas.width) * 4 + j] = data[(i + faceCanvas.width * 2) * 4 + j];\r\n                        data[(i + faceCanvas.width * (faceCanvas.height - 2)) * 4 + j] = data[(i + faceCanvas.width * (faceCanvas.height - 3)) * 4 + j];\r\n                    }\r\n                }\r\n                for (i = 2; i < faceCanvas.height - 2; i++) {\r\n                    for (j = 0; j < 4; j++) {\r\n                        data[(i * faceCanvas.width + 1) * 4 + j] = data[(i * faceCanvas.width + 2) * 4 + j];\r\n                        data[((i + 1) * faceCanvas.width - 2) * 4 + j] = data[((i + 1) * faceCanvas.width - 3) * 4 + j];\r\n                    }\r\n                }\r\n                for (j = 0; j < 4; j++) {\r\n                    data[(faceCanvas.width + 1) * 4 + j] = data[(faceCanvas.width * 2 + 2) * 4 + j];\r\n                    data[(faceCanvas.width * 2 - 2) * 4 + j] = data[(faceCanvas.width * 3 - 3) * 4 + j];\r\n                    data[(faceCanvas.width * (faceCanvas.height - 2) + 1) * 4 + j] = data[(faceCanvas.width * (faceCanvas.height - 3) + 2) * 4 + j];\r\n                    data[(faceCanvas.width * (faceCanvas.height - 1) - 2) * 4 + j] = data[(faceCanvas.width * (faceCanvas.height - 2) - 3) * 4 + j];\r\n                }\r\n                for (i = 1; i < faceCanvas.width - 1; i++) {\r\n                    for (j = 0; j < 4; j++) {\r\n                        data[i * 4 + j] = data[(i + faceCanvas.width) * 4 + j];\r\n                        data[(i + faceCanvas.width * (faceCanvas.height - 1)) * 4 + j] = data[(i + faceCanvas.width * (faceCanvas.height - 2)) * 4 + j];\r\n                    }\r\n                }\r\n                for (i = 1; i < faceCanvas.height - 1; i++) {\r\n                    for (j = 0; j < 4; j++) {\r\n                        data[(i * faceCanvas.width) * 4 + j] = data[(i * faceCanvas.width + 1) * 4 + j];\r\n                        data[((i + 1) * faceCanvas.width - 1) * 4 + j] = data[((i + 1) * faceCanvas.width - 2) * 4 + j];\r\n                    }\r\n                }\r\n                for (j = 0; j < 4; j++) {\r\n                    data[j] = data[(faceCanvas.width + 1) * 4 + j];\r\n                    data[(faceCanvas.width - 1) * 4 + j] = data[(faceCanvas.width * 2 - 2) * 4 + j];\r\n                    data[(faceCanvas.width * (faceCanvas.height - 1)) * 4 + j] = data[(faceCanvas.width * (faceCanvas.height - 2) + 1) * 4 + j];\r\n                    data[(faceCanvas.width * faceCanvas.height - 1) * 4 + j] = data[(faceCanvas.width * (faceCanvas.height - 1) - 2) * 4 + j];\r\n                }\r\n                \r\n                // Draw image width duplicated edge pixels on canvas\r\n                faceContext.putImageData(imgData, 0, 0);\r\n                \r\n                incLoaded.call(this);\r\n            };\r\n            var incLoaded = function() {\r\n                if (this.width > 0) {\r\n                    if (fallbackImgSize === undefined)\r\n                        fallbackImgSize = this.width;\r\n                    if (fallbackImgSize != this.width)\r\n                        console.log('Fallback faces have inconsistent widths: ' + fallbackImgSize + ' vs. ' + this.width);\r\n                } else\r\n                    faceMissing = true;\r\n                loaded++;\r\n                if (loaded == 6) {\r\n                    fallbackImgSize = this.width;\r\n                    container.appendChild(world);\r\n                    callback();\r\n                }\r\n            };\r\n            faceMissing = false;\r\n            for (s = 0; s < 6; s++) {\r\n                var faceImg = new Image();\r\n                faceImg.crossOrigin = globalParams.crossOrigin ? globalParams.crossOrigin : 'anonymous';\r\n                faceImg.side = s;\r\n                faceImg.onload = onLoad;\r\n                faceImg.onerror = incLoaded; // ignore missing face to support partial fallback image\r\n                if (imageType == 'multires') {\r\n                    faceImg.src = path.replace('%s', sides[s]) + '.' + image.extension;\r\n                } else {\r\n                    faceImg.src = image[s].src;\r\n                }\r\n            }\r\n            fillMissingFaces(fallbackImgSize);\r\n            return;\r\n        } else if (!gl) {\r\n            console.log('Error: no WebGL support detected!');\r\n            throw {type: 'no webgl'};\r\n        }\r\n        if (imageType == 'cubemap')\r\n            fillMissingFaces(cubeImgWidth);\r\n        if (image.basePath) {\r\n            image.fullpath = image.basePath + image.path;\r\n        } else {\r\n            image.fullpath = image.path;\r\n        }\r\n        image.invTileResolution = 1 / image.tileResolution;\r\n        \r\n        var vertices = createCube();\r\n        vtmps = [];\r\n        for (s = 0; s < 6; s++) {\r\n            vtmps[s] = vertices.slice(s * 12, s * 12 + 12);\r\n            vertices = createCube();\r\n        }\r\n        \r\n        // Make sure image isn't too big\r\n        var maxWidth = 0;\r\n        if (imageType == 'equirectangular') {\r\n            maxWidth = gl.getParameter(gl.MAX_TEXTURE_SIZE);\r\n            if (Math.max(image.width / 2, image.height) > maxWidth) {\r\n                console.log('Error: The image is too big; it\\'s ' + image.width + 'px wide, '+\r\n                            'but this device\\'s maximum supported size is ' + (maxWidth * 2) + 'px.');\r\n                throw {type: 'webgl size error', width: image.width, maxWidth: maxWidth * 2};\r\n            }\r\n        } else if (imageType == 'cubemap') {\r\n            if (cubeImgWidth > gl.getParameter(gl.MAX_CUBE_MAP_TEXTURE_SIZE)) {\r\n                console.log('Error: The image is too big; it\\'s ' + cubeImgWidth + 'px wide, ' +\r\n                            'but this device\\'s maximum supported size is ' + maxWidth + 'px.');\r\n                throw {type: 'webgl size error', width: cubeImgWidth, maxWidth: maxWidth};\r\n            }\r\n        }\r\n\r\n        // Store horizon pitch and roll if applicable\r\n        if (params !== undefined && (params.horizonPitch !== undefined || params.horizonRoll !== undefined))\r\n            pose = [params.horizonPitch == undefined ? 0 : params.horizonPitch,\r\n                    params.horizonRoll == undefined ? 0 : params.horizonRoll];\r\n\r\n        // Set 2d texture binding\r\n        var glBindType = gl.TEXTURE_2D;\r\n\r\n        // Create viewport for entire canvas\r\n        gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);\r\n\r\n        // Check precision support\r\n        if (gl.getShaderPrecisionFormat) {\r\n            var precision = gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER, gl.HIGH_FLOAT);\r\n            if (precision && precision.precision < 1) {\r\n                // `highp` precision not supported; https://stackoverflow.com/a/33308927\r\n                fragEquiCubeBase = fragEquiCubeBase.replace('highp', 'mediump');\r\n            }\r\n        }\r\n\r\n        // Create vertex shader\r\n        vs = gl.createShader(gl.VERTEX_SHADER);\r\n        var vertexSrc = v;\r\n        if (imageType == 'multires') {\r\n            vertexSrc = vMulti;\r\n        }\r\n        gl.shaderSource(vs, vertexSrc);\r\n        gl.compileShader(vs);\r\n\r\n        // Create fragment shader\r\n        fs = gl.createShader(gl.FRAGMENT_SHADER);\r\n        var fragmentSrc = fragEquirectangular;\r\n        if (imageType == 'cubemap') {\r\n            glBindType = gl.TEXTURE_CUBE_MAP;\r\n            fragmentSrc = fragCube;\r\n        } else if (imageType == 'multires') {\r\n            fragmentSrc = fragMulti;\r\n        }\r\n        gl.shaderSource(fs, fragmentSrc);\r\n        gl.compileShader(fs);\r\n\r\n        // Link WebGL program\r\n        program = gl.createProgram();\r\n        gl.attachShader(program, vs);\r\n        gl.attachShader(program, fs);\r\n        gl.linkProgram(program);\r\n\r\n        // Log errors\r\n        if (!gl.getShaderParameter(vs, gl.COMPILE_STATUS))\r\n            console.log(gl.getShaderInfoLog(vs));\r\n        if (!gl.getShaderParameter(fs, gl.COMPILE_STATUS))\r\n            console.log(gl.getShaderInfoLog(fs));\r\n        if (!gl.getProgramParameter(program, gl.LINK_STATUS))\r\n            console.log(gl.getProgramInfoLog(program));\r\n\r\n        // Use WebGL program\r\n        gl.useProgram(program);\r\n\r\n        program.drawInProgress = false;\r\n\r\n        // Set background clear color (does not apply to cubemap/fallback image)\r\n        var color = params.backgroundColor ? params.backgroundColor : [0, 0, 0];\r\n        gl.clearColor(color[0], color[1], color[2], 1.0);\r\n        gl.clear(gl.COLOR_BUFFER_BIT);\r\n\r\n        // Look up texture coordinates location\r\n        program.texCoordLocation = gl.getAttribLocation(program, 'a_texCoord');\r\n        gl.enableVertexAttribArray(program.texCoordLocation);\r\n\r\n        if (imageType != 'multires') {\r\n            // Provide texture coordinates for rectangle\r\n            if (!texCoordBuffer)\r\n                texCoordBuffer = gl.createBuffer();\r\n            gl.bindBuffer(gl.ARRAY_BUFFER, texCoordBuffer);\r\n            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]), gl.STATIC_DRAW);\r\n            gl.vertexAttribPointer(program.texCoordLocation, 2, gl.FLOAT, false, 0, 0);\r\n\r\n            // Pass aspect ratio\r\n            program.aspectRatio = gl.getUniformLocation(program, 'u_aspectRatio');\r\n            gl.uniform1f(program.aspectRatio, gl.drawingBufferWidth / gl.drawingBufferHeight);\r\n\r\n            // Locate psi, theta, focal length, horizontal extent, vertical extent, and vertical offset\r\n            program.psi = gl.getUniformLocation(program, 'u_psi');\r\n            program.theta = gl.getUniformLocation(program, 'u_theta');\r\n            program.f = gl.getUniformLocation(program, 'u_f');\r\n            program.h = gl.getUniformLocation(program, 'u_h');\r\n            program.v = gl.getUniformLocation(program, 'u_v');\r\n            program.vo = gl.getUniformLocation(program, 'u_vo');\r\n            program.rot = gl.getUniformLocation(program, 'u_rot');\r\n\r\n            // Pass horizontal extent, vertical extent, and vertical offset\r\n            gl.uniform1f(program.h, haov / (Math.PI * 2.0));\r\n            gl.uniform1f(program.v, vaov / Math.PI);\r\n            gl.uniform1f(program.vo, voffset / Math.PI * 2);\r\n\r\n            // Set background color\r\n            if (imageType == 'equirectangular') {\r\n                program.backgroundColor = gl.getUniformLocation(program, 'u_backgroundColor');\r\n                gl.uniform4fv(program.backgroundColor, color.concat([1]));\r\n            }\r\n\r\n            // Create texture\r\n            program.texture = gl.createTexture();\r\n            gl.bindTexture(glBindType, program.texture);\r\n\r\n            // Upload images to texture depending on type\r\n            if (imageType == 'cubemap') {\r\n                // Load all six sides of the cube map\r\n                gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, image[1]);\r\n                gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_X, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, image[3]);\r\n                gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_Y, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, image[4]);\r\n                gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_Y, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, image[5]);\r\n                gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_Z, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, image[0]);\r\n                gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_Z, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, image[2]);\r\n            } else {\r\n                if (image.width <= maxWidth) {\r\n                    gl.uniform1i(gl.getUniformLocation(program, 'u_splitImage'), 0);\r\n                    // Upload image to the texture\r\n                    gl.texImage2D(glBindType, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, image);\r\n                } else {\r\n                    // Image needs to be split into two parts due to texture size limits\r\n                    gl.uniform1i(gl.getUniformLocation(program, 'u_splitImage'), 1);\r\n\r\n                    // Draw image on canvas\r\n                    var cropCanvas = document.createElement('canvas');\r\n                    cropCanvas.width = image.width / 2;\r\n                    cropCanvas.height = image.height;\r\n                    var cropContext = cropCanvas.getContext('2d');\r\n                    cropContext.drawImage(image, 0, 0);\r\n\r\n                    // Upload first half of image to the texture\r\n                    var cropImage = cropContext.getImageData(0, 0, image.width / 2, image.height);\r\n                    gl.texImage2D(glBindType, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, cropImage);\r\n\r\n                    // Create and bind texture for second half of image\r\n                    program.texture2 = gl.createTexture();\r\n                    gl.activeTexture(gl.TEXTURE1);\r\n                    gl.bindTexture(glBindType, program.texture2);\r\n                    gl.uniform1i(gl.getUniformLocation(program, 'u_image1'), 1);\r\n\r\n                    // Upload second half of image to the texture\r\n                    cropContext.drawImage(image, -image.width / 2, 0);\r\n                    cropImage = cropContext.getImageData(0, 0, image.width / 2, image.height);\r\n                    gl.texImage2D(glBindType, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, cropImage);\r\n\r\n                    // Set parameters for rendering any size\r\n                    gl.texParameteri(glBindType, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n                    gl.texParameteri(glBindType, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n                    gl.texParameteri(glBindType, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n                    gl.texParameteri(glBindType, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n\r\n                    // Reactivate first texture unit\r\n                    gl.activeTexture(gl.TEXTURE0);\r\n                }\r\n            }\r\n\r\n            // Set parameters for rendering any size\r\n            gl.texParameteri(glBindType, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n            gl.texParameteri(glBindType, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n            gl.texParameteri(glBindType, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n            gl.texParameteri(glBindType, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n\r\n        } else {\r\n            // Look up vertex coordinates location\r\n            program.vertPosLocation = gl.getAttribLocation(program, 'a_vertCoord');\r\n            gl.enableVertexAttribArray(program.vertPosLocation);\r\n\r\n            // Create buffers\r\n            if (!cubeVertBuf)\r\n                cubeVertBuf = gl.createBuffer();\r\n            if (!cubeVertTexCoordBuf)\r\n                cubeVertTexCoordBuf = gl.createBuffer();\r\n            if (!cubeVertIndBuf)\r\n                cubeVertIndBuf = gl.createBuffer();\r\n\r\n            // Bind texture coordinate buffer and pass coordinates to WebGL\r\n            gl.bindBuffer(gl.ARRAY_BUFFER, cubeVertTexCoordBuf);\r\n            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([0,0,1,0,1,1,0,1]), gl.STATIC_DRAW);\r\n\r\n            // Bind square index buffer and pass indicies to WebGL\r\n            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, cubeVertIndBuf);\r\n            gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array([0,1,2,0,2,3]), gl.STATIC_DRAW);\r\n\r\n            // Find uniforms\r\n            program.perspUniform = gl.getUniformLocation(program, 'u_perspMatrix');\r\n            program.cubeUniform = gl.getUniformLocation(program, 'u_cubeMatrix');\r\n            //program.colorUniform = gl.getUniformLocation(program, 'u_color');\r\n\r\n            program.level = -1;\r\n\r\n            program.currentNodes = [];\r\n            program.nodeCache = [];\r\n            program.nodeCacheTimestamp = 0;\r\n        }\r\n\r\n        // Check if there was an error\r\n        var err = gl.getError();\r\n        if (err !== 0) {\r\n            console.log('Error: Something went wrong with WebGL!', err);\r\n            throw {type: 'webgl error'};\r\n        }\r\n\r\n        callback();\r\n     };\r\n\r\n    /**\r\n     * Destroy renderer.\r\n     * @memberof Renderer\r\n     * @instance\r\n     */\r\n    this.destroy = function() {\r\n        if (container !== undefined) {\r\n            if (canvas !== undefined && container.contains(canvas)) {\r\n                container.removeChild(canvas);\r\n            }\r\n            if (world !== undefined && container.contains(world)) {\r\n                container.removeChild(world);\r\n            }\r\n        }\r\n        if (gl) {\r\n            // The spec says this is only supposed to simulate losing the WebGL\r\n            // context, but in practice it tends to actually free the memory.\r\n            var extension = gl.getExtension('WEBGL_lose_context');\r\n            if (extension)\r\n                extension.loseContext();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Resize renderer (call after resizing container).\r\n     * @memberof Renderer\r\n     * @instance\r\n     */\r\n    this.resize = function() {\r\n        var pixelRatio = window.devicePixelRatio || 1;\r\n        canvas.width = canvas.clientWidth * pixelRatio;\r\n        canvas.height = canvas.clientHeight * pixelRatio;\r\n        if (gl) {\r\n            if (gl.getError() == 1286)\r\n                handleWebGLError1286();\r\n            gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);\r\n            if (imageType != 'multires') {\r\n                gl.uniform1f(program.aspectRatio, canvas.clientWidth / canvas.clientHeight);\r\n            }\r\n        }\r\n    };\r\n    // Initialize canvas size\r\n    this.resize();\r\n\r\n    /**\r\n     * Set renderer horizon pitch and roll.\r\n     * @memberof Renderer\r\n     * @instance\r\n     */\r\n    this.setPose = function(horizonPitch, horizonRoll) {\r\n        pose = [horizonPitch, horizonRoll];\r\n    };\r\n\r\n    /**\r\n     * Render new view of panorama.\r\n     * @memberof Renderer\r\n     * @instance\r\n     * @param {number} pitch - Pitch to render at (in radians).\r\n     * @param {number} yaw - Yaw to render at (in radians).\r\n     * @param {number} hfov - Horizontal field of view to render with (in radians).\r\n     * @param {Object} [params] - Extra configuration parameters. \r\n     * @param {number} [params.roll] - Camera roll (in radians).\r\n     * @param {boolean} [params.returnImage] - Return rendered image?\r\n     */\r\n    this.render = function(pitch, yaw, hfov, params) {\r\n        var focal, i, s, roll = 0;\r\n        if (params === undefined)\r\n            params = {};\r\n        if (params.roll)\r\n            roll = params.roll;\r\n\r\n        // Apply pitch and roll transformation if applicable\r\n        if (pose !== undefined) {\r\n            var horizonPitch = pose[0],\r\n                horizonRoll = pose[1];\r\n\r\n            // Calculate new pitch and yaw\r\n            var orig_pitch = pitch,\r\n                orig_yaw = yaw,\r\n                x = Math.cos(horizonRoll) * Math.sin(pitch) * Math.sin(horizonPitch) +\r\n                    Math.cos(pitch) * (Math.cos(horizonPitch) * Math.cos(yaw) +\r\n                    Math.sin(horizonRoll) * Math.sin(horizonPitch) * Math.sin(yaw)),\r\n                y = -Math.sin(pitch) * Math.sin(horizonRoll) +\r\n                    Math.cos(pitch) * Math.cos(horizonRoll) * Math.sin(yaw),\r\n                z = Math.cos(horizonRoll) * Math.cos(horizonPitch) * Math.sin(pitch) +\r\n                    Math.cos(pitch) * (-Math.cos(yaw) * Math.sin(horizonPitch) +\r\n                    Math.cos(horizonPitch) * Math.sin(horizonRoll) * Math.sin(yaw));\r\n            pitch = Math.asin(Math.max(Math.min(z, 1), -1));\r\n            yaw = Math.atan2(y, x);\r\n\r\n            // Calculate roll\r\n            var v = [Math.cos(orig_pitch) * (Math.sin(horizonRoll) * Math.sin(horizonPitch) * Math.cos(orig_yaw) -\r\n                    Math.cos(horizonPitch) * Math.sin(orig_yaw)),\r\n                    Math.cos(orig_pitch) * Math.cos(horizonRoll) * Math.cos(orig_yaw),\r\n                    Math.cos(orig_pitch) * (Math.cos(horizonPitch) * Math.sin(horizonRoll) * Math.cos(orig_yaw) +\r\n                    Math.sin(orig_yaw) * Math.sin(horizonPitch))],\r\n                w = [-Math.cos(pitch) * Math.sin(yaw), Math.cos(pitch) * Math.cos(yaw)];\r\n            var roll_adj = Math.acos(Math.max(Math.min((v[0]*w[0] + v[1]*w[1]) /\r\n                (Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]) *\r\n                Math.sqrt(w[0]*w[0]+w[1]*w[1])), 1), -1));\r\n            if (v[2] < 0)\r\n                roll_adj = 2 * Math.PI - roll_adj;\r\n            roll += roll_adj;\r\n        }\r\n\r\n        // If no WebGL\r\n        if (!gl && (imageType == 'multires' || imageType == 'cubemap')) {\r\n            // Determine face transforms\r\n            s = fallbackImgSize / 2;\r\n            \r\n            var transforms = {\r\n                f: 'translate3d(-' + (s + 2) + 'px, -' + (s + 2) + 'px, -' + s + 'px)',\r\n                b: 'translate3d(' + (s + 2) + 'px, -' + (s + 2) + 'px, ' + s + 'px) rotateX(180deg) rotateZ(180deg)',\r\n                u: 'translate3d(-' + (s + 2) + 'px, -' + s + 'px, ' + (s + 2) + 'px) rotateX(270deg)',\r\n                d: 'translate3d(-' + (s + 2) + 'px, ' + s + 'px, -' + (s + 2) + 'px) rotateX(90deg)',\r\n                l: 'translate3d(-' + s + 'px, -' + (s + 2) + 'px, ' + (s + 2) + 'px) rotateX(180deg) rotateY(90deg) rotateZ(180deg)',\r\n                r: 'translate3d(' + s + 'px, -' + (s + 2) + 'px, -' + (s + 2) + 'px) rotateY(270deg)'\r\n            };\r\n            focal = 1 / Math.tan(hfov / 2);\r\n            var zoom = focal * canvas.clientWidth / 2 + 'px';\r\n            var transform = 'perspective(' + zoom + ') translateZ(' + zoom + ') rotateX(' + pitch + 'rad) rotateY(' + yaw + 'rad) ';\r\n            \r\n            // Apply face transforms\r\n            var faces = Object.keys(transforms);\r\n            for (i = 0; i < 6; i++) {\r\n                var face = world.querySelector('.pnlm-' + faces[i] + 'face');\r\n                if (!face)\r\n                    continue; // ignore missing face to support partial cubemap/fallback image\r\n                face.style.webkitTransform = transform + transforms[faces[i]];\r\n                face.style.transform = transform + transforms[faces[i]];\r\n            }\r\n            return;\r\n        }\r\n        \r\n        if (imageType != 'multires') {\r\n            // Calculate focal length from vertical field of view\r\n            var vfov = 2 * Math.atan(Math.tan(hfov * 0.5) / (gl.drawingBufferWidth / gl.drawingBufferHeight));\r\n            focal = 1 / Math.tan(vfov * 0.5);\r\n\r\n            // Pass psi, theta, roll, and focal length\r\n            gl.uniform1f(program.psi, yaw);\r\n            gl.uniform1f(program.theta, pitch);\r\n            gl.uniform1f(program.rot, roll);\r\n            gl.uniform1f(program.f, focal);\r\n            \r\n            if (dynamic === true) {\r\n                // Update texture if dynamic\r\n                if (imageType == 'equirectangular') {\r\n                    gl.bindTexture(gl.TEXTURE_2D, program.texture);\r\n                    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, image);\r\n                }\r\n            }\r\n            \r\n            // Draw using current buffer\r\n            gl.drawArrays(gl.TRIANGLES, 0, 6);\r\n        \r\n        } else {\r\n            // Create perspective matrix\r\n            var perspMatrix = makePersp(hfov, gl.drawingBufferWidth / gl.drawingBufferHeight, 0.1, 100.0);\r\n            \r\n            // Find correct zoom level\r\n            checkZoom(hfov);\r\n            \r\n            // Create rotation matrix\r\n            var matrix = identityMatrix3();\r\n            matrix = rotateMatrix(matrix, -roll, 'z');\r\n            matrix = rotateMatrix(matrix, -pitch, 'x');\r\n            matrix = rotateMatrix(matrix, yaw, 'y');\r\n            matrix = makeMatrix4(matrix);\r\n            \r\n            // Set matrix uniforms\r\n            gl.uniformMatrix4fv(program.perspUniform, false, new Float32Array(transposeMatrix4(perspMatrix)));\r\n            gl.uniformMatrix4fv(program.cubeUniform, false, new Float32Array(transposeMatrix4(matrix)));\r\n            \r\n            // Find current nodes\r\n            var rotPersp = rotatePersp(perspMatrix, matrix);\r\n            program.nodeCache.sort(multiresNodeSort);\r\n            if (program.nodeCache.length > 200 &&\r\n                program.nodeCache.length > program.currentNodes.length + 50) {\r\n                // Remove older nodes from cache\r\n                var removed = program.nodeCache.splice(200, program.nodeCache.length - 200);\r\n                for (var j = 0; j < removed.length; j++) {\r\n                    // Explicitly delete textures\r\n                    gl.deleteTexture(removed[j].texture);\r\n                }\r\n            }\r\n            program.currentNodes = [];\r\n            \r\n            var sides = ['f', 'b', 'u', 'd', 'l', 'r'];\r\n            for (s = 0; s < 6; s++) {\r\n                var ntmp = new MultiresNode(vtmps[s], sides[s], 1, 0, 0, image.fullpath);\r\n                testMultiresNode(rotPersp, ntmp, pitch, yaw, hfov);\r\n            }\r\n            \r\n            program.currentNodes.sort(multiresNodeRenderSort);\r\n            \r\n            // Unqueue any pending requests for nodes that are no longer visible\r\n            for (i = pendingTextureRequests.length - 1; i >= 0; i--) {\r\n                if (program.currentNodes.indexOf(pendingTextureRequests[i].node) === -1) {\r\n                    pendingTextureRequests[i].node.textureLoad = false;\r\n                    pendingTextureRequests.splice(i, 1);\r\n                }\r\n            }\r\n            \r\n            // Allow one request to be pending, so that we can create a texture buffer for that in advance of loading actually beginning\r\n            if (pendingTextureRequests.length === 0) {\r\n                for (i = 0; i < program.currentNodes.length; i++) {\r\n                    var node = program.currentNodes[i];\r\n                    if (!node.texture && !node.textureLoad) {\r\n                        node.textureLoad = true;\r\n            \r\n                        setTimeout(processNextTile, 0, node);\r\n                        \r\n                        // Only process one tile per frame to improve responsiveness\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // Draw tiles\r\n            multiresDraw();\r\n        }\r\n        \r\n        if (params.returnImage !== undefined) {\r\n            return canvas.toDataURL('image/png');\r\n        }\r\n    };\r\n    \r\n    /**\r\n     * Check if images are loading.\r\n     * @memberof Renderer\r\n     * @instance\r\n     * @returns {boolean} Whether or not images are loading.\r\n     */\r\n    this.isLoading = function() {\r\n        if (gl && imageType == 'multires') {\r\n            for ( var i = 0; i < program.currentNodes.length; i++ ) {\r\n                if (!program.currentNodes[i].textureLoaded) {\r\n                    return true;\r\n                }\r\n            }\r\n        }\r\n        return false;\r\n    };\r\n    \r\n    /**\r\n     * Retrieve renderer's canvas.\r\n     * @memberof Renderer\r\n     * @instance\r\n     * @returns {HTMLElement} Renderer's canvas.\r\n     */\r\n    this.getCanvas = function() {\r\n        return canvas;\r\n    };\r\n    \r\n    /**\r\n     * Sorting method for multires nodes.\r\n     * @private\r\n     * @param {MultiresNode} a - First node.\r\n     * @param {MultiresNode} b - Second node.\r\n     * @returns {number} Base tiles first, then higher timestamp first.\r\n     */\r\n    function multiresNodeSort(a, b) {\r\n        // Base tiles are always first\r\n        if (a.level == 1 && b.level != 1) {\r\n            return -1;\r\n        }\r\n        if (b. level == 1 && a.level != 1) {\r\n            return 1;\r\n        }\r\n        \r\n        // Higher timestamp first\r\n        return b.timestamp - a.timestamp;\r\n    }\r\n    \r\n    /**\r\n     * Sorting method for multires node rendering.\r\n     * @private\r\n     * @param {MultiresNode} a - First node.\r\n     * @param {MultiresNode} b - Second node.\r\n     * @returns {number} Lower zoom levels first, then closest to center first.\r\n     */\r\n    function multiresNodeRenderSort(a, b) {\r\n        // Lower zoom levels first\r\n        if (a.level != b.level) {\r\n            return a.level - b.level;\r\n        }\r\n        \r\n        // Lower distance from center first\r\n        return a.diff - b.diff;\r\n    }\r\n    \r\n    /**\r\n     * Draws multires nodes.\r\n     * @private\r\n     */\r\n    function multiresDraw() {\r\n        if (!program.drawInProgress) {\r\n            program.drawInProgress = true;\r\n            gl.clear(gl.COLOR_BUFFER_BIT);\r\n            for ( var i = 0; i < program.currentNodes.length; i++ ) {\r\n                if (program.currentNodes[i].textureLoaded > 1) {\r\n                    //var color = program.currentNodes[i].color;\r\n                    //gl.uniform4f(program.colorUniform, color[0], color[1], color[2], 1.0);\r\n                    \r\n                    // Bind vertex buffer and pass vertices to WebGL\r\n                    gl.bindBuffer(gl.ARRAY_BUFFER, cubeVertBuf);\r\n                    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(program.currentNodes[i].vertices), gl.STATIC_DRAW);\r\n                    gl.vertexAttribPointer(program.vertPosLocation, 3, gl.FLOAT, false, 0, 0);\r\n                    \r\n                    // Prep for texture\r\n                    gl.bindBuffer(gl.ARRAY_BUFFER, cubeVertTexCoordBuf);\r\n                    gl.vertexAttribPointer(program.texCoordLocation, 2, gl.FLOAT, false, 0, 0);\r\n                    \r\n                    // Bind texture and draw tile\r\n                    gl.bindTexture(gl.TEXTURE_2D, program.currentNodes[i].texture); // Bind program.currentNodes[i].texture to TEXTURE0\r\n                    gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);\r\n                }\r\n            }\r\n            program.drawInProgress = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Creates new multires node.\r\n     * @constructor\r\n     * @private\r\n     * @param {number[]} vertices - Node's verticies.\r\n     * @param {string} side - Node's cube face.\r\n     * @param {number} level - Node's zoom level.\r\n     * @param {number} x - Node's x position.\r\n     * @param {number} y - Node's y position.\r\n     * @param {string} path - Node's path.\r\n     */\r\n    function MultiresNode(vertices, side, level, x, y, path) {\r\n        this.vertices = vertices;\r\n        this.side = side;\r\n        this.level = level;\r\n        this.x = x;\r\n        this.y = y;\r\n        this.path = path.replace('%s',side).replace('%l',level).replace('%x',x).replace('%y',y);\r\n    }\r\n\r\n    /**\r\n     * Test if multires node is visible. If it is, add it to current nodes,\r\n     * load its texture, and load appropriate child nodes.\r\n     * @private\r\n     * @param {number[]} rotPersp - Rotated perspective matrix.\r\n     * @param {MultiresNode} node - Multires node to check.\r\n     * @param {number} pitch - Pitch to check at.\r\n     * @param {number} yaw - Yaw to check at.\r\n     * @param {number} hfov - Horizontal field of view to check at.\r\n     */\r\n    function testMultiresNode(rotPersp, node, pitch, yaw, hfov) {\r\n        if (checkSquareInView(rotPersp, node.vertices)) {\r\n            // Calculate central angle between center of view and center of tile\r\n            var v = node.vertices;\r\n            var x = v[0] + v[3] + v[6] + v[ 9];\r\n            var y = v[1] + v[4] + v[7] + v[10];\r\n            var z = v[2] + v[5] + v[8] + v[11];\r\n            var r = Math.sqrt(x*x + y*y + z*z);\r\n            var theta = Math.asin(z / r);\r\n            var phi = Math.atan2(y, x);\r\n            var ydiff = phi - yaw;\r\n            ydiff += (ydiff > Math.PI) ? -2 * Math.PI : (ydiff < -Math.PI) ? 2 * Math.PI : 0;\r\n            ydiff = Math.abs(ydiff);\r\n            node.diff = Math.acos(Math.sin(pitch) * Math.sin(theta) + Math.cos(pitch) * Math.cos(theta) * Math.cos(ydiff));\r\n            \r\n            // Add node to current nodes and load texture if needed\r\n            var inCurrent = false;\r\n            for (var k = 0; k < program.nodeCache.length; k++) {\r\n                if (program.nodeCache[k].path == node.path) {\r\n                    inCurrent = true;\r\n                    program.nodeCache[k].timestamp = program.nodeCacheTimestamp++;\r\n                    program.nodeCache[k].diff = node.diff;\r\n                    program.currentNodes.push(program.nodeCache[k]);\r\n                    break;\r\n                }\r\n            }\r\n            if (!inCurrent) {\r\n                //node.color = [Math.random(), Math.random(), Math.random()];\r\n                node.timestamp = program.nodeCacheTimestamp++;\r\n                program.currentNodes.push(node);\r\n                program.nodeCache.push(node);\r\n            }\r\n            \r\n            // TODO: Test error\r\n            // Create child nodes\r\n            if (node.level < program.level) {\r\n                var cubeSize = image.cubeResolution * Math.pow(2, node.level - image.maxLevel);\r\n                var numTiles = Math.ceil(cubeSize * image.invTileResolution) - 1;\r\n                var doubleTileSize = cubeSize % image.tileResolution * 2;\r\n                var lastTileSize = (cubeSize * 2) % image.tileResolution;\r\n                if (lastTileSize === 0) {\r\n                    lastTileSize = image.tileResolution;\r\n                }\r\n                if (doubleTileSize === 0) {\r\n                    doubleTileSize = image.tileResolution * 2;\r\n                }\r\n                var f = 0.5;\r\n                if (node.x == numTiles || node.y == numTiles) {\r\n                    f = 1.0 - image.tileResolution / (image.tileResolution + lastTileSize);\r\n                }\r\n                var i = 1.0 - f;\r\n                var children = [];\r\n                var vtmp, ntmp;\r\n                var f1 = f, f2 = f, f3 = f, i1 = i, i2 = i, i3 = i;\r\n                // Handle non-symmetric tiles\r\n                if (lastTileSize < image.tileResolution) {\r\n                    if (node.x == numTiles && node.y != numTiles) {\r\n                        f2 = 0.5;\r\n                        i2 = 0.5;\r\n                        if (node.side == 'd' || node.side == 'u') {\r\n                            f3 = 0.5;\r\n                            i3 = 0.5;\r\n                        }\r\n                    } else if (node.x != numTiles && node.y == numTiles) {\r\n                        f1 = 0.5;\r\n                        i1 = 0.5;\r\n                        if (node.side == 'l' || node.side == 'r') {\r\n                            f3 = 0.5;\r\n                            i3 = 0.5;\r\n                        }\r\n                    }\r\n                }\r\n                // Handle small tiles that have fewer than four children\r\n                if (doubleTileSize <= image.tileResolution) {\r\n                    if (node.x == numTiles) {\r\n                        f1 = 0;\r\n                        i1 = 1;\r\n                        if (node.side == 'l' || node.side == 'r') {\r\n                            f3 = 0;\r\n                            i3 = 1;\r\n                        }\r\n                    }\r\n                    if (node.y == numTiles) {\r\n                        f2 = 0;\r\n                        i2 = 1;\r\n                        if (node.side == 'd' || node.side == 'u') {\r\n                            f3 = 0;\r\n                            i3 = 1;\r\n                        }\r\n                    }\r\n                }\r\n                \r\n                vtmp = [           v[0],             v[1],             v[2],\r\n                        v[0]*f1+v[3]*i1,    v[1]*f+v[4]*i,  v[2]*f3+v[5]*i3,\r\n                        v[0]*f1+v[6]*i1,  v[1]*f2+v[7]*i2,  v[2]*f3+v[8]*i3,\r\n                          v[0]*f+v[9]*i, v[1]*f2+v[10]*i2, v[2]*f3+v[11]*i3\r\n                ];\r\n                ntmp = new MultiresNode(vtmp, node.side, node.level + 1, node.x*2, node.y*2, image.fullpath);\r\n                children.push(ntmp);\r\n                if (!(node.x == numTiles && doubleTileSize <= image.tileResolution)) {\r\n                    vtmp = [v[0]*f1+v[3]*i1,    v[1]*f+v[4]*i,  v[2]*f3+v[5]*i3,\r\n                                       v[3],             v[4],             v[5],\r\n                              v[3]*f+v[6]*i,  v[4]*f2+v[7]*i2,  v[5]*f3+v[8]*i3,\r\n                            v[0]*f1+v[6]*i1,  v[1]*f2+v[7]*i2,  v[2]*f3+v[8]*i3\r\n                    ];\r\n                    ntmp = new MultiresNode(vtmp, node.side, node.level + 1, node.x*2+1, node.y*2, image.fullpath);\r\n                    children.push(ntmp);\r\n                }\r\n                if (!(node.x == numTiles && doubleTileSize <= image.tileResolution) &&\r\n                    !(node.y == numTiles && doubleTileSize <= image.tileResolution)) {\r\n                    vtmp = [v[0]*f1+v[6]*i1,  v[1]*f2+v[7]*i2,  v[2]*f3+v[8]*i3,\r\n                              v[3]*f+v[6]*i,  v[4]*f2+v[7]*i2,  v[5]*f3+v[8]*i3,\r\n                                       v[6],             v[7],             v[8],\r\n                            v[9]*f1+v[6]*i1,   v[10]*f+v[7]*i, v[11]*f3+v[8]*i3\r\n                    ];\r\n                    ntmp = new MultiresNode(vtmp, node.side, node.level + 1, node.x*2+1, node.y*2+1, image.fullpath);\r\n                    children.push(ntmp);\r\n                }\r\n                if (!(node.y == numTiles && doubleTileSize <= image.tileResolution)) {\r\n                    vtmp = [  v[0]*f+v[9]*i, v[1]*f2+v[10]*i2, v[2]*f3+v[11]*i3,\r\n                            v[0]*f1+v[6]*i1,  v[1]*f2+v[7]*i2,  v[2]*f3+v[8]*i3,\r\n                            v[9]*f1+v[6]*i1,   v[10]*f+v[7]*i, v[11]*f3+v[8]*i3,\r\n                                       v[9],            v[10],            v[11]\r\n                    ];\r\n                    ntmp = new MultiresNode(vtmp, node.side, node.level + 1, node.x*2, node.y*2+1, image.fullpath);\r\n                    children.push(ntmp);\r\n                }\r\n                for (var j = 0; j < children.length; j++) {\r\n                    testMultiresNode(rotPersp, children[j], pitch, yaw, hfov);\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Creates cube vertex array.\r\n     * @private\r\n     * @returns {number[]} Cube vertex array.\r\n     */\r\n    function createCube() {\r\n        return [-1,  1, -1,  1,  1, -1,  1, -1, -1, -1, -1, -1, // Front face\r\n                 1,  1,  1, -1,  1,  1, -1, -1,  1,  1, -1,  1, // Back face\r\n                -1,  1,  1,  1,  1,  1,  1,  1, -1, -1,  1, -1, // Up face\r\n                -1, -1, -1,  1, -1, -1,  1, -1,  1, -1, -1,  1, // Down face\r\n                -1,  1,  1, -1,  1, -1, -1, -1, -1, -1, -1,  1, // Left face\r\n                 1,  1, -1,  1,  1,  1,  1, -1,  1,  1, -1, -1  // Right face\r\n        ];\r\n    }\r\n    \r\n    /**\r\n     * Creates 3x3 identity matrix.\r\n     * @private\r\n     * @returns {number[]} Identity matrix.\r\n     */\r\n    function identityMatrix3() {\r\n        return [\r\n            1, 0, 0,\r\n            0, 1, 0,\r\n            0, 0, 1\r\n        ];\r\n    }\r\n    \r\n    /**\r\n     * Rotates a 3x3 matrix.\r\n     * @private\r\n     * @param {number[]} m - Matrix to rotate.\r\n     * @param {number[]} angle - Angle to rotate by in radians.\r\n     * @param {string} axis - Axis to rotate about (`x`, `y`, or `z`).\r\n     * @returns {number[]} Rotated matrix.\r\n     */\r\n    function rotateMatrix(m, angle, axis) {\r\n        var s = Math.sin(angle);\r\n        var c = Math.cos(angle);\r\n        if (axis == 'x') {\r\n            return [\r\n                m[0], c*m[1] + s*m[2], c*m[2] - s*m[1],\r\n                m[3], c*m[4] + s*m[5], c*m[5] - s*m[4],\r\n                m[6], c*m[7] + s*m[8], c*m[8] - s*m[7]\r\n            ];\r\n        }\r\n        if (axis == 'y') {\r\n            return [\r\n                c*m[0] - s*m[2], m[1], c*m[2] + s*m[0],\r\n                c*m[3] - s*m[5], m[4], c*m[5] + s*m[3],\r\n                c*m[6] - s*m[8], m[7], c*m[8] + s*m[6]\r\n            ];\r\n        }\r\n        if (axis == 'z') {\r\n            return [\r\n                c*m[0] + s*m[1], c*m[1] - s*m[0], m[2],\r\n                c*m[3] + s*m[4], c*m[4] - s*m[3], m[5],\r\n                c*m[6] + s*m[7], c*m[7] - s*m[6], m[8]\r\n            ];\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Turns a 3x3 matrix into a 4x4 matrix.\r\n     * @private\r\n     * @param {number[]} m - Input matrix.\r\n     * @returns {number[]} Expanded matrix.\r\n     */\r\n    function makeMatrix4(m) {\r\n        return [\r\n            m[0], m[1], m[2],    0,\r\n            m[3], m[4], m[5],    0,\r\n            m[6], m[7], m[8],    0,\r\n               0,    0,    0,    1\r\n        ];\r\n    }\r\n    \r\n    /**\r\n     * Transposes a 4x4 matrix.\r\n     * @private\r\n     * @param {number[]} m - Input matrix.\r\n     * @returns {number[]} Transposed matrix.\r\n     */\r\n    function transposeMatrix4(m) {\r\n        return [\r\n            m[ 0], m[ 4], m[ 8], m[12],\r\n            m[ 1], m[ 5], m[ 9], m[13],\r\n            m[ 2], m[ 6], m[10], m[14],\r\n            m[ 3], m[ 7], m[11], m[15]\r\n        ];\r\n    }\r\n    \r\n    /**\r\n     * Creates a perspective matrix.\r\n     * @private\r\n     * @param {number} hfov - Desired horizontal field of view.\r\n     * @param {number} aspect - Desired aspect ratio.\r\n     * @param {number} znear - Near distance.\r\n     * @param {number} zfar - Far distance.\r\n     * @returns {number[]} Generated perspective matrix.\r\n     */\r\n    function makePersp(hfov, aspect, znear, zfar) {\r\n        var fovy = 2 * Math.atan(Math.tan(hfov/2) * gl.drawingBufferHeight / gl.drawingBufferWidth);\r\n        var f = 1 / Math.tan(fovy/2);\r\n        return [\r\n            f/aspect,   0,  0,  0,\r\n                   0,   f,  0,  0,\r\n                   0,   0,  (zfar+znear)/(znear-zfar), (2*zfar*znear)/(znear-zfar),\r\n                   0,   0, -1,  0\r\n        ];\r\n    }\r\n    \r\n    /**\r\n     * Processes a loaded texture image into a WebGL texture.\r\n     * @private\r\n     * @param {Image} img - Input image.\r\n     * @param {WebGLTexture} tex - Texture to bind image to.\r\n     */\r\n    function processLoadedTexture(img, tex) {\r\n        gl.bindTexture(gl.TEXTURE_2D, tex);\r\n        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, img);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n        gl.bindTexture(gl.TEXTURE_2D, null);\r\n    }\r\n    \r\n    var pendingTextureRequests = [];\r\n\r\n    // Based on http://blog.tojicode.com/2012/03/javascript-memory-optimization-and.html\r\n    var loadTexture = (function() {\r\n        var cacheTop = 4;   // Maximum number of concurrents loads\r\n        var textureImageCache = {};\r\n        var crossOrigin;\r\n\r\n        function TextureImageLoader() {\r\n            var self = this;\r\n            this.texture = this.callback = null;\r\n            this.image = new Image();\r\n            this.image.crossOrigin = crossOrigin ? crossOrigin : 'anonymous';\r\n            var loadFn = (function() {\r\n                if (self.image.width > 0 && self.image.height > 0) { // ignore missing tile to supporting partial image\r\n                    processLoadedTexture(self.image, self.texture);\r\n                    self.callback(self.texture, true);\r\n                } else {\r\n                    self.callback(self.texture, false);\r\n                }\r\n                releaseTextureImageLoader(self);\r\n            });\r\n            this.image.addEventListener('load', loadFn);\r\n            this.image.addEventListener('error', loadFn); // ignore missing tile file to support partial image, otherwise retry loop causes high CPU load\r\n        }\r\n\r\n        TextureImageLoader.prototype.loadTexture = function(src, texture, callback) {\r\n            this.texture = texture;\r\n            this.callback = callback;\r\n            this.image.src = src;\r\n        };\r\n\r\n        function PendingTextureRequest(node, src, texture, callback) {\r\n            this.node = node;\r\n            this.src = src;\r\n            this.texture = texture;\r\n            this.callback = callback;\r\n        }\r\n\r\n        function releaseTextureImageLoader(til) {\r\n            if (pendingTextureRequests.length) {\r\n                var req = pendingTextureRequests.shift();\r\n                til.loadTexture(req.src, req.texture, req.callback);\r\n            } else\r\n                textureImageCache[cacheTop++] = til;\r\n        }\r\n\r\n        for (var i = 0; i < cacheTop; i++)\r\n            textureImageCache[i] = new TextureImageLoader();\r\n\r\n        return function(node, src, callback, _crossOrigin) {\r\n            crossOrigin = _crossOrigin;\r\n            var texture = gl.createTexture();\r\n            if (cacheTop)\r\n                textureImageCache[--cacheTop].loadTexture(src, texture, callback);\r\n            else\r\n                pendingTextureRequests.push(new PendingTextureRequest(node, src, texture, callback));\r\n            return texture;\r\n        };\r\n    })();\r\n\r\n    /**\r\n     * Loads image and creates texture for a multires node / tile.\r\n     * @private\r\n     * @param {MultiresNode} node - Input node.\r\n     */\r\n    function processNextTile(node) {\r\n        loadTexture(node, node.path + '.' + image.extension, function(texture, loaded) {\r\n            node.texture = texture;\r\n            node.textureLoaded = loaded ? 2 : 1;\r\n        }, globalParams.crossOrigin);\r\n    }\r\n    \r\n    /**\r\n     * Finds and applies optimal multires zoom level.\r\n     * @private\r\n     * @param {number} hfov - Horizontal field of view to check at.\r\n     */\r\n    function checkZoom(hfov) {\r\n        // Find optimal level\r\n        var newLevel = 1;\r\n        while ( newLevel < image.maxLevel &&\r\n            gl.drawingBufferWidth > image.tileResolution *\r\n            Math.pow(2, newLevel - 1) * Math.tan(hfov / 2) * 0.707 ) {\r\n            newLevel++;\r\n        }\r\n        \r\n        // Apply change\r\n        program.level = newLevel;\r\n    }\r\n    \r\n    /**\r\n     * Rotates perspective matrix.\r\n     * @private\r\n     * @param {number[]} p - Perspective matrix.\r\n     * @param {number[]} r - Rotation matrix.\r\n     * @returns {number[]} Rotated matrix.\r\n     */\r\n    function rotatePersp(p, r) {\r\n        return [\r\n            p[ 0]*r[0], p[ 0]*r[1], p[ 0]*r[ 2],     0,\r\n            p[ 5]*r[4], p[ 5]*r[5], p[ 5]*r[ 6],     0,\r\n            p[10]*r[8], p[10]*r[9], p[10]*r[10], p[11],\r\n                 -r[8],      -r[9],      -r[10],     0\r\n        ];\r\n    }\r\n    \r\n    /**\r\n     * Applies rotated perspective matrix to a 3-vector\r\n     * (last element is inverted).\r\n     * @private\r\n     * @param {number[]} m - Rotated perspective matrix.\r\n     * @param {number[]} v - Input 3-vector.\r\n     * @returns {number[]} Resulting 4-vector.\r\n     */\r\n    function applyRotPerspToVec(m, v) {\r\n        return [\r\n                    m[ 0]*v[0] + m[ 1]*v[1] + m[ 2]*v[2],\r\n                    m[ 4]*v[0] + m[ 5]*v[1] + m[ 6]*v[2],\r\n            m[11] + m[ 8]*v[0] + m[ 9]*v[1] + m[10]*v[2],\r\n                 1/(m[12]*v[0] + m[13]*v[1] + m[14]*v[2])\r\n        ];\r\n    }\r\n    \r\n    /**\r\n     * Checks if a vertex is visible.\r\n     * @private\r\n     * @param {number[]} m - Rotated perspective matrix.\r\n     * @param {number[]} v - Input vertex.\r\n     * @returns {number} 1 or -1 if the vertex is or is not visible,\r\n     *      respectively.\r\n     */\r\n    function checkInView(m, v) {\r\n        var vpp = applyRotPerspToVec(m, v);\r\n        var winX = vpp[0]*vpp[3];\r\n        var winY = vpp[1]*vpp[3];\r\n        var winZ = vpp[2]*vpp[3];\r\n        var ret = [0, 0, 0];\r\n        \r\n        if ( winX < -1 )\r\n            ret[0] = -1;\r\n        if ( winX > 1 )\r\n            ret[0] = 1;\r\n        if ( winY < -1 )\r\n            ret[1] = -1;\r\n        if ( winY > 1 )\r\n            ret[1] = 1;\r\n        if ( winZ < -1 || winZ > 1 )\r\n            ret[2] = 1;\r\n        return ret;\r\n    }\r\n    \r\n    /**\r\n     * Checks if a square (tile) is visible.\r\n     * @private\r\n     * @param {number[]} m - Rotated perspective matrix.\r\n     * @param {number[]} v - Square's vertex array.\r\n     * @returns {boolean} Whether or not the square is visible.\r\n     */\r\n    function checkSquareInView(m, v) {\r\n        var check1 = checkInView(m, v.slice(0, 3));\r\n        var check2 = checkInView(m, v.slice(3, 6));\r\n        var check3 = checkInView(m, v.slice(6, 9));\r\n        var check4 = checkInView(m, v.slice(9, 12));\r\n        var testX = check1[0] + check2[0] + check3[0] + check4[0];\r\n        if ( testX == -4 || testX == 4 )\r\n            return false;\r\n        var testY = check1[1] + check2[1] + check3[1] + check4[1];\r\n        if ( testY == -4 || testY == 4 )\r\n            return false;\r\n        var testZ = check1[2] + check2[2] + check3[2] + check4[2];\r\n        return testZ != 4;\r\n        \r\n\r\n    }\r\n\r\n    /**\r\n     * On iOS (iPhone 5c, iOS 10.3), this WebGL error occurs when the canvas is\r\n     * too big. Unfortuately, there's no way to test for this beforehand, so we\r\n     * reduce the canvas size if this error is thrown.\r\n     * @private\r\n     */\r\n    function handleWebGLError1286() {\r\n        console.log('Reducing canvas size due to error 1286!');\r\n        canvas.width = Math.round(canvas.width / 2);\r\n        canvas.height = Math.round(canvas.height / 2);\r\n    }\r\n}\r\n\r\n// Vertex shader for equirectangular and cube\r\nvar v = [\r\n'attribute vec2 a_texCoord;',\r\n'varying vec2 v_texCoord;',\r\n\r\n'void main() {',\r\n    // Set position\r\n    'gl_Position = vec4(a_texCoord, 0.0, 1.0);',\r\n    \r\n    // Pass the coordinates to the fragment shader\r\n    'v_texCoord = a_texCoord;',\r\n'}'\r\n].join('');\r\n\r\n// Vertex shader for multires\r\nvar vMulti = [\r\n'attribute vec3 a_vertCoord;',\r\n'attribute vec2 a_texCoord;',\r\n\r\n'uniform mat4 u_cubeMatrix;',\r\n'uniform mat4 u_perspMatrix;',\r\n\r\n'varying mediump vec2 v_texCoord;',\r\n\r\n'void main(void) {',\r\n    // Set position\r\n    'gl_Position = u_perspMatrix * u_cubeMatrix * vec4(a_vertCoord, 1.0);',\r\n    \r\n    // Pass the coordinates to the fragment shader\r\n    'v_texCoord = a_texCoord;',\r\n'}'\r\n].join('');\r\n\r\n// Fragment shader\r\nvar fragEquiCubeBase = [\r\n'precision highp float;', // mediump looks bad on some mobile devices\r\n\r\n'uniform float u_aspectRatio;',\r\n'uniform float u_psi;',\r\n'uniform float u_theta;',\r\n'uniform float u_f;',\r\n'uniform float u_h;',\r\n'uniform float u_v;',\r\n'uniform float u_vo;',\r\n'uniform float u_rot;',\r\n\r\n'const float PI = 3.14159265358979323846264;',\r\n\r\n// Texture\r\n'uniform sampler2D u_image0;',\r\n'uniform sampler2D u_image1;',\r\n'uniform bool u_splitImage;',\r\n'uniform samplerCube u_imageCube;',\r\n\r\n// Coordinates passed in from vertex shader\r\n'varying vec2 v_texCoord;',\r\n\r\n// Background color (display for partial panoramas)\r\n'uniform vec4 u_backgroundColor;',\r\n\r\n'void main() {',\r\n    // Map canvas/camera to sphere\r\n    'float x = v_texCoord.x * u_aspectRatio;',\r\n    'float y = v_texCoord.y;',\r\n    'float sinrot = sin(u_rot);',\r\n    'float cosrot = cos(u_rot);',\r\n    'float rot_x = x * cosrot - y * sinrot;',\r\n    'float rot_y = x * sinrot + y * cosrot;',\r\n    'float sintheta = sin(u_theta);',\r\n    'float costheta = cos(u_theta);',\r\n    'float a = u_f * costheta - rot_y * sintheta;',\r\n    'float root = sqrt(rot_x * rot_x + a * a);',\r\n    'float lambda = atan(rot_x / root, a / root) + u_psi;',\r\n    'float phi = atan((rot_y * costheta + u_f * sintheta) / root);',\r\n].join('\\n');\r\n\r\n// Fragment shader\r\nvar fragCube = fragEquiCubeBase + [\r\n    // Look up color from texture\r\n    'float cosphi = cos(phi);',\r\n    'gl_FragColor = textureCube(u_imageCube, vec3(cosphi*sin(lambda), sin(phi), cosphi*cos(lambda)));',\r\n'}'\r\n].join('\\n');\r\n\r\n// Fragment shader\r\nvar fragEquirectangular = fragEquiCubeBase + [\r\n    // Wrap image\r\n    'lambda = mod(lambda + PI, PI * 2.0) - PI;',\r\n\r\n    // Map texture to sphere\r\n    'vec2 coord = vec2(lambda / PI, phi / (PI / 2.0));',\r\n\r\n    // Look up color from texture\r\n    // Map from [-1,1] to [0,1] and flip y-axis\r\n    'if(coord.x < -u_h || coord.x > u_h || coord.y < -u_v + u_vo || coord.y > u_v + u_vo)',\r\n        'gl_FragColor = u_backgroundColor;',\r\n    'else {',\r\n        'if(u_splitImage) {',\r\n            // Image was split into two textures to work around texture size limits\r\n            'if(coord.x < 0.0)',\r\n                'gl_FragColor = texture2D(u_image0, vec2((coord.x + u_h) / u_h, (-coord.y + u_v + u_vo) / (u_v * 2.0)));',\r\n            'else',\r\n                'gl_FragColor = texture2D(u_image1, vec2((coord.x + u_h) / u_h - 1.0, (-coord.y + u_v + u_vo) / (u_v * 2.0)));',\r\n        '} else {',\r\n            'gl_FragColor = texture2D(u_image0, vec2((coord.x + u_h) / (u_h * 2.0), (-coord.y + u_v + u_vo) / (u_v * 2.0)));',\r\n        '}',\r\n    '}',\r\n'}'\r\n].join('\\n');\r\n\r\n// Fragment shader\r\nvar fragMulti = [\r\n'varying mediump vec2 v_texCoord;',\r\n'uniform sampler2D u_sampler;',\r\n//'uniform mediump vec4 u_color;',\r\n\r\n'void main(void) {',\r\n    // Look up color from texture\r\n    'gl_FragColor = texture2D(u_sampler, v_texCoord);',\r\n//    'gl_FragColor = u_color;',\r\n'}'\r\n].join('');\r\n\r\nreturn {\r\n    renderer: function(container, image, imagetype, dynamic) {\r\n        return new Renderer(container, image, imagetype, dynamic);\r\n    }\r\n};\r\n\r\n})(window, document);\r\n"]}]}